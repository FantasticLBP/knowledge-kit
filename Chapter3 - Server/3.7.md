# Node å•å…ƒæµ‹è¯•

## ä¸ºä»€ä¹ˆåšè¿™ä¸ªäº‹æƒ…

æˆ‘åœ¨æˆ‘å†™çš„æ–‡ç« é‡Œé¢å¤šæ¬¡æåˆ°å•å…ƒæµ‹è¯•çš„é‡è¦æ€§ã€‚é‡è¦çš„äº‹æƒ…è¯´ä¸‰éâ€œå•æµ‹å¾ˆé‡è¦â€ã€â€œå•æµ‹å¾ˆé‡è¦â€ã€â€œå•æµ‹å¾ˆé‡è¦â€ã€‚
å•çº¯è¯´è¿™å¥è¯æ²¡å…¬ä¿¡åŠ›å’Œæƒå¨æ€§ï¼Œé‚£æˆ‘ä¸¾ä¾‹å­æ¥è¯´æ˜å§ã€‚

åœºæ™¯1

æŸä¸šåŠ¡çº¿åœ¨ä¸æ–­çš„ç‰ˆæœ¬è¿­ä»£ï¼Œåœ¨ç‰ˆæœ¬6çš„æ—¶å€™å‘ç°åŠŸèƒ½ A çš„ä»£ç å¤ªä¹±å¤ªå¤šäº†ã€‚å°åˆ˜åŒå­¦æ‰“ç®—é‡æ„ï¼Œä»–è¾›è¾›è‹¦è‹¦è§£å†³åï¼Œæ‰“ç®—æäº¤ç»™æµ‹è¯•å·¥ç¨‹å¸ˆè¿›è¡Œæµ‹è¯•ã€‚æµ‹è¯•å·¥ç¨‹å¸ˆè¯´â€œå°åˆ˜ï¼Œä½ è¿™ä¸ªä»£ç å…¨æ˜¯ Bug å‘€ï¼Œæˆ‘ç‚¹è¿›å»å°± Crashâ€ã€‚å°åˆ˜å¬åˆ°åå¾ˆå°´å°¬ï¼Œå¿ƒé‡Œæƒ³â€œåŠŸèƒ½ A çš„ä»£ç æˆ‘å†™çš„å¾ˆå°å¿ƒï¼Œä¸€è¡Œè¡Œæ£€æŸ¥è¿‡å»çš„ï¼Œä¸å¯èƒ½æœ‰é—®é¢˜â€ã€‚æµ‹è¯•è¯´â€œæˆ‘ç‚¹å‡»å•†å“é¡µï¼Œç‚¹å‡»åŠ å…¥è´­ç‰©è½¦ï¼Œé©¬ä¸Š Crash äº†â€ã€‚ä½ è¿™ä¸ªæµ‹è¯•è¢«æ‰“å›ï¼Œé˜»å¡ä¸»æµç¨‹äº†ã€‚å°åˆ˜æƒ³äº†æƒ³æ‰å‘ç°ä»–è‡ªå·±å¼€å‘çš„æ¨¡å—æ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼Œä½†æ˜¯ä»–åœ¨é‡æ„åŠŸèƒ½ A çš„æ—¶å€™ä¸å°å¿ƒæŠŠä¾èµ–åŠŸèƒ½ A çš„åœ°æ–¹å°‘ä¼ é€’äº†é…ç½®å‚æ•° ğŸ˜…

åœºæ™¯2

æŸå…¬å¸åŸºç¡€æ™®é€šç»„æœ‰å°åˆ˜åŒå­¦ï¼Œåœ¨è®¾è®¡æŸä¸ªæ–°æŠ€æœ¯æ–¹æ¡ˆçš„æ—¶å€™ï¼Œè¾›è¾›è‹¦è‹¦èŠ±äº†3å¤©æ—¶é—´å‡ºäº†æŠ€æœ¯æ–¹æ¡ˆï¼Œä»–å»æ‰¾è€æ¿èŠï¼Œè€æ¿è®©ä»–æŠŠæ€è·¯æè¿°ä¸‹ï¼Œå†æŠŠè®¾è®¡çš„æµ‹è¯•ç”¨ä¾‹ç»™ä¸€ä¸‹ã€‚å°åˆ˜ååååè®²å®Œäº†è®¾è®¡æ€è·¯ï¼Œä½†æ˜¯ä»–è¯´è¿˜æ²¡æœ‰è®¾è®¡æµ‹è¯•ç”¨ä¾‹ã€‚è€æ¿è¯´ä½ æ²¡æµ‹è¯•ç”¨ä¾‹ï¼Œæˆ‘æ€ä¹ˆ review ä½ çš„è®¾è®¡ï¼Œä¸€è¡Œè¡Œçœ‹ä»£ç ç†è§£é€»è¾‘å—ï¼Ÿä¸€å¥å¥å¬ä½ çš„è®¾è®¡åˆ¤æ–­æœ‰æ²¡æœ‰é—®é¢˜å—ï¼Ÿä»¥åä½ æ‰¾æˆ‘å¬æŠ€æœ¯è®¾è®¡ï¼Œä½ ç†å¥½è®¾è®¡æ€è·¯ï¼Œå’Œæµ‹è¯•ç”¨ä¾‹ã€‚æˆ‘çœ‹çœ‹ä¸»æµç¨‹å’Œä¸€äº›è¾¹ç•Œçš„è¾“å…¥è¾“å‡ºï¼Œç¡®ä¿è¿™äº›ä¸œè¥¿æ­£ç¡®é‚£å°±æ˜¯æ²¡é—®é¢˜çš„ã€‚æˆ‘æ²¡æœ‰é‚£ä¹ˆå¤šæ—¶é—´ä¸€è¡Œè¡Œçœ‹ä»£ç ã€‚ï¼ˆè¯´çš„ä¹Ÿæ˜¯ï¼Œç»„é•¿æ˜¯ P9 å¿™å¾—å¾ˆï¼‰


åœºæ™¯3

æŸå…¬å¸åŸºç¡€æ™®é€šç»„æœ‰å°åˆ˜åŒå­¦åœ¨åšäº†ç§»åŠ¨ç«¯çš„ APM ç›‘æ§å’Œæ•°æ®ä¸ŠæŠ¥ SDK çš„ç¬¬ä¸€ç‰ˆï¼Œä½†æ˜¯ä»–å¾ˆä¹–ï¼Œå†™å¥½äº†å•å…ƒæµ‹è¯•ã€‚å¿˜äº†è¯´äº†å°åˆ˜åŒå­¦æ˜¯è´Ÿè´£ iOS ç«¯çš„ï¼ŒåŒäº‹åš Android ç«¯çš„å°å¼ åŒå­¦å’Œä»–å¯¹åº”ï¼Œä¸åŒå°±æ˜¯ä»–æ²¡æœ‰å†™å•å…ƒæµ‹è¯•çš„ä»£ç ã€‚ éœ€æ±‚ä¸‹æ¥äº†ï¼Œéœ€è¦è¿­ä»£ç‰ˆæœ¬2ï¼Œå°åˆ˜å’Œå°å¼ éƒ½å¼€å‘å¥½ä»£ç äº†ï¼Œéœ€è¦è¿›è¡Œæµ‹è¯•ã€‚å“ˆå“ˆå“ˆå°åˆ˜ä¹åäº†ï¼Œä»–èŠ±äº†0.5å¤©å°±æµ‹è¯•ç»“æŸï¼Œå°å¼ èŠ±äº†1.5å¤©è¿›è¡Œæµ‹è¯•ã€‚ä¸ºä»€ä¹ˆå‘¢ï¼Ÿå°åˆ˜å†™ä»£ç éƒ½è¦å†™å•å…ƒæµ‹è¯•ä»£ç ï¼Œå°å¼ ä¸å†™ã€‚è™½ç„¶å†™å•å…ƒæµ‹è¯•ä»£ç å¯èƒ½éœ€è¦èŠ±ä¸€ç‚¹ç‚¹æ—¶é—´ã€‚ä½†æ˜¯å½“æ–°ç‰ˆæœ¬è¿­ä»£çš„æ—¶å€™å°±ä¸éœ€è¦å›å¤´ç»§ç»­**å…¨é‡æµ‹è¯•**ã€‚ä»–åªè¦æŒ‰ä¸‹ `Command + U`, Xcode å°±ä¼šè·‘å•å…ƒæµ‹è¯•ç›¸å…³çš„ä»£ç ã€‚


é‚£å•å…ƒæµ‹è¯•çš„å¥½å¤„ï¼ŸğŸ˜‚ ä»€ä¹ˆ?ä½ è¿˜é—®å¥½å¤„ï¼Œä¸Šé¢é‚£ä¹ˆæ¸…æ™°æ˜äº†ï¼Œé‚£æˆ‘å†æ€»ç»“ä¸‹ï¼š
- ç¡®ä¿ä½ å†™çš„ä»£ç çš„æ¯ä¸ªåˆ†æ”¯éƒ½å¯ä»¥è¢«è¦†ç›–ï¼Œé˜²æ­¢çº¿ä¸Šä»£åœ¨ç”¨æˆ·ç«¯ï¼Œä¸å°å¿ƒæ‰§è¡Œåˆ°æœªçŸ¥çš„åˆ†æ”¯é‡Œé¢
- åœ¨è¿›è¡Œæ–°ç‰ˆæœ¬è¿­ä»£æˆ–è€…é‡æ„çš„æ—¶å€™ï¼Œå¯ä»¥é›†ä¸­ç²¾åŠ›åˆ°æ–°é€»è¾‘é‡Œé¢ï¼Œæ—§çš„é€»è¾‘å¯ä»¥ç”¨ UT æµ‹è¯•è¦†ç›–ç‡æ¥ç¡®ä¿
- åœ¨å›¢é˜Ÿå†…è¿›è¡Œ code review æˆ–è€… merge review çš„æ—¶å€™ï¼Œreview çš„äººå¯ä»¥çœ‹ä»£ç ä¸­ä¸»è¦é€»è¾‘ï¼Œç»“åˆ ut æ¥åˆ¤æ–­ã€‚


å¦å¤–ï¼Œæµ‹è¯•æ¥è¯´ä¸€èˆ¬æ˜¯ç»“åˆ CIã€CD çš„ï¼Œåƒæˆ‘ä»¬å…¬å¸æœ‰è‡ªå·±çš„å·¥å…· cli å·¥å…·ï¼Œ iOSã€Androidã€RNã€Reactã€Vueã€Node é¡¹ç›®éƒ½ä¸€èµ·å¤„ç†ï¼Œåˆ†æä¾èµ–ã€æ‰“åŒ…æ„å»ºï¼ˆæ‰“åŒ…ç³»ç»Ÿæ ¹æ®å·¥ç¨‹ç‰¹ç‚¹è°ƒåº¦ç‰¹å®šæ‰“åŒ…æœºï¼‰ã€æµ‹è¯•ã€hot fixã€åŸ‹ç‚¹ç»Ÿè®¡ã€APMç­‰ç­‰ã€‚

æ‰€ä»¥å¦‚æœå…¬å¸è§„æ¨¡å°ï¼Œå°±å†™å¥½ UT ç„¶åç»“åˆ lint åšä¸€äº›å¤„ç†ï¼Œå…¬å¸è§„æ¨¡å¤§ã€å¼€å‘æœ‰èƒ½åŠ›åˆ™éœ€è¦ç»“åˆ ciã€cd å°†æµ‹è¯•çš„èƒ½åŠ›ç»“åˆè¿›å»ã€‚


å¦å¤– UT æ˜¯ä¸€é“å·¥åºï¼Œæœ€å¥½åœ¨æ¯ä¸ªå¼€å‘è€…å†™ä»£ç çš„æ—¶å€™åš MRï¼Œå›¢é˜Ÿå†… MR +1 æ•°å¤§äº3æ‰å¯ä»¥åˆå¹¶åˆ°åˆ†æ”¯ï¼Œä¸” +1 çš„äººé‡Œé¢å¿…é¡»æœ‰ä¸€ä¸ªåŒä¸€ä¸ªé¡¹ç›®çš„åŒå­¦ï¼Œå¿…é¡»æœ‰ä¸€ä¸ªåŒæŠ€æœ¯æ ˆä¸”æ¯”ä½ é«˜æ°´å¹³çš„äººï¼ŒMR æŒ‡å‡ºçš„é—®é¢˜ä¿®æ”¹å¥½æ‰å¯ä»¥åˆå¹¶ã€‚ä¸” MR ä»£ç ä¸èƒ½å¤ªå¤§ï¼Œå› ä¸ºå¤ªå¤§ï¼Œç»™ä½ åš MR çš„åŒå­¦ä¼šå¾ˆè€—è´¹ç²¾åŠ›ã€‚äººå®¶é˜…è¯»ä½ ä»£ç æ—¶é—´æˆæœ¬å¤ªå¤§ã€‚

## Node ä¾§å¦‚ä½•è¿›è¡Œ UT å¼€å‘

Node åœ¨å¤§å­¦ä¸‰å¹´çº§çš„æ—¶å€™å°±å¬è¯´äº†ï¼Œä¹Ÿå†™è¿‡ï¼Œä¹‹å‰ä¹Ÿç”¨æ¥å†™è¿‡çˆ¬è™«ã€è‡ªåŠ¨åŒ–è„šæœ¬ã€cli ç­‰ï¼Œä¹‹å‰å­¦ä¹ è¿‡å¦‚ä½•åœ¨ Node ä¾§å†™ utï¼Œè¿™ç¯‡æ–‡ç« ç”¨æ¥æ€»ç»“ä¸‹ã€‚



ä¸¾ä¸ªä¾‹å­ï¼Œæœ‰ä¸ª Node å·¥ç¨‹ï¼Œä¸€ä¸ªæ¨¡å—çš„ä¸»è¦åŠŸèƒ½æ˜¯è·å–è¯¥ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶ã€‚å¼€å‘ä»£ç å¦‚ä¸‹

```javascript
// fetchCodeFiles.js
const fs = require('fs-extra'),
    glob = require('glob')

const fetchCodeFiles = async (dirPath) => {
  return new Promise((reslove, reject) => {
    glob('**/*.?(sh|pch|json|xcconfig|mm|cpp|h|m)', { root: dirPath, cwd: dirPath, realpath: true }, (err, files) => {
      if (err) reject(err)
      reslove(files)
    })
  });
}

module.exports = fetchCodeFiles
```

å•å…ƒæµ‹è¯•è¯¥æ€ä¹ˆåšï¼Ÿ
1. åœ¨ç»ˆç«¯ä¸‹åˆ‡æ¢åˆ°å½“å‰å·¥ç¨‹ç›®å½•ï¼Œå®‰è£… `npm install yamljs --save`
2. åœ¨å·¥ç¨‹æ ¹ç›®å½•ä¸‹æ–°å»º `test` æ–‡ä»¶å¤¹
3. ä¸ºä½ éœ€è¦çš„å¼€å‘æ–‡ä»¶å†™æµ‹è¯•ä»£ç ã€‚æ–‡ä»¶å‘½åå»ºè®® `æ¨¡å—åç§°.test.js`
4. æµ‹è¯•ä»£ç éœ€è¦å¼•å…¥ `assert`ã€‚
5. é€šè¿‡ `describe` æ–¹æ³•ã€ `it` æ–¹æ³•ã€`assert` æ–¹æ³•æå†™æµ‹è¯•ä»£ç 
6. ä¸ºäº†æ–¹ä¾¿æµ‹è¯•ï¼Œåœ¨ `package.json` æ–‡ä»¶ä¸­çš„ `scripts` ä¸‹æ·»åŠ æè¿° `"test": "mocha"`
7. ä¸ºäº†æ›´æ–¹ä¾¿ï¼Œæˆ‘ä½¿ç”¨çš„æ˜¯ iterm2ï¼Œåœ¨ .zshrc æ–‡ä»¶é‡Œè®¾ç½®åˆ«å `alias nt="node test"`

æå‡æ•ˆç‡çš„é…ç½® .zshrc å¯ä»¥æŸ¥çœ‹æ–‡ç« ï¼š [Mac ç»ˆç«¯æ•ˆç‡ç¥æŠ€](./../Chapter7&#32;-&#32;Geek&#32;Talk/7.10.md)

ä¸Šé¢å¼€å‘ä»£ç çš„æµ‹è¯•ä»£ç å¦‚ä¸‹ï¼š

```javascript
// fetchCodeFiles.test.js
const fetchCodeFiles = require('./../src/fetchCodeFiles'),
    assert = require('assert')

describe("fetch all code files", () => {
    describe("fetch all code files", () => {
        it("should return 12 when code directory is '/Users/liubinpeng/Workspace/search_key/test/code'", (done) => {
            done(assert(fetchCodeFiles('/Users/liubinpeng/Workspace/search_key/test/code')) === 12)
        })
        it("should return 4 when code directory is '/Users/liubinpeng/Workspace/search_key/test/code/Classes'", (done) => {
            done(assert(fetchCodeFiles('/Users/liubinpeng/Workspace/search_key/test/code/Classes')) === 4)
        })
        it("should return 0 when code directory is '/Users/liubinpeng/Workspace/search_key/test/code/EmptyCodeFiles'", (done) => {
            done(assert(fetchCodeFiles('/Users/liubinpeng/Workspace/search_key/test/code/EmptyCodeFiles')) === 0)
        })
    })
})
```

```json
// package.json

{
  "name": "search",
  "version": "1.0.0",
  "description": "des",
  "main": "index.js",
  "scripts": {
    "test": "mocha",
    "start": "node src/index.js"
  },
  "author": "",
  "license": "ISC",
  "dependencies": {
    "fs-extra": "^8.1.0",
    "glob": "^7.1.6",
    "yamljs": "^0.3.0"
  },
  "devDependencies": {
    "mocha": "^6.2.2"
  }
}
```

è¿è¡Œç»“æœ

![æµ‹è¯•ç»“æœ](https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/2019-12-16-nodeUT.png)



## Mocha 

æœ¬æ–‡ä¸»è¦æƒ³è¯´æ˜çš„æ˜¯ UT çš„é‡è¦æ€§ï¼Œä»¥åŠ Node æµ‹å¦‚ä½•åšå•å…ƒæµ‹è¯•ã€‚å½“ç„¶ UT æ²¡è¿™ä¹ˆç®€å•ï¼Œå…·ä½“æ·±å…¥çš„ä¸æ˜¯æœ¬æ–‡çš„ç»ˆç‚¹ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥æŸ¥çœ‹ Mocha è¿™ä¸ªé¡¹ç›®çš„[å®˜æ–¹æ–‡æ¡£](https://mochajs.org)ã€‚