JavascriptCore



1ã€JSCore æ˜¯åŸºäº webkit ä»¥ C/C++ å®ç°çš„ä¸€ä¸ª js åŒ…è£…ï¼Œè®© js å’Œ Native äº¤äº’å˜å¾—æ›´åŠ ç®€å•ã€‚

- JScontext 
  JSContext ä»£è¡¨ä¸€ä¸ª JavaScript çš„æ‰§è¡Œç¯å¢ƒçš„ä¸€ä¸ªå®ä¾‹ã€‚æ‰€æœ‰JavaScriptæ‰§è¡Œéƒ½æ˜¯åœ¨ä¸Šä¸‹æ–‡å†…è¿›è¡Œã€‚JSContextè¿˜ç”¨äºç®¡ç†å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸå†… JavaScript çš„è™šæ‹Ÿæœº
- JSValue
  JSValue æ˜¯ç”¨æ¥æ¥æ”¶ JSContext æ‰§è¡Œåçš„è¿”å›ç»“æœã€‚JSValue å¯ä»¥æ˜¯ JS çš„ä»»æ„ç±»å‹ï¼ˆå˜é‡ã€å¯¹è±¡ã€å‡½æ•°...ï¼‰
- JSManagedValue
  JSManagedValue æ˜¯å¯¹ JSValue çš„å°è£…ï¼Œå¯ä»¥è§£å†³ JS å’Œ OC ä¹‹é—´å¾ªç¯å¼•ç”¨çš„é—®é¢˜ã€‚JSManagedValue æœ€å¸¸ç”¨çš„ç”¨æ³•å°±æ˜¯å®‰å…¨çš„ä»å†…å­˜å †åŒºé‡Œé¢å¼•ç”¨ JSValue å¯¹è±¡.å¦‚æœ JSValue å­˜å‚¨åœ¨å†…å­˜çš„å †åŒºçš„æ–¹å¼æ˜¯ä¸æ­£ç¡®çš„,å¾ˆå®¹æ˜“é€ æˆå¾ªç¯å¼•ç”¨,ç„¶åå¯¼è‡´ JSContext å¯¹è±¡ä¸èƒ½æ­£ç¡®çš„é‡Šæ”¾æ‰.
- JSExport
  æ˜¯ä¸€ä¸ªåè®®ï¼Œç”¨æ¥å°† Native å¯¹è±¡æš´éœ²ç»™ JSï¼Œè¿™ä¸ªå¯¹è±¡å¯ä»¥æŒ‡å‘ç»™è‡ªèº«å’Œåˆ«çš„å¯¹è±¡ã€‚
- JSVirtualMachine
  ç®¡ç† JS å¯¹è±¡ç©ºé—´å’Œæ‰€éœ€çš„èµ„æº

2ã€Native è°ƒç”¨ JS

- åŠ è½½  JS ä»£ç 
      (JSValue *)evaluateScript:(NSString *)script;

- è°ƒç”¨ JS æ–¹æ³•
      JSvalue *callBack = self.context[@"sayHi"];
      [callback callWithArguments:@[@"æ­åŸå°åˆ˜"]];
   

3ã€JS è°ƒç”¨ Native

- é€šè¿‡ Block å®ç°ã€‚ç„¶ååœ¨ JS ä¸­ç›´æ¥è°ƒç”¨æ–¹æ³•å³å¯ã€‚éœ€è¦æ³¨æ„çš„æ˜¯åœ¨ Block å†…éƒ¨ä¸è¦ç›´æ¥ä½¿ç”¨å¤–éƒ¨å®šä¹‰çš„ JScontext å¯¹è±¡æˆ– JSValue ï¼Œåº”è¯¥ä½œä¸ºå‚æ•°ä¼ é€’è¿›æ¥ï¼Œæˆ–è€…é€šè¿‡ + (JSContext *)currentContext; æ¥è·å–ã€‚å¦åˆ™ä¼šé€ æˆå¾ªç¯å¼•ç”¨ã€å†…å­˜æ— æ³•è¢«æ­£ç¡®å›æ”¶
      self.context[@"showMessage"] = ^(NSString *message){
              UIAlertController *alertCtr = [UIAlertController alertControllerWithTitle:@"æç¤º" message:message preferredStyle:UIAlertControllerStyleAlert];
              UIAlertAction *cancel = [UIAlertAction actionWithTitle:@"OK" style:UIAlertActionStyleCancel handler:nil];
              [alertCtr addAction:cancel];
              //æ³¨æ„ï¼šæ–¹æ³•æ˜¯åœ¨å­çº¿ç¨‹ä¸­æ‰§è¡Œçš„ï¼Œéœ€è¦è·Ÿæ–°UIçš„è¯ï¼Œéœ€è¦åˆ‡å…¥ä¸»çº¿ç¨‹ã€‚
              dispatch_async(dispatch_get_main_queue(), ^{
                  [weakSealf presentViewController:alertCtr animated:YES completion:nil];
              });
          };
- é€šè¿‡ JSExport åè®®å®ç°ï¼› JS éœ€è¦é€šè¿‡ OC ä¸­æ³¨å…¥çš„å¯¹è±¡æ¥è°ƒæ–¹æ³•ï¼Œé‚£ä¹ˆæ–¹æ³•éœ€è¦åœ¨åè®®ä¸­å£°æ˜ï¼Œå¹¶ä¸”åœ¨æ³¨å…¥çš„å¯¹è±¡ä¸­å®ç°ï¼›åœ¨ webview åŠ è½½å®Œæˆçš„æ—¶å€™æ³¨å…¥å®ç°åè®®çš„ Native å¯¹è±¡
      //å£°æ˜åè®®
      
      @proptocol JSInject<JSExport>
      - (void)showMessage:(NSString *)message;
      @end
      
      //å®ç°ç›¸åº”çš„åè®®
      
      - (void)showMessage:(NSString *)message{
            UIAlertController *alertCtr = [UIAlertController alertControllerWithTitle:@"æç¤º" message:message preferredStyle:UIAlertControllerStyleAlert];
              UIAlertAction *cancel = [UIAlertAction actionWithTitle:@"OK" style:UIAlertActionStyleCancel handler:nil];
              [alertCtr addAction:cancel];
              //æ³¨æ„ï¼šæ–¹æ³•æ˜¯åœ¨å­çº¿ç¨‹ä¸­æ‰§è¡Œçš„ï¼Œéœ€è¦è·Ÿæ–°UIçš„è¯ï¼Œéœ€è¦åˆ‡å…¥ä¸»çº¿ç¨‹ã€‚
              dispatch_async(dispatch_get_main_queue(), ^{
                  [weakSealf presentViewController:alertCtr animated:YES completion:nil];
              });
      }
      
      //æ³¨å…¥
      
      - (void)webViewDidFinishLoad:(UIWebView *)webView
      {
          //ä»webviewä¸Šè·å–ç›¸åº”çš„JSContextã€‚
          self.context = [webView valueForKeyPath:@"documentView.webView.mainFrame.javaScriptContext"];
      
          //æ³¨å…¥JSéœ€è¦çš„â€œOCâ€å¯¹è±¡
          self.context[@"Bridge"] = [JSInject new];
      }
  

ä¸¾ä¸ªğŸŒ°

JS call Native

    //å¯¹å¤–è¦æš´éœ²çš„ native å¯¹è±¡ï¼ˆå…¶ä¸­æŒ‚è½½äº†ä¸€äº›å±æ€§å’Œæ–¹æ³•ï¼‰
    #import <Foundation/Foundation.h>
    #import <JavaScriptCore/JavaScriptCore.h>
    
    @protocol PersonInjectExport<JSExport>
    
    @property (nonatomic, strong) NSString *name;
    
    @property (nonatomic, strong) NSString *hobby;
    
    - (id)sayHi;
    
    @end
    
    
    @interface PersonInject : NSObject<PersonInjectExport>
    
    @property (nonatomic, strong) NSString *name;
    
    @property (nonatomic, strong) NSString *hobby;
    
    - (id)sayHi;
    
    @end
    
    
    // viewcontroller
    
    - (void)webViewDidFinishLoad:(UIWebView *)webView{
        self.jsContext = [webView valueForKeyPath:@"documentView.webView.mainFrame.javaScriptContext"];
        PersonInject *person = [[PersonInject alloc] init];
        person.name = @"æ­åŸå°åˆ˜";
        person.hobby = @"Codingã€Movieã€Musicã€Table tennisã€Fit";
        self.jsContext[@"lbp"] = person;
    }
    
    //JS
    <body>
    
      å—¨ã€‚å¤§å®¶å¥½æˆ‘æ˜¯
      <p id="name">***</p>
    
      <button id="show">é‚£ä½ åšä¸ªè‡ªæˆ‘ä»‹ç»å§</button>
    
    </body>
    <script>
      var u = navigator.userAgent
      var isAndroid = u.indexOf('Android') > -1 || u.indexOf('Linux') > -1
      var isiOS = u.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/) //iosç»ˆç«¯  
    
      document.getElementById("show").onclick = function () {
        if (isiOS) {
          document.getElementById("name").innerHTML = lbp.name;
          setTimeout(() => {
            alert(lbp.sayHi());
          }, 1000);
        }
      }
    </script>



Native call JS

    //Native
    - (void)callJS{
        JSValue *functionName = self.jsContext[@"sum"];
        NSInteger sum = [[functionName callWithArguments:@[@"2",@"18"]] toInt32];;
        
        UIAlertController *alertVC = [UIAlertController alertControllerWithTitle:@"æ¥è‡ªJS çš„è®¡ç®—" message:[NSString stringWithFormat:@"%zd",sum] preferredStyle:UIAlertControllerStyleAlert];
        UIAlertAction *okAction = [UIAlertAction actionWithTitle:@"OK" style:UIAlertActionStyleCancel handler:nil];
        [alertVC addAction:okAction];
        [self presentViewController:alertVC animated:YES completion:nil];
    }
    
    //JS
    function sum(a ,b){
    	return parseInt(a) + parseInt(b);
    }


