# å¯Œæ–‡æœ¬ç¼–è¾‘å™¨åŸç†æ¢ç´¢

> ç»å¸¸åœ¨åšä¼ä¸šç½‘ç«™çš„ç®¡ç†ç³»ç»Ÿçš„æ—¶å€™éœ€è¦ç”¨åˆ°å¯Œæ–‡æœ¬ç¼–è¾‘å™¨ï¼Œä¹‹å‰åŸºæœ¬ä¸Šéƒ½æ˜¯ç›´æ¥å» npm æˆ–è€… github ä¸Šé¢æœæ‰¾ä¸€äº›æ’åè€ƒå‰æˆ–è€… readme å†™çš„å¥½çš„åº“ï¼Œç›´æ¥æ‹¿æ¥ç”¨ã€‚ä¸‡å˜ä¸ç¦»å…¶å®—ï¼Œæ˜¯æ—¶å€™æ¢ç´¢ä¸‹æœ¬è´¨äº†ã€‚



## contenteditable

è¦æƒ³å®ç°å¯Œæ–‡æœ¬éœ€è¦å¼€å¯â€œç¼–è¾‘â€çš„èƒ½åŠ›ï¼Œç³»ç»Ÿæä¾›äº†ä¸€ä¸ª apiï¼š**contenteditable** å…è®¸æˆ‘ä»¬å¯¹å†…å®¹è¿›è¡Œç¼–è¾‘ã€‚ä¸‹é¢æ˜¯æ¥è‡ª [MDN](https://developer.mozilla.org/en-US/docs/Web/HTML/Global_attributes/contenteditable) çš„å®˜æ–¹è§£é‡Šã€‚

> The contenteditable global attribute is an enumerated attribute indicating if the element should be editable by the user. If so, the browser modifies its widget to allow editing.
> The attribute must take one of the following values:
> - true or the empty string, which indicates that the element must be editable;
> - false, which indicates that the element must not be editable.
> If this attribute is not set, its default value is inherited from its parent element.

contenteditable çš„å€¼è®¾ç½®ä¸º true æˆ–è€…ç©ºå­—ç¬¦ä¸²`""` å…è®¸å†…å®¹è¢«ç¼–è¾‘ï¼Œfalse åˆ™ä»£è¡¨ä¸å¯è¢«ç¼–è¾‘ã€‚
å®ƒä¸ä»…å¯ä»¥ä½œç”¨åœ¨ textareaã€divã€ç”šè‡³æ˜¯ç½‘é¡µæ‰€è§çš„éƒ½å¯ä»¥è¿›è¡Œç¼–è¾‘ã€‚æ‰€ä»¥åˆ©ç”¨è¿™ç‚¹å„¿ä½ å¯ä»¥åšä¸€äº›ğŸ˜ˆåäº‹æƒ… ï¼Œæ¯”å¦‚ä¿®æ”¹æ•™åŠ¡å¤„ç½‘é¡µä¸Šçš„æˆç»©å•å’Œç»©ç‚¹åˆ†æ•°ï¼Œä¿®æ”¹å¤©æ°”é¢„æŠ¥çš„æ¸©åº¦èµ°åŠ¿æƒ…å†µï¼Œåæ‰‹ä¿®æ”¹æŸä¸€å¤©çš„æ¸©åº¦ä¸º 66åº¦ã€‚



## document.execCommand

æƒ³æƒ³çœ‹ï¼Œä½ åœ¨è¾“å…¥æ¡†é‡Œé¢è¾“å…¥äº†ä¸€æ®µæ–‡å­—ï¼Œä½ ç‚¹å‡»ä¸Šé¢çš„åŠ ç²—æŒ‰é’®å¦‚ä½•å®ç°ï¼ŸMDN å‘Šè¯‰æˆ‘ä»¬æœ‰ä¸ª api å¯ä»¥æ»¡è¶³éœ€æ±‚ã€‚å½“å…ƒç´ è¿›å…¥ç¼–è¾‘æ¨¡å¼çš„æ—¶å€™ï¼Œdocument å¯¹è±¡æš´éœ²å‡ºä¸€ä¸ª **execCommand** æ–¹æ³•å»æ“çºµå½“å‰çš„å¯ç¼–è¾‘åŒºåŸŸ ã€‚çœ‹çœ‹ä¸‹æ–¹ [MDN](https://developer.mozilla.org/en-US/docs/Web/API/Document/execCommand) ç»™å‡ºçš„è§£é‡Šã€‚

> When an HTML document has been switched to designMode, its document object exposes an execCommand method to run commands that manipulate the current editable region, such as form inputs or contentEditable elements.
> document.execCommand(aCommandName, aShowDefaultUI, aValueArgument)
> A Boolean that is false if the command is unsupported or disabled.

aCommandNameï¼šå‘½ä»¤åç§°ã€‚æ¯”å¦‚åŠ ç²—ã€ä¸‹åˆ’çº¿ã€æ— åºåˆ—è¡¨ã€æ®µè½ã€H1ç­‰ç­‰
aShowDefaultUIï¼šå¸ƒå°”å€¼ã€‚æ˜¯å¦å±•ç¤ºé»˜è®¤çš„æ ·å¼ï¼Œä¸€èˆ¬ä¸º false
aValueArgumentï¼šä¸€äº›å‘½ä»¤æ‰€éœ€è¦çš„é¢å¤–å‚æ•°ï¼Œæ¯”å¦‚ insertImage æ’å…¥å›¾ç‰‡æ‰€éœ€è¦çš„å›¾ç‰‡ url

å®Œæ•´çš„å‘½ä»¤å’Œå„ä¸ªæµè§ˆå™¨çš„æ”¯æŒæƒ…å†µå¯ä»¥æŸ¥çœ‹ MDNã€‚



## Selection å’Œ Range å¯¹è±¡

åœ¨æ‰§è¡Œ document.execCommand çš„æ—¶å€™éœ€è¦çŸ¥é“å¯¹è°åœ¨ä»€ä¹ˆèŒƒå›´å†…æ‰§è¡Œå‘½ä»¤ã€‚è¿™é‡Œæœ‰ä¸€ä¸ªé€‰åŒºçš„æ¦‚å¿µï¼Œä¹Ÿå°±æ˜¯ Selectionï¼Œç”¨æ¥è¡¨ç¤ºç”¨æˆ·é€‰æ‹©çš„èŒƒå›´ã€‚ï¼ˆè¯´æ˜ï¼šç”¨æˆ·ä¸é€‰ä¸­ä»»ä½•å†…å®¹ï¼Œä¹Ÿå°±æ˜¯åªæœ‰ä¸€é—ªä¸€é—ªçš„å…‰æ ‡çš„æƒ…å†µä¹Ÿç®—æ˜¯ä¸€ç§ç‰¹æ®Šçš„é€‰ä¸­ï¼‰ã€‚

ä¸€ä¸ªé¡µé¢åŒ…å«å¤šä¸ªé€‰ä¸­åŒºåŸŸï¼ˆFirefoxï¼‰ æ”¯æŒã€‚æ‰€ä»¥ Selection å¯ä»¥çœ‹ä½œæ˜¯ Range å¯¹è±¡çš„é›†åˆã€‚é€šå¸¸æƒ…å†µä¸‹æˆ‘ä»¬ä¸€èˆ¬åªå­˜åœ¨ä¸€ä¸ªé€‰ä¸­çš„åŒºåŸŸï¼Œæ‰€ä»¥ `document.getSelection().getRangeAt(0)` å°±å¯ä»¥æ‹¿åˆ°å½“å‰é€‰åŒºçš„ä¿¡æ¯ã€‚

Range å¯¹è±¡è¯·çœ‹ä¸‹å›¾

![é€‰åŒºRangeå¯¹è±¡1](https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/2019-06-28-DocumentRangeObject1.png)

![é€‰åŒºRangeå¯¹è±¡2](https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/2019-06-28-DocumentRangeObject2.png)

ä¸Šé¢è¯´åˆ°**å…‰æ ‡**ä¹Ÿæ˜¯ä¸€ä¸ªç‰¹æ®Šçš„é€‰åŒºï¼Œå½“ endOffset å’Œ startOffset ç›¸ç­‰çš„æ—¶å€™ï¼Œcollapsed å±æ€§å°±ä¸º trueã€‚

é€šè¿‡ document.getSelection().getRangeAt(0) å°±å¯ä»¥è·å–åˆ°é€‰åŒºçš„ä¿¡æ¯ï¼Œé‚£ä¹ˆå¯ä»¥å°†å½“å‰é€‰åŒºä¿å­˜ä¸‹æ¥ï¼Œç­‰åˆ°éœ€è¦çš„æ—¶å€™å†æ‹¿å‡ºæ¥å¹¶å±•ç¤ºã€‚Selection å¯¹è±¡è¿˜æœ‰å‡ ä¸ªå¼€æ”¾çš„æ–¹æ³•ï¼ˆaddRangeã€collapseã€collapseToEndã€collapseToStartï¼‰å¯ä»¥æ“çºµå…‰æ ‡ï¼ˆæ¯”å¦‚æ’å…¥æ–‡å­—åå…‰æ ‡çš„ä½ç½®ï¼‰ã€‚



## ç†è®ºè”ç³»å®é™…ã€ä¸€åˆ‡ä»å®é™…å‡ºå‘

åŠ¨æ‰‹åšä¸€ä¸ªç®€æ˜“çš„å¯Œæ–‡æœ¬ç¼–è¾‘å™¨å§ã€‚ï¼ˆä¸æƒ³å†™ä¸€ä¸ª Vue æˆ–è€… React å·¥ç¨‹ï¼Œæ‹¿æœ€ç®€å•çš„ html æ’¸ä¸€ä¸ªå§ï¼‰

æ€è·¯ï¼š
- æ–°å»º html æ–‡ä»¶
- è®¾ç½®2ä¸ªå¤§çš„ divï¼Œä¸€ä¸ªå±•ç¤ºåŠŸèƒ½æŒ‰é’®ï¼Œä¸€ä¸ªå±•ç¤ºç¼–è¾‘åŒºåŸŸï¼ˆç¼–è¾‘åŒºåŸŸéœ€è¦è®¾ç½®å…è®¸å¯ç¼–è¾‘ï¼‰
- æ ·å¼å¸ƒå±€
- å„ä¸ªåŠŸèƒ½æŒ‰é’®æ·»åŠ ç‚¹å‡»äº‹ä»¶ç›‘å¬
- å› ä¸ºç‚¹å‡»å„ä¸ªæŒ‰é’®éƒ½æ˜¯æ‰§è¡Œ document.execCommandï¼Œå”¯ä¸€ä¸åŒçš„å°±æ˜¯å‘½ååç§°å’Œå‚æ•°ä¸ä¸€æ ·ï¼Œæ‰€ä»¥ç®€å•å°è£…å‡½æ•°
- è°ƒç”¨å°è£…çš„å‡½æ•°ï¼Œä¼ é€’å‚æ•°
  
ä¸‹é¢è´´å‡ºä»£ç 

```html
<html>
<head>
    <title>å¯Œæ–‡æœ¬</title>
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
    <style>
        .commandZone {
            margin: 20px;
            margin-bottom: 0px;
            background: burlywood;
        }
        .editor {
            border: 1px solid gray;
            margin: 0px 20px 20px 20px;
            height: 300px;
        }
        .btn {
            margin: 10px 20px;
            color: black;
            font-size: 20px;
            line-height: 20px;
            display: inline;
        }
    </style>
</head>
<body>
    <div class="commandZone">
        <button id="paragraphBtn" class="btn">æ®µè½</button>
        <select name="hstyle" id="hstyle">
            <option value="1">h1</option>
            <option value="2">h2</option>
            <option value="3">h3</option>
            <option value="4">h4</option>
            <option value="5">h5</option>
            <option value="h6">h6</option>
        </select>
        <button id="boldBtn" class="btn">åŠ ç²—</button>
        <button id="undoBtn" class="btn">åé€€</button>
        <button id="redoBtn" class="btn">å‰è¿›</button>
        <button id="insertHorizontalRuleBtn" class="btn">æ°´å¹³çº¿</button>
        <button id="insertUnorderedListBtn" class="btn">æ— åºåˆ—è¡¨</button>
        <button id="createLinkBtn" class="btn">æ’å…¥é“¾æ¥</button>
        <button id="insertImageBtn" class="btn">æ’å…¥å›¾ç‰‡</button>
    </div>
    <div class="editor" contenteditable="true"></div>
</body>
<script>
    var hStyle = '<h1>';
    document.getElementById('hstyle').onchange = function () {
        var optionSelectedIndex = document.getElementsByTagName('option');
        hStyle = optionSelectedIndex[document.getElementById('hstyle').selectedIndex].innerHTML;
        execEditorCommand('formatBlock', hStyle);
    }

    function execEditorCommand(name, args = null) {
        document.execCommand(name, false, args);
    }

    document.getElementById('boldBtn').onclick = function () {
        execEditorCommand('bold', null);
    }
    document.getElementById('insertHorizontalRuleBtn').onclick = function () {
        execEditorCommand('insertHorizontalRule', null);
    }
    document.getElementById('insertUnorderedListBtn').onclick = function () {
        execEditorCommand('insertUnorderedList', null);
    }
    document.getElementById('undoBtn').onclick = function () {
        execEditorCommand('undo', null);
    }
    document.getElementById('redoBtn').onclick = function () {
        execEditorCommand('redo', null);
    }
    document.getElementById('paragraphBtn').onclick = function () {
        execEditorCommand('formatBlock', '<p>');
    }
    document.getElementById('createLinkBtn').onclick = function () {
        let link = window.prompt('è¯·è¾“å…¥é“¾æ¥åœ°å€');
        execEditorCommand('createLink', link);
    }
    document.getElementById('insertImageBtn').onclick = function () {
        let image = window.prompt('è¯·è¾“å…¥å›¾ç‰‡åœ°å€');
        execEditorCommand('insertImage', image);
    }
</script>
</html>
```

![ç®€æ˜“å¯Œæ–‡æœ¬ç¼–è¾‘å™¨](https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/2019-06-28-RichTextEditor.png)



## æ³¨æ„ç‚¹

- æ‰§è¡Œçš„æ˜¯åŸç”Ÿçš„ document.execCommand æ–¹æ³•ï¼Œæµè§ˆå™¨è‡ªèº«ä¼šå¯¹ contenteditable è¿™ä¸ªå¯ç¼–è¾‘åŒºç»´æŠ¤ä¸€ä¸ª undo æ ˆå’Œä¸€ä¸ª redo æ ˆï¼Œæ‰€ä»¥æˆ‘ä»¬æ‰èƒ½æ‰§è¡Œå‰è¿›å’Œåé€€çš„æ“ä½œï¼Œå¦‚æœæˆ‘ä»¬æ”¹å†™äº†åŸç”Ÿæ–¹æ³•ï¼Œå°±ä¼šç ´ååŸæœ‰çš„æ ˆç»“æ„ï¼Œè¿™æ—¶å°±éœ€è¦è‡ªå·±å»ç»´æŠ¤ï¼Œä»£ä»·å¾ˆå¤§
- å¦‚æœæ˜¯ Vue style é‡Œé¢å¦‚æœåŠ ä¸Š scope çš„è¯ï¼Œé‡Œé¢çš„æ ·å¼å¯¹ç¼–è¾‘åŒºçš„å†…å®¹æ˜¯ä¸ç”Ÿæ•ˆçš„ï¼Œå› ä¸ºç¼–è¾‘åŒºé‡Œé¢æ˜¯åæ¥æ‰åˆ›å»ºçš„å…ƒç´ ï¼Œæ‰€ä»¥è¦ä¹ˆåˆ äº† scopeï¼Œè¦ä¹ˆç”¨ /deep/ è§£å†³ï¼ˆVue æ˜¯è¿™æ ·ï¼‰ã€‚React çš„ styled-components ä¹Ÿæœ‰ç±»ä¼¼é—®é¢˜ã€‚