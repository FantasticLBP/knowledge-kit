# App ä¸Šæ¶åŒ…é¢„æ£€

## ä¸€ã€ iOS ç«¯å¸¸è§è¢«æ‹’åŸå› æ±‡æ€»

1. App å†…åŒ…å«åˆ†å‘ä¸‹è½½åˆ†å‘åŠŸèƒ½ï¼ˆå¼•å¯¼ç”¨æˆ·ä¸‹è½½ App ç­‰åŠŸèƒ½ï¼‰
2. æä¾›çš„æµ‹è¯•è´¦å·æ— æ³•æŸ¥çœ‹å®é™…åŠŸèƒ½
3. é€šè¿‡æ¥å£è¿”å›å¸ƒå°”å€¼åˆ¤æ–­ App æ˜¯å¦å‡çº§ï¼Œä½†å®¡æ ¸æœŸé—´è¯¥æ¥å£ä¸è¯·æ±‚
4. å®¡æ ¸è´¦å·ï¼Œä»»ä½•æ—¶å€™åœ¨ä»»ä½• ip ç™»å½•çœ‹åˆ°çš„éƒ½æ˜¯å®¡æ ¸ç‰ˆ
5. æä¾›çš„ç™»é™†è´¦å·å’Œå¯†ç ä¸å¯¹ï¼Œç™»é™†ä¸ä¸Š
6. è¿è¥å¡«å†™çš„è¥é”€å…³é”®å­—æœ‰é—®é¢˜
7. å…ƒæ•°æ®é—®é¢˜ï¼ŒiPhoneX æˆªå›¾ä¸­ iPhone å£³å­æ˜¯ iPhone7 çš„ï¼Œåº”è¯¥æ˜¯ iPhoneX
8. è¯´æ˜éšç§æƒé™çš„ä½œç”¨
9. è¥é”€æ–‡å­—ï¼ŒæŸäº›èƒ½åŠ›éœ€è¦èµ„è´¨ã€‚æ­¤ç±»åŠŸèƒ½åœ¨å®¡æ ¸æœŸé—´éƒ½å…³é—­
10. ä¿®æ”¹éšç§æƒé™ç›¸å…³çš„æ–‡æ¡ˆï¼Œåšåˆ°è®©å®¡æ ¸äººå‘˜çœ‹å¾—æ‡‚ï¼Œåšåˆ°ã€Œä¿¡è¾¾é›…ã€
11. App æ— æ³•ç™»é™†è¿›å»ï¼Œå±äº bug çº§åˆ«
12. App æ²¡æœ‰é€‚é… ipad
13. Privacy - Data Collection and Storageï¼Œè¯´æ˜ App æ²¡æœ‰åšéšç§æƒé™çš„æ”¶é›†ã€‚
14. è®¿é—® h5 é¡µé¢å‡ºç°é—®é¢˜ã€‚ å±äº bug çº§åˆ«




## äºŒã€ App è¢«æ‹’åŸå› æ±‡æ€»

ä» Android å’Œ iOS 2ç«¯ App è¢«é©³å›çš„ä¸€äº›ä¿¡æ¯æ¥çœ‹ï¼Œé©³å›åŸå› ä¸€èˆ¬åˆ’åˆ†ä¸ºä¸‹é¢å‡ ç±»ï¼š

1. å®¡æ ¸æœŸé—´ï¼Œèµ„æºå’Œé…ç½®éƒ½åº”è¯¥è°ƒèŠ‚ä¸ºå®¡æ ¸æ¨¡å¼
2. App åŒ…å«æŸäº›å…³é”®å­—
3. å®¡æ ¸ç›¸å…³çš„å…ƒæ•°æ®é—®é¢˜ï¼ˆæˆªå›¾ä¸å®é™…å†…å®¹ä¸åŒ¹é…ã€æœºå‹å’Œæˆªå›¾ä¸åŒ¹é…ã€æä¾›ç»™å®¡æ ¸çš„è´¦å·å’Œå¯†ç ç™»é™†ä¸ä¸Šï¼‰
4. ä½¿ç”¨çš„éšç§æƒé™å¿…é¡»è¯´æ˜ï¼Œæ–‡æ¡ˆæè¿°å¿…é¡»æ¸…æ™°
5. App å­˜åœ¨ bug ï¼ˆè´¦å·æ— æ³•ç™»é™†ã€æ²¡æœ‰é€‚é… ipadã€è®¿é—® h5 æ‰“ä¸å¼€  ï¼‰
6. è¯±å¯¼ç”¨æˆ·æ‰“å¼€æŸ¥çœ‹æ›´å¤š App
7. Android åº”ç”¨æœªåŠ å›º
8. åº”ç”¨ç¼ºä¹ç›¸å…³çš„èµ„è´¨å’Œè¯ä¹¦




## ä¸‰ã€ æ–¹æ¡ˆ

å¸¸è§å®¡æ ¸å¤±è´¥çš„åŸå› å¾ˆå¤šï¼Œå¾ˆå¤§æ¯”é‡ä¸€ä¸ªå°±æ˜¯ä»£ç æˆ–è€…æ–‡æœ¬é‡Œé¢å­˜åœ¨ä¸€äº›æ•æ„Ÿè¯ï¼Œæ‰€ä»¥æœ¬æ–‡çš„ä¾§é‡ç‚¹åœ¨äºå…³é”®è¯æ‰«æã€‚åƒä¸Šæ¶è®¾ç½®çš„æˆªå›¾å’Œå½“å‰è®¾å¤‡ä¸åŒ¹é…ã€æä¾›çš„è´¦å·æ— æ³•ä½¿ç”¨åŠŸèƒ½ ğŸ˜‚ è¿™ç§æƒ…å†µæ‰“ä¸€é¡¿å°±å¥½äº†ï¼Œéä¸»æµè¡Œä¸ºä¸åœ¨æœ¬æ–‡èŒƒå›´å†…

### 3.1 è¯äº‘è°å»æ”¶é›†ï¼Ÿ

æ¯ä¸ªå…¬å¸ä¸€èˆ¬æ¥è¯´éƒ½ä¸æ­¢ä¸€æ¡ä¸šåŠ¡çº¿ï¼Œæ‰€ä»¥æ¯ä¸ªä¸šåŠ¡çº¿çš„ App æƒ…å†µå’Œå†…å®¹ä¹Ÿä¸ä¸€æ ·ï¼Œæ‰€ä»¥æ•æ„Ÿè¯ä¹Ÿæ˜¯åƒå·®ä¸‡åˆ«ã€‚æ•æ„Ÿè¯æ”¶é›†è¿™ä¸ªäº‹æƒ…ï¼Œåº”è¯¥ç”±ä¸šåŠ¡çº¿ä¸»è¦è´Ÿè´£ App çš„å¼€å‘è€…æ¥æ”¶é›†ï¼Œæ ¹æ®å¹³æ—¶çš„ä¸Šæ¶æƒ…å†µï¼Œè‹¹æœçš„é©³å›çš„é‚®ä»¶æ¥æ•´ç†ã€‚

### 3.2 æ–¹æ¡ˆè®¾è®¡

å…¬å¸è‡ªç ”å·¥å…· cliï¼ˆiOS SDKã€iOS Appã€Android SDKã€Android Appã€RNã€Nodeã€React ä¾èµ–åˆ†æã€æ„å»ºã€æ‰“åŒ…ã€æµ‹è¯•ã€çƒ­ä¿®å¤ã€åŸ‹ç‚¹ã€æ„å»ºï¼‰ï¼Œå„ä¸ªç«¯éƒ½æ˜¯é€šè¿‡ã€Œæ¨¡ç‰ˆã€æ¥æä¾›èƒ½åŠ›ã€‚åŒ…å«è‹¥å¹²å­é¡¹ç›®ï¼Œæ¯ä¸ªå­é¡¹ç›®å°±æ˜¯æ‰€è°“çš„ â€œ**æ¨¡ç‰ˆ**â€ï¼Œæ¯ä¸ªæ¨¡ç‰ˆå…¶å®å°±æ˜¯ä¸€ä¸ª Node å·¥ç¨‹ï¼Œä¸€ä¸ª npm æ¨¡å—ï¼Œä¸»è¦è´Ÿè´£ä»¥ä¸‹åŠŸèƒ½ï¼šç‰¹å®šé¡¹ç›®ç±»å‹çš„ç›®å½•ç»“æ„ã€è‡ªå®šä¹‰å‘½ä»¤ä¾›å¼€å‘ã€æ„å»ºç­‰ä½¿ç”¨ã€æ¨¡ç‰ˆæŒç»­æ›´æ–°åŠ patch ç­‰ã€‚

æ‰€ä»¥å¯ä»¥åœ¨æ‰“åŒ…æ„å»ºï¼ˆå„ä¸ªç«¯å°†é¡¹ç›®æäº¤åˆ°æ‰“åŒ…ç³»ç»Ÿï¼Œæ‰“åŒ…ç³»ç»Ÿæ ¹æ®é¡¹ç›®è¯­è¨€ã€å¹³å°è°ƒåº¦æ‰“åŒ…æœºï¼‰çš„æ—¶å€™ï¼Œæ‹¿åˆ°æºä»£ç è¿›è¡Œæ‰«æã€‚åŸºäºè¿™ä¸ªç°çŠ¶ï¼Œæ‰€ä»¥æ–¹æ¡ˆæ˜¯ã€Œæ‰«ææ˜¯åŸºäºæºä»£ç å‡ºå‘çš„æ‰«æçš„ã€ã€‚

æŒ‰ç…§ iOS ç«¯ `pod install` è¿™ä¸ªè¿‡ç¨‹ï¼Œcocoapods ä¸ºæˆ‘ä»¬é¢„ç•™äº†é’©å­ï¼š`PreInstallHook.rb`ã€`PostInstallHook.rb`ï¼Œå…è®¸æˆ‘ä»¬åœ¨ä¸åŒçš„é˜¶æ®µä¸ºå·¥ç¨‹åšä¸€äº›è‡ªå®šä¹‰çš„æ“ä½œï¼Œæ‰€ä»¥æˆ‘ä»¬çš„ iOS æ¨¡ç‰ˆè®¾è®¡ä¹Ÿå‚è€ƒäº†è¿™ä¸ªæ€æƒ³ï¼Œåœ¨æ‰“åŒ…æ„å»ºå‰ã€æ„å»ºä¸­ã€æ„å»ºåæä¾›äº†é’©å­ï¼š`prebuild`ã€`build`ã€`postbuild`ã€‚å®šä½å¥½äº†é—®é¢˜ï¼Œè¦åšçš„å°±æ˜¯åœ¨ prebuild é‡Œé¢è¿›è¡Œå…³é”®è¯æ‰«æçš„ç¼–ç å·¥ä½œã€‚

ç¡®å®šäº†ä»€ä¹ˆæ—¶å€™åšä»€ä¹ˆäº‹æƒ…ï¼Œæ¥ä¸‹æ¥å°±è¦è®¨è®ºæ€ä¹ˆåšæ‰åˆé€‚ã€‚

### 3.3 æŠ€æœ¯æ–¹æ¡ˆé€‰æ‹©

å­—ç¬¦ä¸²åŒ¹é…ç®—æ³• KMP æ˜¯ä¸€å¼€å§‹æƒ³åˆ°çš„å†…å®¹ï¼Œé’ˆå¯¹æŸä¸ª App è¿›è¡Œæ—¶æœºæµ‹è¯•ï¼Œå‘ç°50å¤šä¸ªæ•æ„Ÿè¯çš„æƒ…å†µä¸‹ï¼Œä»£ç æ‰«æè€—æ—¶60ç§’é’Ÿï¼Œè§‰å¾—éå¸¸ä¸ç†æƒ³ï¼Œçœ‹ KMP ç®—æ³•æ²¡æœ‰å•¥é—®é¢˜ï¼Œæ‰€ä»¥æ¢ä¸ªæ€è·¯èµ°ä¸‹å»ã€‚

å› ä¸ºæ¨¡ç‰ˆæœ¬è´¨ä¸Š Node é¡¹ç›®ï¼Œæ‰€ä»¥ Node ä¸‹çš„ **glob** æ¨¡å—æ­£å¥½æä¾›æ ¹æ®æ­£åˆ™åŒ¹é…åˆ°åˆé€‚çš„æ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥åŒ¹é…æ–‡ä»¶é‡Œé¢çš„å­—ç¬¦ä¸²ã€‚ç„¶åç»§ç»­åšå®éªŒï¼Œæ•°æ®å¦‚ä¸‹ï¼š9ä¸ªé“­æ„Ÿè¯è¯­ã€ä»£ç æ–‡ä»¶5967ä¸ªï¼Œè€—æ—¶3.5ç§’


### 3.4 å®Œæ•´æ–¹æ¡ˆ

1. ä¸šåŠ¡çº¿éœ€è¦è‡ªå®šä¹‰æ•æ„Ÿè¯äº‘ï¼ˆå› ä¸ºæ¯æ¡ä¸šåŠ¡çº¿çš„å…³é”®è¯äº‘éƒ½ä¸ä¸€æ ·ï¼‰
2. æ•æ„Ÿè¯éœ€è¦åˆ’åˆ†ç­‰çº§ï¼šerrorã€warningã€‚æ‰«æåˆ° error éœ€è¦é©¬ä¸Šåœæ­¢æ„å»ºï¼Œå¹¶æç¤ºã€Œå·²æ‰«æåˆ°ä½ çš„æºç ä¸­å­˜åœ¨æ•æ„Ÿè¯***ï¼Œå¯èƒ½å­˜åœ¨æäº¤å®¡æ ¸å¤±è´¥çš„å¯èƒ½ï¼Œè¯·ä¿®æ”¹åå†æ¬¡æ„å»ºã€ã€‚warning çš„æƒ…å†µä¸éœ€è¦é©¬ä¸Šåœæ­¢æ„å»ºï¼Œç­‰ä»»åŠ¡å…¨éƒ¨ç»“æŸåæ±‡æ€»ç»™å‡ºæç¤ºã€Œå·²æ‰«æåˆ°ä½ çš„æºç ä¸­å­˜åœ¨æ•æ„Ÿè¯***ã€***...ï¼Œå¯èƒ½å­˜åœ¨æäº¤å®¡æ ¸å¤±è´¥çš„å¯èƒ½ï¼Œè¯·å¼€å‘è€…è‡ªå·±ç¡®è®¤ã€
3. é“­æ„Ÿè¯äº‘çš„æ ¼å¼ `scaner.yml` æ–‡ä»¶ã€‚
  - error: æ•°ç»„çš„æ ¼å¼ã€‚åé¢å†™éœ€è¦æ‰«æçš„å…³é”®è¯ï¼Œä¸”ç­‰çº§ä¸º errorï¼Œè¡¨ç¤ºæ‰«æåˆ° error åˆ™é©¬ä¸Šåœæ­¢æ„å»º
  - warningï¼šæ•°ç»„çš„æ ¼å¼ã€‚åé¢å†™éœ€è¦æ‰«æçš„å…³é”®è¯ï¼Œä¸”ç­‰çº§ä¸º warningï¼Œæ‰«æç»“æœä¸å½±å“æ„å»ºï¼Œæœ€ç»ˆåªæ˜¯å±•ç¤ºå‡ºæ¥
  - searchPathï¼šå­—ç¬¦ä¸²æ ¼å¼ã€‚å¯ä»¥è®©ä¸šåŠ¡çº¿è‡ªå®šä¹‰éœ€è¦è¿›è¡Œæ‰«æçš„è·¯å¾„ã€‚
  - fileTypeï¼šæ•°ç»„æ ¼å¼ã€‚å¯ä»¥è®©ä¸šåŠ¡çº¿è‡ªå®šä¹‰éœ€è¦æ‰«æçš„æ–‡ä»¶ç±»å‹ã€‚é»˜è®¤ä¸º `sh|pch|json|xcconfig|mm|cpp|h|m`
  - warningkeywordsScanï¼šå¸ƒå°”å€¼ã€‚ä¸šåŠ¡çº¿å¯ä»¥è®¾ç½®æ˜¯å¦éœ€è¦æ‰«æ warning çº§åˆ«çš„å…³é”®è¯ã€‚
  - errorKeywordsScanï¼šå¸ƒå°”å€¼ã€‚ä¸šåŠ¡çº¿å¯ä»¥è®¾ç½®æ˜¯å¦éœ€è¦æ‰«æ error çº§åˆ«çš„å…³é”®è¯ã€‚
  
  ```yml
  error:
    - checkSwitch
  warning:
    - loan
    - online
    - ischeck
  searchPath:
    ../fixtures
  fileType:
    - h
    - m
    - cpp
    - mm
    - js
  warningkeywordsScan: true
  errorKeywordsScan: true
  ```

4. iOS ç«¯å­˜åœ¨ç§æœ‰ api çš„æƒ…å†µï¼ŒAndroid ç«¯ä¸å­˜åœ¨è¯¥é—®é¢˜
  ç§æœ‰ api 70111ä¸ªæ–‡ä»¶ï¼Œæ¯ä¸ªæ–‡ä»¶å‡è®¾10ä¸ªæ–¹æ³•ï¼Œåˆ™å…±70ä¸‡ä¸ª apiã€‚æ‰€ä»¥è®¡åˆ’æ‰¾å‡º top 100.å»æ‰«æåŒ¹é…ï¼Œæ”¯æŒä¸šåŠ¡çº¿æ˜¯å¦å¼€å¯çš„é€‰é¡¹

å…¶å®è¿™äº›é—®é¢˜éƒ½æ˜¯ä¸šç•Œæ ‡å‡†çš„åšæ³•ï¼Œè‚¯å®šéœ€è¦é¢„ç•™è¿™æ ·çš„èƒ½åŠ›ï¼Œæ‰€ä»¥è‡ªå®šä¹‰è§„åˆ™çš„æ ¼å¼å¯ä»¥æŸ¥çœ‹ä¸Šé¢ yml æ–‡ä»¶çš„å„ä¸ªå­—æ®µæ‰€ç¡®å®šã€‚æ˜ç¡®äº†åšä»€ä¹ˆäº‹ï¼Œä»¥åŠåšäº‹æƒ…çš„æ ‡å‡†ï¼Œé‚£å°±å¯ä»¥å¾ˆå¿«çš„å¼€å±•å¹¶è½åœ°å®ç°ã€‚

```javascript
'use strict'

const { Error, logger } = require('@company/BFF-utils')
const fs = require('fs-extra')
const glob = require('glob')
const YAML = require('yamljs')

module.exports = class PreBuildCommand {
  constructor(ctx) {
    this.ctx = ctx
    this.projectPath = ''
    this.fileNum = 0
    this.isExist = false
    this.errorFiles = []
    this.warningFiles = []
    this.keywordsObject = {}
    this.errorReg = null
    this.warningReg = null
    this.warningkeywordsScan = false
    this.errorKeywordsScan = false
    this.scanFileTypes = ''
  }

  async fetchCodeFiles(dirPath, fileType = 'sh|pch|json|xcconfig|mm|cpp|h|m') {
    return new Promise((resolve, reject) => {
      glob(`**/*.?(${fileType})`, { root: dirPath, cwd: dirPath, realpath: true }, (err, files) => {
        if (err) reject(err)
        resolve(files)
      })
    })
  }

  async scanConfigurationReader(keywordsPath) {
    return new Promise((resolve, reject) => {
      fs.readFile(keywordsPath, 'UTF-8', (err, data) => {
        if (!err) {
          let keywords = YAML.parse(data)
          resolve(keywords)
        } else {
          reject(err)
        }
      })
    })
  }

  async run() {
    const { argv } = this.ctx
    const buildParam = {
      scheme: argv.opts.scheme,
      cert: argv.opts.cert,
      env: argv.opts.env
    }

    // å¤„ç†åŒ…å…³é”®è¯æ‰«æï¼ˆæ•æ„Ÿè¯æ±‡ + ç§æœ‰ apiï¼‰
    this.keywordsObject = (await this.scanConfigurationReader(this.ctx.cwd + '/.scaner.yml')) || {}
    this.warningkeywordsScan = this.keywordsObject.warningkeywordsScan || false
    this.errorKeywordsScan = this.keywordsObject.errorKeywordsScan || false
    if (Array.isArray(this.keywordsObject.fileType)) {
      this.scanFileTypes = this.keywordsObject.fileType.join('|')
    }
    if (Array.isArray(this.keywordsObject.error)) {
      this.errorReg = this.keywordsObject.error.join('|')
    }
    if (Array.isArray(this.keywordsObject.warning)) {
      this.warningReg = this.keywordsObject.warning.join('|')
    }

    // ä»æŒ‡å®šç›®å½•ä¸‹è·å–æ‰€æœ‰æ–‡ä»¶
    this.projectPath = this.keywordsObject ? this.keywordsObject.searchPath : this.ctx.cwd
    const files = await this.fetchCodeFiles(this.projectPath, this.scanFileTypes)

    if (this.errorReg && this.errorKeywordsScan) {
      await Promise.all(
        files.map(async file => {
          try {
            const content = await fs.readFile(file, 'utf-8')
            const result = await content.match(new RegExp(`(${this.errorReg})`, 'g'))
            if (result) {
              if (result.length > 0) {
                this.isExist = true
                this.fileNum++
                this.errorFiles.push(
                  `ç¼–å·: ${this.fileNum}, æ‰€åœ¨æ–‡ä»¶: ${file},  å‡ºç°æ¬¡æ•°: ${result &&
                    (result.length || 0)}`
                )
              }
            }
          } catch (error) {
            throw error
          }
        })
      )
    }

    if (this.errorFiles.length > 0) {
      throw new Error(
        `ä»ä½ çš„é¡¹ç›®ä¸­æ‰«æåˆ°äº† error çº§åˆ«çš„æ•æ„Ÿè¯ï¼Œå»ºè®®ä½ ä¿®æ”¹æ–¹æ³•åç§°ã€å±æ€§åã€æ–¹æ³•æ³¨é‡Šã€æ–‡æ¡£æè¿°ã€‚\næ•æ„Ÿè¯æœ‰ ã€Œ${
          this.errorReg
        }ã€\nå­˜åœ¨é—®é¢˜çš„æ–‡ä»¶æœ‰ ${JSON.stringify(this.errorFiles, null, 2)}`
      )
    }

    // warning
    if (this.warningReg && !this.isExist && this.fileNum === 0 && this.warningkeywordsScan) {
      await Promise.all(
        files.map(async file => {
          try {
            const content = await fs.readFile(file, 'utf-8')
            const result = await content.match(new RegExp(`(${this.warningReg})`, 'g'))
            if (result) {
              if (result.length > 0) {
                this.isExist = true
                this.fileNum++
                this.warningFiles.push(
                  `ç¼–å·: ${this.fileNum}, æ‰€åœ¨æ–‡ä»¶: ${file},  å‡ºç°æ¬¡æ•°: ${result &&
                    (result.length || 0)}`
                )
              }
            }
          } catch (error) {
            throw error
          }
        })
      )

      if (this.warningFiles.length > 0) {
        logger.info(
          `ä»ä½ çš„é¡¹ç›®ä¸­æ‰«æåˆ°äº† warning çº§åˆ«çš„æ•æ„Ÿè¯ï¼Œå»ºè®®ä½ ä¿®æ”¹æ–¹æ³•åç§°ã€å±æ€§åã€æ–¹æ³•æ³¨é‡Šã€æ–‡æ¡£æè¿°ã€‚\næ•æ„Ÿè¯æœ‰ ã€Œ${
            this.warningReg
          }ã€ã€‚æœ‰é—®é¢˜çš„æ–‡ä»¶æœ‰${JSON.stringify(this.warningFiles, null, 2)}`
        )
      }
    }

    for (const key in buildParam) {
      if (!buildParam[key]) {
        throw new Error(`build: ${key} å‚æ•°ç¼ºå¤±`)
      }
    }
  }
}
```