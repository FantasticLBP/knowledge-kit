# iOS ç˜¦èº«ä¹‹é“



App çš„åŒ…å¤§å°åšä¼˜åŒ–çš„ç›®çš„å°±æ˜¯ä¸ºäº†èŠ‚çœç”¨æˆ·æµé‡ï¼Œæé«˜ç”¨æˆ·çš„ä¸‹è½½é€Ÿåº¦ï¼Œä¹Ÿæ˜¯ä¸ºäº†ç”¨æˆ·æ‰‹æœºèŠ‚çœæ›´å¤šçš„ç©ºé—´ã€‚å¦å¤– App Store å®˜æ–¹è§„å®š App å®‰è£…åŒ…å¦‚æœè¶…è¿‡ 150MBï¼Œé‚£ä¹ˆä¸å¯ä»¥ä½¿ OTAï¼ˆover-the-airï¼‰ç¯å¢ƒä¸‹è½½ï¼Œä¹Ÿå°±æ˜¯åªå¯ä»¥åœ¨ WiFi ç¯å¢ƒä¸‹è½½ï¼Œä¼ä¸šæˆ–è€…ç‹¬ç«‹å¼€å‘è€…ä¸‡ä¸‡ä¸æƒ³çœ‹åˆ°è¿™ä¸€ç‚¹ã€‚å…å¾—å¤±å»å¤§é‡çš„ç”¨æˆ·ã€‚

åŒæ—¶å¦‚æœä½ çš„ App éœ€è¦é€‚é… iOS7ã€iOS8 é‚£ä¹ˆå®˜æ–¹è§„å®šä¸»äºŒè¿›åˆ¶ text æ®µçš„å¤§å°ä¸èƒ½è¶…è¿‡ 60MBã€‚å¦‚æœä¸èƒ½æ»¡è¶³è¿™ä¸ªæ ‡å‡†ï¼Œåˆ™æ— æ³•ä¸Šæ¶ App Storeã€‚

å¦ä¸€ç§æƒ…å†µæ˜¯ App åŒ…ä½“ç§¯è¿‡å¤§ï¼Œå¯¹ç”¨æˆ·æ›´æ–°å‡çº§ç‡ä¹Ÿä¼šæœ‰å¾ˆå¤§å½±å“ã€‚

æ‰€ä»¥åº”ç”¨åŒ…çš„ç˜¦èº«è¿«åœ¨çœ‰ç«ã€‚



## 1.  App Thinning

App Thinning æ˜¯æŒ‡ iOS9 ä»¥åå¼•å…¥çš„ä¸€é¡¹ä¼˜åŒ–ï¼Œå®˜æ–¹æè¿°å¦‚ä¸‹
> The App Store and operating system optimize the installation of iOS, tvOS, and watchOS apps by tailoring app delivery to the capabilities of the userâ€™s particular device, with minimal footprint. This optimization, called app thinning, lets you create apps that use the most device features, occupy minimum disk space, and accommodate future updates that can be applied by Apple. Faster downloads and more space for other apps and content provides a better user experience.

Apple ä¼šå°½å¯èƒ½ï¼Œè‡ªåŠ¨é™ä½åˆ†å‘åˆ°å…·ä½“ç”¨æˆ·æ—¶ï¼Œæ‰€éœ€è¦ä¸‹è½½çš„ App å¤§å°ã€‚å…¶ä¸­åŒ…å«ä¸‰é¡¹ä¸»è¦åŠŸèƒ½ï¼šSlicingã€Bitcodeã€On-Demand Resourcesã€‚

App Thinning æ˜¯è‹¹æœå…¬å¸æ¨å‡ºçš„ä¸€é¡¹æ”¹å–„ App ä¸‹è½½è¿›ç¨‹çš„æ–°æŠ€æœ¯ï¼Œä¸»è¦ä¸ºäº†è§£å†³ç”¨æˆ·ä¸‹è½½ App è€—è´¹è¿‡é«˜æµé‡çš„é—®é¢˜ï¼ŒåŒæ—¶è¿˜å¯ä»¥èŠ‚çœç”¨æˆ·è®¾å¤‡å­˜å‚¨ç©ºé—´ã€‚


### 1.1 Slicing

![Slicing](https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/2018-11-15-AppSlicing.jpeg)

å½“å‘ App Store Connect ä¸Šä¼  .ipa åï¼ŒApp Store Connect æ„å»ºè¿‡ç¨‹ä¸­ï¼Œä¼šè‡ªåŠ¨åˆ†å‰²è¯¥ Appï¼Œåˆ›å»ºç‰¹å®šçš„å˜ä½“ï¼ˆvariantï¼‰ä»¥é€‚é…ä¸åŒè®¾å¤‡ã€‚ç„¶åç”¨æˆ·ä» App Store ä¸­ä¸‹è½½åˆ°çš„å®‰è£…åŒ…ï¼Œå³è¿™ä¸ªç‰¹å®šçš„å˜ä½“ï¼Œè¿™ä¸€è¿‡ç¨‹å«åš Slicingã€‚

> Slicing æ˜¯åˆ›å»ºã€åˆ†å‘ä¸åŒå˜ä½“ä»¥é€‚åº”ä¸åŒç›®æ ‡è®¾å¤‡çš„è¿‡ç¨‹

è€Œå˜ä½“ä¹‹é—´çš„å·®å¼‚ï¼Œåˆå…·ä½“ä½“ç°åœ¨æ¶æ„å’Œèµ„æºä¸Šã€‚æ¢å¥è¯è¯´ï¼ŒApp Slicing ä»…å‘è®¾å¤‡ä¼ é€ä¸ä¹‹ç›¸å…³çš„èµ„æºï¼ˆå–å†³äºå±å¹•åˆ†è¾¨ç‡ã€ç³»ç»Ÿæ¶æ„ç­‰ç­‰ï¼‰

å…¶ä¸­ï¼Œ2x å’Œ 3x çš„ç»†åˆ†ï¼Œè¦æ±‚å›¾ç‰‡åœ¨ **Assets** ä¸­ç®¡ç†ã€‚Bundle å†…çš„åˆ™ä¼šåŒæ—¶åŒ…å«ã€‚

![å˜ä½“](https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/2018-11-15-AppVariant.jpeg)


### 1.2 Bitcode

> Bitcode is an intermediate representation of a compiled program. Apps you upload to iTunes Connect that contain bitcode will be compiled and linked on the App Store. Including bitcode will allow Apple to re-optimize your app binary in the future without the need to submit a new version of your app to the App Store.

Bitcode æ˜¯ä¸€ç§ç¨‹åº`ä¸­é—´ç `ã€‚åŒ…å« Bitcode é…ç½®çš„ç¨‹åºå°†ä¼šåœ¨ App Store Connect ä¸Šè¢«é‡æ–°ç¼–è¯‘å’Œé“¾æ¥ï¼Œè¿›è€Œå¯¹å¯æ‰§è¡Œæ–‡ä»¶åšä¼˜åŒ–ã€‚è¿™éƒ¨åˆ†éƒ½æ˜¯åœ¨æœåŠ¡ç«¯è‡ªåŠ¨å®Œæˆçš„ã€‚æ‰€ä»¥å‡å¦‚ä»¥å Apple æ–°æ¨å‡ºäº†æ–°çš„ CPU æ¶æ„æˆ–è€…ä»¥å LLVM æ¨å‡ºäº†ä¸€ç³»åˆ—ä¼˜åŒ–ï¼Œæˆ‘ä»¬ä¸éœ€è¦é‡æ–°ä¸ºå…¶å‘å¸ƒæ–°çš„å®‰è£…åŒ…äº†ã€‚Apple Store ä¼šä¸ºæˆ‘ä»¬è‡ªåŠ¨å®Œæˆè¿™æ­¥ã€‚ç„¶åæä¾›å¯¹åº”çš„ variant ç»™å…·ä½“è®¾å¤‡

å¯¹äº iOS è€Œè¨€ï¼ŒBitcode æ˜¯å¯é€‰çš„ï¼ˆXcode7 ä»¥ååˆ›å»ºçš„æ–°é¡¹ç›®é»˜è®¤å¼€å¯ï¼‰ï¼ŒwatchOSã€tvOS åˆ™æ˜¯å¿…é¡»çš„ã€‚

å¼€å¯ä½ç½®ï¼šBuild Settings -> Enable Bitcode -> è®¾ç½®ä¸º YES


å¼€å¯ Bitcodeï¼Œæœ‰è¿™ä¹ˆ2ç‚¹éœ€è¦æ³¨æ„ï¼š
- å…¨éƒ¨éƒ½è¦æ”¯æŒã€‚æˆ‘ä»¬æ‰€ä¾èµ–çš„é™æ€åº“ã€åŠ¨æ€åº“ã€Cocoapods ç®¡ç†çš„ç¬¬ä¸‰æ–¹åº“ï¼Œéƒ½éœ€è¦å¼€å¯ Bitcodeã€‚å¦åˆ™ä¼šç¼–è¯‘å¤±è´¥

- å¥”æºƒå®šä½ã€‚å¼€å¯ Bitcode åæœ€ç»ˆç”Ÿæˆçš„å¯æ‰§è¡Œæ–‡ä»¶æ˜¯ Apple è‡ªåŠ¨ç”Ÿæˆçš„ï¼ŒåŒæ—¶ä¼šäº§ç”Ÿæ–°çš„ç¬¦å·è¡¨æ–‡ä»¶ï¼Œæ‰€ä»¥æˆ‘ä»¬æ— æ³•ä½¿ç”¨è‡ªå·±åŒ…ç”Ÿæˆçš„ dYSM ç¬¦å·åŒ–æ–‡ä»¶æ¥è¿›è¡Œç¬¦å·åŒ–ã€‚

> For Bitcode enabled builds that have been released to the iTunes store or submitted to TestFlight, Apple generates new dSYMs. Youâ€™ll need to download the regenerated dSYMs from Xcode and then upload them to Crashlytics so that we can symbolicate crashes.For Bitcode enabled apps, ensure that you have checked â€œInclude app symbols for your applicationâ€¦â€ so that we can provide the most accurate crash reports.

ä¸Šé¢æ˜¯ fabric ä¸­å…³äº Downloading Bitcode dYSMs çš„æè¿°ï¼š

åœ¨ä¸Šä¼ åˆ° App Store æ—¶éœ€å‹¾é€‰â€œInclud app symbols for your application...â€ã€‚å‹¾é€‰ä¹‹å Apple ä¼šè‡ªåŠ¨ç”Ÿæˆå¯¹åº”çš„ dYSMï¼Œç„¶åå¯ä»¥åœ¨ Xcode -> Window -> Organizer ä¸­ï¼Œæˆ–è€…åœ¨ Apple Store Connect ä¸­ä¸‹è½½å¯¹åº”çš„ dYSM æ¥è¿›è¡Œç¬¦å·åŒ–


![App Connect-dYSM](https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/2018-11-15-AppConnectYSM.jpeg)

![Xcode-dYSM](https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/2018-11-15-XcodedYSM.jpeg)


é‚£ä¹ˆ Bitcode ä¼šå¯¹ App Thining æœ‰ä»€ä¹ˆä½œç”¨ï¼Ÿ

åœ¨ New Features in Xcode7 ä¸­æœ‰è¿™ä¹ˆä¸€æ®µæè¿°ï¼š

> Bitcode. When you archive for submission to the App Store, Xcode will compile your app into an intermediate representation. The App Store will then compile the bitcode down into the 64 or 32 bit executables as necessary.

å³ï¼ŒApp Store ä¼šå†æŒ‰éœ€å°†è¿™ä¸ª bitcode ç¼–è¯‘è¿› 32/64 ä½çš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚
æ‰€ä»¥ç½‘ä¸Šé“ºå¤©ç›–åœ°åœ°è¯´ Bitcode å®Œæˆäº†å…·ä½“æ¶æ„çš„æ‹†åˆ†ï¼Œä»è€Œå®ç°ç˜¦åŒ…


### 1.3 on-Demand Resources 

on-Demand Resource å³ä¸€éƒ¨åˆ†å›¾ç‰‡å¯ä»¥è¢«æ”¾ç½®åœ¨è‹¹æœçš„æœåŠ¡å™¨ä¸Šï¼Œä¸éšç€ App çš„ä¸‹è½½è€Œä¸‹è½½ï¼Œç›´åˆ°ç”¨æˆ·çœŸæ­£è¿›å…¥åˆ°æŸä¸ªé¡µé¢æ—¶æ‰ä¸‹è½½è¿™äº›èµ„æºæ–‡ä»¶ã€‚

![on-DemandResources](https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/2018-11-15-on-DemandResources.png)

åº”ç”¨åœºæ™¯ï¼šç›¸æœºåº”ç”¨çš„è´´çº¸æˆ–è€…æ»¤é•œã€å…³å¡æ¸¸æˆç­‰

å¦‚éœ€æ”¯æŒ iOS9 ä»¥ä¸‹ç³»ç»Ÿï¼Œé‚£ä¹ˆæ— æ³•ä½¿ç”¨è¿™ä¸ªåŠŸèƒ½ï¼Œå¦åˆ™ä¸Šä¼ ä¼šå¤±è´¥



## 2 åŒ…ä½“ç§¯

2ä¸ªæ¦‚å¿µ

- .ipa (iOS Application Package)ï¼šiOS åº”ç”¨ç¨‹åºå½’æ¡£æ–‡ä»¶ï¼Œå³æäº¤åˆ° App Store Connect çš„æ–‡ä»¶

- .app ï¼ˆApplicationï¼‰ï¼šåº”ç”¨çš„å…·ä½“æè¿°ï¼Œå³å®‰è£…åˆ° iOS è®¾å¤‡ä¸Šçš„æ–‡ä»¶

å½“æˆ‘ä»¬æ‹¿åˆ° Archive åçš„ .ipaï¼Œä½¿ç”¨è§£å‹è½¯ä»¶æ‰“å¼€åï¼ŒPayload ç›®å½•ä¸‹å­˜æ”¾çš„å°±æ˜¯ .app æ–‡ä»¶ï¼ŒäºŒè€…å¤§å°ç›¸å½“

åŒ…ä½“ç§¯ï¼Œè¯„åˆ¤æ ‡å‡†æ˜¯ä»¥ App Store ä¸Šçœ‹åˆ°çš„ä¸ºå‡†ã€‚ä½†æ˜¯ä¸Šä¼ åˆ° App Store Connect å¤„ç†å®Œåï¼Œä¼šè‡ªåŠ¨å¸®æˆ‘ä»¬ç”Ÿæˆå…·ä½“è®¾å¤‡ä¸Šçœ‹åˆ°çš„å¤§å°ã€‚å¦‚ä¸‹ï¼š

![App Store åŒ…å¤§å°](https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/2018-11-15-AppVolume.jpeg)

è¿™å…¶ä¸­ï¼šåˆå¯ä»¥åˆ†ä¸º2ç±»ï¼š Universal å’Œå…·ä½“è®¾å¤‡
Universal æŒ‡é€šç”¨è®¾å¤‡ï¼Œå³æœªåº”ç”¨ App slicing ä¼˜åŒ–ï¼ŒåŒæ—¶åŒ…å«äº†æ‰€æœ‰æ¶æ„ã€èµ„æºã€‚æ‰€ä»¥åŒ…ä½“ç§¯ä¼šæ¯”è¾ƒå¤§

è§‚å¯Ÿ .ipa çš„å¤§å°å’Œ Universal å¯¹åº”çš„åŒ…å¤§å°ç›¸å½“ï¼Œç¨å¾®å°ä¸€ç‚¹ï¼Œå› ä¸º App Store å¯¹ .ipa åšäº†åŠ å¯†å¤„ç†


æœ‰æ—¶å€™ä¸‹è½½ App ä¼šæç¤ºâ€œæ­¤é¡¹ç›®å¤§äº 150MBï¼Œé™¤éæ­¤é¡¹ç›®æ”¯æŒå¢é‡ä¸‹è½½ï¼Œå¦åˆ™æ‚¨å¿…é¡»è¿æ¥è‡³ WiFi æ‰èƒ½ä¸‹è½½â€ã€‚150MB é’ˆå¯¹çš„æ˜¯ä¸‹è½½å¤§å°ã€‚


- ä¸‹è½½å¤§å°ï¼šé€šè¿‡ WiFi ä¸‹è½½çš„å‹ç¼© App å¤§å°
- å®‰è£…å¤§å°ï¼šæ­¤ App å°†åœ¨ç”¨æˆ·è®¾å¤‡ä¸Šå ç”¨ç£ç›˜ç©ºé—´çš„å¤§å°

æ‰€ä»¥æˆ‘ä»¬è¦ç˜¦åŒ…ï¼Œå…³é”®åœ¨äºå‡å° .app æ–‡ä»¶çš„å¤§å°ã€‚


### 2.1 Architectures

å¦‚æœä¸æ”¯æŒ32ä½ä»¥åŠ iOS8 ï¼Œå»æ‰ armv7 ï¼Œå¯æ‰§è¡Œæ–‡ä»¶ä»¥åŠåº“ä¼šå‡å°ï¼Œå³æœ¬åœ° .ipa ä¹Ÿä¼šå‡å°


### 2.2 Resources

èµ„æºçš„ä¼˜åŒ–ä¹Ÿå°±æ˜¯å¹³æ—¶çš„ç»†å¿ƒä¸å®¡æŸ¥ã€‚

å›¾ç‰‡ã€å†…ç½®ç´ æã€Bundleã€å¤šè¯­è¨€ã€Jsonã€å­—ä½“ã€è„šæœ¬ã€Plistã€éŸ³é¢‘

å›¾ç‰‡ï¼šAssets.car
Bundle: éæ”¾åœ¨ Asset Catlog ä¸­ç®¡ç†çš„å›¾ç‰‡èµ„æºã€‚åŒ…æ‹¬ Bundleï¼Œæ•£è½çš„ pngã€jpg ç­‰

ç˜¦åŒ…å…·ä½“çš„æ–¹å¼ï¼š

- æ— ç”¨èµ„æºçš„åˆ é™¤
- é‡å¤æ–‡ä»¶çš„åˆ é™¤
- å¤§æ–‡ä»¶å‹ç¼©
- å›¾ç‰‡ç®¡ç†æ–¹å¼è§„èŒƒ
- on-Demand Resourceï¼ˆæ¸¸æˆçš„ã€å‰ç½®å…³å¡ä¾èµ–ã€æ»¤é•œApp ç­‰çš„ä¾èµ–èµ„æºï¼Œå»ºè®®ç”¨è¿™ç§æ–¹å¼åŠ¨æ€ä¸‹è½½å›¾ç‰‡èµ„æºï¼‰


#### 2.2.1 æ— ç”¨æ–‡ä»¶çš„åˆ é™¤


æ— ç”¨æ–‡ä»¶ä¸»è¦åŒ…å«ï¼šæ— ç”¨å›¾ç‰‡ã€æ— ç”¨éå›¾ç‰‡éƒ¨åˆ†ã€‚

éå›¾ç‰‡éƒ¨åˆ†ï¼šèµ„æºè¾ƒå°‘ï¼Œä½¿ç”¨æ–¹å¼å›ºå®šã€‚æ¯”å¦‚éŸ³é¢‘ã€å­—ä½“ã€‚éœ€è¦æ‰‹åŠ¨æ’æŸ¥
å›¾ç‰‡éƒ¨åˆ†ï¼šä¸»è¦ä½¿ç”¨ä¸€ä¸ªå¼€æºçš„ Mac App [LSUnusedResources](https://github.com/tinymind/LSUnusedResources) è¿›è¡Œå†—ä½™å›¾ç‰‡çš„æ’æŸ¥ã€‚


åˆ é™¤æ— ç”¨çš„å›¾ç‰‡è¿‡ç¨‹ï¼Œå¯ä»¥æ¦‚æ‹¬ä¸ºä¸‹é¢6æ­¥ï¼š
1. é€šè¿‡ find å‘½ä»¤è·å– App å®‰è£…åŒ…ä¸­çš„æ‰€æœ‰èµ„æºæ–‡ä»¶
2. è®¾ç½®ç”¨åˆ°çš„èµ„æºç±»å‹ã€‚æ¯”å¦‚ gifã€jpgã€jpegã€pngã€webp
3. ä½¿ç”¨æ­£åˆ™åŒ¹é…å‡ºåœ¨æºç ä¸­ä½¿ç”¨åˆ°çš„èµ„æºåï¼Œæ¯”å¦‚ pattern = @"@"(.+?)""
4. ä½¿ç”¨ find å‘½ä»¤æ‰¾åˆ°ç¯‡æ‰€æœ‰èµ„æºæ–‡ä»¶ï¼Œå†å»æºç ä¸­æ‰¾åˆ°ä½¿ç”¨åˆ°çš„èµ„æºæ–‡ä»¶ï¼Œ2ä¸ªé›†åˆçš„å·®é›†å°±æ˜¯æ— ç”¨èµ„æºäº†ã€‚
5. ç¡®è®¤æ— ç”¨èµ„æºåå¯ä»¥ä½¿ç”¨ NSFileManager è¿›è¡Œæ–‡ä»¶çš„åˆ é™¤ã€‚
  

å¦‚æœä¸æƒ³é‡æ–°å†™ä¸€ä¸ªå·¥å…·ï¼Œé‚£ä¹ˆå¯ä»¥ç›´æ¥ä½¿ç”¨å¼€æºçš„å·¥å…· LSUnusedResources

ä½†æ˜¯å­˜åœ¨ä¸€ç‚¹é—®é¢˜ã€‚ä¼šå‡ºç°è¯¯æŠ¥ï¼Œå› ä¸ºä¸åŒçš„é¡¹ç›®ï¼Œå›¾ç‰‡ä½¿ç”¨æ–¹å¼ä¸ä¸€æ ·ã€‚

```
- (BOOL)containsSimilarResourceName:(NSString *)name {
    NSString *regexStr = @"([-_]?\\d+)";
    NSRegularExpression* regexExpression = [NSRegularExpression regularExpressionWithPattern:regexStr options:NSRegularExpressionCaseInsensitive error:nil];
    NSArray* matchs = [regexExpression matchesInString:name options:0 range:NSMakeRange(0, name.length)];
    //...
}
```
æºç ä¸­çš„æ­£åˆ™è¡¨è¾¾å¼å¤„ç†çš„æƒ…å†µå¹¶ä¸æ˜¯å¾ˆå‡†ç¡®ã€‚å¯ä»¥æ ¹æ®è‡ªå·±çš„æƒ…å†µä¿®æ”¹æ­£åˆ™å³å¯


#### 2.2.2 å›¾ç‰‡èµ„æºçš„å‹ç¼©

åˆ é™¤äº†æ— ç”¨çš„èµ„æºï¼Œé‚£ä¹ˆå¯¹äºèµ„æºè¿™å—è¿˜æ˜¯æœ‰æ“ä½œçš„ç©ºé—´çš„ï¼Œæ¯”å¦‚å›¾ç‰‡èµ„æºçš„å‹ç¼©ã€‚ç›®å‰å‹ç¼©æ¯”è¾ƒå¥½çš„æ–¹æ¡ˆå°±æ˜¯ WebPï¼Œå®ƒæ˜¯è°·æ­Œå…¬å¸çš„ä¸€ä¸ªå¼€æºé¡¹ç›®ã€‚

WebP çš„ä¼˜åŠ¿ï¼š
- å‹ç¼©ç‡é«˜ã€‚æ”¯æŒæœ‰æŸå’Œæ— æŸ2ç§æ–¹å¼ï¼Œæ¯”å¦‚å°† Gif å›¾å¯ä»¥è½¬æ¢ä¸º Animated WebPï¼Œæœ‰æŸæ¨¡å¼ä¸‹å¯ä»¥å‡å° 64%ï¼Œæ— æŸæ¨¡å¼ä¸‹å¯ä»¥å‡å° 19%
- WebP æ”¯æŒ Alpha é€æ˜å’Œ 24-bit é¢œè‰²æ•°ï¼Œä¸ä¼šåƒ PNG8 é‚£æ ·å› ä¸ºè‰²å½©ä¸å¤Ÿå‡ºç°æ¯›è¾¹ã€‚

Google å…¬å¸åœ¨å¼€æº WebP çš„åŒæ—¶ï¼Œè¿˜æä¾›äº†ä¸€ä¸ªå›¾ç‰‡å‹ç¼©å·¥å…· [cwebp](https://developers.google.com/speed/webp/docs/precompiled)ã€‚
å‹ç¼©å®Œä¹‹åä½¿ç”¨ WebP æ ¼å¼çš„å›¾ç‰‡è¿˜éœ€ä½¿ç”¨ libwebp è¿›è¡Œè§£æï¼Œå‚è€ƒè¿™ä¸ª[Demo](https://github.com/carsonmcdonald/WebP-iOS-example)ã€‚

ç¼ºç‚¹ï¼šWebP åœ¨ CUP æ¶ˆè€—å’Œè§£ç æ—¶é—´ä¸Šä¼šæ¯” PNG é«˜2å€ï¼Œæ‰€ä»¥æˆ‘ä»¬åšé€‰æ‹©çš„æ—¶å€™éœ€è¦å–èˆã€‚


#### 2.2.3 é‡å¤æ–‡ä»¶åˆ é™¤

é‡å¤æ–‡ä»¶ï¼Œå³ä¸¤ä¸ªå†…å®¹å®Œå…¨ä¸€è‡´çš„æ–‡ä»¶ã€‚ä½†æ˜¯æ–‡ä»¶å‘½åä¸ä¸€æ ·ã€‚

å€ŸåŠ© [fdupes](https://github.com/adrianlopezroche/fdupes) è¿™ä¸ªå¼€æºå·¥å…·ï¼Œæ ¡éªŒå„èµ„æºçš„ MD5ã€‚

fdupes æ˜¯ Linux ä¸‹çš„ä¸€ä¸ªå·¥å…·ï¼Œå®ƒç”± Adrian Lopez ç”¨ C è¯­è¨€ç¼–å†™å¹¶åŸºäº MIT è®¸å¯è¯å‘è¡Œï¼Œè¯¥åº”ç”¨ç¨‹åºå¯ä»¥åœ¨æŒ‡å®šçš„ç›®å½•åŠå­ç›®å½•ä¸­æŸ¥æ‰¾é‡å¤çš„æ–‡ä»¶ã€‚fdupes é€šè¿‡å¯¹æ¯”æ–‡ä»¶çš„ MD5 ç­¾åï¼Œä»¥åŠé€å­—èŠ‚æ¯”è¾ƒæ–‡ä»¶æ¥è¯†åˆ«é‡å¤å†…å®¹ï¼Œfdupes æœ‰å„ç§é€‰é¡¹ï¼Œå¯ä»¥å®ç°å¯¹æ–‡ä»¶çš„åˆ—å‡ºã€åˆ é™¤ã€æ›¿æ¢ä¸ºæ–‡ä»¶å‰¯æœ¬çš„ç¡¬é“¾æ¥ç­‰æ“ä½œã€‚

æ–‡ä»¶å¯¹æ¯”ä»ä»¥ä¸‹é¡ºåºå¼€å§‹ï¼š
å¤§å°å¯¹æ¯” > éƒ¨åˆ† MD5 ç­¾åå¯¹æ¯” > å®Œæ•´ MD5 ç­¾åå¯¹æ¯” > é€å­—èŠ‚å¯¹æ¯”

æ‰§è¡Œç»“æŸåä¼šåœ¨å‘½ä»¤è¡Œå±•ç¤ºå‡ºæ¥ï¼Œæ‰€ä»¥éœ€è¦æˆ‘ä»¬äººå·¥å°†è¿™äº›æ–‡ä»¶ç¡®è®¤å¯¹æ¯”ååˆ é™¤æ‰ã€‚


#### 2.2.4 å¤§æ–‡ä»¶å‹ç¼©

å›¾ç‰‡æœ¬èº«çš„å‹ç¼©ï¼Œå»ºè®®ä½¿ç”¨ ImageOptimã€‚å®ƒæ•´åˆäº† Winã€Linux ä¸Šè¯¸å¤šè‘—åå›¾ç‰‡å¤„ç†å·¥å…·çš„ç‰¹è‰²ï¼Œæ¯”å¦‚ PNGOUTã€AdvPNGã€Pngcrushã€OptiPNGã€JpegOptimã€Gifsicle ç­‰ã€‚
Bundle å†…çš„å›¾ç‰‡èµ„æºå¿…é¡»å‹ç¼©ï¼Œå› ä¸º Xcode å¹¶ä¸ä¼šå¯¹å…¶è¿›è¡Œå‹ç¼©ã€‚æ‰€ä»¥åšå¥½å°†å›¾ç‰‡éƒ½ç”¨ Assets ç®¡ç†ã€‚

Xcode æä¾›ç»™æˆ‘ä»¬2ä¸ªç¼–è¯‘é€‰é¡¹æ¥å¸®åŠ©å‹ç¼©å›¾åƒï¼š

- Compress PNG Files: æ‰“åŒ…çš„æ—¶å€™è‡ªåŠ¨å¯¹å›¾ç‰‡è¿›è¡Œæ— æŸå‹ç¼©ã€‚ä½¿ç”¨çš„å·¥å…·ä¸º pngcrushï¼Œå‹ç¼©æ¯”è›®é«˜ã€‚
- Remove Text Medadata From PNG Filesï¼šç§»é™¤ PNG èµ„æºçš„æ–‡æœ¬å­—ç¬¦ï¼Œæ¯”å¦‚å›¾åƒåç§°ã€ä½œè€…ã€ç‰ˆæƒã€åˆ›ä½œæ—¶é—´ã€æ³¨é‡Šç­‰ä¿¡æ¯


#### 2.2.5 å›¾ç‰‡ç®¡ç†æ–¹å¼è§„èŒƒ


##### 2.2.5.1 ä¸»å·¥ç¨‹ä¸­çš„å›¾ç‰‡ç®¡ç†

å·¥ç¨‹ä¸­æ‰€æœ‰ä½¿ç”¨çš„ Asset Catlog ç®¡ç†çš„å›¾ç‰‡ï¼ˆåœ¨ .xcassets æ–‡ä»¶å¤¹ä¸‹ï¼‰æœ€ç»ˆéƒ½ä¼šè¾“å‡ºåˆ° Asset.car å†…ã€‚ä¸åœ¨ Asset.car å†…çš„éƒ½å½’ä¸º Bundle ç®¡ç†ã€‚

- xcassets é‡Œé¢çš„å›¾ç‰‡ã€‚åªèƒ½é€šè¿‡ imageNamed åŠ è½½ã€‚ Bundle é‡Œé¢çš„å›¾ç‰‡è¿˜å¯ä»¥é€šè¿‡ imageWithContentsOfFile ç­‰æ–¹å¼
- xcassets é‡Œé¢çš„ @2xã€@3x ä¼šæ ¹æ®å…·ä½“è®¾å¤‡åˆ†å‘ï¼Œä¸ä¼šåŒæ—¶åŒ…å«ã€‚Bundle éƒ½åŒ…å«ï¼ˆä¸è¿›è¡Œ App Slicingï¼‰
- xcassets å†…å¯ä»¥å¯¹å›¾ç‰‡è¿›è¡Œ Slicingï¼Œå³è£å‰ªå’Œæ‹‰ä¼¸ã€Bundle ä¸æ”¯æŒ
- Bundle å†…æ”¯æŒå¤šè¯­è¨€ï¼ŒImages.xcassets ä¸æ”¯æŒ

> ä½¿ç”¨ imageNamed åˆ›å»ºçš„ UIImage ä¼šè¢«ç«‹å³åŠ å…¥åˆ° NSCache ä¸­ï¼ˆè§£ç åçš„ Image Bufferï¼‰ï¼Œç›´åˆ°æ”¶åˆ°å†…å­˜è­¦å‘Šçš„æ—¶å€™æ‰ä¼šé‡Šæ”¾ä¸ä½¿ç”¨çš„ UIImageã€‚è€Œ imageWithContentsOfFile ä¼šæ¯æ¬¡é‡æ–°ç”³è¯·å†…å­˜ï¼Œç›¸åŒå›¾ç‰‡ä¸ä¼šç¼“å­˜ï¼Œæ‰€ä»¥ xcassets å†…çš„å›¾ç‰‡ï¼ŒåŠ è½½åä¼šäº§ç”Ÿç¼“å­˜

ç»¼ä¸Šï¼šå¸¸ç”¨çš„ã€è¾ƒå°çš„å›¾å»ºè®®å­˜æ”¾åœ¨ Images.xcassets å†…ç®¡ç†ã€‚å¤§å›¾æ”¾åœ¨ Bundle å†…ç®¡ç†ã€‚

è¿™é‡Œè®²ä¸€ä¸ªæ’æ›²äº†ï¼Œæ›¾ç»å¾ˆå¤šæ–‡ç« éƒ½åœ¨è°ˆä¸€ä¸ªç»“è®ºï¼Œé‚£å°±æ˜¯ã€Œå›¾ç‰‡æ”¾åœ¨ Images.xcassets é‡Œé¢æ›´åŠ å¿«é€Ÿä¸”èŠ‚çœç©ºé—´ï¼Œç›´æ¥æ”¾åœ¨ bundle é‡Œé¢ä¼šæ¯”è¾ƒæ…¢ã€ã€‚æˆ‘åšè¿‡å®éªŒï¼Œå®éªŒç¯å¢ƒå’Œç»“è®ºå¦‚ä¸‹ã€‚ä½¿ç”¨ Instruments æµ‹é‡è€—æ—¶ã€‚

<details>
<summary>ç‚¹å‡»å±•å¼€</summary>

```Objective-C
//å®éªŒ1
NSMutableArray *images = [NSMutableArray array];
for (NSInteger index = 0; index < 10; index++) {
    UIImage *image = [UIImage imageNamed:@"icon-iOS"];
    [images addObject:image];
}
self.imageView.image = images.lastObject;
//å®éªŒ2
NSMutableArray *images = [NSMutableArray array];
for (NSInteger index = 0; index < 10; index++) {
    NSString *imagePath = [[NSBundle mainBundle] pathForResource:@"iOS" ofType:@"png"];
    [UIImage imageNamed:@"icon-iOS"];
    UIImage *image = [UIImage imageWithContentsOfFile:imagePath];
    [images addObject:image];
}
self.imageView.image = images.lastObject;
```
</details>

Timeprofile-imageNamedFromAssets
![Timeprofile-imageNamedFromAssets](https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/2019-05-07-Timeprofile-imageNamedFromAssets.png)

TimeProfile-imageWithContentsOfFile
![TimeProfile-imageWithContentsOfFile](https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/2019-05-07-TimeProfile-imageWithContentsOfFile.png)

Timeprofile-UIImageNamedFromFolder
![Timeprofile-UIImageNamedFromFolder](https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/2019-05-07-Timeprofile-UIImageNamedFromFolder.png)


Images.xcassets ï¼š
- å›¾ç‰‡å¤§å°è¦ç²¾ç¡®ï¼Œä¸è¦å‡ºç°å›¾ç‰‡å¤ªå¤§çš„æƒ…å†µ
- ä¸è¦å­˜æ”¾å¤§å›¾ï¼Œä¸ç„¶ä¼šäº§ç”Ÿç¼“å­˜
- ä¸è¦å­˜ jpg å›¾ç‰‡ï¼Œæ‰“åŒ…ä¼šå˜å¤§
- å›¾ç‰‡ä¸éœ€è¦é¢å¤–å‹ç¼©ï¼ˆæœ‰äººåšè¿‡å®éªŒï¼Œå¯¹æ”¾å…¥ assets é‡Œé¢çš„å›¾ç‰‡è¿›è¡Œå‹ç¼©åæ‰“åŒ…å‘ç°åŒ…ä½“ç§¯åè€Œå¢å¤§ï¼Œæ€€ç–‘æ˜¯ Xcode çš„ç¼–è¯‘é€‰é¡¹ Compress PNG Files è‡ªåŠ¨å¯¹å›¾ç‰‡è¿›è¡Œå‹ç¼©ï¼Œ2ç§å‹ç¼©èµ·äº†å†²çªåè€Œå¢å¤§ï¼‰


##### 2.2.5.2 å„ä¸ª pod åº“ä¸­çš„å›¾ç‰‡ç®¡ç†

CocoPods ä¸­ä¸¤ç§èµ„æºå¼•ç”¨æ–¹å¼ä»‹ç»ä¸‹ï¼š
- resource_bundles
    > We strongly recommend library developers to adopt resource bundles as there can be name collisions using the resources attribute.
    å…è®¸å®šä¹‰å½“å‰çš„ pod åº“çš„æœ€è¿œåŒ…çš„åç§°å’Œæ–‡ä»¶ã€‚ç”¨ hash å½¢å¼å£°æ˜ï¼Œkey æ˜¯ bundle çš„åç§°ï¼Œvalue æ˜¯éœ€è¦åŒ…å«æ–‡ä»¶çš„é€šé… patterns
    CocoPods å®˜æ–¹å¼ºçƒˆæ¨èè¯¥æ–¹æ³•å¼•ç”¨èµ„æºï¼Œå› ä¸º key-value å¯ä»¥é¿å…ç›¸åŒèµ„æºçš„åç§°å†²çª
- resources
    > We strongly recommend library developers to adopt resource bundles as there can be name collisions using the resources attribute. Moreover, resources specified with this attribute are copied directly to the client target and therefore they are not optimised by Xcode.
    ä½¿ç”¨è¯¥æ–¹æ³•å¼•ç”¨èµ„æºï¼Œè¢«æŒ‡å®šçš„èµ„æºä¼šè¢«æ‹·è´è¿› target å·¥ç¨‹çš„ main bundle ä¸­ã€‚



è¯´è¯´é¡¹ç›®ä¸­çš„æƒ…å†µå§ï¼šåœ¨å·¥ç¨‹ä¸­ä¹‹å‰æ˜¯é€šè¿‡ resource_bundles å¼•ç”¨èµ„æºçš„ã€‚èµ„æºæ˜¯æ”¾åœ¨ Resources ç›®å½•ä¸‹çš„å›¾ç‰‡å¼•ç”¨ã€‚æŸ¥è¯¢èµ„æ–™åè¯´ã€Œå¦‚æœå›¾ç‰‡èµ„æºæ”¾åˆ° .xcasset é‡Œé¢ Xcode ä¼šå¸®æˆ‘ä»¬è‡ªåŠ¨ä¼˜åŒ–ã€å¯ä»¥ä½¿ç”¨ Slicing ç­‰ï¼ˆè¿™é‡Œä¸ä»…ä»…æŒ‡çš„æ˜¯ resource_bundle ä¸‹çš„ xcassetsã€ã€‚æ‰€ä»¥åŠ¨æ‰‹å°†å„ä¸ª Pod åº“é‡Œé¢çš„å›¾ç‰‡å…¨éƒ½é€šè¿‡ Assets Catalog çš„æ–¹å¼è¿›è¡Œå¤„ç†ã€‚

![Podç»„ä»¶åº“å›¾ç‰‡å¤„ç†å‰åå¯¹æ¯”](https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/2019-05-08-Cocopod-Assets.png)

æ­¥éª¤ï¼š
- åœ¨å„ä¸ª Pod ç»„ä»¶åº“é‡Œé¢çš„ Resources ç›®å½•ä¸‹æ–°å»º Asset Catalog æ–‡ä»¶ï¼Œå‘½åä¸º Images.xcassets
- å°† Resources é‡Œé¢é›¶æ•£çš„å›¾ç‰‡èµ„æºæ‹–è¿› Images.xcassets é‡Œé¢
- ä¿®æ”¹æ¯ä¸ªç»„ä»¶åº“çš„ podspec æ–‡ä»¶
    <details>

    <summary>ç‚¹å‡»å±•å¼€</summary>

    ```
    s.resource_bundles = {
        'XQ_UI' => ['XQ_UI/Assets/*.xcassets']
    }
    </details>
    ```
- ä¸»å·¥ç¨‹æ‰§è¡Œ pod install 

è¯è¯´ `resources` å’Œ `resource_bundles` éƒ½å¯ä»¥ä½¿ç”¨ Asset Catalogï¼Œé‚£ä¹ˆæœ‰ä½•åŒºåˆ«ï¼Ÿ
- resources åªä¼šå°†èµ„æºæ–‡ä»¶ copy åˆ° target å·¥ç¨‹ï¼Œæœ€åå’Œ target å·¥ç¨‹çš„å›¾ç‰‡èµ„æºä»¥åŠåŒæ ·ä½¿ç”¨è¯¥æ–¹å¼çš„ Pod åº“çš„å›¾ç‰‡èµ„æºå…±åŒæ‰“åŒ…åˆ°ä¸€ä¸ª `Assets.car` ä¸­ã€‚å› æ­¤å›¾ç‰‡èµ„æºä¼šæœ‰æ··ä¹±çš„å¯èƒ½ã€‚
- resource_bundles ä¼šç”Ÿæˆä¸€ä¸ªä½ åœ¨ `podspec` ä¸­æŒ‡å®šåç§°çš„ bundleï¼Œä¸”åœ¨ bundle ä¸­ä¹Ÿä¼šç”Ÿæˆä¸€ä¸ª Assets.carã€‚æ‰€ä»¥å›¾ç‰‡æ˜¯è‚¯å®šä¸ä¼šæ··ä¹±çš„ï¼Œä½†æ˜¯å›¾ç‰‡çš„è®¿é—®æ–¹å¼éœ€è¦æ³¨æ„ã€‚


è§£å†³æ–¹æ³•ï¼šä¸ºæ¯ä¸ª pod æ–°å»ºä¸€ä¸ªå›¾ç‰‡çš„åˆ†ç±»ï¼Œæ¯”å¦‚ UIImage+XQUIModuleã€‚ç„¶åè®¿é—®å›¾ç‰‡çš„æ—¶å€™é€šè¿‡ `[UIImage xquiModuleImageNamed:@"pull"]` è®¿é—®ã€‚

<details>
<summary>ç‚¹å‡»å±•å¼€</summary>

```Objective-C
#import "UIImage+XQUIModule.h"
#import <SDGBase/UIImage+Bundle.h>

@implementation UIImage (XQUIModule)

+ (nonnull UIImage *)xquiModuleImageNamed:(nonnull NSString *)name
{
    return [UIImage imageNamed:name inBundleName:@"XQ_UI"];
}
@end

//UIImage+Bundle.m
#import "UIImage+Bundle.h"

@implementation UIImage (Bundle)

+ (nullable UIImage *)imageNamed:(NSString *)name inBundleName:(nullable NSString *)bundleName {
    NSBundle *bundle = [NSBundle bundleWithURL:[[NSBundle mainBundle] URLForResource:bundleName withExtension:@"bundle"]];
    return  [UIImage imageNamed:name inBundle:bundle compatibleWithTraitCollection:nil];
}
@end
```
</details>



#### 2.2.6 çŸ¢é‡å›¾çš„ä½¿ç”¨

äº‹å®ä¸Šï¼Œå¯¹äº App é‡Œé¢çš„å•è‰²å›¾æ ‡ï¼Œæ¯”å¦‚å·¦ä¸Šè§’çš„è¿”å›æŒ‰é’®ã€åº•éƒ¨çš„ tabBarç­‰ï¼Œåªè¦æ˜¯å•è‰²çš„çº¯è‰²å›¾æ ‡éƒ½æ˜¯å¯ä»¥ä½¿ç”¨çŸ¢é‡å›¾ä»£æ›¿çš„ï¼Œæ¯”å¦‚ PDFã€ttf å­—ä½“å›¾æ ‡ç­‰ã€‚è¿™æ ·å°±ä¸éœ€è¦æ·»åŠ  @2xã€@3x å›¾æ ‡ï¼ŒèŠ‚çœäº†ç©ºé—´ã€‚

iOS ä¸­å¦‚ä½•ä½¿ç”¨ ttf çŸ¢é‡å›¾ï¼Œå¯ä»¥æŸ¥çœ‹è¿™ä¸ª [Repo](https://github.com/FantasticLBP/IconFont_Demo)



## 3. Executable file

### 3.1 ç¼–è¯‘é€‰é¡¹ä¼˜åŒ–

#### 3.1.1 Generate Debug Symbols

> Enables or disables generation of debug symbos. When debug symbols are enabled, the level of detail can be controller by the build 'Level of Debug Symbols' Setting.

è°ƒè¯•ç¬¦å·æ˜¯åœ¨ç¼–è¯‘æ—¶å½¢æˆçš„ã€‚å½“ Generate Debug Symbols é€‰é¡¹ä¸º YES çš„æ—¶ï¼Œæ¯ä¸ªæºæ–‡ä»¶åœ¨ç¼–è¯‘æˆ .o æ–‡ä»¶æ—¶ï¼Œç¼–è¯‘å‚æ•°å¤šäº† -g å’Œ -gmodules ä¸¤é¡¹ã€‚æ‰“åŒ…ä¼šç”Ÿæˆ symbols æ–‡ä»¶ã€‚è®¾ç½®ä¸º NO åˆ™ ipa ä¸­ä¸ä¼šç”Ÿæˆ symbol æ–‡ä»¶ï¼Œå¯ä»¥å‡å°‘ ipa å¤§å°ã€‚ä½†ä¼šå½±å“åˆ°å´©æºƒçš„å®šä½ã€‚ä¿æŒé»˜è®¤çš„å¼€å¯ï¼Œä¸åšä¿®æ”¹ã€‚

#### 3.1.2 Asset Catalog Compiler

optimization é€‰é¡¹è®¾ç½®ä¸º space å¯ä»¥å‡å°‘åŒ…å¤§å°
é»˜è®¤é€‰é¡¹ï¼Œä¸åšä¿®æ”¹ã€‚

#### 3.1.3 Dead Code Stripping

> For statically linked executables, dead-code stripping is the process of removing unreferenced code from the executable file. If the code is unreferenced, it must not be used and therefore is not needed in the executable file. Removing dead code reduces the size of your executable and can help reduce paging.


åˆ é™¤é™æ€é“¾æ¥çš„å¯æ‰§è¡Œæ–‡ä»¶ä¸­æœªå¼•ç”¨çš„ä»£ç 

Debug è®¾ç½®ä¸º NOï¼Œ Release è®¾ç½®ä¸º YES å¯å‡å°‘å¯æ‰§è¡Œæ–‡ä»¶å¤§å°ã€‚

Xcode é»˜è®¤ä¼šå¼€å¯æ­¤é€‰é¡¹ï¼ŒC/C++/Swift ç­‰é™æ€è¯­è¨€ç¼–è¯‘å™¨ä¼šåœ¨ link çš„æ—¶å€™ç§»é™¤æœªä½¿ç”¨çš„ä»£ç ï¼Œä½†æ˜¯å¯¹äº Objective-C ç­‰åŠ¨æ€è¯­è¨€æ˜¯æ— æ•ˆçš„ã€‚å› ä¸º Objective-C æ˜¯å»ºç«‹åœ¨è¿è¡Œæ—¶ä¸Šé¢çš„ï¼Œåº•å±‚æš´éœ²ç»™ç¼–è¯‘å™¨çš„éƒ½æ˜¯ Runtime æºç ç¼–è¯‘ç»“æœï¼Œæ‰€æœ‰çš„éƒ¨åˆ†åº”è¯¥éƒ½æ˜¯ä¼šè¢«åˆ¤åˆ«ä¸ºæœ‰æ•ˆä»£ç ã€‚

é»˜è®¤é€‰é¡¹ï¼Œä¸åšä¿®æ”¹ã€‚

#### 3.1.4 Apple Clang - Code Generation

Optimization Level ç¼–è¯‘å‚æ•°å†³å®šäº†ç¨‹åºåœ¨ç¼–è¯‘è¿‡ç¨‹ä¸­çš„ä¸¤ä¸ªæŒ‡æ ‡ï¼šç¼–è¯‘é€Ÿåº¦å’Œå†…å­˜çš„å ç”¨ï¼Œä¹Ÿå†³å®šäº†ç¼–è¯‘ä¹‹åå¯æ‰§è¡Œç»“æœçš„ä¸¤ä¸ªæŒ‡æ ‡ï¼šé€Ÿåº¦å’Œæ–‡ä»¶å¤§å°ã€‚
Build Settings -> code Generation -> Optimization Level
é»˜è®¤æƒ…å†µä¸‹ï¼ŒDebug è®¾å®šä¸º None[-O0] ï¼ŒRelease è®¾å®šä¸º Fastest,Smallest[-Os]ã€‚

- None[-O0]ã€‚ Debug é»˜è®¤çº§åˆ«ã€‚ä¸è¿›è¡Œä»»ä½•ä¼˜åŒ–ï¼Œç›´æ¥å°†æºä»£ç ç¼–è¯‘åˆ°æ‰§è¡Œæ–‡ä»¶ä¸­ï¼Œç»“æœä¸è¿›è¡Œä»»ä½•é‡æ’ï¼Œç¼–è¯‘æ—¶æ¯”è¾ƒé•¿ã€‚ä¸»è¦ç”¨äºè°ƒè¯•ç¨‹åºï¼Œå¯ä»¥è¿›è¡Œè®¾ç½®æ–­ç‚¹ã€æ”¹å˜å˜é‡ ã€è®¡ç®—è¡¨è¾¾å¼ç­‰è°ƒè¯•å·¥ä½œã€‚

- Fast[-O,O1]ã€‚æœ€å¸¸ç”¨çš„ä¼˜åŒ–çº§åˆ«ï¼Œä¸è€ƒè™‘é€Ÿåº¦å’Œæ–‡ä»¶å¤§å°æƒè¡¡é—®é¢˜ã€‚ä¸-O0çº§åˆ«ç›¸æ¯”ï¼Œå®ƒç”Ÿæˆçš„æ–‡ä»¶æ›´å°ï¼Œå¯æ‰§è¡Œçš„é€Ÿåº¦æ›´å¿«ï¼Œç¼–è¯‘æ—¶é—´æ›´å°‘ã€‚

- Faster[-O2]ã€‚åœ¨-O1çº§åˆ«åŸºç¡€ä¸Šå†è¿›è¡Œä¼˜åŒ–ï¼Œå¢åŠ æŒ‡ä»¤è°ƒåº¦çš„ä¼˜åŒ–ã€‚ä¸-O1çº§åˆ«ç›¸ï¼Œå®ƒç”Ÿæˆçš„æ–‡ä»¶å¤§å°æ²¡æœ‰å˜å¤§ï¼Œç¼–è¯‘æ—¶é—´å˜é•¿äº†ï¼Œç¼–è¯‘æœŸé—´å ç”¨çš„å†…å­˜æ›´å¤šäº†ï¼Œä½†ç¨‹åºçš„è¿è¡Œé€Ÿåº¦æœ‰æ‰€æé«˜ã€‚

- Fastest[-O3]ã€‚åœ¨-O2å’Œ-O1çº§åˆ«ä¸Šè¿›è¡Œä¼˜åŒ–ï¼Œè¯¥çº§åˆ«å¯èƒ½ä¼šæé«˜ç¨‹åºçš„è¿è¡Œé€Ÿåº¦ï¼Œä½†æ˜¯ä¹Ÿä¼šå¢åŠ æ–‡ä»¶çš„å¤§å°ã€‚

- Fastest Smallest[-Os]ã€‚Release é»˜è®¤çº§åˆ«ã€‚è¿™ç§çº§åˆ«ç”¨äºåœ¨æœ‰é™çš„å†…å­˜å’Œç£ç›˜ç©ºé—´ä¸‹ç”Ÿæˆå°½å¯èƒ½å°çš„æ–‡ä»¶ã€‚ç”±äºä½¿ç”¨äº†å¾ˆå¥½çš„ç¼“å­˜æŠ€æœ¯ï¼Œå®ƒåœ¨æŸäº›æƒ…å†µä¸‹ä¹Ÿä¼šæœ‰å¾ˆå¿«çš„è¿è¡Œé€Ÿåº¦ã€‚

- Fastest, Aggressive Optimization[-Ofast]ã€‚ å®ƒæ˜¯ä¸€ç§æ›´ä¸ºæ¿€è¿›çš„ç¼–è¯‘å‚æ•°, å®ƒä»¥ç‚¹æµ®ç‚¹æ•°çš„ç²¾åº¦ä¸ºä»£ä»·ã€‚

é»˜è®¤é€‰é¡¹ï¼Œä¸åšä¿®æ”¹ã€‚


#### 3.1.5 Swift Compiler - Code Generation

Xcode 9.3 ç‰ˆæœ¬ä¹‹å Swift ç¼–è¯‘å™¨æä¾›äº†æ–°çš„ Optimization Level é€‰é¡¹æ¥å¸®åŠ©å‡å°‘ Swift å¯æ‰§è¡Œæ–‡ä»¶çš„å¤§å°ï¼š

- No optimization[-Onone]ï¼šä¸è¿›è¡Œä¼˜åŒ–ï¼Œèƒ½ä¿è¯è¾ƒå¿«çš„ç¼–è¯‘é€Ÿåº¦ã€‚
- Optimize for Speed[-O]ï¼šç¼–è¯‘å™¨å°†ä¼šå¯¹ä»£ç çš„æ‰§è¡Œæ•ˆç‡è¿›è¡Œä¼˜åŒ–ï¼Œä¸€å®šç¨‹åº¦ä¸Šä¼šå¢åŠ åŒ…å¤§å°ã€‚
- Optimize for Size[-Osize]ï¼šç¼–è¯‘å™¨ä¼šå°½å¯èƒ½å‡å°‘åŒ…çš„å¤§å°å¹¶ä¸”æœ€å°é™åº¦å½±å“ä»£ç çš„æ‰§è¡Œæ•ˆç‡ã€‚

> We have seen that using -Osize reduces code size from 5% to even 30% for some projects. But what about performance? This completely depends on the project. For most applications the performance hit with -Osize will be negligible, i.e. below 5%. But for performance sensitive code -O might still be the better choice.

å®˜æ–¹æåˆ°ï¼Œ-Osize æ ¹æ®é¡¹ç›®ä¸åŒï¼Œå¤§è‡´å¯ä»¥ä¼˜åŒ–æ‰ 5% - 30% çš„ä»£ç ç©ºé—´å ç”¨ã€‚ ç›¸æ¯” -0 æ¥è¯´ï¼Œä¼šæŸå¤±å¤§æ¦‚ 5% çš„è¿è¡Œæ—¶æ€§èƒ½ã€‚ å¦‚æœä½ çš„é¡¹ç›®å¯¹è¿è¡Œé€Ÿåº¦ä¸æ˜¯ç‰¹åˆ«æ•æ„Ÿï¼Œå¹¶ä¸”å¯ä»¥æ¥å—è½»å¾®çš„æ€§èƒ½æŸå¤±ï¼Œé‚£ä¹ˆ -Osize æ˜¯é¦–é€‰ã€‚

é™¤äº† -O å’Œ -Osizeï¼Œ è¿˜æœ‰å¦å¤–ä¸€ä¸ªæ¦‚å¿µä¹Ÿå€¼å¾—è¯´ä¸€ä¸‹ã€‚ å°±æ˜¯ Single File å’Œ Whole Module ã€‚ åœ¨ä¹‹å‰çš„ XCode ç‰ˆæœ¬ï¼Œè¿™ä¸¤ä¸ªé€‰é¡¹å’Œ -O æ˜¯è¿åœ¨ä¸€èµ·è®¾ç½®çš„ï¼ŒXcode 9.3 ä¸­ï¼Œå°†ä»–ä»¬åˆ†ç¦»å‡ºæ¥ï¼Œå¯ä»¥ç‹¬ç«‹è®¾ç½®ï¼š


Single File å’Œ Whole Module è¿™ä¸¤ä¸ªæ¨¡å¼åˆ†åˆ«å¯¹åº”ç¼–è¯‘å™¨ä»¥ä»€ä¹ˆæ–¹å¼å¤„ç†ä¼˜åŒ–æ“ä½œã€‚

- Single Fileï¼šé€ä¸ªæ–‡ä»¶è¿›è¡Œä¼˜åŒ–ï¼Œå®ƒçš„å¥½å¤„æ˜¯å¯¹äºå¢é‡ç¼–è¯‘çš„é¡¹ç›®æ¥è¯´ï¼Œå®ƒå¯ä»¥å‡å°‘ç¼–è¯‘æ—¶é—´ï¼Œå¯¹æ²¡æœ‰æ›´æ”¹çš„æºæ–‡ä»¶ï¼Œä¸ç”¨æ¯æ¬¡éƒ½é‡æ–°ç¼–è¯‘ã€‚å¹¶ä¸”å¯ä»¥å……åˆ†åˆ©ç”¨å¤šæ ¸ CPUï¼Œå¹¶è¡Œä¼˜åŒ–å¤šä¸ªæ–‡ä»¶ï¼Œæé«˜ç¼–è¯‘é€Ÿåº¦ã€‚ä½†å®ƒçš„ç¼ºç‚¹å°±æ˜¯å¯¹äºä¸€äº›éœ€è¦è·¨æ–‡ä»¶çš„ä¼˜åŒ–æ“ä½œï¼Œå®ƒæ²¡åŠæ³•å¤„ç†ã€‚å¦‚æœæŸä¸ªæ–‡ä»¶è¢«å¤šæ¬¡å¼•ç”¨ï¼Œé‚£ä¹ˆå¯¹è¿™äº›å¼•ç”¨æ–¹æ–‡ä»¶è¿›è¡Œä¼˜åŒ–çš„æ—¶å€™ï¼Œä¼šåå¤çš„é‡æ–°å¤„ç†è¿™ä¸ªè¢«å¼•ç”¨çš„æ–‡ä»¶ï¼Œå¦‚æœä½ é¡¹ç›®ä¸­ç±»ä¼¼çš„äº¤å‰å¼•ç”¨æ¯”è¾ƒå¤šï¼Œå°±ä¼šå½±å“æ€§èƒ½ã€‚

- Whole Moduleï¼š å°†é¡¹ç›®æ‰€æœ‰çš„æ–‡ä»¶çœ‹åšä¸€ä¸ªæ•´ä½“ï¼Œä¸ä¼šäº§ç”Ÿ Single File æ¨¡å¼å¯¹åŒä¸€ä¸ªæ–‡ä»¶åå¤å¤„ç†çš„é—®é¢˜ï¼Œå¹¶ä¸”å¯ä»¥è¿›è¡Œæœ€å¤§é™åº¦çš„ä¼˜åŒ–ï¼ŒåŒ…æ‹¬è·¨æ–‡ä»¶çš„ä¼˜åŒ–æ“ä½œã€‚ç¼ºç‚¹æ˜¯ï¼Œä¸èƒ½å……åˆ†åˆ©ç”¨å¤šæ ¸å¤„ç†å™¨çš„æ€§èƒ½ï¼Œå¹¶ä¸”å¯¹äºå¢é‡ç¼–è¯‘ï¼Œæ¯æ¬¡ä¹Ÿéƒ½éœ€è¦é‡æ–°ç¼–è¯‘æ•´ä¸ªé¡¹ç›®ã€‚

å¦‚æœæ²¡æœ‰ç‰¹æ®Šæƒ…å†µï¼Œä½¿ç”¨é»˜è®¤çš„ Whole Module ä¼˜åŒ–å³å¯ã€‚ å®ƒä¼šç‰ºç‰²éƒ¨åˆ†ç¼–è¯‘æ€§èƒ½ï¼Œä½†çš„ä¼˜åŒ–ç»“æœæ˜¯æœ€å¥½çš„ã€‚

æ•…ï¼Œåœ¨ Relese æ¨¡å¼ä¸‹ -Osize å’Œ Whole Module åŒæ—¶å¼€å¯æ•ˆæœä¼šæœ€å¥½ï¼


#### 3.1.6 Strip Symbol Information

1ã€Deployment Postprocessing
2ã€Strip Linked Product
3ã€Strip Debug Symbols During Copy
4ã€Symbols hidden by default

è®¾ç½®ä¸º YES å¯ä»¥å»æ‰ä¸å¿…è¦çš„ç¬¦å·ä¿¡æ¯ï¼Œå¯ä»¥å‡å°‘å¯æ‰§è¡Œæ–‡ä»¶å¤§å°ã€‚ä½†å»é™¤äº†ç¬¦å·ä¿¡æ¯ä¹‹åæˆ‘ä»¬å°±åªèƒ½ä½¿ç”¨ dSYM æ¥è¿›è¡Œç¬¦å·åŒ–äº†ï¼Œæ‰€ä»¥éœ€è¦å°† Debug Information Format ä¿®æ”¹ä¸º DWARF with dSYM fileã€‚

Symbols Hidden by Default ä¼šæŠŠæ‰€æœ‰ç¬¦å·éƒ½å®šä¹‰æˆâ€private externâ€ï¼Œè¯¦ç»†ä¿¡æ¯è§å®˜æ–¹æ–‡æ¡£ã€‚

æ•…ï¼ŒRelease è®¾ç½®ä¸º YESï¼ŒDebug è®¾ç½®ä¸º NOã€‚


#### 3.1.7 Exceptions

åœ¨ iOSå¾®ä¿¡å®‰è£…åŒ…ç˜¦èº« ä¸€æ–‡ä¸­ï¼Œæœ‰æåˆ°ï¼š

> å»æ‰å¼‚å¸¸æ”¯æŒï¼ŒEnable C++ Exceptionså’ŒEnable Objective-C Exceptionsè®¾ä¸ºNOï¼Œå¹¶ä¸”Other C Flagsæ·»åŠ -fno-exceptionsï¼Œå¯æ‰§è¡Œæ–‡ä»¶å‡å°‘äº†27Mï¼Œå…¶ä¸­__gcc_except_tabæ®µå‡å°‘äº†17.3Mï¼Œ__textå‡å°‘äº†9.7Mï¼Œæ•ˆæœç‰¹åˆ«æ˜æ˜¾ã€‚å¯ä»¥å¯¹æŸäº›æ–‡ä»¶å•ç‹¬æ”¯æŒå¼‚å¸¸ï¼Œç¼–è¯‘é€‰é¡¹åŠ ä¸Š-fexceptionså³å¯ã€‚ä½†æœ‰ä¸ªé—®é¢˜ï¼Œå‡å¦‚ABCä¸‰ä¸ªæ–‡ä»¶ï¼ŒACæ–‡ä»¶æ”¯æŒäº†å¼‚å¸¸ï¼ŒBä¸æ”¯æŒï¼Œå¦‚æœCæŠ›äº†å¼‚å¸¸ï¼Œåœ¨æ¨¡æ‹Ÿå™¨ä¸‹Aè¿˜æ˜¯èƒ½æ•è·å¼‚å¸¸ä¸è‡³äºCrashï¼Œä½†çœŸæœºä¸‹æ•è·ä¸äº†ï¼ˆæœ‰çŸ¥é“åŸå› å¯ä»¥åœ¨ä¸‹é¢ç•™è¨€ï¼šï¼‰ã€‚å»æ‰å¼‚å¸¸åï¼ŒAppstore åç»­å‡ ä¸ªç‰ˆæœ¬ Crash ç‡æ²¡æœ‰æ˜æ˜¾ä¸Šå‡ã€‚

ä¸ªäººè®¤ä¸ºå…³é”®è·¯å¾„æ”¯æŒå¼‚å¸¸å¤„ç†å°±å¥½ï¼Œåƒå¯åŠ¨æ—¶NSCoderè¯»å–settingé…ç½®æ–‡ä»¶å¾—è¦æ”¯æŒæ•è·å¼‚å¸¸ï¼Œç­‰ç­‰

çœ‹è¿™ä¸ªä¼˜åŒ–æ•ˆæœï¼Œæ„Ÿè§‰å‘ç°äº†æ–°å¤§é™†ã€‚å…³é—­åéªŒè¯.. æ¯«æ— æ„ŸçŸ¥ï¼ŒåŸºæœ¬æ²¡ä»€ä¹ˆå˜åŒ–ã€‚

å¯èƒ½å’Œé¡¹ç›®ä¸­ç”¨åˆ°æ¯”è¾ƒå°‘æœ‰å…³ç³»ã€‚æ•…ä¿æŒå¼€å¯çŠ¶æ€ã€‚


#### 3.1.8 Link-Time Optimization

Link-Time Optimization æ˜¯ LLVM ç¼–è¯‘å™¨çš„ä¸€ä¸ªç‰¹æ€§ï¼Œç”¨äºåœ¨ link ä¸­é—´ä»£ç æ—¶ï¼Œå¯¹å…¨å±€ä»£ç è¿›è¡Œä¼˜åŒ–ã€‚è¿™ä¸ªä¼˜åŒ–æ˜¯è‡ªåŠ¨å®Œæˆçš„ï¼Œå› æ­¤ä¸éœ€è¦ä¿®æ”¹ç°æœ‰çš„ä»£ç ï¼›è¿™ä¸ªä¼˜åŒ–ä¹Ÿæ˜¯é«˜æ•ˆçš„ï¼Œå› ä¸ºå¯ä»¥åœ¨å…¨å±€è§†è§’ä¸‹ä¼˜åŒ–ä»£ç ã€‚

è‹¹æœåœ¨ WWDC 2016 ä¸­ï¼Œæ˜ç¡®æå‡ºäº†è¿™ä¸ªä¼˜åŒ–çš„æ¦‚å¿µï¼ŒWhatâ€™s New in LLVMã€‚å¹¶ä¸”è¯´åœ¨è‹¹æœå†…éƒ¨å·²ç»å¹¿æ³›åœ°ä½¿ç”¨è¿™ä¸ªä¼˜åŒ–æ–¹æ³•è¿›è¡Œç¼–è¯‘ã€‚

å®ƒçš„ä¼˜åŒ–ä¸»è¦ä½“ç°åœ¨å¦‚ä¸‹å‡ ä¸ªæ–¹é¢ï¼š

1. å¤šä½™ä»£ç å»é™¤ï¼ˆDead code eliminationï¼‰ï¼šå¦‚æœä¸€æ®µä»£ç åˆ†å¸ƒåœ¨å¤šä¸ªæ–‡ä»¶ä¸­ï¼Œä½†æ˜¯ä»æ¥æ²¡æœ‰è¢«ä½¿ç”¨ï¼Œæ™®é€šçš„ -O3 ä¼˜åŒ–æ–¹æ³•ä¸èƒ½å‘ç°è·¨ä¸­é—´ä»£ç æ–‡ä»¶çš„å¤šä½™ä»£ç ï¼Œå› æ­¤æ˜¯ä¸€ä¸ªâ€œå±€éƒ¨ä¼˜åŒ–â€ã€‚ä½†æ˜¯Link-Time Optimization æŠ€æœ¯å¯ä»¥åœ¨ link æ—¶å‘ç°è·¨ä¸­é—´ä»£ç æ–‡ä»¶çš„å¤šä½™ä»£ç ã€‚

2. è·¨è¿‡ç¨‹ä¼˜åŒ–ï¼ˆInterprocedural analysis and optimizationï¼‰ï¼šè¿™æ˜¯ä¸€ä¸ªç›¸å¯¹å¹¿æ³›çš„æ¦‚å¿µã€‚ä¸¾ä¸ªä¾‹å­æ¥è¯´ï¼Œå¦‚æœä¸€ä¸ª if æ–¹æ³•çš„æŸä¸ªåˆ†æ”¯æ°¸ä¸å¯èƒ½æ‰§è¡Œï¼Œé‚£ä¹ˆåœ¨æœ€åç”Ÿæˆçš„äºŒè¿›åˆ¶æ–‡ä»¶ä¸­å°±ä¸åº”è¯¥æœ‰è¿™ä¸ªåˆ†æ”¯çš„ä»£ç ã€‚

3. å†…è”ä¼˜åŒ–ï¼ˆInlining optimizationï¼‰ï¼šå†…è”ä¼˜åŒ–å½¢è±¡æ¥è¯´ï¼Œå°±æ˜¯åœ¨æ±‡ç¼–ä¸­ä¸ä½¿ç”¨ â€œcall func_nameâ€ è¯­å¥ï¼Œç›´æ¥å°†å¤–éƒ¨æ–¹æ³•å†…çš„è¯­å¥â€œå¤åˆ¶â€åˆ°è°ƒç”¨è€…çš„ä»£ç æ®µå†…ã€‚è¿™æ ·åšçš„å¥½å¤„æ˜¯ä¸ç”¨è¿›è¡Œè°ƒç”¨å‡½æ•°å‰çš„å‹æ ˆã€è°ƒç”¨å‡½æ•°åçš„å‡ºæ ˆæ“ä½œï¼Œæé«˜è¿è¡Œæ•ˆç‡ä¸æ ˆç©ºé—´åˆ©ç”¨ç‡ã€‚

åœ¨æ–°çš„ç‰ˆæœ¬ä¸­ï¼Œè‹¹æœä½¿ç”¨äº†æ–°çš„ä¼˜åŒ–æ–¹å¼ Incrementalï¼Œå¤§å¤§å‡å°‘äº†é“¾æ¥çš„æ—¶é—´ã€‚å»ºè®®å¼€å¯ã€‚


æ€»ç»“ï¼Œå¼€å¯è¿™ä¸ªä¼˜åŒ–åï¼Œä¸€æ–¹é¢å‡å°‘äº†æ±‡ç¼–ä»£ç çš„ä½“ç§¯ï¼Œä¸€æ–¹é¢æé«˜äº†ä»£ç çš„è¿è¡Œæ•ˆç‡ã€‚


### 3.2 ä»£ç ç˜¦èº«

ä»£ç çš„ä¼˜åŒ–ï¼Œå³é€šè¿‡åˆ é™¤æ— ç”¨ç±»ã€æ— ç”¨æ–¹æ³•ã€é‡å¤æ–¹æ³•ç­‰ï¼Œæ¥è¾¾åˆ°å¯æ‰§è¡Œæ–‡ä»¶å¤§å°çš„å‡å°ã€‚
è€Œå¦‚ä½•ç­›é€‰å‡ºç¬¦åˆæ¡ä»¶çš„æ— ç”¨ç±»ã€æ–¹æ³•ï¼Œåˆ™éœ€è¦é€šè¿‡ä¸€äº›å·¥å…·æ¥å®Œæˆï¼ˆfuiï¼‰

æ‰«ææ— ç”¨ä»£ç çš„åŸºæœ¬æ€è·¯éƒ½æ˜¯æŸ¥æ‰¾å·²ç»ä½¿ç”¨çš„æ–¹æ³•/ç±»å’Œæ‰€æœ‰çš„ç±»/æ–¹æ³•ï¼Œç„¶åä»æ‰€æœ‰çš„ç±»/æ–¹æ³•å½“ä¸­å‰”é™¤å·²ç»ä½¿ç”¨çš„æ–¹æ³•/ç±»å‰©ä¸‹çš„åŸºæœ¬éƒ½æ˜¯æ— ç”¨çš„ç±»/æ–¹æ³•ï¼Œä½†æ˜¯ç”±äº Objective-C æ˜¯åŠ¨æ€è¯­è¨€ï¼Œå¯ä»¥ä½¿ç”¨å­—ç¬¦ä¸²æ¥è°ƒç”¨ç±»å’Œæ–¹æ³•ï¼Œæ‰€ä»¥æ£€æŸ¥ç»“æœä¸€èˆ¬éƒ½ä¸æ˜¯ç‰¹åˆ«å‡†ç¡®ï¼Œéœ€è¦äºŒæ¬¡ç¡®è®¤ã€‚ç›®å‰å¸‚é¢ä¸Šçš„æ‰«æçš„æ€è·¯å¤§è‡´å¯ä»¥åˆ†ä¸º 3 ç§ï¼š

- åŸºäº Clang æ‰«æ
- åŸºäºå¯æ‰§è¡Œæ–‡ä»¶æ‰«æ
- åŸºäºæºç æ‰«æ
  

å…ˆè°ˆå‡ ä¸ªæ¦‚å¿µã€‚

å¯æ‰§è¡Œæ–‡ä»¶å°±æ˜¯ **Mach-O** æ–‡ä»¶ï¼Œå…¶å¤§å°æ˜¯æ²¹ä»£ç é‡å†³å®šçš„ï¼Œé€šå¸¸æƒ…å†µä¸‹ï¼Œå¯¹å¯æ‰§è¡Œæ–‡ä»¶è¿›è¡Œç˜¦èº«ï¼Œå°±æ˜¯æ‰¾åˆ°å¹¶åˆ é™¤æ— ç”¨ä»£ç çš„è¿‡ç¨‹ã€‚æ‰¾åˆ°æ— ç”¨ä»£ç çš„è¿‡ç¨‹ç±»æ¯”æ‰¾åˆ°æ— ç”¨å›¾ç‰‡çš„æ€è·¯ã€‚
- æ‰¾åˆ°ç±»å’Œæ–¹æ³•çš„å…¨é›†
- æ‰¾åˆ°ä½¿ç”¨è¿‡çš„ç±»å’Œæ–¹æ³•é›†åˆ
- å–2è€…å·®é›†å¾—åˆ°æ— ç”¨ä»£ç é›†åˆ
- å·¥ç¨‹å¸ˆç¡®è®¤åï¼Œåˆ é™¤å³å¯
  

LinkMap æ–‡ä»¶åˆ†ä¸º3éƒ¨åˆ†ï¼šObject Fileã€Sectionã€Symbolsã€‚
![LinkMapç»“æ„](https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/2019-05-06-LinkMap-Structure.png)
- Object Fileï¼šåŒ…å«äº†ä»£ç å·¥ç¨‹çš„æ‰€æœ‰æ–‡ä»¶
- Sectionï¼šæè¿°äº†ä»£ç æ®µåœ¨ç”Ÿæˆçš„ Mach-O é‡Œçš„åç§»ä½ç½®å’Œå¤§å°
- Symbolsï¼šä¼šåˆ—å‡ºæ¯ä¸ªæ–¹æ³•ã€ç±»ã€Blockï¼Œä»¥åŠå®ƒä»¬çš„å¤§å°

å…ˆè¯´è¯´å¦‚ä½•å¿«é€Ÿæ‰¾åˆ°æ–¹æ³•å’Œç±»çš„å…¨é›†ï¼Ÿ


æˆ‘ä»¬å¯ä»¥é€šè¿‡ **LinkMap** æ¥è·å¾—æ‰€æœ‰çš„ä»£ç ç±»å’Œæ–¹æ³•çš„ä¿¡æ¯ã€‚è·å– LinkMap å¯ä»¥é€šè¿‡å°† Build Setting é‡Œé¢çš„ **Write Link Map File** è®¾ç½®ä¸º YESï¼Œç„¶åæŒ‡å®š **Path to Link Map File** çš„è·¯å¾„å°±å¯ä»¥å¾—åˆ°æ¯æ¬¡ç¼–è¯‘åçš„ LinkMap æ–‡ä»¶äº†ã€‚
![Xcodeä¸­è®¾ç½®è·å–LinkMap](https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/2019-05-06-LinkMap-Xcode.png)


#### 3.2.1 åŸºäº clang æ‰«æ

åŸºæœ¬æ€è·¯æ˜¯åŸºäº clang ASTã€‚è¿½æº¯åˆ°å‡½æ•°çš„è°ƒç”¨å±‚çº§ï¼Œè®°å½•æ‰€æœ‰å®šä¹‰çš„æ–¹æ³•/ç±»å’Œæ‰€æœ‰è°ƒç”¨çš„æ–¹æ³•/ç±»ï¼Œå†å–å·®é›†ã€‚å…·ä½“åŸç†å‚è€ƒ å¦‚ä½•ä½¿ç”¨ Clang Plugin æ‰¾åˆ°é¡¹ç›®ä¸­çš„æ— ç”¨ä»£ç ï¼Œç›®å‰åªæœ‰æ€è·¯æ²¡æœ‰ç°æˆçš„å·¥å…·ã€‚


#### 3.2.2 åŸºäºå¯æ‰§è¡Œæ–‡ä»¶æ‰«æï¼ˆLinkMap ç»“åˆ Mach-O æ‰¾æ— ç”¨ä»£ç ï¼‰

ä¸Šé¢æˆ‘ä»¬å¾—çŸ¥å¯ä»¥é€šè¿‡ LinkMap ç»Ÿè®¡å‡ºæ‰€æœ‰çš„ç±»å’Œæ–¹æ³•ï¼Œè¿˜å¯ä»¥æ¸…æ™°åœ°çœ‹åˆ°ä»£ç æ‰€å åŒ…å¤§å°çš„å…·ä½“åˆ†å¸ƒï¼Œè¿›è€Œæœ‰é’ˆå¯¹æ€§åœ°è¿›è¡Œä»£ç ä¼˜åŒ–ã€‚

![LinkMap-Object file](https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/2019-05-05-LinkMap-ObjectFile.png)

![LinkMap-Sections](https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/2019-05-05-LinkMap-Sections.png)

![LinkMap-Symbols](https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/2019-05-05-LinkMap-Symbols.png)


å¾—åˆ°äº†ä»£ç çš„å…¨é›†ä¿¡æ¯åï¼Œæˆ‘ä»¬è¿˜éœ€è¦æ‰¾åˆ°å·²ç»ä½¿ç”¨è¿‡çš„æ–¹æ³•å’Œç±»ï¼Œè¿™æ ·æ‰å¯ä»¥è·å–å·®é›†ï¼Œæ‰¾åˆ°æ— ç”¨ä»£ç ã€‚æ‰€ä»¥æ¥ä¸‹æ¥å°±è°ˆè°ˆå¦‚ä½•é€šè¿‡ Mach-O å–åˆ°ä½¿ç”¨è¿‡çš„ç±»å’Œæ–¹æ³•ã€‚

Objective-C ä¸­çš„æ–¹æ³•éƒ½ä¼šé€šè¿‡ **objc_msgSend** æ¥è°ƒç”¨ï¼Œè€Œ objc_msgSend åœ¨ Mach-O æ–‡ä»¶é‡Œæ˜¯é€šè¿‡ **_objc_selrefs** è¿™ä¸ª **section** æ¥è·å– selector è¿™ä¸ªå‚æ•°çš„ã€‚

æ‰€ä»¥ï¼Œ_objc_selrefs é‡Œçš„æ–¹æ³•ä¸€å®šæ˜¯è¢«è°ƒç”¨äº†çš„ã€‚**_objc_classrefs** é‡Œæ˜¯è¢«è°ƒç”¨è¿‡çš„ç±»ï¼Œ **objc_superrefs** æ˜¯è°ƒç”¨è¿‡ super çš„ç±»ï¼ˆç»§æ‰¿å…³ç³»ï¼‰ã€‚é€šè¿‡ _objc_classrefs å’Œ _objc_superrefs,æˆ‘ä»¬å°±å¯ä»¥æ‰¾å‡ºä½¿ç”¨è¿‡çš„ç±»å’Œå­ç±»ã€‚

é‚£ä¹ˆï¼ŒMach-O æ–‡ä»¶ä¸­çš„ _objc_selrefsã€_objc_classrefsã€_objc_superrefs å¦‚ä½•æŸ¥çœ‹å‘¢ï¼Ÿ


1. ä½¿ç”¨ otool ç­‰å‘½ä»¤é€†å‘å¯æ‰§è¡Œæ–‡ä»¶ä¸­å¼•ç”¨åˆ°çš„ç±»/æ–¹æ³•å’Œæ‰€æœ‰å®šä¹‰çš„ç±»/æ–¹æ³•ï¼Œç„¶åè®¡ç®—å·®é›†ã€‚å…·ä½“å‚è€ƒiOSå¾®ä¿¡å®‰è£…åŒ…ç˜¦èº«ï¼Œç›®å‰åªæœ‰æ€è·¯æ²¡æœ‰ç°æˆçš„å·¥å…·ã€‚
2. ä½¿ç”¨ [MachOView](https://github.com/gdbinit/MachOView) æŸ¥çœ‹ã€‚ä½†æ˜¯è¿™ä¸ªé¡¹ç›®è¿è¡Œä¸èµ·æ¥ï¼Œè¿™ä¸ªæ–°çš„ [Repo](https://github.com/fangshufeng/MachOView) å¯ä»¥è¿è¡Œèµ·æ¥ã€‚

ä¸‹é¢ä¸¾ä¾‹è¯´æ˜ï¼š

å‰ç½®æ¡ä»¶ï¼šå…ˆè¿è¡Œé¡¹ç›®ï¼Œåœ¨ç”Ÿæˆçš„ Products ç›®å½•ä¸‹çš„ BridgeLabiPhone.app è§£å‹ï¼Œå–å‡ºå¯¹åº”çš„å’Œå·¥ç¨‹åŒåçš„ BridgeLabiPhoneã€‚ç„¶åè¿è¡Œä¸Šé¢çš„ Github é¡¹ç›®ã€‚å¯ä»¥çœ‹åˆ°è¿è¡Œäº†ä¸€ä¸ª Mac Appã€‚ç‚¹å‡»é¡¶éƒ¨çš„èœå•æ é‡Œé¢çš„ File->Openã€‚é€‰æ‹©ç”µè„‘ä¸Šçš„ BridgeLabiPhone.app é€‰æ‹©é‡Œé¢çš„ BridgeLabiPhoneã€‚è§ä¸‹å›¾

![Mach-O-inspect](https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/2019-05-07-Mach-O-Inspect.png)

ç”±äº Objective-C æ˜¯ä¸€é—¨åŠ¨æ€è¯­è¨€ï¼Œæ‰€ä»¥æ£€æµ‹å‡ºçš„ç»“æœä»æ—§éœ€è¦æˆ‘ä»¬2æ¬¡ç¡®è®¤ã€‚


#### 3.2.3 åŸºäºæºç æ‰«æ

ä¸€èˆ¬éƒ½æ˜¯å¯¹æºç æ–‡ä»¶è¿›è¡Œå­—ç¬¦ä¸²åŒ¹é…ã€‚ä¾‹å¦‚å°† A *aã€[A xxx]ã€NSStringFromClass("A")ã€objc_getClass("A") ç­‰å½’ç±»ä¸ºä½¿ç”¨çš„ç±»ï¼Œ@interface A : B å½’ç±»ä¸ºå®šä¹‰çš„ç±»ï¼Œç„¶åè®¡ç®—å·®é›†ã€‚

åŸºäºæºç æ‰«æ æœ‰ä¸ªå·²ç»å®ç°çš„å·¥å…· - fuiï¼Œä½†æ˜¯å®ƒçš„å®ç°åŸç†æ˜¯æŸ¥æ‰¾æ‰€æœ‰ #import "A" å’Œæ‰€æœ‰çš„æ–‡ä»¶è¿›è¡Œæ¯”å¯¹ï¼Œæ‰€ä»¥ç»“æœç›¸å¯¹äºä¸Šé¢çš„æ€è·¯æ¥è¯´å¯èƒ½æ›´ä¸å‡†ç¡®ã€‚


#### 3.2.4 é€šè¿‡ AppCode æŸ¥æ‰¾æ— ç”¨ä»£ç 

AppCode  æä¾›äº† Inspect Code æ¥è¯Šæ–­ä»£ç ï¼Œå…¶ä¸­å«æœ‰æŸ¥æ‰¾æ— ç”¨ä»£ç çš„åŠŸèƒ½ã€‚å®ƒå¯ä»¥å¸®åŠ©æˆ‘ä»¬æŸ¥æ‰¾å‡º AppCode ä¸­æ— ç”¨çš„ç±»ã€æ— ç”¨çš„æ–¹æ³•ç”šè‡³æ˜¯æ— ç”¨çš„ import ï¼Œä½†æ˜¯æ— æ³•æ‰«æé€šè¿‡å­—ç¬¦ä¸²æ‹¼æ¥æ–¹å¼æ¥åˆ›å»ºçš„ç±»å’Œè°ƒç”¨çš„æ–¹æ³•ï¼Œæ‰€ä»¥è¯´è¿˜æ˜¯ä¸Šé¢æ‰€è¯´çš„ åŸºäºæºç æ‰«æ æ›´åŠ å‡†ç¡®å’Œå®‰å…¨ã€‚

![AppCode-code inspect](https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/2019-05-05-CodeClean.png)

è¯´æ˜ï¼šAppCodeæ£€æµ‹å‡ºäº†å®é™…ä¸Šéœ€è¦çš„å¤§éƒ¨åˆ†åœºæ™¯çš„é—®é¢˜ï¼Œä½†æ˜¯ç”±äº Objective-C æ˜¯ä¸€é—¨åŠ¨æ€æ€§è¯­è¨€ï¼Œæ‰€ä»¥ AppCode æ£€æµ‹å‡ºæ— ç”¨çš„æ–¹æ³•ç­‰éƒ½éœ€è¦å·¥ç¨‹å¸ˆè‡ªå·±å†æ¬¡ç¡®è®¤ååˆ é™¤ã€‚ï¼ˆåœ¨æˆ‘ä»¬çš„å·¥ç¨‹ä¸­æœ‰ä¸€äº›å’Œ H5 äº¤äº’çš„æ¡¥æ¥æ–¹æ³•ï¼Œå› æ­¤ AppCode è§†ä¸º Unused Methodï¼Œä½†æ˜¯ä½ åˆ é™¤çš„è¯ï¼Œé‚£å°±è‡ªå·±å“­å»å§ ğŸ˜­ï¼‰ã€‚å®é™…ç»éªŒå‘Šè¯‰æˆ‘ï¼Œä½¿ç”¨ AppCode çš„æ—¶å€™å¦‚æœå·¥ç¨‹æ¯”è¾ƒå¤§ï¼Œåˆ™æ•´ä¸ª code inspect ä¼šéå¸¸è€—æ—¶ï¼ˆç»™ä½ æ‰“ä¸ªé¢„é˜²é’ˆå“¦ï¼Œç¬”èŠ¯ï¼‰

- æ— ç”¨ç±»ï¼šUnused class æ˜¯æ— ç”¨ç±»ï¼ŒUnused import statement æ˜¯æ— ç”¨ç±»å¼•å…¥å£°æ˜ï¼ŒUnused property æ˜¯æ— ç”¨çš„å±æ€§ï¼›
- æ— ç”¨æ–¹æ³•ï¼šUnused method æ˜¯æ— ç”¨çš„æ–¹æ³•ï¼ŒUnused parameter æ˜¯æ— ç”¨å‚æ•°ï¼ŒUnused instance variable æ˜¯æ— ç”¨çš„å®ä¾‹å˜é‡ï¼ŒUnused local variable æ˜¯æ— ç”¨çš„å±€éƒ¨å˜é‡ï¼ŒUnused value æ˜¯æ— ç”¨çš„å€¼ï¼›
- æ— ç”¨å®ï¼šUnused macro æ˜¯æ— ç”¨çš„å®ã€‚
- æ— ç”¨å…¨å±€ï¼šUnused global declaration æ˜¯æ— ç”¨å…¨å±€å£°æ˜ã€‚


#### 3.2.5 è¿è¡Œæ—¶çœŸæ­£æ£€æµ‹ç±»æ˜¯å¦ç”¨è¿‡

é€šè¿‡ä¸Šè¿°æ‰‹æ®µæ‰¾åˆ°å¹¶åˆ é™¤äº†æ— ç”¨ä»£ç ã€‚App ä¸æ–­ä¸Šçº¿è¿­ä»£è›®å¤šä»£ç éƒ½ä¸ä¼šè¢«è°ƒç”¨äº†ï¼ˆä¸šåŠ¡è¢«ç æ‰äº†ï¼‰ã€‚è¿™ç§æ–¹å¼ä¸‹è¿™äº›æ— ç”¨çš„ä»£ç ä¹Ÿæ˜¯å¯ä»¥è¢«åˆ é™¤çš„ã€‚

é€šè¿‡ Objective-C çš„ runtime æºç ï¼Œæˆ‘ä»¬å¯ä»¥æ‰¾åˆ°å¦‚ä½•åˆ¤æ–­ä¸€ä¸ªç±»æ˜¯å¦åˆå§‹åŒ–è¿‡çš„å‡½æ•°ã€‚

```Objective-c
#define RW_INITIALIZED (1<<29)
bool isInitialized() {
   return getMeta()->data()->flags & RW_INITIALIZED;
}
```

isInitialized çš„ç»“æœä¼šä¿å­˜åˆ°å…ƒç±»çš„ class_rw_t ç»“æ„ä½“çš„ flags ä¿¡æ¯é‡Œï¼Œ flags çš„ 1<<29 ä½è®°å½•çš„å°±æ˜¯è¿™ä¸ªç±»æ˜¯å¦åˆå§‹åŒ–äº†çš„ä¿¡æ¯ï¼Œè€Œ flags çš„å…¶ä»–ä½è®°å½•çš„ä¿¡æ¯ï¼Œå¯ä»¥æŸ¥çœ‹ rumtime çš„æºç 

```Objective-c
// ç±»çš„æ–¹æ³•åˆ—è¡¨å·²ä¿®å¤
#define RW_METHODIZED         (1<<30)

// ç±»å·²ç»åˆå§‹åŒ–äº†
#define RW_INITIALIZED        (1<<29)

// ç±»åœ¨åˆå§‹åŒ–è¿‡ç¨‹ä¸­
#define RW_INITIALIZING       (1<<28)

// class_rw_t->ro æ˜¯ class_ro_t çš„å †å‰¯æœ¬
#define RW_COPIED_RO          (1<<27)

// ç±»åˆ†é…äº†å†…å­˜ï¼Œä½†æ²¡æœ‰æ³¨å†Œ
#define RW_CONSTRUCTING       (1<<26)

// ç±»åˆ†é…äº†å†…å­˜ä¹Ÿæ³¨å†Œäº†
#define RW_CONSTRUCTED        (1<<25)

// GCï¼šclass æœ‰ä¸å®‰å…¨çš„ finalize æ–¹æ³•
#define RW_FINALIZE_ON_MAIN_THREAD (1<<24)

// ç±»çš„ +load è¢«è°ƒç”¨äº†
#define RW_LOADED             (1<<23)
```

æ—¢ç„¶å¯ä»¥åœ¨è¿è¡Œçš„æœŸé—´çŸ¥é“ç±»æ˜¯å¦åˆå§‹åŒ–äº†ï¼Œé‚£ä¹ˆå°±å¯ä»¥æ‰¾å‡ºå“ªäº›ç±»æœªåˆå§‹åŒ–ï¼Œå³å¯ä»¥æ‰¾åˆ°åœ¨çœŸå®ç¯å¢ƒé‡Œé¢æ²¡æœ‰ç”¨åˆ°çš„ç±»å¹¶åˆ é™¤æ‰ã€‚



## 4. App Extension

App Extension çš„å ç”¨ï¼Œéƒ½æ”¾åœ¨ Plugin æ–‡ä»¶å¤¹å†…ã€‚å®ƒæ˜¯ç‹¬ç«‹æ‰“åŒ…ç­¾åï¼Œç„¶åå†æ‹·è´è¿› Target App Bundle çš„ã€‚
å…³äº Extensionï¼Œæœ‰ä¸¤ä¸ªç‚¹è¦æ³¨æ„ï¼š

é™æ€åº“æœ€ç»ˆä¼šæ‰“åŒ…è¿›å¯æ‰§è¡Œæ–‡ä»¶å†…éƒ¨ï¼Œæ‰€ä»¥å¦‚æœ App Extension ä¾èµ–äº†ä¸‰æ–¹é™æ€åº“ï¼ŒåŒæ—¶ä¸»å·¥ç¨‹ä¹Ÿå¼•ç”¨äº†ç›¸åŒçš„é™æ€åº“çš„è¯ï¼Œæœ€ç»ˆ App åŒ…ä¸­å¯èƒ½ä¼šåŒ…å«ä¸¤ä»½ä¸‰æ–¹é™æ€åº“çš„ä½“ç§¯ã€‚

åŠ¨æ€åº“æ˜¯åœ¨è¿è¡Œçš„æ—¶å€™æ‰è¿›è¡ŒåŠ è½½é“¾æ¥çš„ï¼Œæ‰€ä»¥ Plugin çš„åŠ¨æ€åº“æ˜¯å¯ä»¥å’Œä¸»å·¥ç¨‹å…±äº«çš„ï¼ŒæŠŠåŠ¨æ€åº“çš„åŠ è½½è·¯å¾„ Runpath Search Paths ä¿®æ”¹ä¸ºè·Ÿä¸»å·¥ç¨‹ä¸€è‡´å°±å¯ä»¥å…±äº«ä¸»å·¥ç¨‹å¼•å…¥çš„åŠ¨æ€åº“ã€‚

æ‰€ä»¥ï¼Œå¦‚æœå¯èƒ½çš„è¯ï¼ŒæŠŠç›¸å…³çš„ä¾èµ–æ”¹æˆåŠ¨æ€åº“æ–¹å¼ï¼Œè¾¾åˆ°å…±äº«ã€‚



## 5. é™æ€åº“ç˜¦èº«

é¡¹ç›®ä¸­éƒ½ä¼šå¼•å…¥ç¬¬ä¸‰æ–¹é™æ€åº“ã€‚é€šè¿‡ lipo å·¥å…·å¯ä»¥æŸ¥çœ‹æ”¯æŒçš„æŒ‡ä»¤é›†ï¼Œæ¯”å¦‚æŸ¥çœ‹å¾®åš SDK
ç»ˆç«¯åˆ‡æ¢åˆ°å¾®åš SDK çš„ç›®å½•ä¸‹æ‰§è¡Œä¸‹é¢å‘½ä»¤ 
- é™æ€åº“æŒ‡ä»¤é›†ä¿¡æ¯æŸ¥çœ‹ï¼š`lipo -info libname.a(æˆ–è€…libname.framework/libname)`

```Shell
lipo -info libWeiboSDK.a
//Architectures in the fat file: libWeiboSDK.a are: armv7 arm64 i386 x86_64
```

æˆ‘ä»¬çŸ¥é“ i386ã€x86_64 æ˜¯æ¨¡æ‹Ÿå™¨çš„æŒ‡ä»¤é›†ã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥æ¨¡æ‹Ÿå™¨ç‰ˆæœ¬çš„æŒ‡ä»¤é›†ã€‚å› ä¸º armv7 ä¹Ÿå¯ä»¥å…¼å®¹ armv7sã€‚æ‰€ä»¥ armv7s ä¹Ÿå¯ä»¥åˆ é™¤äº†ã€‚åªä¿ç•™ armv7 å’Œ arm64

- é™æ€åº“æ‹†åˆ†ï¼š`lipo é™æ€åº“æ–‡ä»¶è·¯å¾„ -thin CPUæ¶æ„ -output æ‹†åˆ†åçš„é™æ€åº“æ–‡ä»¶è·¯å¾„`
- é™æ€åº“åˆå¹¶ï¼š`lipo -create é™æ€åº“1æ–‡ä»¶è·¯å¾„ é™æ€åº“2æ–‡ä»¶è·¯å¾„... é™æ€åº“næ–‡ä»¶è·¯å¾„ -output åˆå¹¶åçš„é™æ€åº“æ–‡ä»¶å¾„`


```Shell
lipo libWeiboSDK.a -thin armv7 -output libWeiboSDK-armv7.a
lipo libWeiboSDK.a -thin arm64 -output libWeiboSDK-arm64.a
lipo create libWeiboSDK-armv7.a libWeiboSDK-arm64.a -output libWeiboSDK.device.a
```

é€šè¿‡ä¸Šé¢çš„æ“ä½œæˆ‘ä»¬å°†é™æ€åº“é‡Œé¢æ”¯æŒæ¨¡æ‹Ÿå™¨çš„æŒ‡ä»¤é›†ç»™å»æ‰äº†ï¼Œæ‰€ä»¥æ¨¡æ‹Ÿå™¨æ˜¯æ— æ³•è·‘ä»£ç çš„ï¼Œå¦‚ä½•è§£å†³ï¼Ÿ

1. å¹³æ—¶ä½¿ç”¨åŒ…å«æ¨¡æ‹Ÿå™¨æŒ‡ä»¤é›†çš„é™æ€åº“ï¼Œåœ¨ App å‘å¸ƒçš„æ—¶å€™å»æ‰
2. å¦‚æœä½¿ç”¨ Cocoapods ç®¡ç†å¯ä»¥ä½¿ç”¨2ä»½ Podfile æ–‡ä»¶ã€‚ä¸€ä»½åŒ…å«æŒ‡ä»¤é›†ä¸€ä»½ä¸åŒ…å«ï¼Œå‘å¸ƒçš„æ—¶å€™åˆ‡æ¢ Podfile æ–‡ä»¶å³å¯ã€‚æˆ–è€…ä¸€ä»½ Podfile æ–‡ä»¶ï¼Œä½†æ˜¯é…ç½®ä¸åŒçš„ç¯å¢ƒè®¾ç½®


è¡¥å……2ä¸ªè¯´æ˜ï¼š

1. dSYM æ–‡ä»¶
   ç¬¦å·è¡¨æ–‡ä»¶ .dSYM æ–‡ä»¶æ˜¯ä» Mach-O æ–‡ä»¶ä¸­æŠ½å–è°ƒè¯•ä¿¡æ¯è€Œå¾—åˆ°çš„æ–‡ä»¶ç›®å½•ï¼Œå®é™…ç”¨äºä¿å­˜è°ƒè¯•ä¿¡æ¯çš„æ˜¯ DWARF æ–‡ä»¶

- è‡ªåŠ¨ç”Ÿæˆã€‚Xcode ä¼šåœ¨å·¥ç¨‹ç¼–è¯‘æˆ–è€…å½’æ¡£çš„æ—¶å€™è‡ªåŠ¨ç”Ÿæˆ .dSYM æ–‡ä»¶ï¼Œåœ¨ Buld setting è®¾ç½®ä¸­æœ‰å¼€å…³å¯ä»¥è®¾ç½®å»å…³æ‰ .dSYM æ–‡ä»¶
- æ‰‹åŠ¨ç”Ÿæˆã€‚é€šè¿‡è„šæœ¬ä» Mach-O æ–‡ä»¶ä¸­æå–å‡ºæ¥ã€‚
```
$ /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/dsymutil /Users/wangzz/Library/Developer/Xcode/DerivedData/YourApp-cqvijavqbptjyhbwewgpdmzbmwzk/Build/Products/Debug-iphonesimulator/YourApp.app/YourApp -o YourApp.dSYM
```
è¯¥æ–¹å¼é€šè¿‡ dsymutil å·¥å…·ï¼Œä»é¡¹ç›®ç¼–è¯‘ç»“æœ .app ç›®å½•ä¸‹çš„ Mach-O æ–‡ä»¶ä¸­æå–å‡ºè°ƒè¯•ç¬¦å·è¡¨æ–‡ä»¶ã€‚Xcode åœ¨å½’æ¡£çš„æ—¶å€™æ˜¯é€šè¿‡å®ƒç”Ÿè¾°çš„ .dSYM æ–‡ä»¶

2. DWARF æ–‡ä»¶
   DebuggingWith Arbitrary Record Formats æ˜¯ ELF å’Œ Mach-O ç­‰æ–‡ä»¶æ ¼å¼ä¸­ç”¨æ¥å­˜å‚¨å’Œå¤„ç†è°ƒè¯•ä¿¡æ¯çš„æ ‡å‡†æ ¼å¼ï¼Œ.dSYM æ–‡ä»¶ä¸­çœŸæ­£ä¿å­˜ç¬¦å·è¡¨æ•°æ®çš„æ˜¯ DWARF æ–‡ä»¶ã€‚DWARF æ–‡ä»¶ä¸­ä¸åŒçš„æ•°æ®éƒ½ä¿å­˜åœ¨ç›¸åº”çš„ section ä¸­ã€‚


æœ€åçš„ä¸€ä¸ªå¯¹æ¯”æ•ˆæœå›¾ï¼š
![ç˜¦èº«æ•ˆæœå›¾](https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/2019-05-09-AppThinning-Comparation.png)


æ€»ç»“ï¼šç˜¦èº«æŠ€æœ¯å¸¸è§æ“ä½œå°±è¿™äº›ï¼Œä½†æ˜¯ç»´æŒåº”ç”¨åŒ…ä½“ç§¯çš„ç˜¦èº«å´æ˜¯ä¸€ä¸ªè§‚å¿µï¼Œä»æ—¥å¸¸å¼€å‘åˆ°çº¿ä¸Šå‘å¸ƒéƒ½éœ€è¦æœ‰è¿™ä¸ªæ„è¯†ã€‚è¿™æ ·å½“ä½ åœ¨å†™ä»£ç çš„æ—¶å€™å°±ä¼šè€ƒè™‘åŒæ ·ä¸€ä¸ªæ•ˆæœï¼Œä½ çš„å…·ä½“å®ç°æ‰‹æ®µæ˜¯æ€ä¹ˆæ ·çš„ã€‚æ¯”å¦‚ä¸ºäº†ä¸€ä¸ªç¨å¾®ç‚«é…·çš„æ•ˆæœå°±è¦å¼•å…¥ä¸€ä¸ªå¾ˆå¤§çš„ä¸‰æ–¹åº“ï¼Œæœ‰äº†â€œç˜¦èº«â€çš„æ„è¯†ï¼Œä½ å¾ˆå¤§å¯èƒ½å°±æ˜¯è‡ªå·±åŠ¨æ‰‹æ’¸ä¸€ä¸ªä»£ç ã€‚æ¯”å¦‚ä¸€äº›æ— ç”¨èµ„æºçš„ç®¡ç†æ–¹å¼ã€æœ‰ç”¨çš„å›¾ç‰‡èµ„æºçš„é«˜æ•ˆç®¡ç†æ–¹å¼ç­‰ç­‰ã€‚æœ‰äº†æ„è¯†ï¼Œè¡ŒåŠ¨è‡ªç„¶ä¼šå¾€è¿™ä¸ªæ–¹é¢å»é ã€‚ï¼ˆğŸ˜‚å¤§é“ç†ä¸€å¥—ä¸€å¥—çš„ã€‚æˆ‘ä¹Ÿä¸æƒ³çš„ï¼Œæ¯•ç«Ÿæ˜¯playboyï¼‰

å…¶ä¸­é‡åˆ°äº†ä¸€ä¸ªç¥å¥‡çš„é—®é¢˜ã€‚lint çš„æ—¶å€™çœ‹åˆ°ä¸€äº›æœªä½¿ç”¨çš„ä¾èµ–åº“ã€‚è§ [é—®é¢˜](https://github.com/FantasticLBP/knowledge-kit/blob/master/Chapter1%20-%20iOS/1.53.md)


**By the wayï¼š**
å¦‚æœåœ¨åº”ç”¨åŒ…ç˜¦èº«æ–¹é¢æœ‰å…¶ä»–çš„åšæ³•ï¼Œè¯·å‘ŠçŸ¥ï¼Œå®Œå–„æ–‡ç« ã€‚

å‚è€ƒæ–‡ç« ï¼š
- [Humble Assets Catalog](http://lingyuncxb.com/2019/04/14/HumbleAssetCatalog/)
- [å…³äº Pod åº“çš„èµ„æºå¼•ç”¨ resource_bundles or resources](http://zhoulingyu.com/2018/02/02/pod-resource-reference/)
- éƒ¨åˆ†å›¾ç‰‡æˆ–è€…æ–‡å­—å†…å®¹å¼•ç”¨æ¥è‡ªç½‘ç»œï¼ˆè‹¥æœ‰å¼•ç”¨åˆ°ï¼Œè¯·å‘Šè¯‰æˆ‘åœ°å€ï¼ŒåŠæ—¶è¡¥å……ï¼‰




- çº¿ç¨‹ã€é˜Ÿåˆ—ã€runloop çš„å…³ç³»ï¼Ÿä¸»ä¸²è¡Œé˜Ÿåˆ—ï¼Œåœ¨ Mach å†…æ ¸ä¸­åˆ›å»º
- blockï¼šå †å†…å­˜ä¸­çš„ç»“æ„ä½“å˜é‡
- å…¨å±€å¹¶å‘é˜Ÿåˆ—ï¼šé˜Ÿåˆ—ï¼ˆFIFOï¼‰ã€‚æ‰€ä»¥æœ€ååŠ å…¥åˆ°å…¨å±€å¹¶å‘é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡æœ€åæ‰§è¡Œï¼Œæ‰§è¡Œçš„æ—¶å€™å°±å¯ä»¥æ‹¿åˆ°ç»“æœ