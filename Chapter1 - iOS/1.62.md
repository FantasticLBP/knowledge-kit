# OCLint å®ç° Code Review - ç»™ä½ çš„ä»£ç ææè´¨é‡

å·¥ç¨‹ä»£ç è´¨é‡ï¼Œä¸€ä¸ªæ°¸æ’çš„è¯é¢˜ã€‚å¥½çš„è´¨é‡çš„å¥½å¤„ä¸è¨€è€Œå–»ï¼Œå›¢é˜Ÿæˆå‘˜é—´é™¤äº†ä¿æŒç»Ÿä¸€çš„é£æ ¼å’Œè¾ƒé«˜çš„è‡ªæˆ‘çº¦æŸåŠ›ä¹‹å¤–ï¼Œè¿˜éœ€è¦ä¸€äº›å·¥å…·æ¥ç»Ÿè®¡åˆ†æä»£ç è´¨é‡é—®é¢˜ã€‚

æœ¬æ–‡å°±æ˜¯é’ˆå¯¹ OC é¡¹ç›®ï¼Œæå‡ºçš„ä¸€ä¸ªæ€è·¯å’Œå®è·µæ­¥éª¤çš„è®°å½•ï¼Œæœ€åå½¢æˆäº†ä¸€ä¸ªå¯ä»¥ç›´æ¥ç”¨çš„è„šæœ¬ã€‚å¦‚æœè§‰å¾—æ–‡ç« ç¯‡å¹…è¿‡é•¿ï¼Œåˆ™ç›´æ¥å¯ä»¥ä¸‹è½½[è„šæœ¬](https://github.com/FantasticLBP/knowledge-kit/tree/master/assets/auto_Lint.sh)

> OCLint is a static code analysis tool for improving quality and reducing defects by inspecting C, C++ and Objective-C code and looking for potential problems ...

ä»å®˜æ–¹çš„è§£é‡Šæ¥çœ‹ï¼Œå®ƒé€šè¿‡æ£€æŸ¥ Cã€C++ã€Objective-C ä»£ç æ¥å¯»æ‰¾æ½œåœ¨é—®é¢˜ï¼Œæ¥æé«˜ä»£ç è´¨é‡å¹¶å‡å°‘ç¼ºé™·çš„é™æ€ä»£ç åˆ†æå·¥å…·



## OCLint çš„ä¸‹è½½å’Œå®‰è£…

æœ‰3ç§æ–¹å¼å®‰è£…ï¼Œåˆ†åˆ«ä¸º Homebrewã€æºä»£ç ç¼–è¯‘å®‰è£…ã€ä¸‹è½½å®‰è£…åŒ…å®‰è£…ã€‚
åŒºåˆ«ï¼š
- å¦‚æœéœ€è¦è‡ªå®šä¹‰ Lint è§„åˆ™ï¼Œåˆ™éœ€è¦ä¸‹è½½æºç ç¼–è¯‘å®‰è£…
- å¦‚æœä»…ä»…æ˜¯ä½¿ç”¨è‡ªå¸¦çš„è§„åˆ™æ¥ Lintï¼Œé‚£ä¹ˆä»¥ä¸Š3ç§å®‰è£…æ–¹å¼éƒ½å¯ä»¥


### 1. Homebrew å®‰è£…

åœ¨å®‰è£…å‰ï¼Œç¡®ä¿å®‰è£…äº† homebrewã€‚æ­¥éª¤ç®€å•å¿«æ·

```Shell
brew tap oclint/formulae   
brew install oclint
```


### 2. å®‰è£…åŒ…å®‰è£…

- è¿›å…¥ OCLint åœ¨ Github ä¸­çš„[åœ°å€](https://github.com/oclint/oclint/releases)ï¼Œé€‰æ‹© Releaseã€‚é€‰æ‹©æœ€æ–°ç‰ˆæœ¬çš„å®‰è£…åŒ…ï¼ˆç›®å‰æœ€æ–°ç‰ˆæœ¬ä¸ºï¼šoclint-0.13.1-x86_64-darwin-17.4.0.tar.gzï¼‰
- è§£å‹ä¸‹è½½æ–‡ä»¶ã€‚å°†æ–‡ä»¶å­˜æ”¾åˆ°ä¸€ä¸ªåˆé€‚çš„ä½ç½®ã€‚ï¼ˆæ¯”å¦‚æˆ‘é€‰æ‹©å°†è¿™äº›éœ€è¦çš„æºä»£ç å­˜æ”¾åˆ° Document ç›®å½•ä¸‹ï¼‰
- åœ¨ç»ˆç«¯ç¼–è¾‘å½“å‰ç¯å¢ƒçš„é…ç½®æ–‡ä»¶ï¼Œæˆ‘ä½¿ç”¨çš„æ˜¯ zshï¼Œæ‰€ä»¥ç¼–è¾‘ .zshrc æ–‡ä»¶ã€‚(å¦‚æœä½¿ç”¨ç³»ç»Ÿçš„ç»ˆç«¯åˆ™ç¼–è¾‘ .bash_profile æ–‡ä»¶)
```Shell
OCLint_PATH=/Users/liubinpeng/Desktop/oclint/build/oclint-release
export PATH=$OCLint_PATH/bin:$PATH
```
- å°†é…ç½®æ–‡ä»¶ source ä¸€ä¸‹ã€‚
```Shell
source .zshrc // å¦‚æœä½ ä½¿ç”¨ç³»ç»Ÿçš„ç»ˆç«¯åˆ™æ‰§è¡Œ soucer .bash_profile
```
- éªŒè¯æ˜¯å¦å®‰è£…æˆåŠŸã€‚åœ¨ç»ˆç«¯è¾“å…¥ `oclint --version`


### 3. æºç ç¼–è¯‘å®‰è£…

- homebrew å®‰è£… CMake å’Œ Ninja è¿™2ä¸ªç¼–è¯‘å·¥å…·
```Shell
brew install cmake ninja
```

- è¿›å…¥ Github æœç´¢ OCLintï¼Œclone æºç 
```Shell
gc https://github.com/oclint/oclint
```

- è¿›å…¥ oclint-scripts ç›®å½•ï¼Œæ‰§è¡Œ ./make å‘½ä»¤ã€‚è¿™ä¸€æ­¥çš„æ—¶é—´éå¸¸é•¿ã€‚ä¼šä¸‹è½½ oclint-json-compilation-databaseã€oclint-xcodebuildã€llvm æºç ä»¥åŠ clang æºç ã€‚å¹¶è¿›è¡Œç›¸å…³çš„ç¼–è¯‘å¾—åˆ° oclintã€‚ä¸”å¿…é¡»ä½¿ç”¨ç¿»å¢™ç¯å¢ƒä¸ç„¶ä¼šæŠ¥ timeoutã€‚å¦‚æœä½ çš„ç”µè„‘æ”¯æŒç¿»å¢™ç¯å¢ƒï¼Œä½†æ˜¯åœ¨ç»ˆç«¯ä¸‹ä¸æ”¯æŒç¿»å¢™ï¼Œå¯ä»¥æŸ¥çœ‹æˆ‘çš„è¿™ç¯‡[æ–‡ç« ](https://github.com/FantasticLBP/knowledge-kit/blob/master/ç¬¬å…­éƒ¨åˆ†%20å¼€å‘æ‚è°ˆ/6.11.md)
```Shell
./make
```

- ç¼–è¯‘ç»“æŸï¼Œè¿›å…¥åŒçº§ build æ–‡ä»¶å¤¹ï¼Œè¯¥æ–‡ä»¶å¤¹ä¸‹çš„å†…å®¹å³ä¸º oclintã€‚å¯ä»¥çœ‹åˆ° `build/oclint-release`ã€‚æ–¹å¼2ä¸‹è½½çš„å®‰è£…åŒ…çš„å†…å®¹å°±æ˜¯è¯¥æ–‡ä»¶å¤¹ä¸‹çš„å†…å®¹ã€‚

- cd åˆ°æ ¹ç›®å½•ï¼Œç¼–è¾‘ç¯å¢ƒæ–‡ä»¶ï¼Œæ¯”å¦‚æˆ‘ zsh å¯¹åº”çš„ .zshrc æ–‡ä»¶ã€‚ç¼–è¾‘ä¸‹é¢çš„å†…å®¹
```Shell
    OCLint_PATH=/Users/liubinpeng/Desktop/oclint/build/oclint-release
    export PATH=$OCLint_PATH/bin:$PATH
```

- source ä¸‹ .zhsrc æ–‡ä»¶
```Shell
source .zshrc // source .bash_profile
```

- è¿›å…¥ `oclint/build/oclint-release` ç›®å½•æ‰§è¡Œè„šæœ¬
```Shell
cp ~/Documents/oclint/build/oclint-release/bin/oclint* /usr/local/bin/
ln -s ~/Documents/oclint/build/oclint-release/lib/oclint /usr/local/lib
ln -s ~/Documents/oclint/build/oclint-release/lib/clang /usr/local/lib
```
è¿™é‡Œä½¿ç”¨ ln -sï¼ŒæŠŠ lib ä¸­çš„ clang å’Œ oclint é“¾æ¥åˆ° /usr/local/bin ç›®å½•ä¸‹ã€‚è¿™æ ·åšçš„ç›®çš„æ˜¯ä¸ºäº†åé¢å¦‚æœç¼–å†™äº†è‡ªå·±åˆ›å»ºçš„ lint è§„åˆ™ï¼Œä¸å¿…è¦æ¯æ¬¡æ›´æ–°è‡ªå®šä¹‰çš„ rule åº“ï¼Œå¿…é¡»æ‰‹åŠ¨å¤åˆ¶åˆ° /usr/local/bin ç›®å½•ä¸‹ã€‚

- éªŒè¯ä¸‹ OCLint æ˜¯å¦å®‰è£…æˆåŠŸã€‚è¾“å…¥ oclint --version

![OCLint-éªŒè¯å®‰è£…æˆåŠŸ](https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/2019-05-15-OCLint-Verify.png)

æ³¨æ„ï¼šå¦‚æœä½ é‡‡ç”¨æºç ç¼–è¯‘çš„æ—¶å€™ç›´æ¥ clone å®˜æ–¹çš„æºç ä¼šæœ‰é—®é¢˜ï¼Œç¼–è¯‘ä¸è¿‡ï¼Œæ‰€ä»¥æä¾›äº†ä¸€ä¸ªå¯ä»¥ç¼–è¯‘è¿‡çš„[ç‰ˆæœ¬](https://github.com/FantasticLBP/oclint)ã€‚åˆ†æ”¯åˆ‡æ¢åˆ° llvm-7.0ã€‚


### 4. xcodebuild çš„å®‰è£…
xcode ä¸‹è½½å®‰è£…å¥½å°±å·²ç»æˆåŠŸå®‰è£…äº†


### 5. xcpretty çš„å®‰è£…

å…ˆå†³æ¡ä»¶ï¼Œä½ çš„æœºå™¨å·²ç»å®‰è£…å¥½äº† Ruby gem.

```Shell
gem install xcpretty
```



## äºŒã€ è‡ªå®šä¹‰ Rule

OClint æä¾›äº† 70+ é¡¹çš„æ£€æŸ¥è§„åˆ™ï¼Œä½ å¯ä»¥ç›´æ¥å»ä½¿ç”¨ã€‚ä½†æ˜¯æŸäº›æ—¶å€™ä½ éœ€è¦åˆ¶ä½œè‡ªå·±çš„æ£€æµ‹è§„åˆ™ï¼Œæ¥ä¸‹æ¥å°±è¯´è¯´å¦‚ä½•è‡ªå®šä¹‰ lint è§„åˆ™ã€‚


1. è¿›å…¥ ~/Document/oclint ç›®å½•ï¼Œæ‰§è¡Œä¸‹é¢çš„è„šæœ¬

```shell
oclint-scripts/scaffoldRule CustomLintRules -t ASTVisitor
```
å…¶ä¸­ï¼Œ*CustomLintRules* å°±æ˜¯å®šä¹‰çš„æ£€æŸ¥è§„åˆ™çš„åå­—ï¼Œ *ASTVisitor* å°±æ˜¯ä½ ç»§æ‰¿çš„ lint è§„åˆ™

å¯ä»¥ç»§æ‰¿çš„è§„åˆ™æœ‰ï¼šASTVisitorã€SourceCodeReaderã€ASTMatcherã€‚

2. æ‰§è¡Œä¸Šé¢çš„è„šæœ¬ï¼Œä¼šç”Ÿæˆä¸‹é¢çš„æ–‡ä»¶
- Documents/oclint/oclint-rules/rules/custom/CustomLintRulesRule.cpp
- Documents/oclint/oclint-rules/test/custom/CustomLintRulesRuleTest.cpp

3. è¦æ–¹ä¾¿çš„å¼€å‘è‡ªå®šä¹‰çš„ lint è§„åˆ™ï¼Œåˆ™éœ€è¦ç”Ÿæˆä¸€ä¸ª xcodeproj é¡¹ç›®ã€‚åˆ‡æ¢åˆ°é¡¹ç›®æ ¹ç›®å½•ï¼Œä¹Ÿå°±æ˜¯ Documents/oclintï¼Œæ‰§è¡Œä¸‹é¢çš„å‘½ä»¤
```Shell
    mkdir Lint-XcodeProject
    cd Lint-XcodeProject
    touch generate-lint-rules.sh
    chmod +x generate-lint-rules.sh
```
    ç»™ä¸Šé¢çš„ generate-lint-rules.sh é‡Œé¢æ·»åŠ ä¸‹é¢çš„è„šæœ¬

    ```Shell
    #! /bin/sh -e
    cmake -G Xcode \
    -D CMAKE_CXX_COMPILER=../build/llvm-install/bin/clang++  \
    -D CMAKE_C_COMPILER=../build/llvm-install/bin/clang \
    -D OCLINT_BUILD_DIR=../build/oclint-core \
    -D OCLINT_SOURCE_DIR=../oclint-core \
    -D OCLINT_METRICS_SOURCE_DIR=../oclint-metrics \
    -D OCLINT_METRICS_BUILD_DIR=../build/oclint-metrics \
    -D LLVM_ROOT=../build/llvm-install/ ../oclint-rules
    ```

4. æ‰§è¡Œ generate-lint-rules.sh è„šæœ¬(./generate-lint-rules.sh)ã€‚å¦‚æœå‡ºç°ä¸‹é¢çš„ Log åˆ™è¯´æ˜ç”Ÿæˆ xcodeproj é¡¹ç›®æˆåŠŸ

![ç”Ÿæˆç¼–å†™lintè§„åˆ™çš„xcodeprojå·¥ç¨‹1](https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/2019-05-23-OCLint-Rule-Xcodeproj.png) 
![ç”Ÿæˆç¼–å†™lintè§„åˆ™çš„xcodeprojå·¥ç¨‹2](https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/2019-05-23-OCLint-Xcode-Rules.png) 

5. æ‰“å¼€æ­¥éª¤4ç”Ÿæˆçš„é¡¹ç›®ï¼Œçœ‹åˆ°æœ‰å¾ˆå¤šæ–‡ä»¶å¤¹ï¼Œä»£è¡¨ oclint è‡ªå¸¦çš„ lint è§„åˆ™ï¼Œæˆ‘ä»¬è‡ªå®šä¹‰çš„ lint è§„åˆ™åœ¨æœ€ä¸‹é¢ã€‚
![ç¼–å†™lintè‡ªå®šä¹‰è§„åˆ™çš„ä»£ç æ–‡ä»¶å¤¹](https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/2019-05-23-OCLint-custom-rule-inXcodeproj.png)

å…³äºå¦‚ä½•è‡ªå®šä¹‰ lint è§„åˆ™çš„å…·ä½“è¿˜æ²¡æœ‰æ·±å…¥ç ”ç©¶ï¼Œè¿™é‡Œç»™ä¸ªä¾‹å­

<details>
<summary>ç‚¹å‡»æŸ¥çœ‹ç¤ºä¾‹ä»£ç </summary>

```C
#include "oclint/AbstractASTVisitorRule.h"
#include "oclint/RuleSet.h"

using namespace std;
using namespace clang;
using namespace oclint;
#include <iostream>

class MVVMRule : public AbstractASTVisitorRule<MVVMRule>
{
public:
    virtual const string name() const override
    {
        return "Property in 'ViewModel' Class interface should be readonly.";
    }

    virtual int priority() const override
    {
        return 3;
    }

    virtual const string category() const override
    {
        return "mvvm";
    }
    
    virtual unsigned int supportedLanguages() const override
    {
        return LANG_OBJC;
    }

#ifdef DOCGEN
    virtual const std::string since() const override
    {
        return "0.18.10";
    }

    virtual const std::string description() const override
    {
        return "Property in 'ViewModel' Class interface should be readonly.";
    }

    virtual const std::string example() const override
    {
        return R"rst(
.. code-block:: cpp

    @interface FooViewModel : NSObject // This is a "ViewModel" Class.
    
    @property (nonatomic, strong) NSObject *bar; // should be readonly.
    
    @end
        )rst";
    }

    virtual const std::string fileName() const override
    {
        return "MVVMRule.cpp";
    }

#endif

    virtual void setUp() override {}
    virtual void tearDown() override {}

    /* Visit ObjCImplementationDecl */
    bool VisitObjCImplementationDecl(ObjCImplementationDecl *node)
    {
        ObjCInterfaceDecl *interface = node->getClassInterface();
        
        bool isViewModel = interface->getName().endswith("ViewModel");
        if (!isViewModel) {
            return false;
        }
        for (auto property = interface->instprop_begin(),
            propertyEnd = interface->instprop_end(); property != propertyEnd; property++)
        {
            clang::ObjCPropertyDecl *propertyDecl = (clang::ObjCPropertyDecl *)*property;
            if (propertyDecl->getName().startswith("UI")) {
                addViolation(propertyDecl, this);
            }
            auto attrs = propertyDecl->getPropertyAttributes();
            bool isReadwrite = (attrs & ObjCPropertyDecl::PropertyAttributeKind::OBJC_PR_readwrite) > 0;
            if (isReadwrite && isViewModel) {
                addViolation(propertyDecl, this);
            }
        }
        return true;
    }
};

static RuleSet rules(new MVVMRule());
```
</details>

6. ä¿®æ”¹è‡ªå®šä¹‰è§„åˆ™åå°±éœ€è¦ç¼–è¯‘ã€‚æˆåŠŸååœ¨ Products ç›®å½•ä¸‹ä¼šçœ‹åˆ°å¯¹åº”åç§°çš„ CustomLintRulesRule.dylib æ–‡ä»¶ï¼Œå°±éœ€è¦å¤åˆ¶åˆ° /Documents/oclint/oclint-release/lib/oclint/rulesã€‚è®²é“ç†ï¼Œç”Ÿæˆæ–°çš„ lint rule æ–‡ä»¶ï¼Œéœ€è¦æŠŠæ–°çš„ dylib æ–‡ä»¶å¤åˆ¶åˆ° /usr/local/libã€‚å› ä¸ºæˆ‘ä»¬åœ¨æºä»£ç å®‰è£…çš„ç¬¬4éƒ¨ï¼Œè®¾ç½®äº† ln -s é“¾æ¥ï¼Œæ‰€ä»¥ä¸éœ€è¦æ¯æ¬¡å¤åˆ¶åˆ°ç›¸åº”æ–‡ä»¶å¤¹ã€‚

ä½†æ˜¯è¿˜æ˜¯æ¯”è¾ƒéº»çƒ¦ï¼Œæ¯æ¬¡éƒ½éœ€è¦ç¼–è¯‘æ–°çš„ lint rule ä¹‹åéœ€è¦å°†ç›¸åº”çš„ dylib æ–‡ä»¶å¤åˆ¶åˆ°æºä»£ç ç›®å½•ä¸‹çš„ oclint-release/lib/oclint/rules ç›®å½•ä¸‹ï¼Œæœ¬ç€ã€Œå¯ä»¥å·æ‡’ç»ä¸åŠ¨æ‰‹ã€çš„åŸåˆ™ï¼Œåœ¨è‡ªå®šä¹‰çš„ rule çš„ target ä¸­ï¼Œåœ¨ Build Phases é€‰é¡¹ä¸‹ CMake PostBuild Rules ä¸­çš„è„šæœ¬ä¸‹å°†ä¸‹é¢çš„ä»£ç å¤åˆ¶è¿›å»

```Shell
cp /Users/liubinpeng/Documents/oclint/Lint-XcodeProject/rules.dl/Debug/libCustomLintRulesRule.dylib /Users/liubinpeng/Documents/oclint/build/oclint-release/lib/oclint/rules/libCustomLintRulesRule.dylib
```

7. è§„åˆ™é™å®šçš„3ä¸ªç±»è¯´æ˜ï¼š
```Shell
RuleBase
|
|-AbstractASTRuleBase
|      |_ AbstractASTVisitorRule
|             |_AbstractASTMatcherRule
|
|-AbstractSourceCodeReaderRule
```
- AbstractSourceCodeReaderRuleï¼šeachLine æ–¹æ³•ï¼Œè¯»å–æ¯è¡Œçš„ä»£ç ï¼Œå¦‚æœæƒ³ç¼–å†™çš„è§„åˆ™æ˜¯éœ€è¦é’ˆå¯¹æ¯è¡Œçš„ä»£ç å†…å®¹ï¼Œåˆ™å¯ä»¥ç»§æ‰¿è‡ªè¯¥ç±»
- AbstractASTVisitorRuleï¼šå¯ä»¥è®¿é—® AST ä¸Šç‰¹å®šç±»å‹çš„æ‰€æœ‰èŠ‚ç‚¹ï¼Œå¯ä»¥æ£€æŸ¥ç‰¹å®šç±»å‹çš„æ‰€æœ‰èŠ‚ç‚¹æ˜¯é€’å½’å®ç°çš„ã€‚åœ¨ **apply** æ–¹æ³•å†…å¯ä»¥çœ‹åˆ°ä»£ç å®ç°ã€‚å¼€å‘è€…åªéœ€è¦é‡è½½ bool visit* æ–¹æ³•æ¥è®¿é—®ç‰¹å®šç±»å‹çš„èŠ‚ç‚¹ã€‚å…¶å€¼è¡¨æ˜æ˜¯å¦ç»§ç»­é€’å½’æ£€æŸ¥
- AbstractASTMatcherRuleï¼šå®ç° setUpMatcher æ–¹æ³•ï¼Œåœ¨æ–¹æ³•ä¸­æ·»åŠ  matcherï¼Œå½“æ£€æŸ¥å‘ç°åŒ¹é…ç»“æœæ—¶ä¼šè°ƒç”¨ callback æ–¹æ³•ã€‚ç„¶åé€šè¿‡ callback æ–¹æ³•æ¥ç»§ç»­å¯¹åŒ¹é…åˆ°çš„ç»“æœè¿›è¡Œå¤„ç†

8. çŸ¥å…¶æ‰€ä»¥ç„¶
oclint ä¾èµ–ä¸æºä»£ç çš„è¯­æ³•æŠ½è±¡æ ‘ï¼ˆASTï¼‰ã€‚å¼€æº clang æ˜¯ oclint è·çš„è¯­æ³•æŠ½è±¡æ ‘çš„ä¾èµ–å·¥å…·ã€‚ä½ å¦‚æœæƒ³å¯¹ AST æœ‰ä¸ªäº†è§£ï¼Œå¯ä»¥æŸ¥çœ‹è¿™ä¸ª[è§†é¢‘](https://www.youtube.com/watch?v=VqCkCDFLSsc&feature=youtu.beï¼‰ï¼Œç›¸å…³è®²è§£https%3A%2F%2Fjonasdevlieghere.com%2Funderstanding-the-clang-ast%2F)

å¦‚æœæƒ³æŸ¥çœ‹æŸä¸ªæ–‡ä»¶çš„ AST ç»“æ„ï¼Œä½ å¯ä»¥è¿›å…¥è¯¥æ–‡ä»¶çš„å‘½ä»¤è¡Œï¼Œç„¶åæ‰§è¡Œä¸‹é¢çš„è„šæœ¬
```Shell
clang -Xclang -ast-dump -fsyntax-only main.m 
```

## ä¸‰ã€ Homebrew æ–¹å¼å®‰è£…çš„ oclint å¦‚ä½•ä½¿ç”¨è‡ªå®šä¹‰è§„åˆ™

1. æŸ¥çœ‹ OCLint å®‰è£…è·¯å¾„
```Shell
which oclint 
// è¾“å‡ºï¼š/usr/local/bin/oclint
ls -al  /usr/local/bin/oclint 
// è¾“å‡ºï¼šæœ¬æœºå®‰è£…è·¯å¾„
```

2. æŠŠä¸Šé¢ç”Ÿæˆçš„æ–°çš„ lint rule ä¸‹çš„ dylib æ–‡ä»¶å¤åˆ¶åˆ°æ­¥éª¤1å¾—åˆ°çš„é¢æœ¬æœºå®‰è£…è·¯å¾„ä¸‹



## å››ã€ ä½¿ç”¨ oclint 


### åœ¨å‘½ä»¤è¡Œä¸­ä½¿ç”¨

1. å¦‚æœé¡¹ç›®ä½¿ç”¨äº† Cocopodï¼Œåˆ™éœ€è¦æŒ‡å®š -workspace xxx.workspace
2. æ¯æ¬¡ç¼–è¯‘ä¹‹å‰éœ€è¦ clean


å®æ“ï¼š

- è¿›å…¥é¡¹ç›®
```Shell
cd /Workspace/Native/iOS/lianhua
```
- æŸ¥çœ‹é¡¹ç›®åŸºæœ¬ä¿¡æ¯
```Shell
xcodebuild -list
//è¾“å‡º
information about project "BridgeLabiPhone":
    Targets:
        BridgeLabiPhone
        lint

    Build Configurations:
        Debug
        Release

    If no build configuration is specified and -scheme is not passed then "Release" is used.

    Schemes:
        BridgeLabiPhone
        lint
```

- ç¼–è¯‘
```Shell
xcodebuild -scheme BridgeLabiPhone -workspace BridgeLabiPhone.xcworkspace  clean && xcodebuild -scheme BridgeLabiPhone -workspace BridgeLabiPhone.xcworkspace -configuration Debug | xcpretty -r json-compilation-database -o compile_commands.json
```

ç¼–è¯‘æˆåŠŸåï¼Œä¼šåœ¨é¡¹ç›®çš„æ–‡ä»¶å¤¹ä¸‹å‡ºç° compile_commands.json æ–‡ä»¶

- ç”Ÿæˆ html æŠ¥è¡¨
```Shell
oclint-json-compilation-database -e Pods -- -report-type html -o oclintReport.html
```

çœ‹åˆ°æœ‰æŠ¥é”™ï¼Œä½†æ˜¯æŠ¥é”™ä¿¡æ¯å¤ªå¤šäº†ï¼Œä¸å¥½å®šä½ï¼Œåˆ©ç”¨ä¸‹é¢çš„è„šæœ¬åˆ™å¯ä»¥å°†æŠ¥é”™ä¿¡æ¯å†™å…¥ log æ–‡ä»¶ï¼Œæ–¹ä¾¿æŸ¥çœ‹

```Shell
oclint-json-compilation-database -e Pods -- -report-type html -o oclintReport.html 2>&1 | tee 1.log
```

æŠ¥é”™ä¿¡æ¯æ˜¯ï¼š**oclint: error: one compiler command contains multiple jobs:**
æŸ¥æ‰¾èµ„æ–™ï¼Œè§£å†³æ–¹æ¡ˆå¦‚ä¸‹
- å°† Project å’Œ Targets ä¸­ Building Settings ä¸‹çš„ COMPILER_INDEX_STORE_ENABLE è®¾ç½®ä¸º **NO**
- åœ¨ podfile ä¸­ target 'xx' do å‰é¢æ·»åŠ ä¸‹é¢çš„è„šæœ¬

```Shell
post_install do |installer|
    installer.pods_project.targets.each do |target|
        target.build_configurations.each do |config|
            config.build_settings['COMPILER_INDEX_STORE_ENABLE'] = "NO"
        end
    end
end
```

ç„¶åç»§ç»­å°è¯•ç¼–è¯‘ï¼Œå‘ç°è¿˜æ˜¯æŠ¥é”™ï¼Œä½†æ˜¯æŠ¥é”™ä¿¡æ¯æ”¹å˜äº†ï¼Œå¦‚ä¸‹

![generate-lintresult-html-error](https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/2019-05-23-OCLint-Report-HTML.png)

çœ‹åˆ°æŠ¥é”™ä¿¡æ¯æ˜¯é»˜è®¤çš„è­¦å‘Šæ•°é‡è¶…è¿‡é™åˆ¶ï¼Œåˆ™ lint å¤±è´¥ã€‚äº‹å®ä¸Š lint åå¯ä»¥è·Ÿå‚æ•°ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¿®æ”¹è„šæœ¬å¦‚ä¸‹

```Shell
oclint-json-compilation-database -e Pods -- -report-type html -o oclintReport.html -rc LONG_LINE=9999 -max-priority-1=9999 -max-priority-2=9999 -max-priority-3=9999
```

ç”Ÿæˆäº† lint çš„ç»“æœï¼ŒæŸ¥çœ‹ html æ–‡ä»¶å¯ä»¥å…·ä½“å®šä½å“ªä¸ªä»£ç æ–‡ä»¶ï¼Œå“ªä¸€è¡Œå“ªä¸€åˆ—æœ‰ä»€ä¹ˆé—®é¢˜ï¼Œæ–¹ä¾¿ä¿®æ”¹ã€‚
    ![lint-result-html-report](https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/2019-05-23-oclint-result-html.png)

- å¦‚æœé¡¹ç›®å·¥ç¨‹å¤ªå¤§ï¼Œæ•´ä¸ª lint ä¼šæ¯”è¾ƒè€—æ—¶ï¼Œæ‰€å¹¸ oclint æ”¯æŒé’ˆå¯¹æŸä¸ªä»£ç æ–‡ä»¶å¤¹è¿›è¡Œ lint
```Shell
oclint-json-compilation-database -i éœ€è¦é™æ€åˆ†æçš„æ–‡ä»¶å¤¹æˆ–æ–‡ä»¶ -- -report-type html -o oclintReport.html  å…¶ä»–çš„å‚æ•°
```

- å‚æ•°è¯´æ˜

| åç§°                      | æè¿°                           | é»˜è®¤é˜ˆå€¼ |
| ----------------------- | ---------------------------- | ---- |
| CYCLOMATIC_COMPLEXITY   | æ–¹æ³•çš„å¾ªç¯å¤æ‚æ€§ï¼ˆåœˆè´Ÿè´£åº¦ï¼‰               | 10   |
| LONG_CLASS              | Cç±»æˆ–Objective-Cæ¥å£ï¼Œç±»åˆ«ï¼Œåè®®å’Œå®ç°çš„è¡Œæ•° | 1000 |
| LONG_LINE               | ä¸€è¡Œä»£ç çš„å­—ç¬¦æ•°                     | 100  |
| LONG_METHOD             | æ–¹æ³•æˆ–å‡½æ•°çš„è¡Œæ•°                     | 50   |
| LONG_VARIABLE_NAME      | å˜é‡åç§°çš„å­—ç¬¦æ•°                     | 20   |
| MAXIMUM_IF_LENGTH       | `if`è¯­å¥çš„è¡Œæ•°                    | 15   |
| MINIMUM_CASES_IN_SWITCH | switchè¯­å¥ä¸­çš„caseæ•°              | 3    |
| NPATH_COMPLEXITY        | æ–¹æ³•çš„NPathå¤æ‚æ€§                  | 200  |
| NCSS_METHOD             | ä¸€ä¸ªæ²¡æœ‰æ³¨é‡Šçš„æ–¹æ³•è¯­å¥æ•°                 | 30   |
| NESTED_BLOCK_DEPTH      | å—æˆ–å¤åˆè¯­å¥çš„æ·±åº¦                    | 5    |
| SHORT_VARIABLE_NAME     | å˜é‡åç§°çš„å­—ç¬¦æ•°                     | 3    |
| TOO_MANY_FIELDS         | ç±»çš„å­—æ®µæ•°                        | 20   |
| TOO_MANY_METHODS        | ç±»çš„æ–¹æ³•æ•°                        | 30   |
| TOO_MANY_PARAMETERS     | æ–¹æ³•çš„å‚æ•°æ•°                       | 10   |






### åœ¨ Xcode ä¸­ä½¿ç”¨

- åœ¨é¡¹ç›®çš„ TARGETS ä¸‹é¢ï¼Œç‚¹å‡»ä¸‹æ–¹çš„ "+" ï¼Œé€‰æ‹© cross-platform ä¸‹é¢çš„  Aggregateã€‚è¾“å…¥åå­—ï¼Œè¿™é‡Œå‘½åä¸º Lint
![Xcodeä¸­åˆ›å»ºlintçš„target](https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/2019-05-23-LintTarget.png)

- é€‰æ‹©å¯¹åº”çš„ TARGET -> lintã€‚åœ¨ Build Phases ä¸‹ Run Script ä¸‹å†™ä¸‹é¢çš„è„šæœ¬ä»£ç 
```Shell
export LC_CTYPE=en_US.UTF-8
cd ${SRCROOT}
xcodebuild -scheme BridgeLabiPhone -workspace BridgeLabiPhone.xcworkspace clean && xcodebuild -scheme BridgeLabiPhone -workspace BridgeLabiPhone.xcworkspace -configuration Debug | xcpretty -r json-compilation-database -o compile_commands.json && oclint-json-compilation-database -e Pods -- -report-type xcode
```

- è¯´æ˜ï¼Œè™½ç„¶æœ‰æ—¶å€™æ²¡æœ‰ç¼–è¯‘é€šè¿‡ï¼Œä½†æ˜¯çœ‹åˆ°å¦‚ä¸‹å›¾çš„å…³äºä»£ç ç›¸å…³çš„ warning åˆ™è¾¾åˆ°ç›®çš„äº†ã€‚
![Xcodeä¸­Lintç»“æœ](https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/2019-05-23-lint-result-inXcode.png)

- lint ç»“æœå¦‚ä¸‹ï¼Œæ ¹æ®ç›¸åº”çš„æç¤ºä¿¡æ¯å¯¹ä»£ç è¿›è¡Œè°ƒæ•´ã€‚å½“ç„¶è¿™åªæ˜¯ä¸€ç§å‚è€ƒï¼Œä¸ä¸€å®šè¦é‡‡çº³ lint ç»™çš„æç¤ºã€‚
![Xcodeä¸­æ˜¾ç¤ºlintç»“æœ](https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/2019-05-23-lint-in-Xcode.png)


## è„šæœ¬åŒ–

æ¯æ¬¡éƒ½åœ¨ç»ˆç«¯å‘½ä»¤è¡Œå»å†™ lint çš„è„šæœ¬ï¼Œæ•ˆç‡å¾ˆä½ï¼Œæ‰€ä»¥æƒ³åšæˆ shell è„šæœ¬ã€‚éœ€è¦çš„åŒå­¦ç›´æ¥ç›´æ¥æ‹·è´è¿›å»ï¼Œç›´æ¥åœ¨å·¥ç¨‹çš„æ ¹ç›®å½•ä¸‹ä½¿ç”¨ï¼Œæˆ‘è¿™è¾¹æ˜¯ä¸€ä¸ª Cocopod å·¥ç¨‹ã€‚æ‹¿èµ°æ‹¿èµ°åˆ«å®¢æ°”

```Shell
#!/bin/bash

COLOR_ERR="\033[1;31m"    #å‡ºé”™æç¤º
COLOR_SUCC="\033[0;32m"  #æˆåŠŸæç¤º
COLOR_QS="\033[1;37m"  #é—®é¢˜é¢œè‰²
COLOR_AW="\033[0;37m"  #ç­”æ¡ˆæç¤º
COLOR_END="\033[1;34m"     #é¢œè‰²ç»“æŸç¬¦

# å¯»æ‰¾é¡¹ç›®çš„ ProjectName
function searchProjectName () {
# maxdepth æŸ¥æ‰¾æ–‡ä»¶å¤¹çš„æ·±åº¦
find . -maxdepth 1 -name "*.xcodeproj"
}

function oclintForProject () {
    # é¢„å…ˆæ£€æµ‹æ‰€éœ€çš„å®‰è£…åŒ…æ˜¯å¦å­˜åœ¨
    if which xcodebuild 2>/dev/null; then
        echo 'xcodebuild exist'
    else
        echo 'ğŸ¤”ï¸ è¿ xcodebuild éƒ½æ²¡æœ‰å®‰è£…ï¼Œç©é¸¡æ¯›å•Šï¼Ÿ ğŸ¤”ï¸'
    fi

    if which oclint 2>/dev/null; then
        echo 'oclint exist'
    else
        echo 'ğŸ˜  å®Œè›‹äº†ä½ ï¼Œç© oclint å´ä¸å®‰è£…å—ï¼Œä½ è¦é—¹å“ªæ · ğŸ˜ '
        echo 'ğŸ˜  ä¹–ä¹–æŒ‰ç…§åšæ–‡ï¼šhttps://github.com/FantasticLBP/knowledge-kit/blob/master/Chapter1%20-%20iOS/1.63.md å®‰è£…æ‰€éœ€ç¯å¢ƒ ğŸ˜ '
    fi
    if which xcpretty 2>/dev/null; then
        echo 'xcpretty exist'
    else
        gem install xcpretty
    fi


    # æŒ‡å®šç¼–ç 
    export LANG="zh_CN.UTF-8"
    export LC_COLLATE="zh_CN.UTF-8"
    export LC_CTYPE="zh_CN.UTF-8"
    export LC_MESSAGES="zh_CN.UTF-8"
    export LC_MONETARY="zh_CN.UTF-8"
    export LC_NUMERIC="zh_CN.UTF-8"
    export LC_TIME="zh_CN.UTF-8"
    export xcpretty=/usr/local/bin/xcpretty # xcpretty çš„å®‰è£…ä½ç½®å¯ä»¥åœ¨ç»ˆç«¯ç”¨ which xcprettyæ‰¾åˆ°

    searchFunctionName=`searchProjectName`
    path=${searchFunctionName}
    # å­—ç¬¦ä¸²æ›¿æ¢å‡½æ•°ã€‚//è¡¨ç¤ºå…¨å±€æ›¿æ¢ /è¡¨ç¤ºåŒ¹é…åˆ°çš„ç¬¬ä¸€ä¸ªç»“æœæ›¿æ¢ã€‚ 
    path=${path//.\//}  # ./BridgeLabiPhone.xcodeproj -> BridgeLabiPhone.xcodeproj
    path=${path//.xcodeproj/} # BridgeLabiPhone.xcodeproj -> BridgeLabiPhone
    
    myworkspace=$path".xcworkspace" # workspaceåå­—
    myscheme=$path  # schemeåå­—

    # æ¸…é™¤ä¸Šæ¬¡ç¼–è¯‘æ•°æ®
    if [ -d ./derivedData ]; then
        echo -e $COLOR_SUCC'-----æ¸…é™¤ä¸Šæ¬¡ç¼–è¯‘æ•°æ®derivedData-----'$COLOR_SUCC
        rm -rf ./derivedData
    fi

    # xcodebuild clean
    xcodebuild -scheme $myscheme -workspace $myworkspace clean


    # # ç”Ÿæˆç¼–è¯‘æ•°æ®
    xcodebuild -scheme $myscheme -workspace $myworkspace -configuration Debug | xcpretty -r json-compilation-database -o compile_commands.json

    if [ -f ./compile_commands.json ]; then
        echo -e $COLOR_SUCC'ç¼–è¯‘æ•°æ®ç”Ÿæˆå®Œæ¯•ğŸ˜„ğŸ˜„ğŸ˜„'$COLOR_SUCC
    else
        echo -e $COLOR_ERR'ç¼–è¯‘æ•°æ®ç”Ÿæˆå¤±è´¥ğŸ˜­ğŸ˜­ğŸ˜­'$COLOR_ERR
        return -1
    fi

    # ç”ŸæˆæŠ¥è¡¨
    oclint-json-compilation-database -e Pods -- -report-type html -o oclintReport.html \
    -rc LONG_LINE=200 \
    -disable-rule ShortVariableName \
    -disable-rule ObjCAssignIvarOutsideAccessors \
    -disable-rule AssignIvarOutsideAccessors \
    -max-priority-1=100000 \
    -max-priority-2=100000 \
    -max-priority-3=100000

    if [ -f ./oclintReport.html ]; then
        rm compile_commands.json
        echo -e $COLOR_SUCC'ğŸ˜„åˆ†æå®Œæ¯•ğŸ˜„'$COLOR_SUCC
    else 
        echo -e $COLOR_ERR'ğŸ˜¢åˆ†æå¤±è´¥ğŸ˜¢'$COLOR_ERR
        return -1
    fi
    echo -e $COLOR_AW'å°†ä¸ºæ‚¨è‡ªåŠ¨æ‰“å¼€ lint çš„åˆ†æç»“æœ...'$COLOR_AW
    # ç”¨ safari æµè§ˆå™¨æ‰“å¼€ oclint çš„ç»“æœ
    open -a "/Applications/Safari.app" oclintReport.html
}

oclintForProject
```

åŒç±»å‹çš„æ–‡ç« ï¼š
- [å¦‚ä½•æ‰“é€ å›¢é˜Ÿçš„ä»£ç é£æ ¼ç»Ÿä¸€ä»¥åŠå¼€å‘æ•ˆç‡çš„æå‡](https://github.com/FantasticLBP/knowledge-kit/blob/master/Chapter1%20-%20iOS/1.52.md)
- [oclintä»‹ç»](https://github.com/hdw09/CIHexoBlog/blob/master/source/_posts/OClintå­¦ä¹ ç¬”è®°.md)
- [è‡ªå®šä¹‰oclintè§„åˆ™](https://github.com/hdw09/CIHexoBlog/blob/master/source/_posts/OCLint-è‡ªå®šä¹‰è§„åˆ™101.md)