# UIWebViewåŠ è½½ç½‘é¡µå†…å®¹

å¯ä»¥é€šè¿‡æœ¬åœ°æ–‡ä»¶ã€urlç­‰æ–¹å¼ã€‚

```objective-c
NSString *htmlPath = [[NSBundle mainBundle] pathForResource:@"index" ofType:@"html"];
NSURLRequest *request = [NSURLRequest requestWithURL:[NSURL fileURLWithPath:htmlPath]];
[self.webView loadRequest:request];
```

## Nativeè°ƒç”¨JavaScript

Nativeè°ƒç”¨JSæ˜¯é€šè¿‡UIWebViewçš„stringByEvaluatingJavaScriptFromString æ–¹æ³•å®ç°çš„ï¼Œè¯¥æ–¹æ³•è¿”å›jsè„šæœ¬çš„æ‰§è¡Œç»“æœã€‚

```objective-c
[webView stringByEvaluatingJavaScriptFromString:@"Math.random();"];
```

å®é™…ä¸Šå°±æ˜¯è°ƒç”¨äº†ç½‘é¡µçš„Windowä¸‹çš„ä¸€ä¸ªå¯¹è±¡ã€‚å¦‚æœæˆ‘ä»¬éœ€è¦è®©nativeç«¯è°ƒç”¨jsæ–¹æ³•ï¼Œé‚£ä¹ˆè¿™ä¸ªjsæ–¹æ³•å¿…é¡»åœ¨windowä¸‹å¯ä»¥è®¿é—®åˆ°ã€‚


## JavaScriptè°ƒç”¨Native

åè¿‡æ¥ï¼ŒJavaScriptè°ƒç”¨Nativeï¼Œå¹¶æ²¡æœ‰ç°æˆçš„APIå¯ä»¥è°ƒç”¨ï¼Œè€Œæ˜¯é—´æ¥åœ°é€šè¿‡ä¸€äº›å…¶å®ƒæ‰‹æ®µæ¥å®ç°ã€‚UIWebViewæœ‰ä¸ªä»£ç†æ–¹æ³•ï¼šåœ¨UIWebViewå†…å‘èµ·çš„ä»»ä½•ç½‘ç»œè¯·æ±‚éƒ½å¯ä»¥é€šè¿‡delegateå‡½æ•°åœ¨Nativeå±‚å¾—åˆ°é€šçŸ¥ã€‚ç”±æ­¤æ€è·¯ï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨UIWebViewå†…å‘èµ·ä¸€ä¸ªè‡ªå®šä¹‰çš„ç½‘ç»œè¯·æ±‚ï¼Œé€šå¸¸æ˜¯è¿™æ ·çš„æ ¼å¼ï¼š**jsbridge://methodName?param1=value1&param2=value2...**

åœ¨UIWebViewçš„delegateå‡½æ•°ä¸­ï¼Œæˆ‘ä»¬åˆ¤æ–­è¯·æ±‚çš„schemeï¼Œå¦‚æœrequest.URL.schemeæ˜¯jsbridgeï¼Œé‚£ä¹ˆå°±ä¸è¿›è¡Œç½‘é¡µå†…å®¹çš„åŠ è½½ï¼Œè€Œæ˜¯å»æ‰§è¡Œç›¸åº”çš„æ–¹æ³•ã€‚æ–¹æ³•åç§°å°±æ˜¯request.URL.hostã€‚å‚æ•°å¯ä»¥é€šè¿‡request.URL.queryå¾—åˆ°ã€‚

é—®é¢˜æ¥äº†ï¼Ÿï¼Ÿ

å‘èµ·è¿™æ ·1ä¸ªç½‘ç»œè¯·æ±‚æœ‰2ç§æ–¹å¼ã€‚1:location.href .2ï¼šiframeã€‚é€šè¿‡location.hrefæœ‰ä¸ªé—®é¢˜ï¼Œå°±æ˜¯å¦‚æœjså¤šæ¬¡è°ƒç”¨åŸç”Ÿçš„æ–¹æ³•ä¹Ÿå°±æ˜¯location.hrefçš„å€¼å¤šæ¬¡å˜åŒ–ï¼ŒNativeç«¯åªèƒ½æ¥å—åˆ°æœ€åä¸€æ¬¡è¯·æ±‚ï¼Œå‰é¢çš„è¯·æ±‚ä¼šè¢«å¿½ç•¥æ‰ã€‚

ä½¿ç”¨ifrmaeæ–¹å¼ï¼Œä»¥è°ƒç”¨Nativeç«¯çš„æ–¹æ³•ã€‚

```javascript
var iFrame;
iFrame = document.createElement("iframe");
iFrame.style.height = "1px";
iFrame.style.width = "1px";
iFrame.style.display = "none";
iFrame.src = url;
document.body.appendChild(iFrame);
setTimeout(function(){
    iFrame.remove();
},100);
```

ä¸¾ä¸ªğŸŒ°ï¼š

éœ€æ±‚ï¼š

åŸç”Ÿç«¯æä¾›ä¸€ä¸ªUIWebViewï¼ŒåŠ è½½ä¸€ä¸ªç½‘é¡µå†…å®¹ã€‚è¿˜æœ‰1ä¸ªæŒ‰é’®ï¼ŒæŒ‰é’®ç‚¹å‡»ä¸€ä¸‹ç½‘é¡µå¢åŠ ä¸€æ®µæ®µè½æ–‡æœ¬ã€‚ç½‘é¡µä¸Šæœ‰2ä¸ªè¾“å…¥æ¡†ï¼Œç”¨æˆ·è¾“å…¥æ•°å­—ï¼Œç‚¹å‡»æŒ‰é’®ï¼Œjså°†ç”¨æˆ·è¾“å…¥çš„å‚æ•°å‘Šè¯‰nativeç«¯ï¼Œnativeå»æ‰§è¡ŒåŠ æ³•ï¼Œè®¡ç®—å®Œæˆåå°†ç»“æœè¿”å›ç»™js

```html
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf8">
    <script language="javascript">
        function loadURL(url) {
            var iFrame;
            iFrame = document.createElement("iframe");
            iFrame.style.height = "1px";
            iFrame.style.width = "1px";
            iFrame.style.display = "none";
            iFrame.src = url;
            document.body.appendChild(iFrame);
            setTimeout(function () {
                iFrame.remove();
            }, 100);
        }


        function receiveValue(value) {
            alert("ä»åŸç”Ÿæ‹¿åˆ°åŠ æ³•ç»“æœä¸ºï¼š" + value);
        }

        function check() {
            var par1 = document.getElementById("par1").value;
            var par2 = document.getElementById("par2").value;
            loadURL("JSBridge://plus?par1=" + par1 + "&par2=" + par2);
        }

    </script>
</head>

<body>
    <input type="text" placeholder="è¯·è¾“å…¥æ•°å­—" id="par1" ï¼> +
    <input type="text" placeholder="è¯·è¾“å…¥æ•°å­—" id="par2" ï¼>
    <input type="button" value="=" onclick="check()" />
</body>
</html>
```

```objective-c
-(void)addContentToWebView{
    NSString *jsString = @" var pNode = document.createElement(\"p\"); pNode.innerText = \"æˆ‘æ˜¯ç”±åŸç”Ÿä»£ç è°ƒç”¨jsåå°†ä¸€æ®µæ–‡ä»¶æ·»åŠ åˆ°htmlä¸Šï¼Œä¹Ÿå°±æ˜¯æ³¨å…¥\";document.body.appendChild(pNode);";
    [self.webView stringByEvaluatingJavaScriptFromString:jsString];
}


-(NSInteger)plusparm:(NSInteger)par1 parm2:(NSInteger)par2{
    return par1 + par2;
}


#pragma mark -- UIWebViewDelegate
- (BOOL)webView:(UIWebView *)webView shouldStartLoadWithRequest:(NSURLRequest *)request navigationType:(UIWebViewNavigationType)navigationType{
    NSURL *url = request.URL;
    NSString *scheme = url.scheme;
    NSString *method = url.host;
    NSString *parms =  url.query;
    NSArray *pars = [parms componentsSeparatedByString:@"&"];
    NSInteger par1 = [[pars[0] substringFromIndex:5] integerValue];
    NSInteger par2 = [[pars[1] substringFromIndex:5] integerValue];
    if ([scheme isEqualToString:@"jsbridge"]) {
    //å‘ç°schemeæ˜¯JSBridgeï¼Œé‚£ä¹ˆå°±æ˜¯è‡ªå®šä¹‰çš„URLschemeï¼Œä¸å»åŠ è½½ç½‘é¡µå†…å®¹è€Œæ‹¦æˆªå»å¤„ç†äº‹ä»¶ã€‚

        if ([method isEqualToString:@"plus"]) {
            NSInteger result = [self plusparm:par1 parm2:par2];
            [self.webView stringByEvaluatingJavaScriptFromString:[NSString stringWithFormat:@"receiveValue(%@);",@(result)]];
        }

        return NO;
    }
    return YES;
}
```


## Android ç«¯å¦‚ä½•ä¸ JS é€šä¿¡ï¼ˆ2ç§æ–¹æ³•ï¼‰

- webview.loadUrl()
- Webview.evaluateJavascript()

> 2è€…åŒºåˆ«ï¼š
>
> 1. loadUrl() ä¼šåˆ·æ–°é¡µé¢ï¼ŒevaluateJavascript() åˆ™ä¸ä¼šåˆ·æ–°é¡µé¢ï¼Œæ•ˆç‡é«˜
> 2. loadUrl() å¾—ä¸åˆ° JS çš„è¿”å›å€¼ï¼›evaluateJavascrip() åˆ™å¯ä»¥è·å–è¿”å›å€¼
> 3. evaluateJavascrip() åœ¨ Android 4.4 ä¹‹åæ‰å¯ä»¥ä½¿ç”¨

æ³¨æ„ï¼šAndroid å¯ä»¥ç›´æ¥è°ƒç”¨ JS çš„ alert() æ–¹æ³•æ˜¯å› ä¸º alert æ–¹æ³•ç›´æ¥æŒ‚è½½åœ¨ window å¯¹è±¡ä¸Šã€‚ä½†æ˜¯ Native ä¸ JS å¯èƒ½ä¸æ­¢ä¸€ä¸ªæ–¹æ³•ã€å¤šä¸ªæ–¹æ³•å¤šä¸ªå±æ€§å»è®¿é—®ï¼Œè¿™æ ·éƒ½ç›´æ¥æŒ‚è½½åœ¨ window å¯¹è±¡ä¸Šä¸æ˜¯æ˜æ™ºä¹‹ä¸¾ã€‚å› ä¸ºåæœŸç»´æŠ¤å¾ˆä¸æ–¹ä¾¿ã€‚æ‰€ä»¥æˆ‘ä»¬åœ¨ Native å’Œ JS ä¹‹é—´ä¼šè®¾ç½®ä¸€ä¸ªæ¡¥æ¥å¯¹è±¡ï¼Œåƒä¸€ä¸ªä¸­é—´å±‚ä¸€æ ·ï¼Œè®©2ç«¯äº’è°ƒã€‚

Android éœ€è¦åœ¨é¡µé¢åŠ è½½å®Œï¼Œä¹Ÿå°±æ˜¯ webview çš„ onPageFinished æ–¹æ³•ä¸­å†™è°ƒç”¨é€»è¾‘ï¼Œå¦åˆ™ä¸ä¼šæ‰§è¡Œ

```java
webView.loadUrl("javascript:callJsFunction('soloname')")
webView.evaluateJavascript("javascript:callJsFunction('soloname')"
```


### JS å¦‚ä½•ä¸ Android é€šä¿¡

- é€šè¿‡ Webview çš„ addJavascriptInterface() è¿›è¡Œå¯¹è±¡æ˜ å°„
- é€šè¿‡ WebviewClient çš„ shouldOverrideUrlLoading() æ–¹æ³•å›è°ƒæ‹¦æˆª Url
- é€šè¿‡ webChromeClient çš„ onJsAlert()ã€onJSPrompt() æ–¹æ³•å›è°ƒæ‹¦æˆª JS å¯¹è¯æ¡† alert()ã€confirm()ã€prompt() ç­‰æ¶ˆæ¯

ç¬¬ä¸€ç§æœ€ç®€æ´ï¼Œä½†æ˜¯åœ¨ Android 4.2 ä»¥ä¸‹å­˜åœ¨æ¼æ´ã€‚

å®éªŒï¼šAndroid webview ä¸Šè·‘ä¸€ä¸ªç½‘é¡µï¼Œç‚¹å‡»ç½‘é¡µçš„æŒ‰é’®ï¼Œè®© Native å¼¹å‡ºä¸€ä¸ªå­—ç¬¦ä¸²ã€‚

```vue
methods: {
  showAndroidToast() {
    $App.showToast("å“ˆå“ˆï¼Œæˆ‘æ˜¯jsè°ƒç”¨çš„")
  }
}
```

```
public class JsJavaBridge {

    private Activity activity;
    private WebView webView;

    public JsJavaBridge(Activity activity, WebView webView) {
        this.activity = activity;
        this.webView = webView;
    }

    @JavascriptInterface
    public void onFinishActivity() {
        activity.finish();
    }

    @JavascriptInterface
    public void showToast(String msg) {
        ToastUtils.show(msg);
    }
}

```

ç„¶åé€šè¿‡  webview è®¾ç½® Android ç±»ä¸ JS ä»£ç çš„æ˜ å°„

```
webView.addJavascriptInterface(new JsJavaBridge(this, tbsWebView), "$App");
```

è¿™é‡Œå°†ç±» JsJavaBridge åœ¨ JS ä¸­æ˜ å°„ä¸ºäº† $Appï¼Œæ‰€ä»¥åœ¨ Vue ä¸­å¯ä»¥è¿™æ ·è°ƒç”¨ `$App.showToast("å“ˆå“ˆï¼Œæˆ‘æ˜¯jsè°ƒç”¨çš„")`ã€‚



## åŒæ­¥å’Œå¼‚æ­¥é—®é¢˜

jsè°ƒç”¨nativeæ˜¯é€šè¿‡åœ¨ä¸€ä¸ªç½‘é¡µä¸Šæ’å…¥ä¸€ä¸ªiframeï¼Œè¿™ä¸ªiframeæ’å…¥å®Œäº†å°±å®Œäº†ï¼Œæ‰§è¡Œçš„ç»“æœéœ€è¦nativeå¦å¤–è°ƒç”¨stringByEvaluatingJavaScriptString æ–¹æ³•é€šçŸ¥jsã€‚è¿™æ˜æ˜¾æ˜¯1ä¸ªå¼‚æ­¥çš„è°ƒç”¨ã€‚è€ŒstringByEvaluatingJavaScriptStringæ–¹æ³•ä¼šè¿”å›æ‰§è¡Œjsè„šæœ¬çš„ç»“æœã€‚æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªåŒæ­¥è°ƒç”¨

æ‰€ä»¥js call nativeæ˜¯å¼‚æ­¥ï¼Œnative call jsæ˜¯åŒæ­¥ã€‚
