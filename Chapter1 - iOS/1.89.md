# block åº•å±‚åŸç†

## block æœ¬è´¨

block æœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ª oc å¯¹è±¡ï¼Œä¹Ÿæœ‰ isa æŒ‡é’ˆ

block æ˜¯å°è£…äº†å‡½æ•°è°ƒç”¨å’Œå‡½æ•°è°ƒç”¨ç¯å¢ƒçš„ OC å¯¹è±¡

![](https://github.com/FantasticLBP/knowledge-kit/raw/master/assets/block-structure.png)

```objectivec
int age = 27;
void(^block)(void) = ^(){
Â Â Â Â NSLog(@"age:%d", age);
};
block();
```

`xcrun -sdk iphoneos clang -arch arm64 -rewrite-objc main.m -o main.cpp`

è½¬æ¢ä¸º c++ å¦‚ä¸‹

```c
int age = 27;
void(*block)(void) = &__main_block_impl_0((void *)__main_block_func_0, &__main_block_desc_0_DATA, age));
((void (*)(__block_impl *))((__block_impl *)block)->FuncPtr)((__block_impl *)block);


struct __main_block_impl_0 {
  struct __block_impl impl;
  struct __main_block_desc_0* Desc;
  int age;
  __main_block_impl_0(void *fp, struct __main_block_desc_0 *desc, int _age, int flags=0) : age(_age) {
    impl.isa = &_NSConcreteStackBlock;
    impl.Flags = flags;
    impl.FuncPtr = fp;
    Desc = desc;
  }
};
```

å¯ä»¥çœ‹åˆ° `__main_block_impl_0` æ˜¯ä¸€ä¸ªç»“æ„ä½“ï¼Œæœ‰3ä¸ªå˜é‡ï¼Œå…¶ä¸­ `__main_block_impl_0` æ˜¯ä¸€ä¸ªæ„é€ æ–¹æ³•ï¼Œæ¥æ”¶4ä¸ªå‚æ•°ï¼Œç¬¬å››ä¸ªå‚æ•° flags æ˜¯éå¿…é¡»çš„ã€‚

`__main_block_func_0` å‚æ•°æ˜¯ä¸€ä¸ªæ–¹æ³•å®ç°ã€‚

```c
static void __main_block_func_0(struct __main_block_impl_0 *__cself) {
  int age = __cself->age; // bound by copy

            NSLog((NSString *)&__NSConstantStringImpl__var_folders_z5_ksvb7q252lbdfg78236t7tt00000gn_T_main_eb3c55_mi_0, age);
        }
```

```c
static struct __main_block_desc_0 {
  size_t reserved;
  size_t Block_size;
} __main_block_desc_0_DATA = { 0, sizeof(struct __main_block_impl_0)};
```

`__main_block_desc_0` æ˜¯ä¸€ä¸ª block ä¿¡æ¯çš„æè¿°ï¼Œå ç”¨äº† `sizeof(struct __main_block_impl_0)` å¤§å°çš„ç©ºé—´ã€‚

`void(*block)(void) = &__main_block_impl_0((void *)__main_block_func_0, &__main_block_desc_0_DATA, age));` ç¬¬ä¸€è¡Œä»£ç ä¹Ÿå°±æ˜¯å°†æ„é€ ä¸€ä¸ª struct ç»™ block å˜é‡ã€‚

`((**void** (*)(__block_impl *))((__block_impl *)block)->FuncPtr)((__block_impl *)block);` ç¬¬äºŒè¡Œä»£ç å…¶å®å°±æ˜¯ `block->FuncPtr(block)` æ ¹æ® block å†…éƒ¨ FuncPtr æ–¹æ³•å¹¶è°ƒç”¨ã€‚

```c
static struct __main_block_desc_0 {
  size_t reserved;
  size_t Block_size;
} __main_block_desc_0_DATA = { 0, sizeof(struct __main_block_impl_0)};
```

ä¸ºä»€ä¹ˆ block->FuncPtr å¯ä»¥ç›´æ¥è®¿é—®ï¼Œè€Œä¸æ˜¯ block å…ˆè®¿é—® implï¼Œå†è®¿é—® FuncPtrï¼Ÿå› ä¸º  __block_impl å°±æ˜¯ __main_block_impl_0 è¿™ä¸ªç»“æ„ä½“çš„ç¬¬ä¸€ä¸ªå˜é‡åœ°å€ï¼ˆç»“æ„ä½“ç‰¹æ€§ï¼‰

```c
struct __block_impl {
  void *isa;
  int Flags;
  int Reserved;
  void *FuncPtr;
};
```

ç±»ä¼¼äºä¸‹é¢ä»£ç 

```
struct __main_block_impl_0 {
  void *isa;
  int Flags;
  int Reserved;
  void *FuncPtr;
  struct __main_block_desc_0* Desc;
  int age;
  __main_block_impl_0(void *fp, struct __main_block_desc_0 *desc, int _age, int flags=0) : age(_age) {
    impl.isa = &_NSConcreteStackBlock;
    impl.Flags = flags;
    impl.FuncPtr = fp;
    Desc = desc;
  }
}; 
```

## block å˜é‡æ•è·

```objectivec
int age = 27;
void(^block)(void) = ^(){
    NSLog(@"age:%d", age);
};
age = 30;
block();
```

è¾“å‡º27ã€‚å› ä¸º Block ä¼šå¯¹å˜é‡è¿›è¡Œæ•è·ã€‚

```c
int age = 27;
void(*block)(void) = ((void (*)())&__main_block_impl_0((void *)__main_block_func_0, &__main_block_desc_0_DATA, age));
age = 30;
 ((void (*)(__block_impl *))((__block_impl *)block)->FuncPtr)((__block_impl *)block);
```

å˜é‡åˆ†ä¸ºï¼šstaticã€autoã€registerã€‚

staticï¼šè¡¨ç¤ºä½œä¸ºé™æ€å˜é‡å­˜å‚¨åœ¨æ•°æ®åŒºã€‚

autoï¼šä¸€èˆ¬çš„å˜é‡ä¸åŠ ä¿®é¥°è¯åˆ™é»˜è®¤ä¸º autoï¼Œauto è¡¨ç¤ºä½œä¸ºè‡ªåŠ¨å˜é‡å­˜å‚¨åœ¨æ ˆä¸Šã€‚æ„å‘³ç€ç¦»å¼€ä½œç”¨åŸŸå˜é‡ä¼šè‡ªåŠ¨é”€æ¯ã€‚

registerï¼šè¿™ä¸ªå…³é”®å­—å‘Šè¯‰ç¼–è¯‘å™¨å°½å¯èƒ½çš„å°†å˜é‡å­˜åœ¨CPUå†…éƒ¨å¯„å­˜å™¨ä¸­ï¼Œè€Œä¸æ˜¯é€šè¿‡å†…å­˜å¯»å€è®¿é—®ï¼Œä»¥æé«˜æ•ˆç‡ã€‚æ˜¯å°½å¯èƒ½ï¼Œä¸æ˜¯ç»å¯¹ã€‚å¦‚æœå®šä¹‰äº†å¾ˆå¤š register å˜é‡ï¼Œå¯èƒ½ä¼šè¶…è¿‡CPU çš„å¯„å­˜å™¨ä¸ªæ•°ï¼Œè¶…è¿‡å®¹é‡ã€‚æ‰€ä»¥åªæ˜¯å¯èƒ½ã€‚

| ä½œç”¨åŸŸ        | æ•è·åˆ° block å†…éƒ¨ | è®¿é—®æ–¹å¼ |
| ---------- | ------------ | ---- |
| å±€éƒ¨å˜é‡ auto  | YES          | å€¼ä¼ é€’  |
| å±€éƒ¨å˜é‡static | YES          | æŒ‡é’ˆä¼ é€’ |
| å…¨å±€å˜é‡       | NO           | ç›´æ¥è®¿é—® |

Demo2

```objectivec
auto int age = 27;
static int height = 176;
void(^block)(void) = ^(){
    NSLog(@"age:%d, height: %d", age, height);
};
age = 30;
height = 177;
block();
// age:27, height: 177
```

clang è½¬ä¸º c++

```c
auto int age = 27;
static int height = 176;
void(*block)(void) = ((void (*)())&__main_block_impl_0((void *)__main_block_func_0, &__main_block_desc_0_DATA, age, &height));
age = 30;
height = 177;
((void (*)(__block_impl *))((__block_impl *)block)->FuncPtr)((__block_impl *)block);


struct __main_block_impl_0 {
  struct __block_impl impl;
  struct __main_block_desc_0* Desc;
  int age;
  int *height;
  __main_block_impl_0(void *fp, struct __main_block_desc_0 *desc, int _age, int *_height, int flags=0) : age(_age), height(_height) {
    impl.isa = &_NSConcreteStackBlock;
    impl.Flags = flags;
    impl.FuncPtr = fp;
    Desc = desc;
  }
};
```

å¯ä»¥çœ‹åˆ° static ä¿®é¥°çš„ height åœ¨ c++ ä»£ç åº•å±‚ç”¨æŒ‡é’ˆè¢« block æ•è·ï¼Œæ‰€ä»¥å€¼ä¿®æ”¹åï¼Œæ˜¯æœ€ç»ˆçš„ 177ï¼Œstatic ä¿®é¥°çš„ ageï¼Œè¢« block æ•è·æ˜¯å€¼ä¼ é€’æ–¹å¼ï¼Œæ‰€ä»¥è¿˜æ˜¯27

Demo3

```objectivec
int age = 27;
static int height = 176;
int main(int argc, const char * argv[]) {
    @autoreleasepool {
        void(^block)(void) = ^(){
            NSLog(@"age:%d, height: %d", age, height);
        };
        age = 26;
        height = 177;
        block();
    }
    return 0;
}
```

è½¬ä¸º c++

```c
void(*block)(void) = ((void (*)())&__main_block_impl_0((void *)__main_block_func_0, &__main_block_desc_0_DATA));
age = 26;
height = 177;
((void (*)(__block_impl *))((__block_impl *)block)->FuncPtr)((__block_impl *)block);


struct __main_block_impl_0 {
  struct __block_impl impl;
  struct __main_block_desc_0* Desc;
  __main_block_impl_0(void *fp, struct __main_block_desc_0 *desc, int flags=0) {
    impl.isa = &_NSConcreteStackBlock;
    impl.Flags = flags;
    impl.FuncPtr = fp;
    Desc = desc;
  }
};
static void __main_block_func_0(struct __main_block_impl_0 *__cself) {
    NSLog((NSString *)&__NSConstantStringImpl__var_folders_z5_ksvb7q252lbdfg78236t7tt00000gn_T_main_65da50_mi_0, age, height);
}
```

å¯ä»¥çœ‹åˆ°å…¨å±€å˜é‡æ˜¯ç›´æ¥è®¿é—®çš„ï¼Œä¸è¿›è¡Œæ‹·è´ã€‚

ä¸ºä»€ä¹ˆè¿™ä¹ˆè®¾è®¡ï¼Ÿ

å› ä¸º auto ä¿®é¥°çš„å˜é‡ä¸€å‡ºä½œç”¨åŸŸé©¬ä¸Šå›æ”¶ï¼Œæ‰€ä»¥ block ä¸ºäº†è‡ªèº«è¿è¡Œä¿¡æ¯çš„å®Œæ•´æ€§ï¼Œæ‰€ä»¥ä¼šæ•è·ã€‚static ä¿®é¥°çš„å˜é‡ï¼Œæ•°æ®ä¸€ç›´åœ¨å†…å­˜ä¸­ï¼Œæ‰€ä»¥æ‰§è¡Œ block ä»£ç çš„æ—¶å€™æ˜¯ç”¨æŒ‡é’ˆè·å–å†…å­˜ä¸­æœ€æ–°çš„æ•°æ®ã€‚å…¨å±€å˜é‡ä¸ä¼šæ•è·ã€‚

self ä¼šæ•è·å—ï¼Ÿ

ä¼šï¼Œå› ä¸º self å°±æ˜¯å±€éƒ¨å˜é‡ã€‚ ä¸€ä¸ª oc æ–¹æ³•è½¬æ¢ä¸º `void test(Person *self, SEL _cmd)` å½¢å¼ï¼Œæ‰€ä»¥ self ä¹Ÿæ˜¯å±€éƒ¨å˜é‡ï¼Œä¼šè¢«æ•è·

## block ç±»å‹

block çš„ç±»å‹å¯ä»¥é€šè¿‡ isa æˆ–è€… class æ–¹æ³•æŸ¥çœ‹ï¼Œæœ€ç»ˆéƒ½æ˜¯ç»§æ‰¿è‡ª NSBlock ç±»å‹

`__NSGlobalBlock__` (`_NSConcreteGlobalBlock`)ï¼šç¨‹åºçš„æ•°æ®åŒºåŸŸï¼ˆ.data åŒºï¼‰

`__NSStackBlock__` (`_NSConcreteStackBlock`)

`__NSMallocBlock__`(`_NSConcreteMallockBlock`)

```objectivec
void(^block)(void) = ^(){
    NSLog(@"Hello block");
};
NSLog(@"%@", [block class]); // __NSGlobalBlock__
NSLog(@"%@", [[block class] superclass]); // NSBlock
NSLog(@"%@", [[[block class] superclass] superclass]); // NSObjec
```

![](https://github.com/FantasticLBP/knowledge-kit/raw/master/assets/block-memorylayout.png)

ä»£ç å­˜æ”¾åœ¨ text æ®µï¼Œstatic ä¿®é¥°çš„æ•°æ®å­˜æ”¾åœ¨ data åŒºï¼Œç¨‹åºå‘˜æ‰‹åŠ¨ç”³è¯·çš„å†…å­˜å­˜æ”¾åœ¨å †ï¼Œå±€éƒ¨å˜é‡å­˜æ”¾åœ¨æ ˆåŒº

### å¦‚ä½•åˆ¤æ–­ block å±äºä»€ä¹ˆç±»å‹

Demo1

```objectivec
void(^block)(void) = ^{
    NSLog(@"");
};
int main(int argc, const char * argv[]) {
    @autoreleasepool {
        NSLog(@"%@", [block class]);
    }
    return 0;
}
```

`__NSGlobalBlock__` ï¼Œæ­¤**ç±»å‹çš„ block ç”¨ç»“æ„ä½“å®ä¾‹çš„å†…å®¹ä¸ä¾èµ–äºæ‰§è¡Œæ—¶çš„çŠ¶æ€ï¼Œæ‰€ä»¥æ•´ä¸ªç¨‹åºåªéœ€è¦1ä¸ªå®ä¾‹ã€‚å› æ­¤å­˜æ”¾äºå…¨å±€å˜é‡ç›¸åŒçš„æ•°æ®åŒºåŸŸå³å¯ã€‚**

```objectivec
void(^block)(void);
void test()
{
    int age = 22;
    block = ^ {
        NSLog(@"ag:%d", age);
    };
}
int main(int argc, const char * argv[]) {
    @autoreleasepool {
        test(); 
        block();   // age:-1074793800  
    }
    return 0;
}
```

ä¸ºä»€ä¹ˆä¼šæ‰“å°å‡º `age:-1074793800`ã€‚ å› ä¸º block è®¿é—®äº†auto å˜é‡ï¼Œæ‰€ä»¥æ˜¯ `__NSStackBlock__`ã€‚é‚£ä¹ˆ block å†…éƒ¨çš„æ•°æ®åœ¨æ ˆä¸Šç»´æŠ¤ï¼Œå½“å‡ºäº† test æ–¹æ³•åï¼Œblock å†…éƒ¨å˜é‡çš„åœ°å€åˆ°åº•æŒ‡å‘ä»€ä¹ˆæ˜¯ä¸ç¡®å®šçš„ï¼Œå¯èƒ½ä¼šå‡ºç°å¼‚å¸¸ã€‚

| block ç±»å‹            | ç¯å¢ƒ                             |
| ------------------- | ------------------------------ |
| `__NSGlobalBlock__` | æ²¡æœ‰è®¿é—® auto å˜é‡                   |
| `__NSStackBlock__`  | è®¿é—®äº† auto å˜é‡                    |
| `__NSMallocBlock__` | `__NSStackBlock__` è°ƒç”¨äº† copy æ–¹æ³• |

Demo1: 

```objectivec
MyBlock block;
{
    Person *person = [[Personalloc] init];
    block = ^{
        NSLog(@"block called");
    };
    NSLog(@"%@", [block class]); 
};
```

MRC ç¯å¢ƒï¼š å¦‚æœ block ä¸è®¿é—®å¤–éƒ¨å±€éƒ¨å˜é‡ï¼Œåˆ™`__NSGlobalBlock__`

ARC ç¯å¢ƒï¼šå¦‚æœ block ä¸è®¿é—®å¤–éƒ¨å±€éƒ¨å˜é‡ï¼Œåˆ™`__NSGlobalBlock__`

Demo2: 

```objectivec
typedef void(^MyBlock)(void);
int main(int argc, const char * argv[]) {
    @autoreleasepool {
        MyBlock block;
        {
            auto Person *person = [[Person alloc] init];
            person.age = 10;
            block = ^{
                NSLog(@"age:%zd", person.age);
            };
            NSLog(@"%@", [block class]);    // __NSStackBlock__
        };
    }
    return 0;
}
```

MRC ç¯å¢ƒä¸‹ï¼šå¦‚æœè®¿é—®äº† auto å˜é‡ï¼Œåˆ™ä¸º `__NSStackBlock__`

ARC ç¯å¢ƒä¸‹ï¼š**ARC ä¸‹é¢æ¯”è¾ƒç‰¹æ®Šï¼Œé»˜è®¤å±€éƒ¨å˜é‡å¯¹è±¡éƒ½æ˜¯å¼ºæŒ‡é’ˆï¼Œå­˜æ”¾åœ¨å †é‡Œé¢ã€‚æ‰€ä»¥ block ä¸º `__NSMallocStack__`**

Demo3: 

```objectivec
typedef void(^MyBlock)(void);
int main(int argc, const char * argv[]) {
    @autoreleasepool {
        MyBlock block;
        {
            auto Person *person = [[Person alloc] init];
            person.age = 10;
            block = [^{
                NSLog(@"age:%zd", person.age);
            } copy];
            NSLog(@"%@", [block class]);    // __NSMallocBlock__
        };
    }
    return 0;
}
```

MRC ä¸‹ï¼šå¦‚æœ block è°ƒç”¨ copy æ–¹æ³•ï¼Œåˆ™ block ä¸º `__NSMallocStck__`

ARC ä¸‹ï¼šå¦‚æœ block è°ƒç”¨ copy æ–¹æ³•ï¼Œåˆ™  block ä»æ—§ä¸º `__NSMallocBlock__`ã€‚`__NSMallocBlock__` è°ƒç”¨ copy ä»æ—§ä¸º `__NSMallocBlock__`

åœ¨ ARC ä¸‹ï¼Œå¦‚æœæœ‰ä¸€ä¸ªå¼ºæŒ‡é’ˆå¼•ç”¨ blockï¼Œåˆ™ block ä¼šè¢«æ‹·è´åˆ°å †ä¸Šï¼Œæˆä¸º  `__NSMallocStck`



| Block ç±»                     | åŸæœ¬ä½ç½®   | å¤åˆ¶æ•ˆæœ   |     |
| --------------------------- | ------ | ------ | --- |
| `__NSConcreteStackBlock__`  | æ ˆ      | æ ˆå¤åˆ¶åˆ°å †  |     |
| `__NSConcreteGlobalBlock__` | ç¨‹åºçš„æ•°æ®æ®µ | ä»€ä¹ˆä¹Ÿä¸åš  |     |
| `__NSConcreteMallocBlock__` | å †      | å¼•ç”¨è®¡æ•°+1 |     |

### å†…å­˜ç®¡ç†

### æ€è€ƒé¢˜

æŸ¥çœ‹ block ç¼–è¯‘æˆ c++ ä»£ç çš„æºç å¯ä»¥å‘ç° `__main_block_desc_0` ç»“æ„ä½“å†…éƒ¨æ˜¯å˜åŒ–çš„ã€‚ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿreservedã€Block_size æ˜¯ä¸€ç›´æœ‰çš„ï¼Œvoid (*copy)ã€void (*dispose) åªæœ‰åœ¨ä¿®é¥°å¯¹è±¡çš„æ—¶å€™æ‰æœ‰ã€‚ä¸ºä»€ä¹ˆè¿™ä¹ˆè®¾è®¡ï¼Ÿ

```c
static struct __main_block_desc_0 {
  size_t reserved;
  size_t Block_size;
  void (*copy)(struct __main_block_impl_0*, struct __main_block_impl_0*);
  void (*dispose)(struct __main_block_impl_0*);
} __main_block_desc_0_DATA = { 0, sizeof(struct __main_block_impl_0), __main_block_copy_0, __main_block_dispose_0};
```

å› ä¸º block ä¼šå¯¹å˜é‡è¿›è¡Œå†…å­˜ç®¡ç†ã€‚`void *copy`ã€`void *dispose` éƒ½æ˜¯å†…å­˜ç®¡ç†çš„æ–¹æ³•ã€‚

å¦‚æœ block è®¿é—®çš„ä¸æ˜¯å¯¹è±¡ï¼Œåˆ™ç»“æ„ä½“æ²¡æœ‰  `void *copy`ã€`void *dispose`

Demo1:

```objectivec
{
    Person *person = [[Person alloc] init];
    dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(3 * NSEC_PER_SEC)), dispatch_get_main_queue(), ^{
        NSLog(@"1---%@", person);
    }); 
}
```

1s å person æ‰§è¡Œäº† dealloc æ–¹æ³•

Demo2

```objectivec
{
    __weak Person *person = [[Person alloc] init];
    dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(3 * NSEC_PER_SEC)), dispatch_get_main_queue(), ^{
        NSLog(@"1---%@", person);
    });
}
```

é©¬ä¸Šæ‰§è¡Œäº† Person çš„ dealloc æ–¹æ³•ã€‚å› ä¸º `__weak` ä¿®é¥°ï¼Œblock å†…éƒ¨çš„ `_Block_object_assign` ä¼šæ ¹æ® `__strong` ä¸ºå¯¹è±¡å¼•ç”¨è®¡æ•° +1ï¼Œ`__weak` åˆ™å¼•ç”¨è®¡æ•°ä¸å˜ã€‚æ‰€ä»¥æ˜¯ `__weak` ä¿®é¥°ï¼Œå‡ºç¦»ä½œç”¨åŸŸåˆ™ç«‹é©¬ä¼šé‡Šæ”¾ Person å¯¹è±¡ã€‚

`_Block_object_assign` ä¼šæ ¹æ®å†…å­˜ä¿®é¥°ç¬¦æ¥å¯¹å†…å­˜è¿›è¡Œæ“ä½œã€‚

Demo3

```objectivec
{
    Person *person = [[Person alloc] init];
    __weak Person *weakP = person;
    dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(1 * NSEC_PER_SEC)), dispatch_get_main_queue(), ^{
        NSLog(@"1---%@", person);
        dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(2 * NSEC_PER_SEC)), dispatch_get_main_queue(), ^{
            NSLog(@"2---%@", person);
        });
    });
}
```

3s åæ‰§è¡Œ Person çš„  dealloc

Demo4 

```objectivec
{
    Person *person = [[Person alloc] init];
    __weak Person *weakP = person;
    dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(1 * NSEC_PER_SEC)), dispatch_get_main_queue(), ^{
        NSLog(@"1---%@", weakP);
        dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(2 * NSEC_PER_SEC)), dispatch_get_main_queue(), ^{
            NSLog(@"2---%@", person);
        });
    });
}
```

3s åæ‰§è¡Œ Person çš„ dealloc æ–¹æ³•

Demo5

```objectivec
{
    Person *person = [[Person alloc] init];
    __weak Person *weakP = person;
    dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(1 * NSEC_PER_SEC)), dispatch_get_main_queue(), ^{
        NSLog(@"1---%@", person);
        dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(2 * NSEC_PER_SEC)), dispatch_get_main_queue(), ^{
            NSLog(@"2---%@", weakP);
        });
    });
}
```

1s åæ‰§è¡Œ Person çš„ dealloc æ–¹æ³•ã€‚

ç»“è®ºï¼šblock ä½œä¸º GCD API çš„æ–¹æ³•å‚æ•°æ—¶ï¼Œå¦‚æœ block å†…éƒ¨è®¿é—®äº†å¯¹è±¡ï¼Œå¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸç»“æŸéœ€è¦æŸ¥çœ‹å¼ºå¼•ç”¨ç»“æŸæ—¶åˆ»ã€‚

### ARC ç¯å¢ƒä¸‹ç¼–è¯‘å™¨ä¼šè‡ªåŠ¨ä¼š block copy å¤åˆ¶åˆ°å †ä¸Š

1. block ä½œä¸ºå‡½æ•°è¿”å›å€¼æ—¶ï¼ˆå¦‚æœæ ˆ blockï¼Œç¦»å¼€æ–¹æ³•ä½œç”¨åŸŸä¹‹åï¼Œreturn ç»™æ–°çš„å˜é‡åŒºä½¿ç”¨ï¼Œç”±äºæ ˆå˜åŒ–äº†ï¼Œæ‰€ä»¥ä¸å®‰å…¨ã€‚æ¯”å¦‚è®¿é—® auto å˜é‡çš„æ ˆ blockï¼Œå¯èƒ½æŸä¸ªå˜é‡å·²ç»ä¸æ˜¯ä¹‹å‰çš„æŸä¸ªå€¼äº†ï¼‰

2. å°† block èµ‹å€¼ç»™ __strong æŒ‡é’ˆæ—¶

3. block ä½œä¸º Cocoa API ä¸­æ–¹æ³•åå«æœ‰ usingBlock çš„æ–¹æ³•å‚æ•°æ—¶

4. block ä½œä¸º GCD API çš„æ–¹æ³•å‚æ•°æ—¶

æ ˆç©ºé—´çš„ block ä¸ä¼šå¯¹å˜é‡è¿›è¡Œ copy æ“ä½œ

å †ç©ºé—´çš„ block ä¼šå †å˜é‡è‡ªåŠ¨è¿›è¡Œ copy æ“ä½œ

`__NSStackBlock__` å†…éƒ¨è®¿é—®äº†å¯¹è±¡ï¼Œé»˜è®¤æ˜¯ `__strong` ä¿®é¥°ã€‚å¦‚æœå¯¹è±¡æ˜¯ `__weak` åˆ™ block è½¬æ¢ c++ å†…éƒ¨æ•è·çš„å¯¹è±¡ï¼Œä¹Ÿç”¨ weak ä¿®é¥°

```c
typedef void(^MyBlock)(void);
int main(int argc, const char * argv[]) {
    @autoreleasepool {
        MyBlock block;
        {
            __weak Person *person = [[Person alloc] init];
            person.age = 27;
            block = ^{
                NSLog(@"age:%zd", person.age);
            };
            person.age = 28;
        };
    }
    return 0;
}

struct __main_block_impl_0 {
  struct __block_impl impl;
  struct __main_block_desc_0* Desc;
  Person *__weak person;
  __main_block_impl_0(void *fp, struct __main_block_desc_0 *desc, Person *__weak _person, int flags=0) : person(_person) {
    impl.isa = &_NSConcreteStackBlock;
    impl.Flags = flags;
    impl.FuncPtr = fp;
    Desc = desc;
  }
};
```

## block ä¿®æ”¹å˜é‡

Demo1

```objectivec
typedef void(^MyBlock)(void);
int main(int argc, const char * argv[]) {
    @autoreleasepool {
        int age = 27;
        MyBlock block = ^{
            age = 28;
        };
        NSLog(@"%zd", age);
    }
    return 0;
}
```

è¿è¡Œä¼šæŠ¥é”™ `// Variable is not assignable (missing __block type specifier)` ä¸ºä»€ä¹ˆä¸èƒ½ä¿®æ”¹ï¼Ÿç»§ç»­æŸ¥çœ‹ c++ æºä»£ç 

```c
static void __main_block_func_0(struct __main_block_impl_0 *__cself) {
  int age = __cself->age; // bound by copy
    NSLog((NSString *)&__NSConstantStringImpl__var_folders_z5_ksvb7q252lbdfg78236t7tt00000gn_T_main_f31a48_mi_0, age);
}

static struct __main_block_desc_0 {
  size_t reserved;
  size_t Block_size;
} __main_block_desc_0_DATA = { 0, sizeof(struct __main_block_impl_0)};
int main(int argc, const char * argv[]) {
    /* @autoreleasepool */ { __AtAutoreleasePool __autoreleasepool; 
        int age = 27;
        MyBlock block = ((void (*)())&__main_block_impl_0((void *)__main_block_func_0, &__main_block_desc_0_DATA, age));
        NSLog((NSString *)&__NSConstantStringImpl__var_folders_z5_ksvb7q252lbdfg78236t7tt00000gn_T_main_f31a48_mi_1, age);
    }
    return 0;
}
```

å¯ä»¥çœ‹åˆ°åœ¨ block å†…éƒ¨ä¿®æ”¹å¤–éƒ¨å˜é‡ä¹Ÿå°±æ˜¯åœ¨æ–°åˆ›å»ºçš„å‡½æ•°å†…éƒ¨ï¼Œä¿®æ”¹ main å‡½æ•°å†…éƒ¨çš„å˜é‡ ğŸ˜‚ è¿™æ€ä¹ˆå¯èƒ½ï¼Ÿ

å…¨å±€å˜é‡ã€static å˜é‡åœ¨ block å†…éƒ¨å¯ä»¥ä¿®æ”¹ã€‚

- `__block` ç”¨äºè§£å†³ block å†…éƒ¨æ— æ³•ä¿®æ”¹ auto å˜é‡çš„é—®é¢˜ã€‚

- `__block` ä¸èƒ½ä¿®é¥° staticã€å…¨å±€å˜é‡

- ç¼–è¯‘å™¨ä¼šå°† `__block` ä¿®é¥°çš„å˜é‡åŒ…è£…ä¸ºä¸€ä¸ªå¯¹è±¡ï¼ˆåç»­ä¿®æ”¹åˆ™é€šè¿‡æŒ‡é’ˆæ‰¾åˆ°ç»“æ„ä½“å¯¹è±¡ï¼Œç»“æ„ä½“å¯¹è±¡å†ä¿®æ”¹é‡Œé¢çš„å€¼ï¼‰

Demo

```objectivec
__block int age = 27;
MyBlock block = ^{
    age = 28;
};
```

è½¬ä¸º C++ 

```c
__attribute__((__blocks__(byref))) __Block_byref_age_0 age = {(void*)0,(__Block_byref_age_0 *)&age, 0, sizeof(__Block_byref_age_0), 27};
        MyBlock block = ((void (*)())&__main_block_impl_0((void *)__main_block_func_0, &__main_block_desc_0_DATA, (__Block_byref_age_0 *)&age, 570425344));
        NSLog((NSString *)&__NSConstantStringImpl__var_folders_z5_ksvb7q252lbdfg78236t7tt00000gn_T_main_f0f60a_mi_0, (age.__forwarding->age));

struct __Block_byref_age_0 {
  void *__isa;
__Block_byref_age_0 *__forwarding;
 int __flags;
 int __size;
 int age;
};

static void __main_block_func_0(struct __main_block_impl_0 *__cself) {
  __Block_byref_age_0 *age = __cself->age; // bound by ref
  (age->__forwarding->age) = 28;
}
```

å¯ä»¥çœ‹åˆ° `__block int age = 27;` å˜ä¸ºäº† `__Block_byref_age_0 age` ç»“æ„ä½“ã€‚block å†…éƒ¨çš„å‡½æ•°åœ¨ä¿®æ”¹ age çš„æ—¶å€™å…¶å®å°±æ˜¯é€šè¿‡ `__main_block_impl_0` ç»“æ„ä½“çš„ age æ‰¾åˆ° `__Block_byref_age_0`ï¼Œç„¶åè®¿é—® `__Block_byref_age_0` ä¸­çš„æˆå‘˜å˜é‡ `__forwarding` è®¿é—®æˆå‘˜å˜é‡ ageï¼Œå¹¶ä¿®æ”¹å€¼ã€‚

![](https://github.com/FantasticLBP/knowledge-kit/raw/master/assets/block-forwarding.png)

 `__block` ä¿®é¥°åŸºæœ¬æ•°æ®ç±»å‹å’Œå¯¹è±¡ï¼Œå¯¹äºç”Ÿæˆçš„ç»“æ„ä½“ä¹Ÿä¸ä¸€æ ·ã€‚

QAï¼šä¸ºä»€ä¹ˆ`__block` å˜é‡çš„ `__Block_byref_age_0` ç»“æ„ä½“å¹¶ä¸åœ¨ block ç»“æ„ä½“ `__main_block_impl_0` ä¸­ï¼Ÿ

å› ä¸ºè¿™æ ·åšå¯ä»¥åœ¨å¤šä¸ª block ä¸­ä½¿ç”¨ `__block` å˜é‡ã€‚

Demo

```objectivec
struct __Block_byref_age_0 {
  void *__isa;
__Block_byref_age_0 *__forwarding;
 int __flags;
 int __size;
 int age;
};

struct __Block_byref_p_1 {
  void *__isa;
__Block_byref_p_1 *__forwarding;
 int __flags;
 int __size;
 void (*__Block_byref_id_object_copy)(void*, void*);
 void (*__Block_byref_id_object_dispose)(void*);
 NSObject *p;
};
```

block åªè¦å’Œå¯¹è±¡æ‰“äº¤é“ï¼Œç»“æ„ä½“é‡Œé¢è¦ç®¡ç†å†…å­˜ï¼Œæ‰€ä»¥ä¼šæœ‰ `void *copy` ,`void *dispose`  

block å†…éƒ¨æ“ä½œæ•°ç»„ç­‰ç±»å‹ï¼Œä¸éœ€è¦åŠ  `__block`



Demoï¼šçŸ¥é“ `__block` çš„æœ¬ä¹‹åï¼Œä¸‹é¢æ‰“å°çš„ age çš„åœ°å€æ˜¯ struct é‡Œé¢å“ªä¸ªçš„å€¼ï¼Ÿ

```objectivec
__block int age = 27;
MyBlock block = ^{
    age = 28;
};
NSLog(@"%p", &age);
```

çŸ¥é“è½¬æ¢ä¸ºc++åçš„æ•ˆæœï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä»£ç ä¸­æŒ‰ç…§ç»“æ„ä½“ï¼Œè‡ªå·±å®šä¹‰å¹¶è½¬æ¥åˆ° block

```objectivec
struct __Block_byref_age_0 {
  void *__isa;  // 0x0000000105231f70 +8
 struct __Block_byref_age_0 *__forwarding; // 0x0000000105231f78 + 8
 int __flags; // 0x0000000105231f80 +4
 int __size; // 0x0000000105231f84 + 4
 int age;   // 0x0000000105231f88
};

struct __block_impl {
  void *isa;
  int Flags;
  int Reserved;
  void *FuncPtr;
};

struct __main_block_desc_0 {
  size_t reserved;
  size_t Block_size;
  void (*copy)(void);
    void (*dispose)(void);
};

struct __main_block_impl_0 {
  struct __block_impl impl;
  struct __main_block_desc_0* Desc;
  struct __Block_byref_age_0 *age; // by ref
};


typedef void(^MyBlock)(void);
int main(int argc, const char * argv[]) {
    @autoreleasepool {
        __block int age = 27;
        MyBlock block = ^{
            age = 28;
        };
        struct __main_block_impl_0 *blockImpl = (__bridge struct __main_block_impl_0 *)block;
        NSLog(@"%p", &age);
    }
    return 0;
}
```

æˆ‘ä»¬å°†æ–­ç‚¹è®¾ç½®åˆ° NSLog è¿™é‡Œï¼Œæ‰“å°å‡ºè‡ªå®šä¹‰ç»“æ„ä½“ `__main_block_impl_0` ä¸­çš„ age ã€‚

![](https://github.com/FantasticLBP/knowledge-kit/raw/master/assets/Block-variableAddress.png)

```c
// 0x0000000105231f70
struct __Block_byref_age_0 {
  void *__isa;  // åœ°å€ï¼š0x0000000105231f70 é•¿åº¦ï¼š+8
 struct __Block_byref_age_0 *__forwarding; //  åœ°å€ï¼š0x0000000105231f78 é•¿åº¦ï¼š+8
 int __flags; // åœ°å€ï¼š0x0000000105231f80 é•¿åº¦ï¼š+4
 int __size; // åœ°å€ï¼š0x0000000105231f84 é•¿åº¦ï¼š+4
 int age;   // åœ°å€ï¼š0x0000000105231f88
};

```

å°†åœ°å€æ‰“å°å‡ºæ¥ã€‚è¯¥åœ°å€å°±æ˜¯ `__Block_byref_age_0`  ç»“æ„ä½“çš„åœ°å€ï¼Œä¹Ÿå°±æ˜¯ç»“æ„ä½“å†…ç¬¬ä¸€ä¸ª `isa` çš„åœ°å€ã€‚æˆ‘ä»¬è®¡ç®—ä¸‹ï¼Œè§„åˆ™å¦‚ä¸‹ï¼š

- æŒ‡é’ˆé•¿åº¦8ä¸ªå­—èŠ‚

- int é•¿åº¦4ä¸ªå­—èŠ‚

ç®—å‡ºæ¥ age çš„åœ°å€ä¸º `0x0000000105231f88` ï¼Œæ­¤æ—¶ Xcode æ‰“å°å‡ºçš„åœ°å€ä¹Ÿæ˜¯ `0x105231f88`ã€‚å…¶å®ä¹Ÿå°±æ˜¯ `blockImple->age->age` çš„åœ°å€

block å†…éƒ¨å¯¹å˜é‡çš„å€¼ä¿®æ”¹å…¶å®å°±æ˜¯å¯¹ block å†…éƒ¨è‡ªå®šä¹‰ç»“æ„ä½“å†…éƒ¨çš„å˜é‡ä¿®æ”¹ã€‚

å½“ block è¢« copy åˆ°å †ä¸Š

- ä¼šè°ƒç”¨ block å†…éƒ¨çš„ copy å‡½æ•°

- copy å‡½æ•°å†…éƒ¨ä¼šè°ƒç”¨ `_Block_object_assign` å‡½æ•°

- `_Block_object_assign` å‡½æ•°ä¼šæ ¹æ®æ‰€æŒ‡å‘å¯¹è±¡çš„ä¿®é¥°ç¬¦ï¼ˆ__strongã€__weakã€__unsafe_unretainedï¼‰åšå‡ºç›¸åº”çš„æ“ä½œï¼Œå½¢æˆå¼ºå¼•ç”¨ï¼ˆretainï¼‰æˆ–è€…å¼±å¼•ç”¨ï¼ˆæ³¨æ„ï¼šè¿™é‡Œä»…é™äºARCæ—¶ä¼šretainï¼ŒMRCæ—¶ä¸ä¼šretainï¼‰

å½“ block ä»å †ä¸­ç§»é™¤

- ä¼šè°ƒç”¨ block å†…éƒ¨çš„ dispose å‡½æ•°

- dispose å‡½æ•°ä¼šè°ƒç”¨ `_Block_object_dispose` å‡½æ•°

- `_Block_object_dispose` å‡½æ•°ä¼šè‡ªåŠ¨é‡Šæ”¾ `__block` ä¿®é¥°çš„å˜é‡ï¼ˆreleaseï¼‰



## `__forwarding` çš„è®¾è®¡

![](https://github.com/FantasticLBP/knowledge-kit/raw/master/assets/block_forwarding.png) 

å½“blockåœ¨æ ˆä¸­æ—¶ï¼Œ`__Block_byref_age_0`ç»“æ„ä½“å†…çš„`__forwarding`æŒ‡é’ˆæŒ‡å‘ç»“æ„ä½“è‡ªå·±ã€‚

è€Œå½“blockè¢«å¤åˆ¶åˆ°å †ä¸­æ—¶ï¼Œæ ˆä¸­çš„`__Block_byref_age_0`ç»“æ„ä½“ä¹Ÿä¼šè¢«å¤åˆ¶åˆ°å †ä¸­ä¸€ä»½ï¼Œè€Œæ­¤æ—¶æ ˆä¸­çš„`__Block_byref_age_0`ç»“æ„ä½“ä¸­çš„`__forwarding`æŒ‡é’ˆæŒ‡å‘çš„å°±æ˜¯å †ä¸­çš„`__Block_byref_age_0`ç»“æ„ä½“ï¼Œå †ä¸­`__Block_byref_age_0`ç»“æ„ä½“å†…çš„`__forwarding`æŒ‡é’ˆä¾ç„¶æŒ‡å‘è‡ªå·±ã€‚





## Block å†…å­˜å¼•ç”¨

è¢« `__block ` ä¿®é¥°ç¬¦ä¿®é¥°çš„å¯¹è±¡åœ¨å†…å­˜ä¸­å¦‚ä¸‹

![](https://github.com/FantasticLBP/knowledge-kit/raw/master/assets/block-object-memoery.png)

```c

int main(int argc, const char * argv[]) {
    /* @autoreleasepool */ { __AtAutoreleasePool __autoreleasepool; 
       __attribute__((__blocks__(byref))) __Block_byref_p_0 p = {(void*)0,(__Block_byref_p_0 *)&p, 33554432, sizeof(__Block_byref_p_0), __Block_byref_id_object_copy_131, __Block_byref_id_object_dispose_131, ((Person *(*)(id, SEL))(void *)objc_msgSend)((id)((Person *(*)(id, SEL))(void *)objc_msgSend)((id)objc_getClass("Person"), sel_registerName("alloc")), sel_registerName("init"))};
        void(*block)(void) = ((void (*)())&__main_block_impl_0((void *)__main_block_func_0, &__main_block_desc_0_DATA, (__Block_byref_p_0 *)&p, 570425344));
    }
    return 0;
}


static void __Block_byref_id_object_copy_131(void *dst, void *src) {
 _Block_object_assign((char*)dst + 40, *(void * *) ((char*)src + 40), 131);
}

static void __main_block_copy_0(struct __main_block_impl_0*dst, struct __main_block_impl_0*src) {
    _Block_object_assign((void*)&dst->p, (void*)src->p, 8/*BLOCK_FIELD_IS_BYREF*/);
}
```



å¦‚æœ `__block` ä¿®é¥° `__strong` åˆ™è¡¨ç¤º block_impl ç»“æ„ä½“ä¸­çš„ person æˆå‘˜å˜é‡æŒ‡å‘ä¸€ä¸ªæ–°çš„ç»“æ„ä½“ `__Block_byref_person_0`ã€‚è¿™ä¸ªçº¿æ˜¯å¼ºå¼•ç”¨ã€‚

`__Block_byref_person_0` ç»“æ„ä½“æˆå‘˜å˜é‡ person çœŸæ­£çš„ Person å¯¹è±¡çš„å¼•ç”¨å…³ç³»è¦çœ‹ block å¤–éƒ¨ person çš„ä¿®é¥°æ˜¯ `__strong` è¿˜æ˜¯ `__weak`ï¼Œå› ä¸ºä»æ ˆä¸Šæ‹·è´åˆ°å †ä¸Šï¼Œä¼šè°ƒç”¨ block çš„ desc çš„ `__main_block_copy_0`ï¼Œæœ¬è´¨ä¸Šè°ƒç”¨çš„æ˜¯ `_Block_object_assign` 

`__Block_byref_id_object_copy_131` æ–¹æ³•é‡Œçš„ 40 ä»£è¡¨ä»€ä¹ˆ?

```c

struct __Block_byref_p_0 {
    void *__isa; 8
__Block_byref_p_0 *__forwarding;    8
    int __flags; 4
    int __size; 4
    void (*__Block_byref_id_object_copy)(void*, void*); 8
    void (*__Block_byref_id_object_dispose)(void*); 8
    Person *p;
};


__attribute__((__blocks__(byref))) __Block_byref_p_0 p = {
    0,
    &p,
    33554432,
    sizeof(__Block_byref_p_0),
    __Block_byref_id_object_copy_131,
    __Block_byref_id_object_dispose_131,
    ((Person *(*)(id, SEL))(void *)objc_msgSend)((id)((Person *(*)(id, SEL))(void *)objc_msgSend)((id)objc_getClass("Person"), sel_registerName("alloc")), sel_registerName("init"))
    
};
```

`__Block_byref_p_0` ç»“æ„ä½“åœ°å€ä¸Šåç§»40å°±æ˜¯ p å¯¹è±¡ã€‚





## å¾ªç¯å¼•ç”¨

 self æ˜¯ä¸€ä¸ªå±€éƒ¨å˜é‡ï¼Œblock è®¿é—® selfï¼Œå³å­˜åœ¨æ•è·å˜é‡çš„æ•ˆæœã€‚

### ARC ä¸‹

 `__weak`ã€`__unsafe_unretained`ã€`__block``

åŒºåˆ«åœ¨äºï¼š`__weak` ä¸ä¼šäº§ç”Ÿå¼ºå¼•ç”¨ï¼ŒæŒ‡å‘çš„å¯¹è±¡é”€æ¯æ—¶ï¼Œä¼šè‡ªåŠ¨ç»™æŒ‡é’ˆç½®ä¸º nil

`__unsafe_retained` ä¸ä¼šäº§ç”Ÿå¼ºå¼•ç”¨ï¼Œä¸å®‰å…¨ã€‚å½“æŒ‡å‘çš„å¯¹è±¡é”€æ¯æ—¶ï¼ŒæŒ‡é’ˆåœ°å€å€¼ä¸å˜ã€‚



```objectivec
@interface Person : NSObject
@property (nonatomic, assign) NSInteger age;
@property (nonatomic, copy) void (^block)(void);
- (void)test;
@end

@implementation Person
- (void)dealloc
{
    NSLog(@"%s", __func__);
}
- (void)test
{
Â Â Â Â 
    __weak typeof(self) weakself = self;
    self.block = ^{
        weakself.age = 23;
    };
    self.block();
    NSLog(@"age:%ld",  (long)self.age);
}
@end

Person *p = [[Person alloc] init];
[p test];
```

æ–¹æ³•1: `__weak` ä¿®é¥°ã€‚`__weak typeof(self) weakself = self;`

æ–¹æ³•2: `__unsafe_retained` ä¿®é¥°ã€‚`**__unsafe_unretained** **typeof**(**self**) weakself = **self**;`

æ–¹æ³•3: `__block` ä¿®é¥°ã€‚å› ä¸ºæ­¤æ—¶ä¼šæ„æˆ3è§’å…³ç³»ã€‚æ‰€ä»¥éœ€è¦è°ƒç”¨ blockã€‚block å†…éƒ¨éœ€è¦å°†å¯¹è±¡è®¾ç½®ä¸º nilã€‚

```objectivec
__block Person *weakself = [[Person alloc] init];
p.block = ^{
    weakself.age = 23;
    NSLog(@"%ld", weakself.age);
    weakself = nil;
};
p.block();
```

`__unsafe_retained` å› ä¸ºä¸å®‰å…¨æ‰€ä»¥ä¸æ¨èï¼Œ`__block` å› ä¸ºä½¿ç”¨ç¹çï¼Œä¸”å¿…é¡»ç­‰åˆ°è°ƒç”¨ block æ‰ä¼šé‡Šæ”¾å†…å­˜ï¼Œæ‰€ä»¥ä¸æ¨èã€‚ARC ä¸‹æœ€ä½³ç”¨ `__weak`

![](https://github.com/FantasticLBP/knowledge-kit/raw/master/assets/block_object_cycle.png)

### MRC ä¸‹

æ–¹æ³•1: `__unsafe_retained` ä¿®é¥°ã€‚`**__unsafe_unretained** **typeof**(**self**) weakself = **self**;`

æ–¹æ³•2: `__block` ä¿®é¥°ã€‚MRC ä¸‹ä¸ä¼šå¯¹ block å†…éƒ¨çš„å¯¹è±¡å¼•ç”¨è®¡æ•° +1





## æ€»ç»“

block æœ¬è´¨æ˜¯ä»€ä¹ˆï¼Ÿ

å°è£…äº†å‡½æ•°è°ƒç”¨åŠå…¶è°ƒç”¨ç¯å¢ƒçš„ OC å¯¹è±¡



`__block` çš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ

å¯ä»¥å¯¹ block å¤–éƒ¨çš„å˜é‡è¿›è¡Œæ•è·ï¼Œå¯ä»¥ä¿®æ”¹ã€‚ä½†æ˜¯éœ€è¦æ³¨æ„å†…å­˜ç®¡ç†ç›¸å…³é—®é¢˜ã€‚æ¯”å¦‚`__weak`ã€`__unsafe_unretained`ã€`__block` 



ä¿®æ”¹ NSMutableArray ä¸éœ€è¦åŠ  `__block`?

æ˜¯çš„