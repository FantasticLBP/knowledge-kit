# DYLD åŠ Mach-O 

ä»€ä¹ˆæ˜¯ DYLDï¼Ÿdynamic loaderï¼ŒåŠ¨æ€åŠ è½½å™¨ã€‚åœ¨ MacOS/iOS ä¸­ï¼Œæ˜¯ä½¿ç”¨ `/usr/lib/dyld` ç¨‹åºæ¥åŠ è½½åŠ¨æ€åº“çš„ã€‚



## ä»æºæ–‡ä»¶åˆ°å¯æ‰§è¡Œæ–‡ä»¶åšäº†ä»€ä¹ˆï¼Ÿ

é—®ï¼šæºæ–‡ä»¶ -> å¯æ‰§è¡Œæ–‡ä»¶ï¼Œæ˜¯ä¸æ˜¯åªéœ€è¦ç»è¿‡ç¼–è¯‘å°±å¤Ÿäº†ï¼Ÿ

ä¸æ˜¯çš„ã€‚ä»æºæ–‡ä»¶åˆ°å¯æ‰§è¡Œæ–‡ä»¶ï¼Œéœ€è¦ç»è¿‡ç¼–è¯‘ã€é“¾æ¥2ä¸ªæ­¥éª¤ï¼š

- ç¼–è¯‘ï¼šå°†æºä»£ç è½¬ä¸ºäº†äºŒè¿›åˆ¶æœºå™¨æŒ‡ä»¤ã€‚ä¿å­˜è¿™äº›äºŒè¿›åˆ¶æœºå™¨æŒ‡ä»¤çš„æ–‡ä»¶ï¼Œå«åšç›®æ ‡æ–‡ä»¶ `.o` æ–‡ä»¶ã€‚æ¯ä¸ªæºæ–‡ä»¶å¯¹åº”ä¸€ä¸ªç›®æ ‡æ–‡ä»¶ã€‚
- é“¾æ¥ï¼šå¾—åˆ°ç›®æ ‡æ–‡ä»¶æ€ä¹ˆå˜æˆå¯æ‰§è¡Œç¨‹åºå‘¢ï¼Ÿé“¾æ¥å™¨å°†è¿™äº›ç›®æ ‡æ–‡ä»¶æ‰“åŒ…æˆæœ€ç»ˆå¯æ‰§è¡Œç¨‹åºã€‚é™¤äº†æ‰“åŒ…ç›®æ ‡æ–‡ä»¶å¤–ï¼Œé“¾æ¥å™¨è¿˜ä¼šæ‰“åŒ…ä¸€ä¸ªéå¸¸é‡è¦çš„ä¸œè¥¿ï¼Œå°±æ˜¯æ ‡å‡†åº“ã€‚å¯æ‰§è¡Œç¨‹åº = ç¨‹åºå‘˜å†™çš„ä»£ç  + ä½¿ç”¨åˆ°çš„æ ‡å‡†åº“ï¼ˆåŠ¨æ€åº“/é™æ€åº“ï¼‰ã€‚

é‚£çœ‹ä¸Šå»é“¾æ¥å™¨åšçš„äº‹æƒ…å¾ˆç®€å•ï¼Œä¸å°±æ˜¯ä¸ªæ‰“åŒ…å·¥å…·ï¼Ÿ**é“¾æ¥å™¨æœ€é‡è¦çš„å·¥ä½œå°±æ˜¯å†³å®šç¬¦å·ï¼ˆå˜é‡åã€å‡½æ•°åï¼‰çš„å®šä¹‰**

```c++
#include <Foundation/Foundation.h>

int main() {
	NSLog(@"Hello world");
	return 0;
}
```

ä¾‹å¦‚ä¸Šé¢çš„ä»£ç  `main.m`ã€‚ç¼–è¯‘å™¨åœ¨ç¼–è¯‘ `main.m`  æ—¶é‡åˆ° NSLogï¼Œæ ¹æœ¬ä¸çŸ¥é“è¿™ä¸ª `NSLog` ç¬¦å·å®šä¹‰åœ¨å“ªé‡Œï¼Œè¿™ä¸æ˜¯ç¼–è¯‘å™¨è¯¥å…³å¿ƒçš„äº‹æƒ…ã€‚å› æ­¤ï¼Œç¼–è¯‘å™¨åªèƒ½çœ‹åˆ°å±€éƒ¨ï¼Œåªèšç„¦å…³å¿ƒä¸€ä¸ªå½“å‰çš„æºæ–‡ä»¶ã€‚åˆ°åº•è°æ¥å…³å¿ƒè¿™ä¸ª NSLog ç¬¦å·å®šä¹‰åœ¨å“ªå‘¢ï¼Ÿè¿™å°±æ˜¯é“¾æ¥å™¨ã€‚

é“¾æ¥å™¨æ‰“åŒ…æ‰€æœ‰çš„ç›®æ ‡æ–‡ä»¶ï¼Œå› ä¸ºé“¾æ¥å™¨å¯ä»¥çœ‹åˆ°å…¨å±€ï¼Œå…·æœ‰ä¸Šå¸è§†è§’ï¼Œå› æ­¤é“¾æ¥å™¨ä»ä¾èµ–çš„åº“ä¸­å»æŸ¥æ‰¾ NSLog è¿™ä¸ªç¬¦å·ï¼Œå¦‚æœæ‰¾ä¸åˆ°åˆ™ä¼šæŠ¥ç»å…¸çš„é”™è¯¯   `undefined reference to  ***`

ç¼–è¯‘å™¨åªèƒ½å°† NSLog è¿™ä¸ªå‡½æ•°çš„è·³è½¬åœ°å€æš‚æ—¶è®¾ç½®ä¸º0ï¼Œéšååœ¨é“¾æ¥çš„æ—¶å€™å†å»ä¿®æ­£å®ƒã€‚



ä¸€æ­¥æ­¥éªŒè¯ä¸‹ï¼š

ç¬¬ä¸€æ­¥ï¼Œå°† main.m ç¼–è¯‘ä¸º main.o æ–‡ä»¶ã€‚æŒ‡ä»¤å¦‚ä¸‹

```shell
clang -target x86_64-apple-macos13.1 \
  -fobjc-arc \
  -isysroot /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX13.1.sdk \
  -c main.m -o main.o
```

ç¬¬äºŒæ­¥ï¼Œå·²ç»å¾—åˆ°äº† main.o ç›®æ ‡æ–‡ä»¶ï¼Œä¹Ÿå°±æ˜¯äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œåˆ©ç”¨æŒ‡ä»¤ `objdump -r main.o` æŸ¥çœ‹ç›®æ ‡æ–‡ä»¶ä¸­çš„å†…å®¹

<img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/ObjdumpWatchObjectFile.png" style="zoom:30%" />

å¯ä»¥çœ‹åˆ° main å‡½æ•°ä¸­ï¼Œcallq å°±æ˜¯è°ƒç”¨ NSLog å‡½æ•°ã€‚åé¢çš„åœ°å€å†™ä¸ºäº† 0ï¼Œè¿™é‡Œçš„0ä¼šåœ¨åé¢é“¾æ¥çš„è¿‡ç¨‹ä¸­è¢«ä¿®æ­£ã€‚

ç¬¬ä¸‰æ­¥ï¼Œå¦å¤–ä¸ºäº†èƒ½è®©é“¾æ¥å™¨èƒ½å¤Ÿå®šä½åˆ°è¿™äº›éœ€è¦è¢«ä¿®æ­£çš„åœ°å€ï¼Œåœ¨ä»£ç å—ä¸­å¯ä»¥çœ‹åˆ°ä¸€ä¸ªé‡å®šä½è¡¨ã€‚æŒ‡ä»¤ä¸º `objdump -r main.o`

<img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/ObjdumpWatchObjectFileWithRelocationTable.png" style="zoom:30%" />

NSLog ä½äºåç§»é‡ä¸º19çš„ä½ç½®ï¼Œ

ç¬¬å››æ­¥ï¼Œé“¾æ¥ç›®æ ‡æ–‡ä»¶åˆ°å¯æ‰§è¡Œæ–‡ä»¶ï¼ŒæŒ‡ä»¤ä¸º 

```shell
clang -target x86_64-apple-macos13.1 \
  -fobjc-arc \
  -isysroot /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX13.1.sdk \
  main.o -o main
```

å› ä¸ºç›®å‰ Foundation å·²ç»å­˜åœ¨äºç³»ç»Ÿç›®å½•ï¼Œæ‰€ä»¥ä¸éœ€è¦é¢å¤–æŒ‡å®šåŠ¨æ€åº“/é™æ€åº“è·¯å¾„äº†ã€‚



## è¾“å‡ºé‡å®šå‘

<img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/XcodeBuildScriptOutputRedirect.png" style="zoom:30%" />

ç»ˆç«¯è¾“å…¥ `tty` æ•²å›è½¦ï¼Œç„¶ååœ¨ Xcode è„šæœ¬ä¸­ï¼Œå°±å¯ä»¥å°† echo è¾“å‡ºçš„ç»“æœé‡å®šå‘åˆ°ç»ˆç«¯ `echo "message" > /dev/ttys000`

å› ä¸ºè¦ç¼–å†™è„šæœ¬ï¼Œç ”ç©¶ MachO æ–‡ä»¶ï¼Œä½†æ¯æ¬¡ç¼–è¯‘åçš„ MachO è¿˜è¦ show in Finderï¼Œä¹‹åå†åˆ‡æ¢åˆ°ç»ˆç«¯ï¼Œç„¶åæ‰§è¡Œè„šæœ¬å¾ˆç¹çã€‚æ‰€ä»¥å¯ä»¥ç›´æ¥åœ¨ Xcode çš„ Build Phases ä¸­ï¼Œå¢åŠ è„šæœ¬è§£å†³è¯¥é—®é¢˜ã€‚

ä½† Build Phases ä¸­çš„ Run Script é•¿åº¦æœ‰é™ï¼Œä¸èƒ½å†™å¾ˆå¤šè„šæœ¬ï¼Œæ‰€ä»¥è¿˜æ˜¯éœ€è¦ç»“åˆ Xcconfigã€‚

Xcconfig ä¸­å®šä¹‰çš„å˜é‡åœ¨ Run Script ä¸­æ˜¯å¯ä»¥è®¿é—®çš„åˆ°ã€‚

Demo éªŒè¯å¦‚ä¸‹ï¼š

<img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/XcconfigFileCanVisitByXcodeScript.png" style="zoom:25%" />



## ç¬¦å·å¯è§æ€§

æŒ‰ç…§å…ˆåé¡ºåº

- ç”Ÿæˆç›®æ ‡æ–‡ä»¶é˜¶æ®µï¼š`-O1ã€O2ã€O3ã€Osã€Oz`
- é“¾æ¥ï¼šæ­»ä»£ç å‰¥ç¦» dead code strip
- ç¼–è¯‘åçš„äº§ç‰© mach-oï¼šstrip å‰¥ç¦»ç¬¦å·



## MachO å¯è¯»å¯å†™

Apple çš„æœºåˆ¶ï¼Œåªè¦æ–‡ä»¶å¯ä»¥æ­£ç¡®ç­¾åï¼ŒApple å°±è®¤ï¼Œå¯ä»¥ä¿®æ”¹ã€‚



## ç¼–è¯‘é˜¶æ®µåšäº†ä»€ä¹ˆ 

- æ±‡ç¼–
- å°†ç¬¦å·å½’ç±»ï¼š
  - æ•°æ®ï¼Œæ”¾åœ¨æ•°æ®æ®µ
  - å¯ä»¥è·å–åˆ°åœ°å€çš„ç¬¦å·ï¼Œå˜æˆåœ°å€
  - ç±»ä¼¼ NSLog è¿™ç§åªæœ‰åœ¨é“¾æ¥çš„æ—¶å€™æ‰å¯ä»¥ç¡®å®šä¸€äº›ä¸œè¥¿ï¼Œé‚£è¿™ç§æš‚æ—¶æ— æ³•ç¡®å®šåœ°å€çš„ç¬¦å·ï¼Œéƒ½ç»Ÿä¸€æš‚å­˜èµ·æ¥ã€‚å«åšâ€œé‡å®šä½ç¬¦å·è¡¨â€ã€‚fishhook å°±æ˜¯åŸºäºæ­¤æ¥å®ç°ç³»ç»Ÿç¬¦å·çš„ hook
- é“¾æ¥ã€‚é“¾æ¥å™¨é€šè¿‡é“¾æ¥å°†é‡å®šä½ç¬¦å·è¡¨å’Œç¬¦å·è¡¨åˆå¹¶åˆ°ä¸€å¼ è¡¨ä¸­ï¼Œç›®æ ‡æ–‡ä»¶ï¼ˆ`.o` æ–‡ä»¶ï¼‰å’Œç¬¦å·è¡¨ï¼Œåˆå¹¶åˆ°ä¸€èµ·ï¼Œ

å¦‚ä½•æ‰¾å‡ºéœ€è¦é‡å®šä½çš„ç¬¦å·ï¼Ÿ

```shell
objdump --macho --reloc MachOAndSymbol.o
```



two_levelnamespace & flat_namespace:

â¼†çº§å‘½åç©ºé—´ä¸â¼€çº§å‘½åç©ºé—´ã€‚é“¾æ¥å™¨é»˜è®¤é‡‡â½¤â¼†çº§å‘½åç©ºé—´ï¼Œä¹Ÿå°±æ˜¯é™¤äº†ä¼šè®°å½•ç¬¦å·åç§°ï¼Œè¿˜ä¼šè®°å½•ç¬¦å·å±äºå“ªä¸ªMach-Oçš„ï¼Œâ½å¦‚ä¼šè®°å½•ä¸‹æ¥_NSLogæ¥â¾ƒFoundationã€‚



## ç¬¦å·

- å…¨å±€ç¬¦å·å¯¹æ•´ä¸ªé¡¹ç›®å¯è§ï¼Œå¯¹ä½¿ç”¨çš„åœ°æ–¹å¯è§ï¼Œæ•´ä¸ªç¬¦å·è¡¨éƒ½å¯è§ã€‚

- Static åªå¯¹å®šä¹‰æ‰€åœ¨çš„æ–‡ä»¶å¯è§ã€‚

ç¬¦å·çš„ç§ç±»

| Symbol Type | **è¯´æ˜**                                                     |
| ----------- | ------------------------------------------------------------ |
| **U**       | undefinedï¼ˆæœªå®šä¹‰ï¼‰                                          |
| **A**       | absoluteï¼ˆç»å¯¹ç¬¦å·ï¼‰                                         |
| **T**       | text section symbol(__TEXT.__text)                           |
| **D**       | data section symbol(__DATA.__data)                           |
| **B**       | bss section symbol(__DATA.__bss)                             |
| **C**       | common symbolï¼ˆåªèƒ½å‡ºç°åœ¨`MH_OBJECT` ç±»å‹çš„`Mach-O`â½‚ä»¶ä¸­ï¼‰  |
| **-**       | debugger symbol table                                        |
| **S**       | é™¤äº†ä¸Šâ¾¯æ‰€è¿°çš„ï¼Œå­˜æ”¾åœ¨å…¶ä»–`section`çš„å†…å®¹ï¼Œä¾‹å¦‚æœªåˆå§‹åŒ–çš„å…¨å±€å˜é‡å­˜æ”¾åœ¨(__DATA,__common)ä¸­ |
| **I**       | indirect symbolï¼ˆç¬¦å·ä¿¡æ¯ç›¸åŒï¼Œä»£è¡¨åŒâ¼€ç¬¦å·ï¼‰                |
| **U**       | åŠ¨æ€å…±äº«åº“ä¸­çš„â¼©å†™uè¡¨ç¤ºâ¼€ä¸ªæœªå®šä¹‰å¼•â½¤å¯¹åŒâ¼€åº“ä¸­å¦â¼€ä¸ªæ¨¡å—ä¸­ç§æœ‰å¤–éƒ¨ç¬¦å· |

ç¼–è¯‘ `main.m` åˆ° `main.o` 

```shell
clang -target x86_64-apple-macos13.1 \
  -fobjc-arc \
  -isysroot /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX13.1.sdk \
  -c main.m -o main.o
```

ä½¿ç”¨ `nm -pa  .oæ–‡ä»¶è·¯å¾„` å‘½ä»¤æ¥æŸ¥çœ‹ç¬¦å·

<img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/NMListAllKindOfSymbol.png" style="zoom:45%" />





### ç¬¦å·çš„åˆ†ç±»

- Common Symbolï¼šåœ¨å®šä¹‰æ—¶ï¼Œæœªåˆå§‹åŒ–çš„å…¨å±€ç¬¦å·ã€‚

  æœ‰è¶£çš„ featureï¼š

  ```c++
  int global_int_age = 28;
  int global_int_age;
  
  void main() {
  	print("Hello world");
  }
  ```

  ä¸Šé¢çš„ä»£ç ä¸ä¼šç¼–è¯‘æŠ¥é”™ã€‚å½“å­˜åœ¨2ä¸ªåŒåçš„å…¨å±€ç¬¦å·ï¼Œä¸€ä¸ªåˆå§‹åŒ–äº†ï¼Œä¸€ä¸ªæœªåˆå§‹åŒ–ï¼Œä¸ä¼šæŠ¥é”™ã€‚åœ¨ç¼–è¯‘é“¾æ¥é˜¶æ®µï¼Œå½“æ‰¾åˆ°å®šä¹‰ä¹‹åï¼Œæœªå®šä¹‰çš„ä¼šè¢«åˆ æ‰ã€‚

  é’ˆå¯¹å…¨å±€ç¬¦å·ï¼š

  - å½“å­˜åœ¨2ä¸ªåŒåçš„å…¨å±€ç¬¦å·ï¼Œä¸€ä¸ªåˆå§‹åŒ–äº†ï¼Œä¸€ä¸ªæœªåˆå§‹åŒ–ï¼Œä¸ä¼šæŠ¥é”™ã€‚åœ¨ç¼–è¯‘é“¾æ¥é˜¶æ®µï¼Œå½“æ‰¾åˆ°å®šä¹‰ä¹‹åï¼Œæœªå®šä¹‰çš„ä¼šè¢«åˆ æ‰ã€‚
  - é“¾æ¥å™¨é»˜è®¤ä¼šæŠŠæœªåˆå§‹åŒ–çš„å…¨å±€ç¬¦å·ï¼Œç»™å¼ºåˆ¶åˆå§‹åŒ–æ‰ã€‚æ¯”å¦‚ `int global_age;` åˆå§‹åŒ–ä¸º `int global_age = 0;`

- 



ç”Ÿæˆç›®æ ‡æ–‡ä»¶åˆ†è¿‡ç¨‹ä¸­ï¼Œåªéœ€è¦å¤´æ–‡ä»¶ä¿¡æ¯ï¼ˆå¤´æ–‡ä»¶è·¯å¾„ï¼‰ï¼Œåªéœ€è¦é‡å®šä½ç¬¦å·è¡¨ï¼ŒçŸ¥é“å“ªäº›ç¬¦å·éœ€è¦é‡å®šä½ï¼Œé“¾æ¥çš„æ—¶å€™ï¼Œä¼šè‡ªåŠ¨å°†ç¬¦å·é‡å®šä½ã€‚



## vim å¿«é€ŸæŸ¥æ‰¾ API åŠŸèƒ½

`man nm`



<img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/VimManNm.png" style="zoom:45%" />

è¿›å…¥ vim æ¨¡å¼äº†ï¼Œçœ‹åˆ°å·¦ä¸‹è§’æœ‰ `:` å…‰æ ‡ï¼Œå¦‚æœæƒ³æŸ¥çœ‹å½“å‰ nm å‘½ä»¤çš„å‚æ•°ï¼Œå¯ä»¥å¿«é€ŸæŸ¥æ‰¾ï¼Œè¾“å…¥ `/ + å…·ä½“å‚æ•°`ï¼Œæ•²å›è½¦å³å¯è·³è½¬åˆ°è¦åŒ¹é…åˆ°çš„ä½ç½®ï¼Œå¦‚æœæœ‰å¤šä¸ªç»“æœï¼Œä¸”å½“å‰è‡ªåŠ¨è·³è½¬åˆ°çš„ä¸æ˜¯æ­£ç¡®çš„ä½ç½®ï¼Œvim æ¨¡å¼ä¸‹å¯ä»¥è¾“å…¥ `n` è·³è½¬åˆ°ä¸‹ä¸€ä¸ªåŒ¹é…åˆ°çš„ä½ç½®ï¼ˆn å³ nextï¼‰ï¼Œè¾“å…¥ `N` åˆ™è·³è½¬åˆ°ä¸Šä¸€ä¸ªåŒ¹é…åˆ°çš„ä½ç½®ã€‚



æ¯”å¦‚æŸ¥æ‰¾ `-p`ï¼Œåˆ™è¾“å…¥ `/-p`ï¼Œæ•²å›è½¦çš„æ•ˆæœå¦‚ä¸‹

<img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/VimModeManNMSearchMode.png" style="zoom:45%" />



### ç¬¦å·çš„å¯¼å…¥å¯¼å‡ºåŠ App ç˜¦èº«

ä»£ç ä¸­ä½¿ç”¨äº† Foundation åº“çš„ NSLogï¼ŒNSLog å¯¹äºä¸šåŠ¡ä»£ç æ¥è¯´ï¼Œå°±æ˜¯ä¸€ä¸ªå¯¼å…¥çš„ç¬¦å·ï¼Œå¯¹äº Foundation åº“æ¥è¯´ï¼Œå°±æ˜¯ä¸€ä¸ªå¯¼å‡ºçš„ç¬¦å·ã€‚

ä»€ä¹ˆç¬¦å·å¯ä»¥æ˜¯å¯¼å‡ºçš„ç¬¦å·ï¼Ÿå…¨å±€ç¬¦å·å¯ä»¥æ˜¯å¯¼å‡ºç¬¦å·ã€‚

App æˆ–è€…ä¸€ä¸ª MachO ä¸­ï¼Œæ‰€æœ‰ä½¿ç”¨åˆ°çš„åŠ¨æ€åº“çš„ç¬¦å·ï¼Œéƒ½ä¿å­˜åœ¨é—´æ¥ç¬¦å·è¡¨ä¸­ï¼Œè¿™äº›é—´æ¥ç¬¦å·è¡¨ä¸­çš„æ•°æ®ï¼Œæ¥è‡ªäºåŠ¨æ€åº“ä¸­ã€‚

åŠ¨æ€åº“ï¼Œå…¨å±€ç¬¦å· -> å¯¼å‡ºç¬¦å·

é—´æ¥ç¬¦å·è¡¨ -> åŠ¨æ€åº“ç¬¦å·

æ‰€ä»¥ï¼ŒStrip ç¬¦å·çš„æ—¶å€™ï¼Œå¯èƒ½ä¸èƒ½ Strip å…¨å±€ç¬¦å·ã€‚



OC ä»£ç ï¼Œé»˜è®¤éƒ½æ˜¯å¯¼å‡ºçš„å…¨å±€ç¬¦å·ï¼Œæ‰€ä»¥å®¹æ˜“å ç©ºé—´ï¼Œæƒ³è®©ä½“ç§¯å˜å°ï¼Œå°±å¯ä»¥å°½é‡ä¸æƒ³æš´éœ²çš„ç¬¦å·ï¼Œä½¿ç”¨é“¾æ¥å™¨çš„èƒ½åŠ›ï¼Œå°†ä¸éœ€è¦æš´éœ²çš„ç¬¦å·ä¸æš´éœ²å‡ºå»ã€‚

```shell
OTHER_LDFLAGS=$(inherited) -Xinker -unexported_symbol -Xlinker _OBJC_CLASS_$_Person
```



é™æ€åº“ = `.o` æ–‡ä»¶çš„åˆé›† + é‡å®šä½ç¬¦å·è¡¨ã€‚ä½†é‡å®šä½ç¬¦å·è¡¨ä¸­çš„ç¬¦å·ä¸èƒ½ stripï¼Œæ‰€ä»¥åªèƒ½ strip `.o` æ–‡ä»¶çš„è°ƒè¯•ç¬¦å·ã€‚



QAï¼šä»ç¬¦å·è§’åº¦å‡ºå‘ï¼ŒåŠ¨æ€åº“è¿˜æ˜¯é™æ€åº“å¯¹äº App ç˜¦èº«è¾ƒå¥½ï¼ˆæ›´æœ‰æŠ“æ‰‹ï¼‰ï¼Ÿä½¿ç”¨åŠ¨æ€åº“è¿˜æ˜¯é™æ€åº“ä¼šæåŠæ›´å°ï¼Ÿ

- App åœ¨é“¾æ¥é™æ€åº“çš„æ—¶å€™ï¼Œé™æ€åº“å°±æ˜¯ .o æ–‡ä»¶çš„åˆé›†ï¼Œä¼šæŠŠ `.o`  ä¸­çš„ç¬¦å·ï¼ˆåŒ…æ‹¬å¯ä»¥é‡å®šä½çš„ç¬¦å·ï¼‰ï¼Œéƒ½æ”¾åˆ° App è‡ªèº«çš„ç¬¦å·è¡¨ä¸­ï¼Œä¹Ÿå°±æ„å‘³ç€å¯èƒ½æ˜¯ï¼šæœ¬åœ°ç¬¦å·ã€å…¨å±€ç¬¦å·ã€å¯¼å‡ºç¬¦å·ã€‚æ ¹æ® Strip çš„åŸç†ï¼ŒStrip å¯ä»¥è„±ç¦»é™¤äº†é—´æ¥ç¬¦å·è¡¨ä¹‹å¤–çš„æ‰€æœ‰ç¬¦å·ã€‚

  é™æ€åº“é“¾æ¥çš„æ—¶å€™ï¼Œé™¤äº†é—´æ¥ç¬¦å·è¡¨ï¼Œå…¶ä»–åŒºåŸŸéƒ½æœ‰å¯èƒ½æ”¾ã€‚æ‰€ä»¥é“¾æ¥é™æ€åº“å ç”¨ä½“ç§¯æ›´å°ã€‚

- App åœ¨é“¾æ¥åŠ¨æ€åº“çš„æ—¶å€™ï¼Œæ­£å¥½ç›¸åï¼ŒApp é“¾æ¥çš„åŠ¨æ€åº“çš„ç¬¦å·éƒ½æ”¾åˆ°äº†é—´æ¥ç¬¦å·è¡¨ä¸­ï¼Œå³ä½¿ Strip æ‰€æœ‰ç¬¦å·ï¼Œä¹Ÿä¸å¯èƒ½è„±æ‰é—´æ¥ç¬¦å·è¡¨ä¸­çš„ç¬¦å·ã€‚

æ‰€ä»¥å¤§å®¶åœ¨å†™ SDK çš„æ—¶å€™ï¼Œå¯ä»¥ä»ç¬¦å·è§’åº¦å‡ºå‘æƒ³æƒ³ï¼Œæ˜¯é€‰æ‹©é™æ€åº“è¿˜æ˜¯åŠ¨æ€åº“ã€‚é’ˆå¯¹åŠ¨æ€åº“ï¼Œå¯ä»¥ strip å¯¼å‡ºç¬¦å·ã€‚é»˜è®¤ OC çš„ç¬¦å·éƒ½æ˜¯å¯¼å‡ºçš„ã€‚



## Strip

é™æ€åº“/ .o æ–‡ä»¶ Strip æµç¨‹ï¼š å¤„ç†  `_DWARF` æ®µ

<img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/StaticLibararyStripProcess.png" style="zoom:70%" />

Strip çš„è¿‡ç¨‹ï¼Œå°±æ˜¯åœ¨ä¿®æ”¹ Mach-O æ–‡ä»¶ä¸­çš„å†…å®¹ã€‚





åŠ¨æ€åº“

<img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/DyanmicLibraryStripProcess.png" style="zoom:70%" />

All Symbols

<img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/AllSymbolStripProcess.png" style="zoom:70%" />



Non-Global Symbolsï¼ˆéå…¨å±€ç¬¦å·ï¼‰ï¼š



<img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/ExternalSymbolStripProcess.png" style="zoom:70%" />





## æ–­ç‚¹

- ç»ˆç«¯ LLDB æ¨¡å¼ä¸‹é€šè¿‡å‘½ä»¤æ·»åŠ çš„æ–­ç‚¹æ˜¯é€šç”¨çš„ï¼Œæ˜¯ç¬¦å·æ–­ç‚¹ã€‚é€šè¿‡ `br write -f æ–‡ä»¶è·¯å¾„` å¯ä»¥å°†æ–­ç‚¹å¯¼å‡ºï¼Œå…±äº«ç»™å…¶ä»–äºº
- Xcode GUI æ·»åŠ çš„æ–­ç‚¹æ˜¯å¸¦æœ‰ç»å¯¹è·¯å¾„çš„ï¼Œé€šè¿‡ `br write -f æ–‡ä»¶è·¯å¾„` å¯¼å‡ºçš„æ–­ç‚¹ä¿¡æ¯åœ¨å¸¦æœ‰æ–‡ä»¶çš„ç»å¯¹è·¯å¾„ï¼Œä¸æ–¹ä¾¿å…±äº«ã€‚è¦åšçš„å°±æ˜¯æ–‡ä»¶è·¯å¾„çš„æ›¿æ¢ã€‚



## é“¾æ¥

æºä»£ç ç¼–è¯‘æˆç›®æ ‡æ–‡ä»¶ã€‚

```shell
clang -x objective-c \
-target x86_64-apple-macos11.1 \
-fobjc-arc \
-isysroot /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX13.1.sdk \
-c main.m -o main.o
```

<img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/NMListAllKindOfSymbol.png" style="zoom:45%" />

ä» `.o` ç›®æ ‡æ–‡ä»¶é“¾æ¥ä¸ºå¯æ‰§è¡Œæ–‡ä»¶ 

```shell
 clangå‘½ä»¤å‚æ•°ï¼š
     -x: æŒ‡å®šç¼–è¯‘æ–‡ä»¶è¯­è¨€ç±»å‹
     -g: ç”Ÿæˆè°ƒè¯•ä¿¡æ¯
     -c: ç”Ÿæˆç›®æ ‡æ–‡ä»¶ï¼Œåªè¿è¡Œpreprocessï¼Œcompileï¼Œassembleï¼Œä¸é“¾æ¥
     -o: è¾“å‡ºæ–‡ä»¶
     -isysroot: ä½¿ç”¨çš„SDKè·¯å¾„
     1. -I<directory> åœ¨æŒ‡å®šç›®å½•å¯»æ‰¾å¤´æ–‡ä»¶ header search path
     2. -L<dir> æŒ‡å®šåº“æ–‡ä»¶è·¯å¾„ï¼ˆ.a\.dylibåº“æ–‡ä»¶ï¼‰ library search path
     3. -l<library_name> æŒ‡å®šé“¾æ¥çš„åº“æ–‡ä»¶åç§°ï¼ˆ.a\.dylibåº“æ–‡ä»¶ï¼‰other link flags -lAFNetworking
     -F<directory> åœ¨æŒ‡å®šç›®å½•å¯»æ‰¾framework framework search path
     -framework <framework_name> æŒ‡å®šé“¾æ¥çš„frameworkåç§° other link flags -framework AFNetworking
```



```shell
clang -target x86_64-apple-macos13.1 \
-fobjc-arc \
-isysroot /Applications/Xcode.app/Contents/Developer/Platforms/MaxOSX.platform/Developer/SDKs/MacOSX11.sdk \
-L./AFNetworking \
-lAFNetworking \
test.o -o test
```



## æ¢ç´¢ã€Œé™æ€åº“å°±æ˜¯ .o æ–‡ä»¶çš„åˆé›†ã€

`.a` é™æ€åº“ï¼Œ`.dylib` åŠ¨æ€åº“ä½¿ç”¨æœ‰é—®é¢˜ï¼Œä¸€èˆ¬æ˜¯ï¼š

- header search path
- library search path
- other link flags

è¿™3ä¸ªçš„ä¸€ä¸ªæˆ–è€…å¤šä¸ªé€ æˆçš„é—®é¢˜ï¼Œç€æ‰‹å»æ’æŸ¥é—®é¢˜å³å¯ã€‚



åšä¸ªå®éªŒï¼ŒéªŒè¯ä¸‹é™æ€åº“å…¶å®å°±æ˜¯ `.o` æ–‡ä»¶çš„åˆé›†ã€‚

ç¬¬ä¸€æ­¥ï¼Œç¼–å†™ oc ä»£ç ï¼Œå°±ä¸€ä¸ª Person ç±»ï¼Œå†™ä¸€ä¸ªç±»æ–¹æ³•ï¼Œç¼–è¯‘ä¸ºé™æ€åº“ã€‚`Person.m` ç¼–è¯‘ä¸º `Person.o`

ç¬¬äºŒæ­¥ï¼Œåˆ©ç”¨ clang å°† `person.o`  è½¬æ¢ä¸ºé™æ€åº“ã€‚

<img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/ConvertObjectFileToStaticLib.png" style="zoom:40%" />

å…¶å®ï¼Œè¿™é‡Œå°±å·²ç»å¯ä»¥éªŒè¯ã€Œé™æ€åº“å°±æ˜¯ .o æ–‡ä»¶çš„åˆé›†ã€ã€‚

åˆ©ç”¨ `objdump --macho --private-header Person.dylib` æŸ¥çœ‹é™æ€åº“ä¾æ—§æ˜¯ `Object File` 

<img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/ObjdumpWatchStatisLibraryIsObjectFile.png" style="zoom:40%" />

ç¬¬ä¸‰æ­¥ï¼Œç¼–å†™ä»£ç  `main.m` ä»£ç ï¼Œå¯¼å…¥é™æ€åº“ `<Person.h>`

```objective-c
#import <Foundation/Foundation.h>
#import <Person.h>

int main(int argc, char * argv[]) {
    Person *p = [[Person alloc] init];
    [p sayHi];
    NSLog(@"%@", p);
}
```

ç¬¬å››æ­¥ï¼Œåˆ©ç”¨ clang å°† `main.m` ç¼–è¯‘ä¸º `main.o` æ–‡ä»¶ã€‚æ³¨æ„ï¼Œå› ä¸ºç”¨åˆ°äº† NSLog å’Œå¯¼å…¥äº†é™æ€åº“çš„å¤´æ–‡ä»¶ï¼Œæ‰€ä»¥éœ€è¦åŠ å‚æ•°æŒ‡å®š NSLog è¯¥ç¬¦å·ä»å“ªç¡®å®šï¼Œä¹Ÿéœ€è¦æŒ‡å®šé™æ€åº“æ‰€éœ€çš„ä¿¡æ¯ã€‚

```shell
clang -x objective-c \
  -target x86_64-apple-macos13.1 \
  -fobjc-arc \
  -isysroot /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX13.1.sdk \
  -I./StaticLibrary \
  -c main.m -o main.o
```

ç¬¬äº”æ­¥ï¼Œå°†ç¬¬å››æ­¥å¾—åˆ°çš„ `main.o` æ–‡ä»¶å’Œå‰é¢ç¼–è¯‘å¥½çš„ `Person` é™æ€åº“

```shell
clang -target x86_64-apple-macos13.1 \
  -fobjc-arc \
  -isysroot /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX13.1.sdk \
  > -L./StaticLibrary \
  > -lPerson \
  > main.o -o main
```

æ³¨æ„ï¼šä¸Šé¢ç¬¬äºŒæ­¥ï¼Œå¾—åˆ°çš„ `Person` é™æ€åº“éœ€è¦é‡å‘½åä¸‹ï¼Œå› ä¸º clang æŒ‡ä»¤ `-l` å‚æ•°çš„ `Person`ï¼Œå…¶å®å°±æ˜¯å»æ‰¾ `libPerson` çš„åŠ¨æ€åº“æˆ–è€…é™æ€åº“ã€‚

æŸ¥æ‰¾è§„åˆ™ï¼šå…ˆæ‰¾ `lib+<library_name>` çš„åŠ¨æ€åº“ï¼Œæ‰¾ä¸åˆ°ï¼Œå†å»æ‰¾ `lib+<library_name>` çš„é™æ€åº“ï¼Œè¿˜æ‰¾ä¸åˆ°ï¼Œå°±æŠ¥é”™ 

ç¬¬å…­æ­¥ï¼ŒæŸ¥çœ‹ç¬¬äº”æ­¥å¾—åˆ°çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œç„¶åæ‰§è¡Œï¼Œçœ‹çœ‹æ˜¯å¦æ­£å¸¸ï¼Ÿ

- æˆåŠŸï¼Œåˆ™è¯´æ˜ é™æ€åº“å°±æ˜¯`.o` æ–‡ä»¶çš„é›†åˆï¼Œå•ä¸ª `main.o` æ–‡ä»¶ï¼Œä¿®æ”¹æ‹“å±•åå°±å¯ä»¥å˜ä¸ºé™æ€åº“
- ä¸æˆåŠŸï¼Œåˆ™ç›¸å

<img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/MachOLinkedByObjetFileAndStaticLibrary.png" style="zoom:40%" />



è¿™ä¸€éƒ¨åˆ†ç›¸å…³çš„è„šæœ¬å’Œæºç ï¼Œå¯ä»¥æŸ¥çœ‹ 



## Framework

Mac OS/iOS å¹³å°è¿˜å¯ä»¥ä½¿ç”¨ Frameworkï¼ŒFramework å®é™…ä¸Šæ˜¯ä¸€ç§æ‰“åŒ…æ–¹å¼ï¼Œå°†åº“çš„ï¼šäºŒè¿›åˆ¶æ–‡ä»¶ã€å¤´æ–‡ä»¶ã€å’Œæœ‰å…³èµ„æºæ‰“åŒ…åˆ°ä¸€èµ·ï¼Œæ–¹ä¾¿ç®¡ç†å’Œåˆ†å‘ã€‚

Framework å’Œç³»ç»Ÿ UIKit.Framework è¿˜æ˜¯æœ‰å¾ˆå¤§åŒºåˆ«çš„ã€‚

- ç³»ç»Ÿçš„ Framework ä¸éœ€è¦æ‹·è´åˆ°ç›®æ ‡ç¨‹åºä¸­
- æˆ‘ä»¬è‡ªå·±çš„ Framework ä¸ç®¡æ˜¯é™æ€è¿˜æ˜¯åŠ¨æ€çš„ï¼Œéƒ½éœ€è¦æ‹·è´åˆ° App ä¸­ï¼ˆApp å’Œ Extension çš„ Bundle æ˜¯å…±äº«çš„ï¼‰

å› æ­¤ï¼ŒApple æŠŠè¿™ç§ Framework åˆå«åš `Embedded Framework`ã€‚å¼€å‘ä¸­ä½¿ç”¨çš„åŠ¨æ€åº“ä¼šè¢«æ”¾åˆ° ipa çš„ framework ç›®å½•ä¸‹ï¼ŒåŸºäºæ²™ç›’è¿è¡Œã€‚

ä¸åŒçš„ App ä½¿ç”¨ç›¸æ‹¥çš„åŠ¨æ€åº“ï¼Œå¹¶ä¸ä¼šåªåœ¨ç³»ç»Ÿä¸­å­˜åœ¨ä¸€ä»½ã€‚è€Œæ˜¯åœ¨å„ä¸ª App ä¸­å„è‡ªæ‰“åŒ…ã€ç­¾åã€åŠ è½½ä¸€ä»½ã€‚



æ ¹æ® Apple å®¡æ ¸è¦æ±‚ï¼Œä¸Šä¼ åˆ° App Store çš„ ipa å¯æ‰§è¡Œæ–‡ä»¶æœ‰å¤§å°é™åˆ¶ã€‚è¿™é‡Œçš„å¤§å°ä¸æ˜¯æŒ‡äºŒè¿›åˆ¶ï¼ˆMach-Oï¼‰æ–‡ä»¶å¤§å°ï¼Œè€Œæ˜¯æŒ‡å»å…¶ä¸­ `__TEXT` æ®µçš„å¤§å°ã€‚

- iOS 7 ä¹‹å‰ï¼ŒäºŒè¿›åˆ¶æ–‡ä»¶ä¸­æ‰€æœ‰ `__TEXT`  éƒ¨åˆ†æ€»å’Œä¸å¾—è¶…è¿‡ 80M
- iOS7.x è‡³ iOS8.xï¼ŒäºŒè¿›åˆ¶æ–‡ä»¶ä¸­ï¼Œæ¯ä¸ªæ¶æ„ä¸­çš„ `__TEXT` éƒ¨åˆ†ä¸å¾—è¶…è¿‡ 60M
- iOS9.0 ä¹‹åï¼ŒäºŒè¿›åˆ¶æ–‡ä»¶ä¸­æ‰€æœ‰ `__TEXT` éƒ¨åˆ†çš„æ€»å’Œä¸è¶…è¿‡ 500M

ä¸ºäº†å®ç°è¯¥æ•ˆæœï¼Œå¾ˆå¤šå…¬å¸åœ¨ç»„ä»¶åŒ–æˆ–è€…å¼€æºåº“ï¼Œéƒ½é‡‡ç”¨åŠ¨æ€é“¾æ¥çš„æ–¹å¼ã€‚å› ä¸ºåŠ¨æ€é“¾æ¥çš„éƒ¨åˆ†ï¼Œä¸ç®—åœ¨å½“å‰ Mach-O çš„ `__TEXT` æ®µã€‚



Framework:

- åŠ¨æ€åº“ï¼šHeader +  `.dylib` + ç­¾å + èµ„æºæ–‡ä»¶
- é™æ€åº“ï¼šHeader + `.a`  + ç­¾å + èµ„æºæ–‡ä»¶





QAï¼šé€šå¸¸æƒ…å†µä¸‹ï¼Œ**åŒä¸€ä»½ä»£ç ï¼Œä¸€ä¸ªåº“åˆ¶ä½œæˆåŠ¨æ€åº“ä½“ç§¯ä¼šæ¯”é™æ€åº“å°**ã€‚ä¸ºä»€ä¹ˆï¼Ÿ

é™æ€åº“æ˜¯ä¸€å † `.o` æ–‡ä»¶çš„é›†åˆã€‚å‡è®¾ AFNetworking æœ‰15ä¸ª `.m` æ–‡ä»¶ï¼Œç¼–è¯‘åäº§ç”Ÿ 15ä¸ª `.o` æ–‡ä»¶ã€‚æ¯ä¸ª `.o` æ–‡ä»¶çš„éƒ½å­˜åœ¨ä¸‹é¢3éƒ¨åˆ†ï¼š

- Mach header
- Segment
- Section

Mach header åŒ…æ‹¬ä¸€äº›åŸºç¡€ä¿¡æ¯ï¼Œæ‰€ä»¥ Mach header å­˜åœ¨å†—ä½™ï¼ˆå¤§å°ç«¯åºã€CPU ç±»å‹ç­‰ï¼‰ï¼Œè¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆé™æ€åº“æ¯”åŠ¨æ€åº“ä½“ç§¯å¤§çš„åŸå› ä¹‹ä¸€ã€‚

<img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/AFNetworkingStaticLibFormat.png" style="zoom:40%" />

```shell
Unix_Kernel î‚° ~/Desktop/OCExplore/OCExplore î‚° file Person.o
Person.o: Mach-O 64-bit object x86_64
 Unix_Kernel î‚° ~/Desktop/OCExplore/OCExplore î‚° otool -h Person.o
Person.o:
Mach header
      magic  cputype cpusubtype  caps    filetype ncmds sizeofcmds      flags
 0xfeedfacf 16777223          3  0x00           1     4       1880 0x00002000
```



åŠ¨æ€åº“åœ¨ Mach header è¿™é‡Œæœ‰æ”¹è¿›ï¼ŒAFNetworking åŠ¨æ€åº“æ ¼å¼å¦‚ä¸‹ï¼š

<img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/AFNetworkingDynamicLibFormat.png" style="zoom:40%" />

å°†å…¬å…±çš„ä¿¡æ¯æ”¾åˆ°ä¸€èµ·ï¼Œå…¬ç”¨ä¸€ä¸ª Mach headerã€‚



ä½†ã€ŒåŒä¸€ä»½ä»£ç ï¼Œä¸€ä¸ªåº“åˆ¶ä½œæˆåŠ¨æ€åº“ä½“ç§¯ä¼šæ¯”é™æ€åº“å°ã€ä¸ç»å¯¹ã€‚

å¯¹äº iOS9ï¼ŒLoad Commands Segment vmsize é»˜è®¤æ˜¯ä¸€ä¸ªå†…å­˜é¡µï¼Œä¹Ÿå°±æ˜¯16k

å¯¹äº iOS10ï¼ŒLoad Commands Segment vmsize é»˜è®¤æ˜¯ 32k

- vmsizeï¼šæ­¤ segment å ç”¨çš„è™šæ‹Ÿå†…å­˜çš„å­—èŠ‚æ•°
- filesizeï¼šæ­¤ segment åœ¨ç£ç›˜ä¸Šå ç”¨çš„å†…å­˜æ•°

å‡è®¾é¡¹ç›®åªæœ‰1ä¸ªæºæ–‡ä»¶ï¼Œå¯èƒ½æ‰“åŒ…åçš„é™æ€åº“è¦æ¯”åŠ¨æ€åº“ä½“ç§¯å¤§ã€‚





ç»§ç»­åšä¸ªå®éªŒï¼ŒéªŒè¯ä¸‹ Framework çš„ç»“æ„ï¼ˆä¸Šé¢åšäº†é™æ€åº“ï¼‰ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥æ²¿ç”¨ä¸Šé¢çš„æˆæœï¼Œå°†é™æ€åº“åŒ…è£…æˆ Framework

ç¬¬ä¸€æ­¥ï¼Œæ–°å»ºä¸€ä¸ªæ–‡ä»¶å¤¹ `Framworks`ï¼Œä¸‹é¢åˆ›å»ºä¸€ä¸ª `Person.Framework` æ–‡ä»¶å¤¹ï¼ŒæŠŠä¹‹å‰å¾—åˆ°çš„é™æ€åº“ `Person` ç§»åŠ¨åˆ°è¯¥ç›®å½•ä¸‹ã€‚å¹¶æŠŠ `main.m` ç§»åŠ¨è¿‡å»ã€‚

<img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/StaticLibraryMoveToValidateFramework.png" style="zoom:40%" />

ç¬¬äºŒæ­¥ï¼Œå› ä¸º Framework çš„ç»“æ„é‡Œæœ‰ Header ä¿¡æ¯ï¼Œæ‰€ä»¥åˆ›å»º `Headers` æ–‡ä»¶å¤¹ï¼ŒæŠŠ `Person.h` æ–‡ä»¶æ”¾è¿›å»ã€‚

ç¬¬ä¸‰æ­¥ï¼Œæ ¹æ® `main.m` å’Œ framework ä¿¡æ¯ï¼Œç¼–è¯‘æˆ `main.o`

```shell
clang -x objective-c \
  -target x86_64-apple-macos13.1 \
  -fobjc-arc \
  -isysroot /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX13.1.sdk \
  -I./Frameworks/Person.framework/Headers \
  -c main.m -o main.o
```

ç¬¬å››æ­¥ï¼Œå†æ ¹æ® `main.o` å’Œ framework å»å®Œæˆé“¾æ¥ã€‚é“¾æ¥ä¸‰è¦ç´ ï¼šåº“çš„å¤´æ–‡ä»¶ã€åº“æ‰€åœ¨ç›®å½•ã€åº“çš„åç§°ã€‚åªä¸è¿‡åœ¨å¤„ç† Framework çš„æ—¶å€™ï¼Œå‚æ•°ä¸ä¸€æ ·

```shell
clang -target x86_64-apple-macos13.1 \
  -fobjc-arc \
  -isysroot /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX13.1.sdk \
  -F./Frameworks \
  -framework Person \
  main.o -o main
```

è¯´æ˜ï¼šmain.o é“¾æ¥ Person.framework ç”Ÿæˆ main å¯æ‰§è¡Œæ–‡ä»¶

- `-F./Frameworks` åœ¨å½“å‰ç›®å½•çš„å­ç›®å½• Frameworks æŸ¥æ‰¾éœ€è¦çš„åº“æ–‡ä»¶

- `-framework Person ` é“¾æ¥çš„åç§°ä¸º `Person.framework` çš„åŠ¨æ€åº“æˆ–è€…é™æ€åº“

  æŸ¥æ‰¾è§„åˆ™ï¼šå…ˆæ‰¾ `Person.framework` çš„åŠ¨æ€åº“ï¼Œæ‰¾ä¸åˆ°ï¼Œå†å»æ‰¾ `Person.framework` çš„é™æ€åº“ï¼Œè¿˜æ‰¾ä¸åˆ°ï¼Œå°±æŠ¥é”™





## åŠ¨æ€åº“

### ç›´æ¥é“¾æ¥åŠ¨æ€åº“

ç»§ç»­é€šè¿‡å°å®éªŒæ¥ç ”ç©¶åŠ¨æ€åº“çš„åˆ›å»ºä¸ä½¿ç”¨

ç¬¬ä¸€æ­¥ï¼šåˆ›å»º dylib æ–‡ä»¶å¤¹ï¼Œä¸‹é¢åˆ›å»º `Person.h` `Person.m`  ç±»ã€‚åœ¨ dylib åŒå±‚ç›®å½•åˆ›å»º main.m æ–‡ä»¶ã€‚ä»£ç å¦‚ä¸‹

<img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/DynamicLibaryCodeTemplate.png" style="zoom:25%" />

ç¬¬äºŒæ­¥ï¼šå¯¹ main.m ç¼–è¯‘æˆ main.o æ–‡ä»¶ï¼ŒæŒ‡ä»¤ä¸º

```shell
clang -target x86_64-apple-macos13.1 \
  -fobjc-arc \
  -isysroot /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX13.1.sdk \
  -I./dylib \
  -c main.m -o main.o
```

ç¬¬ä¸‰æ­¥ï¼šåˆ° dylib æ–‡ä»¶å¤¹ä¸‹ï¼Œå¯¹ Person ç¼–è¯‘ä¸º Person.o æ–‡ä»¶ï¼ŒæŒ‡ä»¤ä¸º

```shell
clang -target x86_64-apple-macos13.1 \
  -fobjc-arc \
  -isysroot /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX13.1.sdk \
  -c Person.m -o Person.o
```

ç¬¬å››æ­¥ï¼šå°† Person.o ç¼–è¯‘ä¸ºåŠ¨æ€åº“ï¼ŒæŒ‡ä»¤ä¸º

```shell
clang -dynamiclib \
  -target x86_64-apple-macos13.1  \
  -fobjc-arc \
  -isysroot /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX13.1.sdk \
  Person.o -o LibPerson.dylib
```

ç¬¬äº”æ­¥ï¼Œå°† main.o å’Œ LibPerson.dylib é“¾æ¥ï¼Œæˆä¸º main å¯æ‰§è¡Œæ–‡ä»¶

```shell
clang -target x86_64-apple-macos13.1 \
  -fobjc-arc \
  -isysroot /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX13.1.sdk \
  -L./dylib \
  -lPerson \
  main.o -o main
```

æ¯æ¬¡é’ˆå¯¹åŠ¨æ€åº“çš„æ“ä½œéƒ½æ˜¯è¿™äº›å·®ä¸å¤šçš„æŒ‡ä»¤ï¼Œå°±æ˜¯ä¸€äº›å‚æ•°çš„ä¸åŒï¼Œå†™ä¸ª Shell è„šæœ¬ï¼Œå‘½åä¸º `build.sh`

```shell
echo "---------------- start --------------"

echo "ç¬¬ä¸€æ­¥ï¼šå…ˆå¯¹ main.m ç¼–è¯‘ä¸º main.o"

clang -target x86_64-apple-macos13.1 \
  -fobjc-arc \
  -isysroot /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX13.1.sdk \
  -I./dylib \
  -c main.m -o main.o

echo "ç¬¬äºŒæ­¥ï¼Œå†å¯¹ Person ç¼–è¯‘ä¸º Person.o"

pushd ./dylib
clang -target x86_64-apple-macos13.1 \
  -fobjc-arc \
  -isysroot /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX13.1.sdk \
  -c Person.m -o Person.o

echo "ç¬¬ä¸‰æ­¥ï¼Œå°† Person.o ç¼–è¯‘ä¸º libPerson.dylib åŠ¨æ€åº“"

clang -dynamiclib \
  -target x86_64-apple-macos13.1  \
  -fobjc-arc \
  -isysroot /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX13.1.sdk \
  Person.o -o libPerson.dylib

echo "ç¬¬å››æ­¥ï¼Œå°† main.o å’Œ libPerson.dylib é“¾æ¥ä¸ºå¯æ‰§è¡Œæ–‡ä»¶ main"

popd
clang -target x86_64-apple-macos13.1 \
  -fobjc-arc \
  -isysroot /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX13.1.sdk \
  -L./dylib \
  -lPerson \
  main.o -o main

echo "---------------- Done --------------"
```

ç»“æœå¦‚ä¸‹ï¼š

<img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/DynamicLibraryBuildShellResult.png" style="zoom:25%" />



ç¬¬å…­æ­¥ï¼šå¯¹ç”Ÿæˆçš„ main å¯æ‰§è¡Œæ–‡ä»¶è¿›è¡Œè°ƒè¯•è¿è¡Œï¼Œä½¿ç”¨ lldb æŒ‡ä»¤ `lldb -file å¯æ‰§è¡Œæ–‡ä»¶`ï¼Œç„¶åè¾“å…¥ r è¿›è¡Œè¿è¡Œï¼š

<img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/DynamicLibaryCheckResult.png" style="zoom:25%" />



å’¦ï¼Œä¸ºä»€ä¹ˆæˆ‘ç”¨åŠ¨æ€åº“é“¾æ¥åè¿˜æ˜¯æ— æ³•ä½¿ç”¨ï¼Ÿï¼Ÿï¼Ÿå¸¦ç€é—®é¢˜ç ”ç©¶ä¸‹



### é™æ€åº“é“¾æ¥æˆåŠ¨æ€åº“

å› ä¸ºï¼š

- `.o` æ–‡ä»¶å¯ä»¥é“¾æ¥æˆé™æ€åº“
- `.o` æ–‡ä»¶å¯ä»¥é“¾æ¥æˆåŠ¨æ€åº“

æ‰€ä»¥ï¼šèƒ½ä¸èƒ½æ¨å¯¼å‡ºè¿™æ ·ä¸€ä¸ªç»“è®ºï¼šé™æ€åº“ä¹Ÿå¯ä»¥é“¾æ¥æˆåŠ¨æ€åº“ã€‚

åšä¸ªå°å®éªŒéªŒè¯çœ‹çœ‹ï¼š

å’Œä¸Šé¢çš„ææ–™æ²¡æœ‰å·®åˆ«ï¼ŒåŒºåˆ«åœ¨äºè„šæœ¬ï¼Œå…¶ä¸­ä¸€æ­¥æ˜¯å°†é™æ€åº“é“¾æ¥ä¸ºåŠ¨æ€åº“ã€‚

ä½¿ç”¨é“¾æ¥å™¨ LD èƒ½åŠ›ï¼Œé“¾æ¥é™æ€åº“ä¸ºåŠ¨æ€åº“æŒ‡ä»¤å¦‚ä¸‹

```shell
ld -dylib -arch x86_64 \
  -macosx_version_min 13.1 \
  -syslibroot /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX13.1.sdk \
  -lsystem -framework Foundation \
  libPerson.a -o libPerson.dylib
```

`build.sh` å®Œæ•´è„šæœ¬å¦‚ä¸‹

```shell
echo "---------------- start --------------"

echo "ç¬¬ä¸€æ­¥ï¼šå…ˆå¯¹ main.m ç¼–è¯‘ä¸º main.o"

clang -target x86_64-apple-macos13.1 \
  -fobjc-arc \
  -isysroot /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX13.1.sdk \
  -I./dylib \
  -c main.m -o main.o

echo "ç¬¬äºŒæ­¥ï¼Œå†å¯¹ Person ç¼–è¯‘ä¸º Person.o"

pushd ./dylib
clang -target x86_64-apple-macos13.1 \
  -fobjc-arc \
  -isysroot /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX13.1.sdk \
  -c Person.m -o Person.o

echo "ç¬¬ä¸‰æ­¥ï¼Œå¯¹ Person.o ç¼–è¯‘ä¸º LibPerson.a é™æ€æ€åº“"

libtool -static -arch_only x86_64 Person.o -o libPerson.a

echo "ç¬¬å››æ­¥ï¼ŒLD é“¾æ¥å™¨å°† libPerson.a é“¾æ¥ä¸º libPerson.dylib åŠ¨æ€åº“"

ld -dylib -arch x86_64 \
  -macosx_version_min 13.1 \
  -syslibroot /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX13.1.sdk \
  -lsystem -framework Foundation \
  libPerson.a -o libPerson.dylib

echo "ç¬¬äº”æ­¥ï¼Œå°† main.o å’Œ libPerson.dylib é“¾æ¥ä¸ºå¯æ‰§è¡Œæ–‡ä»¶ main"

popd
clang -target x86_64-apple-macos13.1 \
  -fobjc-arc \
  -isysroot /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX13.1.sdk \
  -L./dylib \
  -lPerson \
  main.o -o main

echo "---------------- Done --------------"
```

æ‰§è¡Œå®Œè„šæœ¬ï¼Œåˆå‡ºç°äº†å¥‡æ€ªçš„ç°è±¡ï¼š

<img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/ConvertStaticLibToDynamicLibNoSymbolError.png" style="zoom:25%" />



å‘ç°ï¼Œåœ¨åˆ©ç”¨åŠ¨æ€åº“é“¾æ¥æˆå¯æ‰§è¡Œæ–‡ä»¶æ—¶æŠ¥é”™äº† `undefined symbols for **`ï¼Œç„¶ååˆ©ç”¨ `objdump --macho --exports-trie libPerson.dylib` æŸ¥çœ‹åŠ¨æ€åº“çš„å¯¼å‡ºç¬¦å·ï¼Œå±…ç„¶æ˜¯ç©ºã€‚ä¸ºä»€ä¹ˆï¼Ÿ

é“¾æ¥å™¨åœ¨é“¾æ¥é˜¶æ®µï¼Œé»˜è®¤ä½¿ç”¨  `-noall_load` å‚æ•°ã€‚å…±4ä¸ªå‚æ•°ï¼š

- `-noall_load` ï¼šé»˜è®¤æ˜¯ `-noall_load`ï¼Œé¡¾åæ€ä¹‰å°±æ˜¯ä¸ä¼šæ‰€æœ‰ç¬¦å·çš„åŠ è½½ï¼Œè€Œæ˜¯é“¾æ¥å™¨é“¾æ¥ä¸€ä¸ªé™æ€åº“ä¹‹å‰å»æ‰«æé™æ€åº“æ–‡ä»¶ï¼Œæ‰¾åˆ°éœ€è¦çš„ä»£ç å†è¿›è¡Œé“¾æ¥
- `-all_load`ï¼šé“¾æ¥æ‰€æœ‰ç¬¦å·ï¼Œä¸ç®¡ä»£ç æœ‰æ²¡æœ‰ä½¿ç”¨
- `-force_load`ï¼š å¯ä»¥æŒ‡å®šè¦è½½å…¥æ‰€æœ‰æ–¹æ³•çš„åº“ï¼Œåé¢å¿…é¡»è·Ÿä¸€ä¸ªåªæƒ³é™æ€åº“çš„è·¯å¾„
- `-ObjC`ï¼šå‘Šè¯‰é“¾æ¥å™¨æŠŠåº“ä¸­å®šä¹‰çš„ Objective-C ç±»å’Œ Category éƒ½åŠ è½½è¿›æ¥ï¼Œè¿™æ ·ç¼–è¯‘ä¹‹åçš„å¯æ‰§è¡Œæ–‡ä»¶ä¼šå˜å¤§ï¼ˆå› ä¸ºåŠ è½½äº†å…¶ä»–çš„ OC ä»£ç è¿›æ¥ï¼‰ã€‚ç”±äº  OCè¯­è¨€ç¬¦å·é“¾æ¥çš„åŸºæœ¬å•ä½æ˜¯ç±»ï¼Œé™æ€åº“é“¾æ¥æ—¶é¦–å…ˆä¼šé“¾æ¥æœ¬ç±»ï¼Œè€Œ Category æ˜¯è¿è¡Œæ—¶æ‰ä¼šè¢«åŠ è½½çš„ï¼Œå› æ­¤ä¼šè¢«é™æ€é“¾æ¥å™¨ç›´æ¥å¿½ç•¥æ‰ï¼Œé€šè¿‡ `-ObjC` å‘½ä»¤æ˜¯å‘ŠçŸ¥é“¾æ¥å™¨é“¾æ¥æ‰€æœ‰çš„ OC ä»£ç 

çŸ¥é“å…·ä½“åŸå› é‚£å°±å¥½åŠäº†ï¼Œä¿®æ”¹æŒ‡ä»¤

```shell
ld -dylib -arch x86_64 \
  -macosx_version_min 13.1 \
  -syslibroot /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX13.1.sdk \
  -lsystem -framework Foundation \
  -all_load \
  libPerson.a -o libPerson.dylib
```

å†æ¬¡è¿è¡Œ build è„šæœ¬ï¼Œç„¶åå¯¹å¯æ‰§è¡Œæ–‡ä»¶æ‰§è¡Œï¼Œè¿˜æ˜¯æŠ¥é”™ ğŸ˜‚

<img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/LinkFailedFromStaticLibConvertedDynamicLib.png" style="zoom:25%" />

 

é€šè¿‡ä¸Šé¢çš„å®éªŒå¯ä»¥å¾—å‡ºç»“è®ºï¼š

- é™æ€åº“æ˜¯ `.o` æ–‡ä»¶çš„åˆé›†
- åŠ¨æ€åº“æ˜¯ `.o` æ–‡ä»¶é“¾æ¥åçš„äº§ç‰©
- é™æ€åº“å¯ä»¥é“¾æ¥æˆåŠ¨æ€åº“
- åŠ¨æ€åº“æ˜¯æœ€ç»ˆé“¾æ¥äº§ç‰©ã€‚åŠ¨æ€åº“æ¯”é™æ€åº“å¤šèµ°ä¸€æ¬¡é“¾æ¥çš„è¿‡ç¨‹



### åŠ¨æ€åº“ Library not loadedï¼Ÿ

ä¸ºä»€ä¹ˆåŠ¨æ€åº“é“¾æ¥åçš„å¯æ‰§è¡Œæ–‡ä»¶è¿è¡Œï¼Œä¼šæŠ¥ `Library not loaded: 'libPerson.dylib'` é”™è¯¯ï¼Ÿ

ä¸å¾—ä¸èŠèŠåŠ¨æ€åº“åŠ è½½åŸç†

<img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/DynamicLibaryLoadProcess.png" style="zoom:50%" />

ä¹Ÿå°±æ˜¯è¯´å½“ dyld åŠ è½½ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ï¼ˆmainï¼‰ çš„æ—¶å€™ï¼Œåœ¨ Mach-O ä¸­æœ‰ä¸€ä¸ªåå­—å« `LC_LOAD_DYLIB` çš„ Load Commandï¼Œé‡Œé¢ä¿å­˜äº†æ‰€ä½¿ç”¨åˆ°çš„åŠ¨æ€åº“çš„è·¯å¾„ã€‚å¯æ‰§è¡Œæ–‡ä»¶çš„åŠ¨æ€åº“å°±æ˜¯é  dyld æ ¹æ®åŠ¨æ€åº“è·¯å¾„è¿›è¡ŒåŠ è½½çš„ã€‚

ç”¨ MachOView æ‰“å¼€å¦ä¸€ä¸ª App çœ‹çœ‹

<img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/LCLoadDYLIBViaMachO.png" style="zoom:30%" />



å¯¹äºæˆ‘ä»¬è‡ªå·±é“¾æ¥çš„å¯æ‰§è¡Œæ–‡ä»¶ main è¿›è¡ŒæŸ¥çœ‹ï¼Œåˆ©ç”¨ `otool  -l main | grep 'DYLIB' -A 5` æŒ‡ä»¤

<img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/OtoolWatchLCLoadDYLIB.png" style="zoom:30%" />

å¯ä»¥å‘ç°ï¼š

- name å¥½åƒå°±æ˜¯åŠ¨æ€åº“çš„è·¯å¾„
- é“¾æ¥çš„å…¶ä»–å‡ ä¸ªåŠ¨æ€åº“çš„è·¯å¾„éƒ½æ²¡é—®é¢˜ï¼Œå°±æ˜¯ LibPerson.dylib è·¯å¾„æœ‰é—®é¢˜ã€‚



å¦‚ä½•è§£å†³ï¼Ÿ

éœ€è¦åœ¨ç¼–è¯‘é“¾æ¥ç”ŸæˆåŠ¨æ€åº“çš„æ—¶å€™ï¼Œæœ‰ä¸ªä¸œè¥¿ä¿å­˜åŠ¨æ€åº“è·¯å¾„ï¼Œè¿™ä¸ªå°±æ˜¯ Mach-O æ–‡ä»¶ä¸­çš„å¦ä¸€ä¸ª Load Commandï¼Œå³ `LC_ID_DYLIB`ã€‚



#### æ–¹å¼ä¸€ï¼šé€šè¿‡ `install_name_tool` æŒ‡ä»¤

<img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/InstallNameToolChangeDynamicLibName.png" style="zoom:30%" />

é€šè¿‡æ”¹å˜åŠ¨æ€åº“ name æ¥ä¿®æ”¹åŠ¨æ€åº“çš„è·¯å¾„ã€‚å…·ä½“æŒ‡ä»¤ä¸º `install_name_tool -id /Users/unix_kernel/Desktop/LDAndFramework/StaticLibraryLinkedIntoDynamicLibrary/dylib/libPerson.dylib libPerson.dylib`

ä¿®æ”¹åŠ¨æ€åº“çš„ name ä¹‹åï¼Œå†æ¬¡ `otool  -l libPerson.dylib | grep 'DYLIB' -A 5` æŸ¥çœ‹è·¯å¾„ä¿¡æ¯

<img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/InstallNameToolChangeDynamicLibName.png" style="zoom:30%" />

åŠ¨æ€åº“æœ‰äº†æ­£ç¡®çš„ name åï¼Œå†é‡æ–°é“¾æ¥ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶ã€‚å¯æ‰§è¡Œæ–‡ä»¶å¯ä»¥æ­£ç¡®è¿è¡Œï¼ŒæŸ¥çœ‹æ‰€ä»¥æ¥çš„åŠ¨æ€åº“è·¯å¾„ï¼Œå‡æ­£ç¡®åŠ è½½ã€‚

<img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/DynamicLibHaveRightPathThenLinkedExecuteFile.png" style="zoom:30%" />



ä¸Šé¢çš„æ–¹æ¡ˆæœ‰ç‚¹ç¼ºç‚¹ï¼Œå› ä¸ºè·¯å¾„æ˜¯ç»å¯¹è·¯å¾„ï¼Œå› æ­¤æ²¡åŠæ³•è¿ç§»ã€‚



#### æ–¹å¼äºŒï¼š`rpath`

`rpath`ï¼ŒRunpath search pathsï¼Œdyld æœç´¢è·¯å¾„ã€‚è¿è¡Œæ—¶ï¼Œ`@rpath`  æŒ‡ç¤º dyld æŒ‰é¡ºåºæœç´¢è·¯å¾„åˆ—è¡¨ï¼Œä»¥æ‰¾åˆ°åŠ¨æ€åº“ã€‚

`@rpath` ä¿å­˜ä¸€ä¸ªæˆ–å¤šä¸ªè·¯å¾„çš„å˜é‡ã€‚



å‰æè¯´æ˜ï¼šæ¨¡æ‹Ÿä¸‹ App çœŸå®ç¯å¢ƒã€‚åˆ›å»ºä¸€ä¸ªæ–‡ä»¶å¤¹ `Frameworks`ï¼Œå†…éƒ¨ç»§ç»­åˆ›å»º `Person.framework` æ–‡ä»¶å¤¹ï¼Œå…¶å†…éƒ¨ç»§ç»­åˆ›å»º `Headers`

æ–‡ä»¶å¤¹ï¼Œå°† dylib æ–‡ä»¶å¤¹ä¸‹çš„æ–‡ä»¶å¤åˆ¶è¿‡å»ã€‚ç»“æ„å¦‚ä¸‹

```shell
// tree -L 4
.
â”œâ”€â”€ Frameworks
â”‚Â Â  â””â”€â”€ Person.framework
â”‚Â Â      â”œâ”€â”€ Headers
â”‚Â Â      â”‚Â Â  â””â”€â”€ Person.h
â”‚Â Â      â”œâ”€â”€ Person.h
â”‚Â Â      â”œâ”€â”€ Person.m
â”œâ”€â”€ build.sh
â”œâ”€â”€ dylib
â”‚Â Â  â”œâ”€â”€ Person.h
â”‚Â Â  â”œâ”€â”€ Person.m
â”‚Â Â  â”œâ”€â”€ Person.o
â”‚Â Â  â”œâ”€â”€ libPerson.a
â”‚Â Â  â””â”€â”€ libPerson.dylib
â”œâ”€â”€ main.m
```

ç¬¬ä¸€æ­¥ï¼Œåœ¨ ` Frameworks/Person.framework` ä¸‹é¢æ‰§è¡Œå‘½ä»¤ï¼Œå°† `Person.m` ç¼–è¯‘ä¸º `Person.o` 

```shell
clang -target x86_64-apple-macos13.1 \
  -fobjc-arc \
  -isysroot /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX13.1.sdk \
  -c Person.m -o Person.o
```

ç¬¬äºŒæ­¥ï¼Œå°† `Person.o` é“¾æ¥ä¸ºåŠ¨æ€åº“

```shell
clang -dynamiclib \
  -target x86_64-apple-macos13.1  \
  -fobjc-arc \
  -isysroot /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX13.1.sdk \
  Person.o -o Person
```

ç¬¬ä¸‰æ­¥ï¼Œç»™åŠ¨æ€åº“åˆ©ç”¨ `install_name_tool` ä¿®æ”¹ idï¼Œid æŒ‡å®š `@rpath` ä¿¡æ¯

```shell
install_name_tool -id @rpath/Frameworks/Person.framework/Person /Users/unix_kernel/Desktop/LDAndFramework/StaticLibraryLinkedIntoDynamicLibrary/Frameworks/Person.framework/Person
```

ç¬¬å››æ­¥ï¼Œåˆ©ç”¨ `otool` æŸ¥çœ‹åŠ¨æ€åº“çš„ name æ˜¯å¦ä¿®æ”¹å¥½äº† `@rpath` ä¿¡æ¯

```
otool -l Person | grep 'ID' -A 5
```

ç¬¬äº”æ­¥ï¼Œå›åˆ°æ ¹ç›®å½•ï¼Œå°† `main.m` ç¼–è¯‘ä¸º `main.o`

```shell
clang -target x86_64-apple-macos13.1 \
  -fobjc-arc \
  -isysroot /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX13.1.sdk \
  -I./Frameworks/Person.framework/Headers \
  -c main.m -o main.o
```

ç¬¬å…­æ­¥ï¼Œå°† `main.o` å’Œ `Person.framework` é“¾æ¥ä¸ºå¯æ‰§è¡Œæ–‡ä»¶

```shell
clang -target x86_64-apple-macos13.1 \
  -fobjc-arc \-isysroot /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX13.1.sdk \
  -F./Frameworks \
  -framework Person \
  main.o -o main
```

æ­¤æ—¶çš„å¯æ‰§è¡Œæ–‡ä»¶è™½ç„¶é“¾æ¥æˆåŠŸäº†ï¼Œä½†æ˜¯å¯æ‰§è¡Œæ–‡ä»¶éœ€è¦ç”¨åˆ°åŠ¨æ€åº“çš„åŠŸèƒ½ï¼Œç›´æ¥è¿è¡Œä¼šæŠ¥é”™ `Library not loaded: '@rpath/Frameworks/Person.framework/Person'`ã€‚æ‰€ä»¥éœ€è¦ç»™å¯æ‰§è¡Œæ–‡ä»¶æ·»åŠ  `rpath` ä¿¡æ¯

ç¬¬ä¸ƒæ­¥ï¼Œç»™å¯æ‰§è¡Œæ–‡ä»¶ `main` æ·»åŠ  `rpath` ä¿¡æ¯

```shell
install_name_tool -add_rpath /Users/unix_kernel/Desktop/LDAndFramework/StaticLibraryLinkedIntoDynamicLibrary main
```

æ·»åŠ åéªŒè¯æ˜¯å¦æ·»åŠ æˆåŠŸï¼ŒæŒ‡ä»¤ `otool -l main | grep 'RPATH' -A 5`

ç¬¬å…«æ­¥ï¼Œé“¾æ¥æˆåŠŸå `main` å¯æ‰§è¡Œæ–‡ä»¶å³å¯æ‰§è¡Œ



ä¸‹é¢æ˜¯ä¸Šé¢å…¨éƒ¨æ­¥éª¤çš„æˆªå›¾è¯´æ˜ã€‚

<img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/LinkDynamicFrameworkFullProcess.png" style="zoom:30%" />





ç»™åŠ¨æ€åº“æ·»åŠ  `rpath` ä¿¡æ¯ã€‚

æ ¸å¿ƒï¼šè°é“¾æ¥åŠ¨æ€åº“ï¼Œ`rpath` è°æ¥æä¾›ï¼Œæ¯”å¦‚ä¸€ä¸ª Person.framework è·¯å¾„ä¸ºï¼š `/usr/meiying/desktop/DynamicExplore/Person.framework`

- å¯æ‰§è¡Œæ–‡ä»¶ä¸­ `Load Command ` ä¸­å­˜åœ¨ `LC_RPATH` ï¼Œå€¼ä¸º `/usr/meiying/desktop/DynamicExplore/Person.framework`
- åŠ¨æ€åº“ Mach-O ä¸­ä¹Ÿå­˜åœ¨ å€¼ä¸º `@rpath/Frameworks/Person.framework/Person`

åæ€ï¼šä¸Šé¢çš„æ–¹æ¡ˆè¿˜æ˜¯æœ‰ç¼ºç‚¹çš„ï¼Œåº”ä¸ºå¯æ‰§è¡Œæ–‡ä»¶æä¾›çš„ `rpath`  è¿˜æ˜¯ä¸€ä¸ªç»å¯¹è·¯å¾„ã€‚



#### æ–¹å¼ä¸‰ï¼š@execute_pathã€@loader_path

`@executable_path`ï¼šè¡¨ç¤ºå¯æ‰§â¾ç¨‹åºæ‰€åœ¨çš„â½¬å½•ï¼Œè§£æä¸ºå¯æ‰§â¾â½‚ä»¶çš„ç»å¯¹è·¯å¾„ã€‚

`@loader_path`ï¼šè¡¨ç¤ºè¢«åŠ è½½çš„`Mach-O` æ‰€åœ¨çš„â½¬å½•ï¼Œæ¯æ¬¡åŠ è½½æ—¶ï¼Œéƒ½å¯èƒ½è¢«è®¾ç½®ä¸ºä¸åŒçš„è·¯å¾„ï¼Œç”±ä¸Šå±‚æŒ‡å®š

å¯ä»¥å°†å¯æ‰§è¡Œæ–‡ä»¶çš„ rpath ä¿®æ”¹ä¸ºçµæ´»çš„ï¼Œè€Œä¸æ˜¯å†™æ­»çš„è·¯å¾„ï¼ŒæŒ‡ä»¤ä¸º

```shell
install_name_tool -rpath /Users/unix_kernel/Desktop/LDAndFramework/StaticLibraryLinkedIntoDynamicLibrary @executable_path main
```

<img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/ChangeExecutablePathOnExecutableFile.png" style="zoom:30%" />

è¿™ä¸ªå¯ä¸æ˜¯èŠ±é‡Œèƒ¡å“¨çš„çƒ§æ“ä½œï¼ŒCocoapods ä¹Ÿæ˜¯è¿™ä¹ˆå¹²çš„

```
LD_RUNPATH_SEARCH_PATHS = $(inherited) '@executable_path/Frameworks' '@loader_path/Frameworks'
```

<img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/CocoapodsExecutablePath.png" style="zoom:50%" />





æ³¨æ„ï¼š`@loader_path` è¿˜æ˜¯æ¯”è¾ƒæŠ½è±¡çš„ï¼Œä¸¾ä¸€ä¸ªå®é™…åœºæ™¯ä¾‹å­æ¥çœ‹çœ‹

å‡è®¾èƒŒæ™¯æ˜¯ï¼š

- åŠ¨æ€åº“ Cat å…·æœ‰ `[cat sleep]` èƒ½åŠ›
- åŠ¨æ€åº“ Person å…·æœ‰ `[person sayHi]` èƒ½åŠ›ï¼ŒåŠ¨æ€åº“ Person ä½¿ç”¨äº†åŠ¨æ€åº“ Cat
- å¯æ‰§è¡Œæ–‡ä»¶ï¼Œå¯¼å…¥äº†åŠ¨æ€åº“ Person

è¿™æ ·ä¸€ä¸ªåœºæ™¯ï¼Œä»£ç æ¨¡æ‹Ÿä¸‹ï¼Œæ–‡ä»¶ç›®å½•å¦‚ä¸‹

<img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/DynamicUseDynamicLib.png" style="zoom:50%" />

1. åœ¨ Cat.framework æ–‡ä»¶å¤¹ä¸‹è¿è¡Œ build.sh
2. åœ¨ Person.framework æ–‡ä»¶å¤¹ä¸‹è¿è¡Œ build.sh
3. åœ¨ main.m æ ¹ç›®å½•ä¸‹è¿è¡Œ build.sh

å¾—åˆ° main å¯æ‰§è¡Œæ–‡ä»¶ï¼Œè¿è¡ŒæŠ¥é”™ã€‚

```shell
lldb -file main
(lldb) target create "main"
Current executable set to '/Users/unix_kernel/Desktop/LDAndFramework/DynamicLibraryUseDynamicLibrary/main' (x86_64).
(lldb) r
Process 54157 launched: '/Users/unix_kernel/Desktop/LDAndFramework/DynamicLibraryUseDynamicLibrary/main' (x86_64)
dyld[54157]: Library not loaded: 'Person'
  Referenced from: '/Users/unix_kernel/Desktop/LDAndFramework/DynamicLibraryUseDynamicLibrary/main'
  Reason: tried: 'Person' (no such file), '/usr/local/lib/Person' (no such file), '/usr/lib/Person' (no such file), '/Users/unix_kernel/Desktop/LDAndFramework/DynamicLibraryUseDynamicLibrary/Person' (no such file), '/usr/local/lib/Person' (no such file), '/usr/lib/Person' (no such file)
Process 54157 stopped
* thread #1, stop reason = signal SIGABRT
    frame #0: 0x000000010005698e dyld`__abort_with_payload + 10
dyld`:
->  0x10005698e <+10>: jae    0x100056998               ; <+20>
    0x100056990 <+12>: movq   %rax, %rdi
    0x100056993 <+15>: jmp    0x100013150               ; cerror_nocancel
    0x100056998 <+20>: retq
Target 0: (main) stopped.
```

å¾—åˆ°æ–°çš„å‘½é¢˜ï¼š**å¯æ‰§è¡Œæ–‡ä»¶ä¸­å¼•å…¥åŠ¨æ€åº“ Aï¼ŒåŠ¨æ€åº“çš„åŠŸèƒ½å®ç°ä¾èµ–åŠ¨æ€åº“ Bï¼Œé“¾æ¥å™¨è¯¥å¦‚ä½•é“¾æ¥å‘¢ï¼Ÿ**



ç¬¬ä¸€ç§å°è¯•ï¼š

å¯¹ Cat.framework ä¸‹çš„ build.sh ä¿®æ”¹è„šæœ¬ï¼ŒæŒ‡å®š `@rpath` ä¿¡æ¯ï¼Œ `-Xlinker -install_name -Xlinker @rpath/Cat.framework/Cat`

```shell
echo "1ï¼š ç¼–è¯‘ Cat.m ä¸º Cat.o å¯æ‰§è¡Œæ–‡ä»¶"

clang -target x86_64-apple-macos13.1 \
  -fobjc-arc \
  -isysroot /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX13.1.sdk \
  -c Cat.m -o Cat.o

echo "2: é“¾æ¥ Cat.o ä¸º Cat åŠ¨æ€åº“"

clang -dynamiclib \
    -target x86_64-apple-macos13.1  \
    -fobjc-arc \
    -isysroot /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX13.1.sdk \
    -Xlinker -install_name -Xlinker @rpath/Cat.framework/Cat \
    Cat.o -o Cat

echo "3: è¾“å‡ºåŠ¨æ€åº“çš„ nameï¼ˆè·¯å¾„ï¼‰ä¿¡æ¯"
otool -l Cat | grep 'ID' -A 5
```

å¯¹ Person.framework ä¸‹çš„ build.sh ä¿®æ”¹è„šæœ¬ï¼ŒæŒ‡å®š `@rpath` ä¿¡æ¯ï¼Œ` -Xlinker -install_name -Xlinker @rpath/Person.framework/Person`

```shell
echo "1ï¼šç¼–è¯‘ Person.m ä¸º Person.o å¯æ‰§è¡Œæ–‡ä»¶"

clang -target x86_64-apple-macos13.1 \
  -fobjc-arc \
  -isysroot /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX13.1.sdk \
  -I./Headers \
  -I./Frameworks/Cat.framework/Headers \
  -c Person.m -o Person.o

echo "2: é“¾æ¥ Person.o ä¸º Person åŠ¨æ€åº“"

clang -dynamiclib \
    -target x86_64-apple-macos13.1  \
    -fobjc-arc \
    -isysroot /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX13.1.sdk \
    -Xlinker -install_name -Xlinker @rpath/Person.framework/Person \
    -F./Frameworks/ \
    -framework Cat \
    Person.o -o Person


echo "3: è¾“å‡ºåŠ¨æ€åº“çš„ dylib ä¿¡æ¯"
otool -l Person | grep 'DYLIB' -A 5

echo "-----------"
echo "4: è¾“å‡ºåŠ¨æ€åº“çš„ name ä¿¡æ¯"
otool -l Person | grep 'ID' -A 5

```

å¯¹å¯æ‰§è¡Œæ–‡ä»¶ main æ ¹ç›®å½•ï¼ŒæŒ‡å®š `@executable_path` ä¿¡æ¯ï¼Œ`-Xlinker -rpath -Xlinker @executable_path/Frameworks`

```shell
echo "---------------- start --------------"

echo "ç¬¬ä¸€æ­¥ï¼šå…ˆå¯¹ main.m ç¼–è¯‘ä¸º main.o"

clang -target x86_64-apple-macos13.1 \
  -fobjc-arc \
  -isysroot /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX13.1.sdk \
  -I./Frameworks/Person.framework/Headers \
  -c main.m -o main.o

echo "ç¬¬äºŒæ­¥ï¼Œå°† main.o å’Œ Person.dylib é“¾æ¥ä¸ºå¯æ‰§è¡Œæ–‡ä»¶ main"

clang -target x86_64-apple-macos13.1 \
  -fobjc-arc \
  -isysroot /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX13.1.sdk \
  -Xlinker -rpath -Xlinker @executable_path/Frameworks \
  -F./Frameworks \
  -framework Person \
  main.o -o main

echo "ç¬¬ä¸‰æ­¥ï¼Œè¾“å‡ºä¿¡æ¯"
otool -l main | grep 'RPATH' -A 3
otool -l main | grep 'DYLIB' -A 3

echo "---------------- Done --------------"
```

è¿è¡ŒæŠ¥é”™å¦‚ä¸‹ï¼š

<img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/DynamicLibReferencedDynamicLibImageNotFoundError.png" style="zoom:30%" />

ä¸ºä»€ä¹ˆè¿˜é”™è¯¯äº†ï¼Ÿéƒ½å·²ç»ç»™å¯æ‰§è¡Œæ–‡ä»¶æ·»åŠ äº† `@executable_path`ï¼Œç»™2ä¸ªåŠ¨æ€åº“éƒ½æ·»åŠ äº† `@rpath`ï¼Œæ€ä¹ˆåŠï¼Ÿ

æ€è·¯ï¼šå› ä¸ºæŠ¥é”™æ˜¯è¯´åŠ¨æ€åº“ Person æ‰¾ä¸åˆ°åŠ¨æ€åº“ Catï¼Œé‚£æ˜¯ä¸æ˜¯èšç„¦ä¸‹ Personï¼Œåœ¨ Person çš„é“¾æ¥æŒ‡ä»¤ä¸­ï¼Œç»™ Person æ·»åŠ  `@rpath` å°±å¯ä»¥äº†ï¼Ÿ

åŠ¨æ‰‹å®è·µä¸‹ï¼Œä¿®æ”¹ Person åŠ¨æ€åº“çš„ build.sh è„šæœ¬

```shell
echo "1ï¼šç¼–è¯‘ Person.m ä¸º Person.o å¯æ‰§è¡Œæ–‡ä»¶"

clang -target x86_64-apple-macos13.1 \
  -fobjc-arc \
  -isysroot /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX13.1.sdk \
  -I./Headers \
  -I./Frameworks/Cat.framework/Headers \
  -c Person.m -o Person.o

echo "2: é“¾æ¥ Person.o ä¸º Person åŠ¨æ€åº“"

clang -dynamiclib \
    -target x86_64-apple-macos13.1  \
    -fobjc-arc \
    -isysroot /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX13.1.sdk \
    -Xlinker -install_name -Xlinker @rpath/Person.framework/Person \
    -Xlinker -rpath -Xlinker @executable_path/Frameworks/Person.framework/Frameworks \
    -F./Frameworks/ \
    -framework Cat \
    Person.o -o Person


echo "3: è¾“å‡ºåŠ¨æ€åº“çš„ dylib ä¿¡æ¯"
otool -l Person | grep 'DYLIB' -A 5

echo "-----------"
echo "4: è¾“å‡ºåŠ¨æ€åº“çš„ name ä¿¡æ¯"
otool -l Person | grep 'ID' -A 5

```

åœ¨ Person.frameworkè¿è¡Œä¸‹ build.shï¼Œç„¶ååœ¨æ ¹ç›®å½•ä¸‹è¿è¡Œ build.shï¼Œå¾—åˆ°æ–°çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œç„¶åå¯ä»¥æˆåŠŸè¿è¡Œ

<img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/DynamicLibReferenceDynamicLibUseRPathAndExecutablePath.png" style="zoom:30%" />

åæ€ï¼šå¯æ‰§è¡Œæ–‡ä»¶ä¾èµ–åŠ¨æ€åº“ Aï¼ŒåŠ¨æ€åº“ A ä¾èµ–åŠ¨æ€åº“ Bï¼Œä¸Šé¢çš„é…ç½®å¾ˆç¹çï¼š

- å¯æ‰§è¡Œæ–‡ä»¶æä¾› `rpath`ï¼ŒæŒ‡ä»¤ä¸ºï¼š `-Xlinker -rpath -Xlinker @executable_path/Frameworks`
- åŠ¨æ€åº“ A æŒ‡å®š name ä¸º `-Xlinker -install_name -Xlinker @rpath/Person.framework/Person`ï¼ŒåŒæ—¶åˆå› ä¸ºä¾èµ–äº†åŠ¨æ€åº“ Bï¼Œæ‰€ä»¥åŒæ—¶åˆè¦æä¾› `rpath`ï¼ŒæŒ‡ä»¤ä¸º `-Xlinker -rpath -Xlinker @executable_path/Frameworks/Person.framework/Frameworks `
- åŠ¨æ€åº“ B æŒ‡å®š nameï¼ŒæŒ‡ä»¤ä¸º `-Xlinker -install_name -Xlinker @rpath/Cat.framework/Cat`

å¥½ç¹çå•Šï¼Œæœ‰æ²¡æœ‰ç®€åŒ–çš„æ–¹æ³•ã€‚æ­¤æ—¶ **`@loader_path`** å‘¼ä¹‹æ¬²å‡ºäº†ã€‚

åœ¨å½“å‰åœºæ™¯ä¸‹ï¼ŒPerson åŠ¨æ€åº“çš„æŒ‡ä»¤å¯ä»¥ç®€åŒ–ä¸‹ã€‚`-Xlinker -rpath -Xlinker @executable_path/Frameworks/Person.framework/Frameworks ` å¯ä»¥æ›¿æ¢ä¸º `-Xlinker -rpath -Xlinker @loader_path/Frameworks `

ä¿®æ”¹è„šæœ¬åï¼Œåˆ†åˆ«åœ¨ Person.framework å’Œ main å¯æ‰§è¡Œæ–‡ä»¶æ ¹ç›®å½•ä¸‹æ‰§è¡Œ build.sh è„šæœ¬ï¼Œç„¶åéªŒè¯å¯æ‰§è¡Œæ–‡ä»¶æ˜¯å¦å¯ä»¥æ­£ç¡®è¿è¡Œï¼ŒåŠ è½½æ‰€éœ€åŠ¨æ€åº“

æ³¨ï¼šä¸ºäº†æ–¹ä¾¿çœ‹æ¸…æ¥šè„šæœ¬æ‰§è¡Œæƒ…å†µå’Œå¯æ‰§è¡Œæ–‡ä»¶æ‰§è¡Œç»“æœï¼Œè¿™æ¬¡è¿è¡Œæ³¨é‡Šäº† otool çš„æ‰“å°è„šæœ¬ã€‚

<img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/DynamicLibReferencedDynamicLibUseLoaderPath.png" style="zoom:30%" />



`loader_path` æ˜¯æ ‡å‡†è§£å†³æ–¹æ¡ˆã€‚éšä¾¿æ‰“å¼€ AFNetworking å·¥ç¨‹çœ‹çœ‹

<img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/LoaderPathAndRPathInAFNetworking.png" style="zoom:30%" />





é“¾æ¥å™¨å¯çœŸå¼ºå¤§å•Šï¼ŒåŒæ—¶ Mach-O å¼€çš„å£å­ä¹Ÿå¤šï¼Œä¹Ÿå°±æ˜¯å¯ä»¥éšæ„ä¿®æ”¹å·²ç»ç¼–è¯‘å¥½çš„å¯æ‰§è¡Œæ–‡ä»¶çš„ `rpath` ï¼Œè‡ªå·±ä¹Ÿå¯ä»¥åˆ›å»ºä¸€ä¸ªåŒåçš„åŠ¨æ€åº“ï¼ˆnameï¼‰æŠŠåŸæœ‰çš„åŠ¨æ€åº“æ›¿æ¢äº†ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆ MacOS é‚£äº›ç ´è§£è½¯ä»¶çš„å·¥ä½œåŸç†ã€‚ï¼ˆå½“ç„¶ï¼Œè¿™äº›ä¹Ÿè¦ç»“åˆé€†å‘æŠ€æœ¯ï¼‰

ä¸Šè¿°çš„æ“ä½œï¼Œå…¶å®æœ¬è´¨å°±æ˜¯ä¿®æ”¹ Mach-O æ–‡ä»¶çš„ Load Commandï¼ŒæŒ‰ç…§ Apple çš„æœºåˆ¶ï¼ŒMach-O ä¿®æ”¹åï¼Œå¿…é¡»é‡æ–°ç­¾åæ‰å¯ä»¥è¿è¡Œä½¿ç”¨ç ´è§£è½¯ä»¶æ—¶ï¼Œæ€»æ˜¯è¦æ±‚æˆ‘ä»¬é‡æ–°ç­¾åï¼ŒèƒŒåçš„å‘½ä»¤å¦‚ä¸‹ï¼š

```shell
sudo codesign --force --deep --sign - (åº”ç”¨è·¯å¾„)
```



### åŠ¨æ€åº“å¦‚ä½•å¯¼å‡ºæ‰€å¼•ç”¨çš„åŠ¨æ€åº“çš„ç¬¦å·

- ä¸»å·¥ç¨‹ -> Person åŠ¨æ€åº“
- Person åŠ¨æ€åº“ -> Cat åŠ¨æ€åº“

é‚£ä¹ˆä¸»å·¥ç¨‹å¯ä»¥ç›´æ¥è°ƒç”¨ Cat åŠ¨æ€åº“çš„èƒ½åŠ›å—ï¼Ÿ

æ­£å¸¸å†™ä»£ç è‚¯å®šå¯ä»¥ï¼Œä½†æ˜¯ä»é“¾æ¥å™¨è§’åº¦åˆ†æä¸‹ï¼Œå¦‚ä½•å®ç°

è°ƒç”¨çš„æœ¬è´¨å°±æ˜¯ç¬¦å·çš„å‘ç°ã€‚ä¹Ÿå°±æ˜¯ Cat çš„ç¬¦å·æœ‰æ²¡æœ‰å¯¼å‡ºï¼Ÿå¯æ‰§è¡Œæ–‡ä»¶ mian ä½¿ç”¨çš„èƒ½åŠ›å°±æ˜¯åŠ¨æ€åº“å¯¼å‡ºåï¼Œè‡ªå·±å¯¼å…¥çš„ã€‚

å› ä¸º main å¼•å…¥äº† `import <Person.h>` ï¼ŒæŸ¥çœ‹ä¸‹ Person åŠ¨æ€åº“çš„å¯¼å‡ºç¬¦å·ï¼Œä½¿ç”¨æŒ‡ä»¤ `objdump --macho --exports-trie Person`

è¿›å…¥ Cat.framework ä¹ŸæŸ¥çœ‹ä¸‹ Cat åŠ¨æ€åº“çš„å¯¼å‡ºç¬¦å·ï¼Œä½¿ç”¨æŒ‡ä»¤ `objdump --macho --exports-trie Cat`

å‘ç° Person æ²¡æœ‰å¯¼å‡º Cat çš„ç¬¦å·ã€‚é‚£åœ¨å¯æ‰§è¡Œæ–‡ä»¶ä¸­è°ƒç”¨ä¸äº† Cat çš„èƒ½åŠ›äº†ã€‚

<img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/DynamicLibReferencedDynamicLibSeeExportedSymbol.png" style="zoom:30%" />



æ€ä¹ˆåŠå‘¢ï¼Ÿé“¾æ¥å™¨ LD å·²ç»æ˜¯å¾ˆæˆç†Ÿçš„ä¸œè¥¿äº†ï¼Œå¯¹äºå¤„ç†åŠ¨æ€åº“ä¾èµ–äº†åŠ¨æ€åº“ï¼Œä¸”éœ€è¦å°†è¢«ä¾èµ–åŠ¨æ€åº“çš„ç¬¦å·å¯¼å‡ºï¼Œè¿™æ ·çš„éœ€æ±‚æ—©å·²æ»¡è¶³äº†ã€‚å…·ä½“æ˜¯ä»€ä¹ˆå‚æ•°ï¼Ÿç»ˆç«¯è¾“å…¥ `man ld` æŸ¥çœ‹ä¸‹æŒ‡ä»¤

<img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/ManLDListReexportArg.png" style="zoom:30%" />

å…¶ä¸­ï¼Œæˆ‘ä»¬éœ€è¦ç”¨çš„æ˜¯ `-reexport_framework` è¿™ä¸ªå‚æ•°ã€‚æŒ‡ä»¤ä¸º ` -Xlinker -reexport_framework -Xlinker Cat`

å¯¹æ­¤ï¼Œä¿®æ”¹ Person.framework çš„ build.sh è„šæœ¬

```
echo "1ï¼šç¼–è¯‘ Person.m ä¸º Person.o å¯æ‰§è¡Œæ–‡ä»¶"

clang -target x86_64-apple-macos13.1 \
  -fobjc-arc \
  -isysroot /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX13.1.sdk \
  -I./Headers \
  -I./Frameworks/Cat.framework/Headers \
  -c Person.m -o Person.o

echo "2: é“¾æ¥ Person.o ä¸º Person åŠ¨æ€åº“"

clang -dynamiclib \
    -target x86_64-apple-macos13.1  \
    -fobjc-arc \
    -isysroot /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX13.1.sdk \
    -Xlinker -install_name -Xlinker @rpath/Person.framework/Person \
    -Xlinker -rpath -Xlinker @executable_path/Frameworks/Person.framework/Frameworks \
    -Xlinker -reexport_framework -Xlinker Cat \
    -F./Frameworks/ \
    -framework Cat \
    Person.o -o Person


echo "3: è¾“å‡ºåŠ¨æ€åº“çš„ dylib ä¿¡æ¯"
otool -l Person | grep 'DYLIB' -A 5

echo "-----------"
echo "4: è¾“å‡ºåŠ¨æ€åº“çš„ name ä¿¡æ¯"
otool -l Person | grep 'ID' -A 5

```

æ‰§è¡Œè„šæœ¬è¾“å‡ºå¦‚ä¸‹ï¼š

<img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/DynamicLibExportFrameworkSymbolWhichUsed.png" style="zoom:30%" />

ç»“æ„å¦‚ä¸‹ï¼š

<img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/AppUseIndirectDynamicLibProcess.png" style="zoom:60%" />

ç†è®ºä¸Šæ¥è®²ï¼ŒPerson.framework æŠŠ Cat.framework å¯¼å‡ºäº†ï¼Œå®ç°æ–¹å¼æ˜¯é€šè¿‡ç»™ Mach-O çš„ä¸€ä¸ªå«åš `LC_REEXPORT_DYLIB` çš„ Load Commandã€‚ä¹Ÿå°±æ˜¯å¯æ‰§è¡Œæ–‡ä»¶ï¼Œé€šè¿‡ Person.framework çš„ `LC_REEXPORT_DYLIB` load Command å¯ä»¥å®ç°è®¿é—® Cat.framework çš„ç¬¦å·ã€‚

å®Œæ•´éªŒè¯ä¸‹ï¼Œè¿˜éœ€è¦åš2ä»¶äº‹æƒ…ï¼š

- ä¿®æ”¹ main.m çš„ä»£ç ï¼Œå› ä¸ºè¦è®¿é—® Cat.framework çš„èƒ½åŠ›ï¼Œæµ‹è¯•èƒ½å¦æ­£å¸¸è¿è¡Œ

  ```objective-c
  #import <Foundation/Foundation.h>
  #import "Person.h"
  #import <Cat.h>
  
  int main(int argc, char * argv[]) {
      Person *p = [[Person alloc] init];
      [p sayHi];
      Cat *cat = [[Cat alloc] init];
      [cat sleep];
      return 0;
  }
  ```

- ä¿®æ”¹ main.m çš„ build.sh è„šæœ¬ï¼Œå› ä¸º Person.framework å·²ç»æš´éœ²äº† Cat.framework çš„èƒ½åŠ›ã€‚LD é“¾æ¥æŒ‡ä»¤éœ€è¦åŠ  Cat.framework å¤´æ–‡ä»¶çš„å‚æ•°

  ```shell
  echo "---------------- start --------------"
  
  echo "ç¬¬ä¸€æ­¥ï¼šå…ˆå¯¹ main.m ç¼–è¯‘ä¸º main.o"
  
  clang -target x86_64-apple-macos13.1 \
    -fobjc-arc \
    -isysroot /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX13.1.sdk \
    -I./Frameworks/Person.framework/Headers \
    -I./Frameworks/Person.framework/Frameworks/Cat.framework/Headers \
    -c main.m -o main.o
  
  echo "ç¬¬äºŒæ­¥ï¼Œå°† main.o å’Œ Person.dylib é“¾æ¥ä¸ºå¯æ‰§è¡Œæ–‡ä»¶ main"
  
  clang -target x86_64-apple-macos13.1 \
    -fobjc-arc \
    -isysroot /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX13.1.sdk \
    -Xlinker -rpath -Xlinker @executable_path/Frameworks \
    -F./Frameworks \
    -framework Person \
    main.o -o main
  
  # echo "ç¬¬ä¸‰æ­¥ï¼Œè¾“å‡ºä¿¡æ¯"
  # otool -l main | grep 'RPATH' -A 3
  # otool -l main | grep 'DYLIB' -A 3
  
  echo "---------------- Done --------------"
  ```

ä¿®æ”¹å®Œä»é‡Œåˆ°å¤–ä¸€æ¬¡æ€§æ‰§è¡Œ build.shï¼Œå¾—åˆ° main å¯æ‰§è¡Œæ–‡ä»¶ã€‚ä¸€åˆ‡é¡ºåˆ©ï¼Œè¾“å‡ºå¦‚ä¸‹ï¼š

<img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/UseIndirectDynamicLibSymbolWhenDynamicLibraryReferencedDynamicLib.png" style="zoom:30%" />





## xcframework

### è¯ç”ŸèƒŒæ™¯

XCFrameworkï¼šæ˜¯è‹¹æœå®˜â½…æ¨èçš„ã€â½€æŒçš„ï¼Œå¯ä»¥æ›´â½…ä¾¿çš„è¡¨ç¤ºâ¼€ä¸ªå¤šå¹³å°å’Œæ¶æ„çš„åˆ†å‘â¼†è¿›åˆ¶åº“çš„æ ¼å¼ã€‚ä¸“â»”åœ¨ 2019 å¹´æå‡ºçš„framework çš„å¦â¼€ç§å…ˆè¿›æ ¼å¼ã€‚

éœ€è¦ Xcode11 ä»¥ä¸Šâ½€æŒã€‚æ˜¯ä¸ºäº†æ›´å¥½çš„â½€æŒ Mac Catalyst æœºåˆ¶å’Œ ARM èŠ¯â½šçš„ macOSã€‚



### ä¼˜åŠ¿

èƒ–äºŒè¿›åˆ¶ï¼šFat Binaryï¼Œé€šç”¨äºŒè¿›åˆ¶æ ¼å¼ï¼ˆUniversal Binaryï¼‰ã€‚é€šç”¨äºŒè¿›åˆ¶æ–‡ä»¶å®é™…ä¸Šå°±æ˜¯å°†æ”¯æŒä¸åŒæ¶æ„çš„äºŒè¿›åˆ¶æ–‡ä»¶æ‰“åŒ…æˆä¸€ä¸ªæ–‡ä»¶ï¼Œç³»ç»Ÿåœ¨åŠ è½½è¿è¡Œæ—¶ï¼Œä¼šæ ¹æ®é€šç”¨äºŒè¿›åˆ¶æ–‡ä»¶ä¸­æä¾›çš„æ¶æ„ï¼Œé€‰æ‹©å’Œå½“å‰ç³»ç»ŸåŒ¹é…çš„äºŒè¿›åˆ¶æ–‡ä»¶ã€‚

åŠ¨æ€åº“æ˜¯å¯ä»¥åˆå¹¶çš„ã€‚å‰ææ˜¯ä¸åŒçš„ CPU æ¶æ„ã€‚åˆå¹¶ä¹‹åè¿˜æ˜¯å¤šä¸ªä¸åŒçš„åŠ¨æ€åº“ï¼Œåªä¸è¿‡ mach-header æ˜¯æŒ¨åœ¨ä¸€èµ·çš„ï¼Œæ‰€æœ‰çš„åº“æ–‡ä»¶ä¹Ÿæ˜¯æŒ¨ç€çš„ã€‚å¯ä»¥ç†è§£æˆæ˜¯â€œå‹ç¼©â€ã€‚

lipo æŒ‡ä»¤çš„ç¼ºç‚¹ï¼šä¸èƒ½åˆå¹¶ç›¸åŒæ¶æ„ã€‚å¯¹ä¸åŒçš„åº“å¤„ç†åï¼Œè¿˜è¦å¤„ç† `dSYM` æ–‡ä»¶ï¼Œå¦‚æœåº“å¼€å¯äº† Bitcodeï¼Œè¿˜ä¼šç”Ÿæˆ `BCSymbolMaps`

æ–‡ä»¶ã€‚æ‰€ä»¥ä½¿ç”¨ lipo å¤„ç†åŠ¨æ€åº“çš„åˆå¹¶ã€æ‹†åˆ†ï¼Œéƒ½éœ€è¦ç®¡ç† `dSYM`ã€`BCSymbolMaps`ã€`åº“æ–‡ä»¶`ï¼Œè¾ƒä¸ºç¹çã€‚

åŸºäºæ­¤ï¼ŒApple åœ¨ 2019 è¯ç”Ÿäº† `xcframework` æŠ€æœ¯ã€‚

å’Œä¼ ç»Ÿçš„ framework ç›¸â½ï¼š

- å¯ä»¥â½¤å•ä¸ª`.xcframework` â½‚ä»¶æä¾›å¤šä¸ªå¹³å°çš„åˆ†å‘â¼†è¿›åˆ¶â½‚ä»¶

- ä¸ `Fat Header` ç›¸â½ï¼Œå¯ä»¥æŒ‰ç…§å¹³å°åˆ’åˆ†ï¼Œå¯ä»¥åŒ…å«ç›¸åŒæ¶æ„çš„ä¸åŒå¹³å°çš„â½‚ä»¶

- åœ¨ä½¿â½¤æ—¶ï¼Œä¸éœ€è¦å†é€šè¿‡è„šæœ¬å»å‰¥ç¦»ä¸éœ€è¦çš„æ¶æ„ä½“ç³»ï¼ˆæ¯”å¦‚é»˜è®¤åŒ…å«3ç§æ¶æ„ï¼Œarmv7ã€arm64ã€x86_64 ä¸Šæ¶å‰ä¸ºäº†åŒ…å¤§å°ï¼Œè¿˜ä¼šç”¨ lipo æŒ‡ä»¤å‰”é™¤ä¸éœ€è¦çš„æ¶æ„ï¼‰



### å¦‚ä½•åˆ¶ä½œ xcframework

ç¬¬ä¸€æ­¥ï¼šå…ˆåˆ›å»ºä¸€ä¸ªåŠ¨æ€åº“ `pod lib create Person`ã€‚é‡Œé¢å°±ä¸€ä¸ª Person ç±»ï¼Œ åŒ…å«2ä¸ªæ–¹æ³•ã€‚

ç¬¬äºŒæ­¥ï¼šåˆ©ç”¨ `xcodebuild` æŒ‡ä»¤æ‰“åŒ…ã€‚`xcodebuild` æŒ‡ä»¤æ‰§è¡Œçš„æ˜¯æ‰“åŒ…å½“å‰çš„å·¥ç¨‹ç›®å½•ï¼Œä¼šè¯»å– `-workspace` å‚æ•°æŒ‡å®šçš„é¡¹ç›®é…ç½®ï¼Œç„¶åæ ¹æ®æŒ‡å®šçš„ `-scheme` å’Œ `-configuration` æ¨¡å¼å»æ‰“åŒ…å·¥ç¨‹ã€‚

å…ˆæ‰“å‡ºæ¨¡æ‹Ÿå™¨çš„åŒ…ï¼ŒæŒ‡ä»¤å¦‚ä¸‹ï¼š

```shell
xcodebuild -workspace Person.xcworkspace \
  -scheme 'Person-Example' \
  -configuration Release \
  -destination 'generic/platform=iOS Simulator' \
  -archivePath '../archives/Person.framework-iphonesimulator.xcarchive' \
  SKIP_INSTALL=NO \
  archive
```

å†æ‰“å‡ºçœŸæœºçš„åŒ…ï¼ŒæŒ‡ä»¤å¦‚ä¸‹

```shell
xcodebuild -workspace Person.xcworkspace \
  -scheme 'Person-Example' \
  -configuration Release \
  -destination 'generic/platform=iOS' \
  -archivePath '../archives/Person.framework-iphoneos.xcarchive' \
  SKIP_INSTALL=NO \
  archive
```

æ‰“åŒ…æˆåŠŸçš„è¾“å‡ºå¦‚ä¸‹ï¼š

<img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/XcodebuildArchiveSuccessResult.png" style="zoom:30%" />

å®ä½“ç›®å½•å¦‚ä¸‹ï¼š

<img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/XcodebuildDynamicLibResult.png" style="zoom:30%" />

æ³¨æ„ï¼šæˆ‘ä»¬æ‰“è´¥å½’æ¡£åç”Ÿæˆçš„ç¬¦å·è¡¨åªæœ‰ `.dSYM` æ–‡ä»¶ï¼Œæ²¡æœ‰ `BCSymbolMaps` æ–‡ä»¶ï¼Œæ˜¯å› ä¸ºå·¥ç¨‹æ²¡æœ‰å¼€å¯ BitCodeï¼Œå½“å¼€å¯ BitCode åçš„ï¼Œæ‰“åŒ…ä¼šç”Ÿæˆ `BCSymbolMaps` æ–‡ä»¶ï¼Œä½œç”¨ä¹Ÿæ˜¯ç”¨äº Crash åè§£æå †æ ˆç”¨çš„ã€‚

å› ä¸º `.dSYM` æ–‡ä»¶æ˜¯é»˜è®¤ç”Ÿæˆçš„ï¼Œä½†æ˜¯ `Bitcode` éœ€è¦åˆ†åˆ«å¼€å¯ï¼ˆPod å’Œ Demo å·¥ç¨‹ï¼‰ã€‚å¼€å¯ Bitcode åé‡æ–°æ‰“åŒ…ï¼Œçœ‹çœ‹ç”Ÿæˆçš„äº§ç‰©é‡Œæœ‰æ²¡æœ‰ `BCSymbolMaps` å’Œç›¸å…³çš„ `.bcsymbolmap` æ–‡ä»¶

<img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/XcodebuildResultWithBitcodeEnable.png" style="zoom:30%" />



ç¬¬ä¸‰æ­¥ï¼šåˆ©ç”¨ `xcodebuild` æ‰“åŒ…æˆ xcframework

```shell
xcodebuild -create-xcframework \
  -framework 'archives/Person.framework-iphoneos.xcarchive/Products/Library/Frameworks/Person.framework' \
  -framework 'archives/Person.framework-iphonesimulator.xcarchive/Products/Library/Frameworks/Person.framework' \
  -output './../xcframework/Person.xcframework'
```

ç»“æœå¦‚ä¸‹ï¼š

<img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/XcodebuildXcframeworkResult.png" style="zoom:30%" />

å¯ä»¥çœ‹åˆ°æ‰“åŒ…åçš„ xcframework è‡ªåŠ¨å¤„ç†äº†æ–‡ä»¶å¤¹ã€‚ä½†æ˜¯ç¼ºç‚¹æ˜¯æˆ‘ä»¬æä¾›çš„ frameworkï¼Œåˆ«äººä½¿ç”¨å¯èƒ½ä¼š crashï¼Œæ‰€ä»¥ä¸ºäº†ä¸€äº›ä½¿ç”¨åœºæ™¯éœ€è¦åœ¨ xcframework ä¸­æä¾› `.dSYM` æ–‡ä»¶æˆ–è€… `.bcsymbolmap` æ–‡ä»¶ã€‚

ç¬¬å››æ­¥ï¼šåŠ å…¥ `.dSYM` å’Œ `.BCSymbolMaps` æ–‡ä»¶ï¼Œé‡æ–°ç”Ÿæˆ xcframeworkï¼Œå…¶å‚æ•°ä¸º `-debug-symbols`ï¼Œåé¢è·¯å¾„å¿…é¡»æ˜¯ç»å¯¹è·¯å¾„ã€‚

```shell
xcodebuild -create-xcframework \
  -framework 'archives/Person.framework-iphoneos.xcarchive/Products/Library/Frameworks/Person.framework' \
  -debug-symbols '/Users/unix_kernel/Desktop/LDAndFramework/MultipleArchMerge/Person/archives/Person.framework-iphoneos.xcarchive/BCSymbolMaps/3C61A3F4-4398-322F-8AC9-F078B196C381.bcsymbolmap' \
  -debug-symbols '/Users/unix_kernel/Desktop/LDAndFramework/MultipleArchMerge/Person/archives/Person.framework-iphoneos.xcarchive/BCSymbolMaps/B34138DB-2F8F-372C-93D3-7ADDDFC7BDA1.bcsymbolmap' \
  -debug-symbols '/Users/unix_kernel/Desktop/LDAndFramework/MultipleArchMerge/Person/archives/Person.framework-iphoneos.xcarchive/dSYMs/Person.framework.dSYM' \
  -framework 'archives/Person.framework-iphonesimulator.xcarchive/Products/Library/Frameworks/Person.framework' \
  -debug-symbols '/Users/unix_kernel/Desktop/LDAndFramework/MultipleArchMerge/Person/archives/Person.framework-iphonesimulator.xcarchive/dSYMs/Person.framework.dSYM' \
  -output './../xcfrmaework/Person.xcframework'
```

ç»“æœå¦‚ä¸‹

<img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/XcodebuildXCFrameworkWithDebugSymbol.png" style="zoom:30%" />

å¯ä»¥çœ‹åˆ° xcframework é‡Œé¢ä¸åªæœ‰ä¸åŒçš„åŠ¨æ€åº“ï¼Œè¿˜æºå¸¦äº†å¯¹åº”çš„ `.dSYM` å’Œ `bcsymbolmap` æ–‡ä»¶ï¼Œç”¨äºå †æ ˆã€ç¬¦å·è¿˜åŸã€‚



ç¬¬äº”æ­¥ï¼šåˆ¶ä½œå¥½çš„ xcframework æ¥å…¥ä½¿ç”¨ä¸‹ã€‚

- æ–°å»ºä¸€ä¸ªå«åš `XCFrameworkUsageDemo` çš„ Xcode iOS App å·¥ç¨‹

- å¯¼å…¥åˆ›å»ºçš„ `Person.xcframework` 

- import å¤´æ–‡ä»¶å¹¶ä½¿ç”¨

  <img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/XcodeProjectUseXcframework.png" style="zoom:20%" />

- ç¼–è¯‘è¿è¡Œï¼ŒæŸ¥çœ‹ products ä¸‹é¢çš„äº§ç‰©ï¼Œå› ä¸ºé€‰æ‹©çš„æ˜¯æ¨¡æ‹Ÿå™¨è¿è¡Œï¼Œæ‰€ä»¥éªŒè¯  `Person.framework` é‡Œé¢çš„åŠ¨æ€åº“æ–‡ä»¶å¤§å°ï¼Œæ˜¯å¦å’Œ `Person.xcframework` é‡Œé¢æ¨¡æ‹Ÿå™¨ç›®å½•ä¸‹ Person åŠ¨æ€åº“çš„å¤§å°ä¸€è‡´

  <img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/XcframeworkWillImportArchLibAutomatically.png" style="zoom:20%" />

å¯ä»¥çœ‹åˆ°æˆ‘ä»¬æ‰“åŒ…çš„ `Person.xcframework` å¯ä»¥æ­£å¸¸ä½¿ç”¨ï¼Œé™¤æ­¤ä¹‹å¤–ï¼Œ`Person.xcframework` åŒ…å«äº†æ¨¡æ‹Ÿå™¨å’ŒçœŸæœºçš„åŠ¨æ€åº“æ–‡ä»¶å’Œå¯¹åº”çš„ `.dSYM` å’Œ `.bcsymbolmap` æ–‡ä»¶ï¼Œå½“å¯¼å…¥åˆ°é¡¹ç›®ä¸­çš„æ—¶å€™ï¼ŒXcode ä¼šæ ¹æ®å½“å‰ç¼–è¯‘çš„æ¶æ„ï¼Œè‡ªåŠ¨ä»é‡Œé¢é€‰æ‹©åˆé€‚çš„æ¶æ„æ–‡ä»¶ã€‚

å¥½å¤„æœ‰3:

- ä¸éœ€è¦å¤„ç†å¤´æ–‡ä»¶
- æˆ‘ä»¬ä¸éœ€è¦å…³å¿ƒä¸Šçº¿å‰å¤„ç†ï¼Œé‡å¤æ¶æ„ï¼ˆlipo å‰”é™¤ï¼‰
- è°ƒè¯•ç¬¦å·ä¹Ÿæ–¹ä¾¿çš„ç»™åˆ°

æ³¨æ„ï¼šè¯¥éƒ¨åˆ†ä»£ç ï¼Œåœ¨ `LDAndFramework/XCFramework` ç›®å½•ä¸‹ã€‚



## Weak Import

å…ˆåšä¸ªå°å®éªŒ

ç¬¬ä¸€æ­¥ï¼šåˆ›å»ºä¸€ä¸ª iOS App å·¥ç¨‹ï¼Œç„¶åæŠŠä¸Šé¢ç”Ÿæˆçš„ `Person.framework` æ‹–åˆ°å·¥ç¨‹æ ¹ç›®å½•ä¸‹

ç¬¬äºŒæ­¥ï¼šä¸å¼•å…¥åŠ¨æ€åº“ï¼Œè€Œæ˜¯é€šè¿‡ xcconfig æ–‡ä»¶ï¼Œå‘Šè¯‰é“¾æ¥å™¨ï¼Œå…³äºåŠ¨æ€åº“çš„ä¸‰è¦ç´ ï¼šå¤´æ–‡ä»¶ä½ç½®ã€åŠ¨æ€åº“åç§°ã€‚

ç¬¬ä¸‰æ­¥ï¼šç¼–è¯‘è¿è¡Œã€‚

<img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/ProjectCompileDyanmicLibUseXcconfig.png" style="zoom:20%" />

ç»“è®ºï¼šç¼–è¯‘æ­£å¸¸ï¼Œä½†æ˜¯è¿è¡Œä¼šæŠ¥é”™ `Library not loaded: @rpath/Person.framework/Person`

ç¬¬ä¸€ç§è§£å†³æ–¹æ¡ˆæ˜¯ç»™ xcconfig æ·»åŠ  rpath çš„å…·ä½“è·¯å¾„ã€‚

<img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/XcconfigSetRpathInfo.png" style="zoom:20%" />

ç¬¬äºŒç§è§£å†³æ–¹æ¡ˆæ˜¯å°†åº“å£°æ˜ä¸ºâ€œå¼±å¼•ç”¨â€ã€‚è¾“å…¥ `man ld` æŸ¥çœ‹å…·ä½“çš„å‚æ•°å’Œè¯´æ˜ï¼š

```shell
 -weak_framework name[,suffix]
             This is the same as the -framework name[,suffix] but forces the framework and all references to it to be marked as weak imports.  Note: due to a
             clang optimizations, if functions are not marked weak, the compiler will optimize out any checks if the function address is NULL.
```

ä¿®æ”¹ xcconfig æ–‡ä»¶ä¸º

```shell
//  å¼•ç”¨ä¸€ä¸ªåŠ¨æ€åº“ï¼Œ3è¦ç´ ï¼šå¤´æ–‡ä»¶ã€åŠ¨æ€åº“åç§°ã€åŠ¨æ€åº“è·¯å¾„
// çŸ¥é“äº†é“¾æ¥çš„åŸç†ä¹‹åï¼Œå°±çŸ¥é“å¯ä»¥ä¸ç”¨æŠŠåŠ¨æ€åº“æ‰˜åˆ°é¡¹ç›®ä¸­å»ï¼ŒæŒ‡å®šäº†3è¦ç´ å°±å¯ä»¥é“¾æ¥äº†ã€‚
// 1. -I:å¤´æ–‡ä»¶ä¿¡æ¯
HEADER_SEARCH_PATHS = $(inherited) ${SRCROOT}/Person.framework/Headers
LD_RUNPATH_SEARCH_PATHS = $(inherited)
// 2. -F:framework
FRAMEWORK_SEARCH_PATHS = $(inherited) ${SRCROOT}
// 3. -weak_framework: å…è®¸è¯¥åº“åœ¨è¿è¡Œæ—¶æ¶ˆå¤±
OTHER_LDFLAGS = $(inherited) -Xlinker -weak_framework -Xlinker "Person"
```

ä¿®æ”¹åç¼–è¯‘è¿è¡Œï¼Œå‘ç°æ²¡æœ‰æŠ¥ `Library not loaded: ` è¿™æ ·çš„é”™ã€‚

æˆ‘ä»¬å¯¹æ·»åŠ äº† `_weak-framework` è¿™ä¸ªé“¾æ¥å™¨å‚æ•°çš„å¯æ‰§è¡Œæ–‡ä»¶æŸ¥çœ‹ä¸‹ï¼ŒæŒ‡ä»¤ä¸º `otool -l WeakImportDemo`

<img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/LDSetWeakFramework.png" style="zoom:30%" />

æŸ¥çœ‹ Mach-O å‘ç°ï¼Œä» `LC_LOAD_DYLIB` å˜ä¸º `LC_LOAD_WEAK_DYLIB` 



é€šå¸¸ï¼Œå½“é“¾æ¥ä¸€ä¸ªåº“æ—¶ï¼Œé“¾æ¥å™¨ä¼šå°è¯•è§£ææ‰€æœ‰ä»è¯¥æ¡†æ¶ä¸­å¼•ç”¨çš„ç¬¦å·ã€‚å¦‚æœæŸä¸ªç¬¦å·åœ¨åº“ä¸å­˜åœ¨æˆ–è€…æ²¡æœ‰å¯¼å‡ºï¼Œé“¾æ¥å™¨ä¼šæŠ¥é”™ï¼Œå› ä¸ºè¿™æ˜¯ä¸€ä¸ªå¼ºé“¾æ¥ï¼ˆstrong linkingï¼‰çš„è¦æ±‚ã€‚

ä½¿ç”¨ `-weak_framework` é€‰é¡¹ï¼Œå¯ä»¥å‘Šè¯‰é“¾æ¥å™¨ï¼Œå³ä½¿æ¡†æ¶ä¸­ç¼ºå°‘æŸäº›ç¬¦å·ï¼Œä¹Ÿä¸è¦æŠ¥é”™ï¼Œè€Œæ˜¯å…è®¸é“¾æ¥ç»§ç»­è¿›è¡Œã€‚

è¿™æ ·ï¼Œåº”ç”¨ç¨‹åºåœ¨è¿è¡Œæ—¶å¯ä»¥ä¼˜é›…åœ°å¤„ç†ç¼ºå°‘çš„ç¬¦å·ï¼Œä¾‹å¦‚ï¼ŒæŸä¸ªç‰¹æ€§å¯èƒ½å› ä¸ºç¼ºå°‘å®ç°è€Œä¸å¯ç”¨ï¼Œä½†åº”ç”¨ç¨‹åºçš„å…¶ä»–éƒ¨åˆ†ä»ç„¶å¯ä»¥æ­£å¸¸å·¥ä½œã€‚

å½“ä¸€ä¸ªåŠ¨æ€åº“ï¼Œåœ¨è¿è¡Œæ—¶ï¼Œä¸èƒ½ä¿è¯



## é™æ€åº“ç¬¦å·å†²çªåŸå› åŠå…¶è§£æ³•

æ¢ç´¢ä¸‹é™æ€åº“ç¬¦å·å†²çªçš„æƒ…å†µä¸‹ï¼Œæ€ä¹ˆè§£å†³ï¼Ÿ

æ¥ä¸ªç®€å•çš„å°å®éªŒã€‚

ç¬¬ä¸€æ­¥ï¼šå‡†å¤‡2ä¸ª AFNetworking çš„é™æ€åº“ï¼Œç¬¦å·ä¸€æ¨¡ä¸€æ ·ï¼Œä½†æ˜¯é™æ€åº“åç§°ä¸åŒã€‚

ç¬¬äºŒæ­¥ï¼šåˆ›å»º Demo å·¥ç¨‹ï¼Œå°†é™æ€åº“æ”¾åˆ°æ ¹ç›®å½•ä¸‹ã€‚

ç¬¬ä¸‰æ­¥ï¼šåˆ›å»º xcconfig æ–‡ä»¶ã€‚é…ç½®å‚æ•°ç”¨äºé…åˆ¶ä¸€äº›ç¼–è¯‘ã€é“¾æ¥ä¿¡æ¯ã€‚

```json
//// -I
HEADER_SEARCH_PATHS = $(inherited) "${SRCROOT}/AFNetworking" "$(SRCROOT)/AFNetworking2"
//// -L
LIBRARY_SEARCH_PATHS = $(inherited) "${SRCROOT}/AFNetworking" "$(SRCROOT)/AFNetworking2"
//// -l
OTHER_LDFLAGS = $(inherited) -l"AFNetworking" -l"AFNetworking2"
```

ç¬¬å››æ­¥ï¼šå°è¯•ç¼–è¯‘ï¼Œç¼–è¯‘æˆåŠŸã€‚

<img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/ProjectLinkedTwoSameStaticLib.png" style="zoom:20%" />

QAï¼šä¸ºä»€ä¹ˆé“¾æ¥2ä¸ªåŒååŒç¬¦å·çš„é™æ€åº“ï¼Œç¼–è¯‘ä¸æŠ¥é”™ï¼Ÿ

ä¼šæœ‰äºŒçº§å‘½åç©ºé—´å—ï¼Ÿä¸æ˜¯çš„ã€‚é™æ€åº“æœ¬è´¨å°±æ˜¯ä¸€å † `.o` æ–‡ä»¶ï¼Œæ‰€æœ‰çš„ `.o` æœ€åéƒ½ä¼šå’Œä¸»å·¥ç¨‹çš„å¯æ‰§è¡Œæ–‡ä»¶è¿›è¡Œåˆå¹¶ï¼Œæ‰€ä»¥ä¸å­˜åœ¨äºŒçº§å‘½åç©ºé—´çš„é—®é¢˜ã€‚

æ ¸å¿ƒåŸå› æ˜¯å› ä¸ºï¼Œé“¾æ¥å™¨é’ˆå¯¹é™æ€åº“ï¼Œåœ¨ deac code strip ä¸“é—¨ä¸ºé™æ€åº“ï¼Œè®¾ç½®ä¸º `-noall_load`ï¼Œæ„æ€æ˜¯ï¼šå®Œå…¨ä¸åŠ è½½ã€ç›´æ¥å»ä¼˜åŒ–

å¯ä»¥éªŒè¯ä¸‹ï¼Œåœ¨é“¾æ¥çš„æ—¶å€™ä¿®æ”¹é“¾æ¥å‚æ•°ä¸º `-all_load` å°±ä¼šæŠ¥é”™

<img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/ProjectLinkedTwoSameStaticLibWillFailedWithAllLoad.png" style="zoom:20%" />



å¦‚ä½•è§£å†³ï¼Ÿï¼Ÿ

LD æä¾›äº† ` -load_hidden` å‚æ•°ã€‚

```shell
 -load_hidden path_to_archive
             Uses specified static library as usual, but treats all global symbols from the static library to as if they are visibility hidden.
             Useful when building a dynamic library that uses a static library but does not want to export anything from that static library.
```

ä¿®æ”¹ LD é“¾æ¥å‚æ•° 

```shell
OTHER_LDFLAGS = $(inherited) -l"AFNetworking" -l"AFNetworking2" -Xlinker -force_load -Xlinker "${SRCROOT}/AFNetworking/libAFNetworking.a" -Xlinker -load_hidden -Xlinker "${SRCROOT}/AFNetworking2/libAFNetworking2.a"
```

<img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/ProjectLinkedTwoSameStaticLibWithLoadHidden.png" style="zoom:20%" />

å…·ä½“ä»£ç è§ï¼š `LDAndFramework/StaticLibConflictsSolution/StaticLibConflictsDemo`



## åŠ¨åŠ¨

ç¬¬ä¸€æ­¥ï¼Œåˆ›å»ºä¸€ä¸ªåå­—å« `NetworkManager` çš„ Frameworkï¼Œå‹¾é€‰æµ‹è¯•ã€‚é‡Œé¢å°±æ·»åŠ ä¸€ä¸ª `NetworkDetector`  ç±»ï¼Œæœ‰1ä¸ªç±»æ–¹æ³• `+sharedManager`

ç¬¬äºŒæ­¥ï¼Œç»™åŠ¨æ€åº“æ·»åŠ  AFNetworking ä¾èµ–ã€‚

- é¡¹ç›®æ ¹ç›®å½•ä¸‹æ‰§è¡Œ `pod init` ï¼Œåˆå§‹åŒ–å·¥ç¨‹
- æ·»åŠ  `pod 'AFNetworking'` 

ç¬¬ä¸‰æ­¥ï¼šç›®çš„æ˜¯ä¸ºäº†ç ”ç©¶ App -> NetworkManager åŠ¨æ€åº“ -> AFNetworking åŠ¨æ€åº“çš„æƒ…å†µï¼Œæ‰€ä»¥ App å¯ä»¥ç”¨æµ‹è¯•å·¥ç¨‹ä»£æ›¿ï¼Œæµ‹è¯•å·¥ç¨‹å°±æ˜¯ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ï¼Œç±»ä¼¼ä¸€ä¸ª Appã€‚

å‘ç°ç¼–è¯‘é€šè¿‡ï¼Œè¿è¡ŒæŠ¥é”™ã€‚

<img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/DynamicLibLinkedDynamicLibInApp.png" style="zoom:25%" />

ä¸ºä»€ä¹ˆï¼ŸåŸå› 

å› ä¸º `Pods-NetworkManager.debug.xcconfig` é‡Œé¢çš„é…ç½®ä¿¡æ¯å‘Šè¯‰é“¾æ¥å™¨å…³äºç¼–è¯‘çš„3è¦ç´ ï¼šå¤´æ–‡ä»¶ä½ç½®ã€åŠ¨æ€åº“åç§°ã€rpath ä¿¡æ¯ã€‚æ‰€ä»¥å¯ä»¥é“¾æ¥æˆåŠŸï¼Œ

è¿è¡ŒæŠ¥é”™æ˜¯å› ä¸º dyld æ‰¾ä¸åˆ° AFNetworking åŠ¨æ€åº“æ‰€åœ¨çš„ä½ç½®ã€‚

ä½¿ç”¨çš„ AFNetworking åŠ¨æ€åº“ï¼Œæ‰€ä»¥`NetworkManager.Framework` çš„ Load Command `LC_LOAD_DYLIB` ä¸­çš„ name å°±å‘Šè¯‰å¤–éƒ¨ï¼ŒAFNetworking å°†ä¼šåœ¨ `@rpath/AFNetworking.framework/AFNetworking` ä¸‹é¢æŸ¥æ‰¾ã€‚

<img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/NetworkManagerFrameworkLoadCommandInfo.png" style="zoom:25%" />

éµå¾ªåŸåˆ™æ˜¯è°é“¾æ¥åº“ï¼Œè°å°±æä¾›åº“æ‰€éœ€è¦çš„ rpath ä¿¡æ¯ã€‚æ‰€ä»¥ `NetworkManager.Framework` æä¾› rpath ä¿¡æ¯ã€‚xcconfig æ–‡ä»¶çš„ `LD_RUNPATH_SEARCH_PATHS` æ˜¯ Xcode é¡¹ç›®ä¸­çš„ä¸€ä¸ªè®¾ç½®ï¼Œå®ƒåœ¨ç¼–è¯‘æ—¶å‘Šè¯‰é“¾æ¥å™¨åœ¨ç”Ÿæˆçš„å¯æ‰§è¡Œæ–‡ä»¶çš„è¿è¡Œæ—¶è·¯å¾„ï¼ˆrpathï¼‰ä¸­åŒ…å«ç‰¹å®šçš„ç›®å½•ï¼ˆ `install_name_tool -add_rpath` æ˜¯åœ¨äºŒè¿›åˆ¶æ–‡ä»¶ç”Ÿæˆåå¯¹å…¶è¿›è¡Œä¿®æ”¹ï¼‰

```shell
LD_RUNPATH_SEARCH_PATHS = $(inherited) '@executable_path/Frameworks' '@loader_path/Frameworks' '@executable_path/../../Frameworks'
```

dyld åœ¨è¿è¡Œèµ·æ¥åï¼Œä¼šæ ¹æ® `LD_RUNPATH_SEARCH_PATHS` æä¾›çš„ rpath ä¿¡æ¯ï¼Œå’Œ AFNetworking çš„ `name` æ‹¼æ¥å»æŸ¥æ‰¾ã€‚ä½†æˆ‘ä»¬é¢å‰çš„ä¾‹å­ï¼Œè·¯å¾„ä¸‹æ²¡æœ‰ AFNetworkingã€‚

å¦‚ä½•è§£å†³ï¼Ÿ

æ–¹å¼ä¸€ï¼šlow ä¸€ç‚¹ï¼Œç›´æ¥ç»™æµ‹è¯•å·¥ç¨‹ä¹Ÿ `pod AFNetworking`ã€‚è¿™æ˜¯åœ¨æ¢ç©¶åŸç†ï¼Œç®€å•è§£å†³é—®é¢˜å¯ä»¥è¿™ä¹ˆåšã€‚

<img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/TestProjectRPathViaInstallDynamicLib.png" style="zoom:25%" />

æ–¹å¼äºŒï¼šä¸æ˜¯æ‰¾ä¸åˆ° AFNetworking å—ï¼Ÿå› ä¸º xcconfig æä¾›çš„è·¯å¾„æ‰¾ä¸åˆ°ï¼Œé‚£ç›´æ¥ç»™ `LD_RUNPATH_SEARCH_PATHS` é…ç½®ä¸€ä¸ªå¯ä»¥æ‰¾åˆ°çš„åœ°æ–¹ã€‚ç„¶åè¿è¡ŒæˆåŠŸã€‚è¿™åªæ˜¯ä¸ºäº†ç ”ç©¶å®šä½é—®é¢˜åï¼Œç®€å•è§£å†³é—®é¢˜çš„æ–¹æ¡ˆã€‚

<img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/XcconfigRPathWithAbsolutePath.png" style="zoom:25%" />

æ–¹å¼ä¸‰ï¼šè§‚å¯Ÿæ ‡å‡†åšæ³•ï¼Œæ¯”å¦‚ä¸€ä¸ª App ä½¿ç”¨äº† AFNetworkingï¼Œè¿™ä¸ª case Cocoapods æ˜¯æ€ä¹ˆå¤„ç†çš„ï¼Ÿ

<img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/AppUseDynamicLibWithCocoapods.png" style="zoom:25%" />

æ˜¯é€šè¿‡ shell è„šæœ¬æ¥å¤„ç†çš„ã€‚è¯¥è„šæœ¬è‚¯å®šæ˜¯ Cocoapods ç”Ÿæˆçš„ã€‚å±äºå·¥ç¨‹åŒ–èŒƒç•´ã€‚æ ¸å¿ƒä»£ç å¦‚ä¸‹

<img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/CocoapodsCopyFramework.png" style="zoom:25%" />

å…·ä½“æ€ä¹ˆåšå‘¢ï¼Ÿç¼–å†™ shell è„šæœ¬ï¼Œç¼–è¯‘ Person åŠ¨æ€åº“ã€AFNetworking åŠ¨æ€åº“ï¼Œç„¶åå°†äº§ç‰©å¤åˆ¶åˆ° Frameworks æ–‡ä»¶å¤¹ä¸‹ã€‚

Tips

>  å¾€ä¸€ä¸ª Framework é‡Œé€šè¿‡ Cocoapods å¯¼å…¥ä¸€ä¸ªåº“ï¼Œå¹¶ä¸ä¼šçœŸçš„å¯¼å…¥ï¼Œè€Œæ˜¯ç”Ÿæˆé“¾æ¥å™¨é“¾æ¥æ‰€éœ€çš„å‚æ•°ï¼Œå¹¶ä¸ä¼šæŠŠä¾èµ–çš„åº“æ–‡ä»¶æ”¾åˆ°è‡ªèº«çš„ Framework ä¸­ã€‚



æ¥ä¸ªæœ‰è¶£çš„æ“ä½œï¼šNetworkManager.Framework å¦‚ä½•ä½¿ç”¨ä¸»å·¥ç¨‹çš„åŠŸèƒ½ï¼Ÿä¹Ÿå°±æ˜¯åå‘ä¾èµ–

**åŠŸèƒ½çš„æœ¬è´¨å°±æ˜¯ç¬¦å·ï¼Œdyld åœ¨é“¾æ¥çš„æ—¶å€™ï¼Œä¼šæŠŠæ‰€æœ‰çš„å¯¼å‡ºç¬¦å·æ”¾åˆ°ä¸€èµ·ï¼Œåªè¦è¿è¡Œçš„æ—¶å€™æ‰¾åˆ°æ‰€æœ‰çš„ç¬¦å·ï¼Œå°±å¯ä»¥åŠ¨æ€é“¾æ¥ã€‚**

 é‚£æ€ä¹ˆåšå‘¢ï¼Ÿ

ç¬¬ä¸€æ­¥ï¼šåœ¨ Appï¼ˆæˆ‘ä»¬çš„å®éªŒä¸­å°±æ˜¯æµ‹è¯•å·¥ç¨‹ï¼‰åˆ›å»º NetworkObject ç±»

ç¬¬äºŒæ­¥ï¼šåœ¨ framework çš„ HEADER_SEARCH_PATHS ä¸­å¢åŠ  App çš„å¤´æ–‡ä»¶æŸ¥æ‰¾è·¯å¾„

ç¬¬ä¸‰æ­¥ï¼šframework ä¸­å¢åŠ å®ç°ä»£ç ï¼Œä½¿ç”¨ App ä¸­çš„ç¬¦å·

<img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/FrameworkCannotFoundSymbolFromApp.png" style="zoom:25%" />



å‘ç°ç¼–è¯‘æŠ¥é”™ï¼Ÿç¬¦å·æ‰¾ä¸åˆ°

- é“¾æ¥çš„æ—¶å€™ä¼šå»æ‰¾ç¬¦å·çš„åœ°å€
- ä½† App å’ŒåŠ¨æ€åº“çš„ç¬¦å·åŸåˆ™æ˜¯ï¼Œé“¾æ¥æˆåŠŸï¼ŒApp è¿è¡Œèµ·æ¥ï¼ŒåŠ¨æ€åº“è‡ªç„¶å¯ä»¥è®¿é—®åˆ° App ä¸­çš„ç¬¦å·

æ‰€ä»¥ï¼Œå¦‚ä½•é“¾æ¥æˆåŠŸï¼Ÿå¦‚ä½•å¤„ç†è¿™ä¸ªæœªå®šä¹‰çš„ç¬¦å·ï¼Ÿ

LD é“¾æ¥å™¨æ”¯æŒç¬¦å·çš„å¤„ç†ã€‚

æ–¹æ³•ä¸€ï¼šä¿®æ”¹åŠ¨æ€åº“ xcconfig æ·»åŠ æœªå®šä¹‰çš„ç¬¦å·ä¸ºåŠ¨æ€æŸ¥æ‰¾ã€‚ä½†é£é™©è¾ƒå¤§ï¼Œæ‰€æœ‰æœªå®šä¹‰çš„éƒ½ä¸ä¼šæŠ¥é”™è¯¯ä¼¤è¾ƒå¤§ã€‚

```shell
OTHER_LDFLAGS = $(inherited) -framework "AFNetworking" -Xlinker -undefined -Xlinker dynamic_lookup
```

æ–¹æ³•äºŒï¼šåªå¯¹ç‰¹å®šçš„æœªå®šä¹‰çš„ç¬¦å·é‡‡ç”¨åŠ¨æ€æŸ¥æ‰¾

```shell
OTHER_LDFLAGS = $(inherited) -framework "AFNetworking" -Xlinker -U -Xlinker _OBJC_CLASS_$_NetworkObject
```

<img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/FrameworkUseAppSymbolFixWithLDDynamicLookup.png" style="zoom:25%" />



## åŠ¨é™

æ¨¡æ‹Ÿï¼šApp -> NetworkManager åŠ¨æ€åº“ -> AFNetworking é™æ€åº“ã€‚å°†ä¸Šé¢çš„å·¥ç¨‹ä¸­ï¼ŒNetworkManager ä¸­çš„ podfile `# use_frameworks!` æ³¨é‡Šæ‰ï¼Œå°±ä¼šä»¥é™æ€åº“çš„å½¢å¼é“¾æ¥ AFã€‚

åŠ¨æ€åº“ä¾èµ–é™æ€åº“ï¼Œåˆ™ä¼šæŠŠé™æ€åº“ä¸­æ‰€æœ‰ä»£ç é“¾æ¥åˆ°åŠ¨æ€åº“ä¸­ã€‚æ‰€ä»¥å·¥ç¨‹å¯ä»¥æ­£å¸¸ç¼–è¯‘ã€é“¾æ¥ã€‚

å¦‚ä½•åœ¨ App ä¸­å¼•å…¥é™æ€åº“ AFNetworking ä¸­çš„ç¬¦å·ï¼Ÿå› ä¸ºé“¾æ¥åï¼ŒåŠ¨æ€åº“ä¸­å·²ç»åŒ…å«äº†é™æ€åº“ä¸­çš„ç¬¦å·ï¼Œæ‰€ä»¥åªéœ€è¦è®© Xcode ç¼–è¯‘é€šè¿‡å³å¯ã€‚ç¬¦å·æŸ¥æ‰¾æ— éœ€å…³å¿ƒã€‚

æ‰“å¼€ NetworkManager åŠ¨æ€åº“çš„ Mach-O æŸ¥çœ‹ä¸‹ç¬¦å·ï¼Œå¯ä»¥çœ‹åˆ°åŠ¨æ€åº“ NetworkManager ä¸­å·²ç»åŒ…å«äº†é™æ€åº“ AFNetworking çš„ç¬¦å·ã€‚

<img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/DynamicLibContainStaticLibSymbols.png" style="zoom:25%" />

å¦‚ä½•æˆåŠŸç¼–è¯‘ï¼Ÿå‘Šè¯‰é“¾æ¥å™¨ HEADER_SEARCH_PATH ä¿¡æ¯å³å¯ã€‚

<img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/DynamicUseStaticLibThenUseStaticLibInApp.png" style="zoom:25%" />



æ€è€ƒï¼šåŠ¨æ€åº“é“¾æ¥é™æ€åº“åï¼Œé™æ€åº“ä¸­æš´éœ²çš„å¯¼å‡ºç¬¦å·ï¼Œåœ¨åŠ¨æ€åº“ä¸­ä¹Ÿæ˜¯å¯¼å‡ºç¬¦å·ã€‚å‡è®¾åŠ¨æ€åº“ä¸æƒ³æŠŠé™æ€åº“çš„ç¬¦å·æš´éœ²å‡ºæ¥ï¼Œè¯¥æ€ä¹ˆåšï¼Ÿ

LD é“¾æ¥å™¨æä¾›äº†èƒ½åŠ›ï¼Œå°†é™æ€åº“çš„ç¬¦å·ä¸æš´éœ²å‡ºæ¥ã€‚

```shell
OTHER_LDFLAGS = $(inherited) -ObjC -Xlinker -hidden-l"AFNetworking"
```

<img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/LDHiddenSymbolWhenDynamicUseStaticLib.png" style="zoom:25%" />



## é™é™

æ¨¡æ‹Ÿï¼šApp -> NetworkManager é™æ€åº“ -> AFNetworking é™æ€åº“

- å°†ä¸Šé¢çš„å·¥ç¨‹ä¸­ï¼ŒNetworkManager ä¸­çš„ `Build Settings` -> `Mach-OType` æ”¹ä¸º `Static Library`
- å°† Podfile ä¸­ `use_frameworks!` æ³¨é‡Šæ‰ï¼Œå°±ä¼šä»¥é™æ€åº“çš„å½¢å¼é“¾æ¥ AF

ä¹‹åç¼–è¯‘æŠ¥é”™

<img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/StaticLibUseStaticLibError.png" style="zoom:25%" />

æ­¤æ—¶ NetworkManager é™æ€åº“ä¸­åªæœ‰è‡ªå·±çš„ç¬¦å·ï¼Œæ²¡æœ‰æ‰€ä¾èµ–çš„ AFNetworking ä¸­çš„ç¬¦å·ã€‚

App é“¾æ¥ NetworkManager é™æ€åº“ï¼Œéœ€è¦å‘Šè¯‰é“¾æ¥å™¨ï¼šå¤´æ–‡ä»¶ã€åº“åç§°ã€åº“æ‰€åœ¨ä½ç½®ã€‚

ä½† NetworkManager é™æ€åº“é“¾æ¥ AFNetworking é™æ€åº“ï¼Œæ²¡æœ‰é…ç½®ä¿¡æ¯å‘Šè¯‰ Appã€‚æ‰€ä»¥éœ€è¦é¢å¤–é…ç½®ã€‚App ç›´æ¥ä¾èµ–çš„é™æ€åº“ï¼Œé™æ€åº“æ‰€ä»¥æ¥çš„é™æ€åº“æ²¡æœ‰å¯¹ App å¯è§ã€‚

æ–¹æ³•ä¸€ï¼šBuild Settings -> æŸ¥æ‰¾ Other Linker Flagsï¼Œæ·»åŠ  `-lAFBetworking` æŒ‡æ˜é“¾æ¥å“ªä¸ªåº“ï¼›æŸ¥æ‰¾ Libarary Search Pathï¼Œè®¾ç½®åº“çš„æŸ¥æ‰¾è·¯å¾„ `${BUILD_DIR}/$(CONFIGURATION)$(EFFECTIVE_PLATFORM_NAME)/AFNetworking`



<img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/StaticLibUseStaticLibSetLibSearchPath.png" style="zoom:25%" />

æ–¹æ³•äºŒï¼šç›´æ¥ç»™ App install é™æ€åº“ã€‚

å…·ä½“ä»£ç è§ï¼š`LDAndFramework/StaticLibUseStaticLib`



## é™åŠ¨

æ¨¡æ‹Ÿï¼šApp -> NetworkManager é™æ€åº“ -> AFNetworking åŠ¨æ€åº“ã€‚æ•ˆæœç­‰ä»·äºï¼Œ ï¼ˆApp + é™æ€åº“ï¼‰+ åŠ¨æ€åº“ã€‚

- Xcode ä¸­å°† NetworkManager é¡¹ç›®çš„ Build Settings ä¸­çš„ Mach-O Type è®¾ç½®ä¸º `Static Library`
- Podfile ä¸­å°† `use_frameworks!` æ³¨é‡Šæ‰“å¼€

ç¼–è¯‘æŠ¥é”™ï¼Œç¬¦å·æœªå®šä¹‰ ã€‚

<img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/StaticLibUseDynamicLibErrorWhenUseInApp.png" style="zoom:25%" />

æ‰€ä»¥ç—‡ç»“æ‰€åœ¨ï¼šå°±æ˜¯æŠŠåŠ¨æ€åº“çš„ä»£ç ä¹Ÿæ”¾åˆ° App é‡Œé¢ï¼ŒApp æ‰å¯ä»¥ä½¿ç”¨åŠ¨æ€åº“é‡Œé¢çš„ç¬¦å·ã€‚ä¸Šé¢ä»£ç è¿è¡Œï¼ŒNetworkManager é™æ€åº“è°ƒç”¨ AFNetworking åŠ¨æ€åº“çš„èƒ½åŠ›ï¼Œå°±ç›¸å½“äº App ç›´æ¥è®¿é—® AFNetworking åŠ¨æ€åº“çš„ç¬¦å·ä¸€æ ·ã€‚

App æ²¡æœ‰é…ç½®å…³äº AFNetworking çš„é“¾æ¥ä¸‰è¦ç´ ï¼Œæ‰€ä»¥æ‰¾ä¸åˆ° AFã€‚

- AutoLinkï¼šå½“åœ¨ä»£ç ä¸­ `import <AFNetworking/AFNetworking.h>` ä¼šè‡ªåŠ¨åœ¨ç›®æ ‡æ–‡ä»¶çš„ Mach-O ä¸­ `OTHER_LDFLAGS` æ‹¼æ¥ `-framework`  å‚æ•°
- æ‰€ä»¥åªéœ€è¦å‘Šè¯‰ App framework search path å³å¯ã€‚å‚è€ƒdebug.xcconfig ä¸­çš„ `FRAMEWORK_SEARCH_PATHS = $(inherited) "${PODS_CONFIGURATION_BUILD_DIR}/AFNetworking"`ï¼Œå±•å¼€ä¸º `"${BUILD_DIR}/$(CONFIGURATION)$(EFFECTIVE_PLATFORM_NAME)/AFNetworking"`ã€‚å°†å…¶è®¾ç½®åˆ° Build Settings çš„ framework search path ä¸­ã€‚

ä¿®æ”¹åç¼–è¯‘æ²¡é—®é¢˜ï¼Œè¿è¡ŒæŠ¥é”™ï¼Œå› ä¸ºç¼–è¯‘åçš„ AFNetworking æ²¡æœ‰æ‹·è´åˆ° App æ‰€éœ€ç›®å½•ä¸‹.

<img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/AppRunFailedDynamicLibNotLocatedAppDir.png" style="zoom:25%" />

æ€ä¹ˆå¤„ç†ï¼Ÿ

- å‚è€ƒå…¶ä»–ä½¿ç”¨ AFNetworking çš„é¡¹ç›®ï¼ŒCocoapods å·¥ç¨‹åŒ–æ¨¡ç‰ˆå†™å¥½äº†è„šæœ¬ï¼Œç›´æ¥æ‹·è´ä¸€ä»½åˆ°å·¥ç¨‹æ ¹ç›®å½•ä¸‹ï¼Œé‡å‘½åä¸º `handle-frameworks.sh`
- Xcode Targets é€‰æ‹© â€œNetworkManagerTestsâ€ -> Build Phasesï¼Œæ·»åŠ  â€œRun scriptâ€ï¼Œå†…å®¹ä¸º `"${SRCROOT}/handle-frameworks.sh"`

è¿è¡ŒæˆåŠŸã€‚

<img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/StaticLibUseDynamicLibFrameworkHandleByShell.png" style="zoom:25%" />



å…·ä½“ä»£ç è§ï¼š`LDAndFramework/StaticLibUseDynamicLib`



## åŒæ—¶ä¾èµ–é™æ€åº“ã€åŠ¨æ€åº“

```shell
platform :ios, '14.1'

target 'InstallDyanmicAndStaticFramework' do
  use_frameworks!
  $static_framework = ['AFNetworking']

  pre_install do |install|
    puts install
    install.pod_targets.each {| pod |
      if $static_framework.include?(pod.name)
        def pod.build_type;
          Pod::BuildType.static_framework # ä½¿ç”¨é™æ€åº“
        end
      end
    }
  end

  # Pods for InstallDyanmicAndStaticFramework
  pod 'SDWebImage'
  pod 'AFNetworking'
end
```

ä»£ç è§ï¼š`LDAndFramework/InstallDyanmicAndStaticFramework`





## module

### å®šä¹‰

ä¸€ä¸ª Module æ˜¯æœºå™¨ä»£ç å’Œæ•°æ®çš„æœ€å°å•ä½ï¼Œå¯ä»¥ç‹¬ç«‹äºå…¶ä»–ä»£ç å•å…ƒè¿›è¡Œé“¾æ¥ã€‚

é€šå¸¸ï¼ŒModule æ˜¯é€šè¿‡ç¼–è¯‘å•ä¸ªæºæ–‡ä»¶ç”Ÿæˆçš„ç›®æ ‡æ–‡ä»¶ã€‚ä¾‹å¦‚ï¼Œå½“å‰çš„ `test.m` è¢«ç¼–è¯‘æˆç›®æ ‡æ–‡ä»¶ `test.o` æ—¶ï¼Œå½“å‰çš„ç›®æ ‡æ–‡ä»¶å°±ä»£è¡¨äº†ä¸€ä¸ª Module ã€‚

ä½†æ˜¯ï¼ŒModule åœ¨è°ƒç”¨çš„æ—¶å€™ä¼šäº§ç”Ÿ**å¼€é”€**ï¼Œæ¯”å¦‚æˆ‘ä»¬åœ¨ä½¿ç”¨ä¸€ä¸ªé™æ€åº“çš„æ—¶å€™ã€‚ï¼ˆè¿™ä¸ªå¼€é”€æ˜¯ä»€ä¹ˆæ¥ä¸‹å»ä¼šè®²ï¼‰



### åœºæ™¯

è¯´äººè¯ï¼Œå¹³æ—¶ä»€ä¹ˆæƒ…å†µä¸‹ä½¿ç”¨çš„æœ€å¤šï¼Ÿå¯¼å…¥åº“æ–‡ä»¶çš„æ—¶å€™ï¼Œå°±æ˜¯ module çš„ä¸»æˆ˜åœºã€‚

å½“åœ¨ App é‡Œå¯¼å…¥ä¸€ä¸ªåº“çš„æ—¶å€™ï¼Œå‘ç”Ÿäº†ä»€ä¹ˆäº‹æƒ…ï¼Ÿ`.h` æ–‡ä»¶ä¹Ÿæ˜¯éœ€è¦ç¼–è¯‘çš„ï¼ˆé‡Œé¢ä¹Ÿä¼šæ‰¿è½½ä¸€äº›æ–¹æ³•ä¿¡æ¯ï¼‰ã€‚

å…ˆè°ˆè°ˆå¯¼å…¥æ–¹å¼ï¼Œå¯¼å…¥æ–¹å¼æœ‰2ç§ï¼š

- `include`:

  å‡è®¾æ²¡æœ‰å¼€å¯ module èƒ½åŠ›ï¼Œå½“ä½¿ç”¨ `#include <*.h>` çš„æ—¶å€™ï¼Œ å¤´æ–‡ä»¶ Aã€B åœ¨ `use.c ` `another-use.c` ä¸­ï¼Œinclude å‡ æ¬¡å°±è¦ç¼–è¯‘å‡ æ¬¡ã€‚

  <img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/HeaderFileWillCompileMoreTimesWithoutModule.png" style="zoom:25%" />

  ç¼–è¯‘ use.c å°±è¦ç¼–è¯‘ include è¿›æ¥çš„ Aã€Bã€‚ç¼–è¯‘ another-use.c  åŒæ ·è¦ç¼–è¯‘ Aã€Bã€‚æ•ˆç‡ä½ä¸‹ã€‚

- `import`ï¼šä¸ `include` ç›¸å¯¹åº”ï¼Œ`import  `  è¯­å¥ç”¨äºå¯¼å…¥æ¨¡å—ï¼Œè€Œä¸æ˜¯ç®€å•çš„æ–‡æœ¬åŒ…å«ã€‚ä½¿ç”¨æ¨¡å—å¯ä»¥å‡å°‘ç¼–è¯‘æ—¶é—´ï¼Œå› ä¸ºç¼–è¯‘å™¨åªéœ€è¦ç¼–è¯‘æ¨¡å—çš„æ¥å£è€Œä¸æ˜¯æ•´ä¸ªæ¨¡å—çš„å®ç°

  <img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/ClangModuleSample.png" style="zoom:25%" />

`clang -fmodules -fmodule-map-file=mo dule.modulemap -fmodules-cache-path=./moduleCache -c use.c -o use.o` ï¼š

- `-fmodules` ç”¨äºå‘Šè¯‰ clang å¯ç”¨ module ç¼–è¯‘
- ç¼–è¯‘å module ç¼“å­˜ä¿å­˜åˆ° `-fmodules-cache-path` åé¢çš„è·¯å¾„ä¸­å¯ä»¥çœ‹åˆ° Aã€B2ä¸ªå¤´æ–‡ä»¶ï¼Œç¼–è¯‘ç¼“å­˜ä¹Ÿå­˜åœ¨2ä¸ªï¼Œåˆ†åˆ«ä»¥ Aã€B å¼€å¤´
- `-fmodule-map-file` æŒ‡æ˜ modulemap æ–‡ä»¶è·¯å¾„

module æ˜¯ clang æä¾›çš„èƒ½åŠ›ã€‚å¯ä»¥æŠŠå¤´æ–‡ä»¶ç¼–è¯‘æˆäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œç¼“å­˜åˆ°ç³»ç»Ÿç›®å½•ä¸­ã€‚è¿™æ ·çš„å¥½å¤„æ˜¯ï¼Œåœ¨ä½¿ç”¨æŸä¸ª `.h` çš„å¤šä¸ª `.m` ä¸­ï¼Œå°±ä¸ä¼šå› ä¸ºå¤šå¤„å¼•å…¥ `.h` è€Œç¼–è¯‘å¤šæ¬¡ `.h`



### modulemap è§„èŒƒå’Œå®ä¾‹



#### case 1ï¼šä¸Šä¾‹ä¸­çš„ modulemap

```shell
/* module.modulemap */
module A {	// å®šä¹‰äº†ä¸€ä¸ªåå­—å« A çš„æ¨¡å—
  header "A.h"	//æ¨¡å— A çš„å…¬å…±å¤´æ–‡ä»¶ä¸º A.hã€‚è¿™æ„å‘³ç€ä»»ä½•æƒ³è¦ä½¿ç”¨æ¨¡å— A ä¸­å®šä¹‰çš„ç±»æˆ–å‡½æ•°çš„ä»£ç ï¼Œéƒ½éœ€è¦å¯¼å…¥ A.h æ–‡ä»¶
}

module B {		// å®šä¹‰äº†ä¸€ä¸ªåä¸º B çš„æ¨¡å—ã€‚ã€‚
  header "B.h"	// æ¨¡å— B çš„å…¬å…±å¤´æ–‡ä»¶æ˜¯ B.h
  export A	// æ¨¡å— B å‘å¤–æš´éœ²æ¨¡å— Aã€‚è¿™æ„å‘³ç€ä»»ä½•å¯¼å…¥æ¨¡å— B çš„ä»£ç ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨æ¨¡å— A ä¸­å®šä¹‰çš„ç±»æˆ–å‡½æ•°ã€‚export A å°†æ¨¡å— A ä½œä¸ºæ¨¡å— B çš„ä¸€éƒ¨åˆ†å…¬å¼€ï¼Œä»¥ä¾¿åœ¨ä½¿ç”¨æ¨¡å— B æ—¶ï¼Œå¯ä»¥éšå¼ä½¿ç”¨æ¨¡å— A ä¸­çš„å†…å®¹ã€‚
}
```

å‡è®¾å­˜åœ¨ä¸€ä¸ª c.h çš„æ–‡ä»¶ï¼Œéœ€æ±‚æ˜¯æƒ³ä½¿ç”¨æ¨¡å— A å’Œæ¨¡å— B ä¸­å®šä¹‰çš„å†…å®¹ã€‚

æ–¹æ³•ä¸€ï¼šç›´æ¥ import æ¨¡å—å¯¹åº”çš„å¤´æ–‡ä»¶

```objective-c
#import "A.h"
#import "B.h"
```

æ–¹æ³•äºŒï¼šå› ä¸ºæ¨¡å— B å·²ç»æš´éœ²äº†æ¨¡å— Aï¼Œæ‰€ä»¥å¯¼å…¥ B å°±å¯ä»¥ä½¿ç”¨æ¨¡å— A ä¸­å®šä¹‰çš„ç±»å’Œå‡½æ•°

```objective-c
#import "B.h"
```



#### case2ï¼šAFNetworking Demo ä¸­çš„ modulemap

AFNetworking çš„ [Framework/module.modulemap](https://github.com/AFNetworking/AFNetworking/blob/master/Framework/module.modulemap)

```json
framework module AFNetworking {	// å®šä¹‰ä¸€ä¸ªåä¸º AFNetworking çš„æ¡†æ¶æ¨¡å—
    umbrella header "AFNetworking.h"	// æŒ‡å®šäº†æ¡†æ¶çš„ä¼å¤´æ–‡ä»¶ï¼Œè¿™ä¸ªæ–‡ä»¶æ˜¯åŒ…å«äº†æ‰€æœ‰å…¬å…±å¤´æ–‡ä»¶çš„æ–‡ä»¶ï¼Œæ–¹ä¾¿å¤–éƒ¨å—²æ¬§å“¦é‚£ä¸ª
    export *	// è¡¨ç¤ºæ¡†æ¶ä¸­çš„æ‰€æœ‰å…¬å…±æ¥å£ï¼ˆç±»ã€ç»“æ„ä½“ã€æšä¸¾ã€åè®®ç­‰ï¼‰éƒ½è¢«å¯¼å‡ºï¼Œ
    module * { export * } // æ„å‘³ç€æ¡†æ¶å†…éƒ¨çš„æ‰€æœ‰å­æ¨¡å—ï¼ˆå³ AFNetworking.h ä¸­å¤´æ–‡ä»¶ä»£è¡¨çš„å­æ¨¡å—éƒ½ä¼šè¢«åŒ¹é…åˆ°ï¼‰ï¼Œå­æ¨¡å—çš„åç§°å°±æ˜¯ .h æ–‡ä»¶çš„åç§°ï¼Œéƒ½å°†è¢«å¯¼å‡ºï¼Œå¯ä»¥è¢«å¤–éƒ¨æ‰€è®¿é—®
}
```



#### case3ï¼šAsyncDisplayKit çš„ modulemap

```json
framework module AsyncDisplayKit {	// å®šä¹‰äº†ä¸€ä¸ªåä¸º AsyncDisplayKit çš„æ¡†æ¶æ¨¡å—
  umbrella header "AsyncDisplayKit.h"	// æŒ‡å®šäº†æ¡†æ¶çš„ä¼å¤´æ–‡ä»¶ï¼Œè¿™ä¸ªæ–‡ä»¶æ˜¯åŒ…å«æ‰€æœ‰å…¬å…±å¤´æ–‡ä»¶çš„æ–‡ä»¶ï¼Œæ–¹ä¾¿å¤–éƒ¨è°ƒç”¨
  
  export *		// è¡¨ç¤ºæ¡†æ¶ä¸­æ‰€æœ‰å…¬å…±å€Ÿå£ï¼ˆç±»ã€ç»“æ„ä½“ã€æšä¸¾ã€åè®®ç­‰ï¼‰éƒ½è¢«å¯¼å‡ºï¼Œå¯ä»¥è¢«å¤–éƒ¨ä»£ç è®¿é—®
  module * {		// æ„å‘³ç€æ¡†æ¶å†…éƒ¨çš„æ‰€æœ‰å­æ¨¡å—ï¼ˆå³ AsyncDisplayKit.h ä¸­å¤´æ–‡ä»¶ä»£è¡¨çš„å­æ¨¡å—éƒ½ä¼šè¢«åŒ¹é…åˆ°ï¼‰ï¼Œå­æ¨¡å—çš„åç§°å°±æ˜¯ .h æ–‡ä»¶çš„åç§°ï¼Œéƒ½å°†è¢«å¯¼å‡ºï¼Œå¯ä»¥è¢«å¤–éƒ¨æ‰€è®¿é—®
    export *
  }
  
  explicit module ASControlNode_Subclasses {	// æ˜¾ç¤ºæŒ‡åï¼Œå®šä¹‰äº†ä¸€ä¸ªåä¸º ASControlNode_Subclasses çš„å­æ¨¡å—ï¼Œå®ƒåŒ…å«äº†ä¸ ASControlNode ç›¸å…³çš„å­ç±»
    header "ASControlNode+Subclasses.h"	// æŒ‡å®šäº†å­æ¨¡å—çš„å¤´æ–‡ä»¶ï¼Œè¿™ä¸ªå¤´æ–‡ä»¶åŒ…å«äº†å­ç±»çš„å®šä¹‰
    export *
  }
  
  explicit module ASDisplayNode_Subclasses {	// å®šä¹‰äº†ä¸€ä¸ªåä¸º ASDisplayNode_Subclasses çš„å­æ¨¡å—ï¼Œå®ƒåŒ…å«äº†æ‰€æœ‰ä¸ ASDisplayNode ç›¸å…³çš„å­ç±»
    header "ASDisplayNode+Subclasses.h"	// æŒ‡å®šäº†å­æ¨¡å—çš„å¤´æ–‡ä»¶ï¼Œè¿™ä¸ªå¤´æ–‡ä»¶åŒ…å«äº†å­ç±»çš„å®šä¹‰
    export *
  }
  
}
```

çœ‹ä¸€ä¸ªä¾‹å­ï¼ŒAsyncDisplayKit ä¸­ `umbrella header` ä¼å¤´æ–‡ä»¶ï¼Œå³ `AsyncDisplayKit.h` çš„å†…å®¹

```c++
#import <AsyncDisplayKit/ASAvailability.h>
#import <AsyncDisplayKit/ASDisplayNode.h>
#import <AsyncDisplayKit/ASDisplayNode+Convenience.h>
#import <AsyncDisplayKit/ASDisplayNodeExtras.h>

#import <AsyncDisplayKit/ASControlNode.h>
#import <AsyncDisplayKit/ASImageNode.h>
#import <AsyncDisplayKit/ASTextNode.h>
#import <AsyncDisplayKit/ASButtonNode.h>
#import <AsyncDisplayKit/ASMapNode.h>
#import <AsyncDisplayKit/ASVideoNode.h>
#import <AsyncDisplayKit/ASVideoPlayerNode.h>
#import <AsyncDisplayKit/ASEditableTextNode.h>

#import <AsyncDisplayKit/ASImageProtocols.h>
#import <AsyncDisplayKit/ASBasicImageDownloader.h>
#import <AsyncDisplayKit/ASPINRemoteImageDownloader.h>
#import <AsyncDisplayKit/ASMultiplexImageNode.h>
#import <AsyncDisplayKit/ASNetworkImageNode.h>
#import <AsyncDisplayKit/ASPhotosFrameworkImageRequest.h>

#import <AsyncDisplayKit/ASTableView.h>
#import <AsyncDisplayKit/ASTableNode.h>
#import <AsyncDisplayKit/ASCollectionView.h>
#import <AsyncDisplayKit/ASCollectionNode.h>
#import <AsyncDisplayKit/ASCollectionViewLayoutInspector.h>
#import <AsyncDisplayKit/ASCollectionViewLayoutFacilitatorProtocol.h>
#import <AsyncDisplayKit/ASCellNode.h>
#import <AsyncDisplayKit/ASSectionContext.h>

#import <AsyncDisplayKit/ASElementMap.h>
#import <AsyncDisplayKit/ASCollectionLayoutContext.h>
#import <AsyncDisplayKit/ASCollectionLayoutState.h>
#import <AsyncDisplayKit/ASCollectionFlowLayoutDelegate.h>

#import <AsyncDisplayKit/ASSectionController.h>
#import <AsyncDisplayKit/ASSupplementaryNodeSource.h>

#if AS_IG_LIST_KIT
#import <AsyncDisplayKit/IGListAdapter+AsyncDisplayKit.h>
#import <AsyncDisplayKit/AsyncDisplayKit+IGListKitMethods.h>
#endif

#import <AsyncDisplayKit/ASScrollNode.h>

#import <AsyncDisplayKit/ASPagerFlowLayout.h>
#import <AsyncDisplayKit/ASPagerNode.h>

#import <AsyncDisplayKit/ASNodeController+Beta.h>
#import <AsyncDisplayKit/ASViewController.h>
#import <AsyncDisplayKit/ASNavigationController.h>
#import <AsyncDisplayKit/ASTabBarController.h>
#import <AsyncDisplayKit/ASRangeControllerUpdateRangeProtocol+Beta.h>

#import <AsyncDisplayKit/ASDataController.h>

#import <AsyncDisplayKit/ASLayout.h>
#import <AsyncDisplayKit/ASDimension.h>
#import <AsyncDisplayKit/ASDimensionInternal.h>
#import <AsyncDisplayKit/ASDimensionDeprecated.h>
#import <AsyncDisplayKit/ASLayoutElement.h>
#import <AsyncDisplayKit/ASLayoutSpec.h>
#import <AsyncDisplayKit/ASBackgroundLayoutSpec.h>
#import <AsyncDisplayKit/ASCenterLayoutSpec.h>
#import <AsyncDisplayKit/ASRelativeLayoutSpec.h>
#import <AsyncDisplayKit/ASInsetLayoutSpec.h>
#import <AsyncDisplayKit/ASOverlayLayoutSpec.h>
#import <AsyncDisplayKit/ASRatioLayoutSpec.h>
#import <AsyncDisplayKit/ASAbsoluteLayoutSpec.h>
#import <AsyncDisplayKit/ASStackLayoutDefines.h>
#import <AsyncDisplayKit/ASStackLayoutSpec.h>

#import <AsyncDisplayKit/_ASAsyncTransaction.h>
#import <AsyncDisplayKit/_ASAsyncTransactionGroup.h>
#import <AsyncDisplayKit/_ASAsyncTransactionContainer.h>
#import <AsyncDisplayKit/_ASDisplayLayer.h>
#import <AsyncDisplayKit/_ASDisplayView.h>
#import <AsyncDisplayKit/ASDisplayNode+Beta.h>
#import <AsyncDisplayKit/ASTextNode+Beta.h>
#import <AsyncDisplayKit/ASTextNodeTypes.h>
#import <AsyncDisplayKit/ASBlockTypes.h>
#import <AsyncDisplayKit/ASContextTransitioning.h>
#import <AsyncDisplayKit/ASControlNode+Subclasses.h>
#import <AsyncDisplayKit/ASDisplayNode+Subclasses.h>
#import <AsyncDisplayKit/ASEqualityHelpers.h>
#import <AsyncDisplayKit/ASHighlightOverlayLayer.h>
#import <AsyncDisplayKit/ASImageContainerProtocolCategories.h>
#import <AsyncDisplayKit/ASLog.h>
#import <AsyncDisplayKit/ASMutableAttributedStringBuilder.h>
#import <AsyncDisplayKit/ASThread.h>
#import <AsyncDisplayKit/ASRunLoopQueue.h>
#import <AsyncDisplayKit/ASTextKitComponents.h>
#import <AsyncDisplayKit/ASTraitCollection.h>
#import <AsyncDisplayKit/ASVisibilityProtocols.h>
#import <AsyncDisplayKit/ASWeakSet.h>
#import <AsyncDisplayKit/ASEventLog.h>

#import <AsyncDisplayKit/CoreGraphics+ASConvenience.h>
#import <AsyncDisplayKit/NSMutableAttributedString+TextKitAdditions.h>
#import <AsyncDisplayKit/UICollectionViewLayout+ASConvenience.h>
#import <AsyncDisplayKit/UIView+ASConvenience.h>
#import <AsyncDisplayKit/UIImage+ASConvenience.h>
#import <AsyncDisplayKit/NSArray+Diffing.h>
#import <AsyncDisplayKit/ASObjectDescriptionHelpers.h>
#import <AsyncDisplayKit/UIResponder+AsyncDisplayKit.h>

#import <AsyncDisplayKit/AsyncDisplayKit+Debug.h>
#import <AsyncDisplayKit/ASDisplayNode+Deprecated.h>

#import <AsyncDisplayKit/ASCollectionNode+Beta.h>
```

ä½¿ç”¨ï¼šå­æ¨¡å—å¯ä»¥é€šè¿‡å¤§æ¨¡å—è®¿é—®åˆ°ï¼Œæ¯”å¦‚ `@AsyncDisplayKit.ASEventLog;`

æ›´å¤šå…³äº Module çš„ä¿¡æ¯ï¼Œå¯ä»¥æŸ¥çœ‹ [Clang::Modules](https://clang.llvm.org/docs/Modules.html)



### å®æˆ˜ï¼šFramework ä½¿ç”¨ modulemap 

ç¬¬ä¸€æ­¥ï¼šåˆ›å»ºåŠ¨æ€åº“ `PersonFramework`ï¼Œåˆ›å»ºä¸€ä¸ª iOS App Demo å·¥ç¨‹ã€‚

ç¬¬äºŒæ­¥ï¼šç»™åŠ¨æ€åº“æ·»åŠ  `PersonFramework.modulemap` æ–‡ä»¶

ç¬¬ä¸‰æ­¥ï¼šç»™ä¸»å·¥ç¨‹ã€åŠ¨æ€åº“è®¾ç½®åœ¨åŒä¸€ä¸ª Xcode é¡¹ç›®ä¸­ç¼–è¯‘è°ƒè¯•ã€‚

<img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/ModuleDemoProject.png" style="zoom:30%" />



ç»“è®ºï¼š

- å·¥ç¨‹ä¸­ `PersonFramework.modulemap` å‘½åçš„ modulemapï¼Œåœ¨ç¼–è¯‘åè¢« Xcode é‡å‘½åä¸º `module.modulemap`ï¼Œç³»ç»Ÿåªè®¤è¿™ä¸ª

- `.modulemap` æ–‡ä»¶æœ‰å¤šç§å†™æ³•ï¼Œå°±æ‹¿ä¸Šé¢çš„ä¸¾ä¾‹ï¼Œç­‰ä»·äº3ç§å†™æ³•ï¼š

  - å†™æ³•1

    ```json
    framework module PersonFramework {
        // umbrella ä¸åŠ  Headerï¼Œåˆ™è¯´æ˜åé¢è¦è·Ÿæ–‡ä»¶å¤¹è·¯å¾„ã€‚
        umbrella "Headers"
        export *
        module * {
            export *
        }
    }
    ```

    `nubrella` åä¸åŠ  Headerï¼Œè¯´æ˜è·Ÿå¾—æ˜¯æ–‡ä»¶å¤¹ï¼Œæ–‡ä»¶å¤¹ä¸­é‡Œé¢çš„å†…å®¹å’Œ `Build Phases` ä¸­ `Header`  public éƒ¨åˆ†çš„å¤´æ–‡ä»¶æè¿°çš„ä¸€è‡´ã€‚ä¼šå°† public çš„å¤´æ–‡ä»¶ï¼Œæœ€åæ”¾åˆ° `Headers` æ–‡ä»¶å¤¹ä¸­ã€‚

  - å†™æ³•2

    ```json
    framework module PersonFramework {
        umbrella header "PersonFramework.h"
        export *
        module * {
            export *
        }   
    }
    ```

    `umbrella header + ä¼å¤´æ–‡ä»¶` æ„å‘³ç€ä¼å¤´æ–‡ä»¶é‡Œæ‰€æœ‰çš„ `.h` å°†ä¼šè¢«æ”¾åˆ° `Headers` æ–‡ä»¶å¤¹ä¸­ã€‚ä¸”ç»™å¤–éƒ¨è®¿é—®

  - å†™æ³•3

    ```json
    framework module PersonFramework {
        umbrella header "PersonFramework.h"
        explicit module Worker {
            header "Worker.h"
            export *
        }
        explicit module Student {
            header "Student.h"
            export *
        }   
    }
    ```

    å†™æ³•3æ˜¯å°†éœ€è¦æš´éœ²çš„å¤´æ–‡ä»¶ï¼ŒæŒ¨ä¸ªæ˜¾ç¤ºå£°æ˜å­æ¨¡å—ï¼ŒæŒ‡æ˜å¤´æ–‡ä»¶ï¼Œç„¶åå¯¼å‡ºã€‚



### Swift Framework modulemap

èƒŒæ™¯ï¼šæ¢ç´¢ Swift Framework ä¸­ï¼Œæ²¡æœ‰æ¡¥æ¥æ–‡ä»¶ï¼ŒSwift å¦‚ä½•è®¿é—® OCï¼Ÿå¦‚ä½•å¤„ç† modulemap å¯¼å‡ºæ–‡ä»¶ï¼Ÿ

é—®é¢˜1ï¼šSwift Framework ä¸­ Swift é‡Œå¦‚ä½•è®¿é—® OCï¼Ÿ

åˆ©ç”¨ modulemap è§£å†³ã€‚

<img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/SwiftFramworkSwiftCallOCViaModuleMap.png" style="zoom:30%" />

ä½†æ˜¯ï¼Œä¸Šé¢çš„åšæ³•æœ‰å‰¯ä½œç”¨ã€‚è™½ç„¶ Framework å†…éƒ¨ Swift å¯ä»¥è®¿é—® OC äº†ï¼Œä½†æ˜¯ä½¿ç”¨ Framework çš„åœ°æ–¹ï¼Œä¹Ÿå¯ä»¥è®¿é—®åˆ° OCStudent ç±»ã€‚å¦‚ä½•è§£å†³è¯¥é—®é¢˜ï¼Ÿ

<img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/SwiftFrameworkOCClassCanVisitOutside.png" style="zoom:30%" />



å¦‚ä½•å®ç°åªåœ¨ Swift Framework å†… Swift ä»£ç å¯ä»¥è®¿é—® OC ç±»ï¼Œåœ¨ä½¿ç”¨ framework çš„åœ°æ–¹ï¼Œè®¿é—®ä¸åˆ° oc ç±»ï¼Ÿ

module æä¾› private modle çš„èƒ½åŠ›ã€‚

<img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/PrivateModuleUsage.png" style="zoom:30%" />

è¯´æ˜ï¼š

- private  module æ–‡ä»¶å¿…é¡»å‘½åä¸º `PersonSwiftFramework.private.modulemap` çš„ `private.modulemap` æ ¼å¼

- `private.modulemap` æ¨¡å—åå¿…é¡»ä¸º `PersonSwiftFramework_Private`

  ```json
  /* module.modulemap */
  framework module PersonSwiftFramework_Private {
      module OCStudent {
          header "OCStudent.h"
          export *
      }
  }
  ```

  æ–‡ä»¶å†…å®¹æ˜¯ä¸å¸Œæœ›é€šè¿‡æ­£å¸¸é¢„è®¾æ¨¡å—æš´éœ²å‡ºå»çš„å­æ¨¡å—ã€‚

  ä»€ä¹ˆæ˜¯æ­£å¸¸é¢„è®¾æ¨¡å—ï¼Ÿæ¯”å¦‚ `PersonSwiftFramework` æ˜¯æ­£å¸¸é¢„è®¾æ¨¡å—ï¼Œé€šè¿‡ `@import PersonSwiftFramework.` è®¿é—®å‡ç¬¦åˆé¢„æœŸã€‚

- private module æ˜¯è§„èŒƒï¼Œä½†æ˜¯è¿˜æ˜¯å¯ä»¥åœ¨ä½¿ç”¨ framework çš„åœ°æ–¹é€šè¿‡ `@import PersonSwiftFramework_Private.OCStudent;`è®¿é—®åˆ°çš„

å…·ä½“ä»£ç è§ï¼š `LDAndFramework/module-collections/ModulePractice`





### Swift é™æ€åº“çš„åˆå¹¶

#### æ¦‚å¿µ

Xcode 9 ä¹‹åï¼ŒSwift å¼€å§‹æ”¯æŒé™æ€åº“ã€‚

Swift æ²¡æœ‰å¤´æ–‡ä»¶çš„æ¦‚å¿µï¼ŒSwift è¦ç”¨ public ä¿®é¥°çš„ç±»å’Œå‡½æ•°æ€ä¹ˆåŠï¼Ÿ

Swift åº“å¼•å…¥äº†ä¸€ä¸ªå…¨æ–°çš„æ–‡ä»¶ `.swiftmodule`ï¼Œå…¶åŒ…å«åºåˆ—åŒ–è¿‡çš„ ASTï¼Œä¹ŸåŒ…å« SILï¼ˆSwift Intermediate Languageï¼ŒSwift ä¸­é—´è¯­è¨€ï¼‰



#### å®æˆ˜ï¼šSwift é™æ€åº“åˆå¹¶

ç¬¬ä¸€æ­¥ï¼šå‡†å¤‡2ä¸ª Swift é™æ€åº“ã€‚å…¶ä¸­ FLSwiftWorker 2ä¸ªç±»å®Œå…¨ä¸€æ ·ï¼ŒFLSwiftAã€FLSwiftB åŒåæ–¹æ³•ï¼Œæ–¹æ³•å®ç°ä¸ä¸€æ ·ã€‚

ç¼–å†™è„šæœ¬ï¼š `cp -Rv -- "${BUILT_PRODUCTS_DIR}/" "${SOURCE_ROOT}/../Products"`ï¼ŒæŠŠäº§ç‰©æ‹·è´åˆ° products ç›®å½•ä¸‹

<img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/SwiftStaticComposedProject.png" style="zoom:30%" />

ç¬¬äºŒæ­¥ï¼Œæ‰“ç®—ç”¨ libtool æŒ‡ä»¤ `libtool -static FLSwiftLibA.framework/FLSwiftLibA FLSwiftLibB.framework/FLSwiftLibB -o libFLSwiftC.a` è¿›è¡Œåˆå¹¶ï¼Œå‘ç°æŠ¥é”™

<img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/LibtoolCombineStaticFrameworkErrorDueSameSymbol.png" style="zoom:30%" />



å› ä¸ºå­˜åœ¨åŒåç¬¦å·ï¼Œä½†æ˜¯åˆä¸å­˜åœ¨2çº§å‘½åç©ºé—´ï¼Œæ‰€ä»¥å¦‚ä½•å¤„ç†ç¬¦å·é—®é¢˜ï¼Ÿï¼Ÿ

éœ€è¦æ‰¾ Headers å¤´æ–‡ä»¶ä¿¡æ¯å’Œ Modules æ–‡ä»¶å¤¹é‡Œé¢çš„ä¿¡æ¯ã€‚

```shell
.
â”œâ”€â”€ FLSwiftLibA
â”œâ”€â”€ Headers
â”‚Â Â  â”œâ”€â”€ FLSwiftLibA-Swift.h
â”‚Â Â  â””â”€â”€ FLSwiftLibA.h
â”œâ”€â”€ Info.plist
â”œâ”€â”€ Modules
â”‚Â Â  â”œâ”€â”€ FLSwiftLibA.swiftmodule
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ Project
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ x86_64-apple-ios-simulator.abi.json
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ x86_64-apple-ios-simulator.swiftdoc
â”‚Â Â  â”‚Â Â  â””â”€â”€ x86_64-apple-ios-simulator.swiftmodule
â”‚Â Â  â””â”€â”€ module.modulemap
â””â”€â”€ _CodeSignature
    â”œâ”€â”€ CodeDirectory
    â”œâ”€â”€ CodeRequirements
    â”œâ”€â”€ CodeRequirements-1
    â”œâ”€â”€ CodeResources
    â””â”€â”€ CodeSignature
```

ç¬¬ä¸‰æ­¥ï¼Œæ–°å»ºä¸€ä¸ª iOS App å·¥ç¨‹ï¼Œå¼•å…¥åˆå¹¶åçš„é™æ€åº“ libSwiftC.a ç„¶åä¸€æ­¥æ­¥è§£å†³ç¬¦å·å†²çªé—®é¢˜

- æŠŠé™æ€åº“æ‹–å…¥åˆ°å·¥ç¨‹ä¸­

- æ–°å»º xcconfig æ–‡ä»¶ï¼Œé…ç½®é™æ€åº“çš„å¤´æ–‡ä»¶ç­‰ä¿¡æ¯

- ç¼–è¾‘ xcconfig é…ç½®å¤´æ–‡ä»¶ä¿¡æ¯ï¼Œä¸ç„¶ç¼–è¯‘ä¼šæŠ¥é”™ï¼ˆå¼•å…¥äº†å¤´æ–‡ä»¶ï¼‰ã€‚

  ```shell
  // å¤´æ–‡ä»¶ä¿¡æ¯
  HEADER_SEARCH_PATHS = $(inherited) "${SRCROOT}/FLStaticLibC/Public/FLSwiftLibA.framework/Headers" "${SRCROOT}/FLStaticLibC/Public/FLSwiftLibB.framework/Headers"
  ```

  1.ä¸ºä»€ä¹ˆ App å·¥ç¨‹ä¸­çš„ OC ç±»ä¸­å¯¼å…¥å¤´æ–‡ä»¶ç¼–è¯‘æˆåŠŸï¼Œä½†è¿˜æ˜¯æ— æ³•è®¿é—®é‡Œé¢çš„ç±»ï¼Ÿ

  <img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/ImportHeaderFileButCannotUseClass.png" style="zoom:30%" />

  åŒæ ·ï¼Œéœ€è¦ä¸€ä¸ªæ–°çš„å‚æ•°ï¼Œå‘Šè¯‰ LD modulemap çš„ä¿¡æ¯ï¼Œç„¶åç³»ç»Ÿæ ¹æ® module.modulemap å»å…³è”æŸ¥æ‰¾ `FLSwiftLibA.swiftmodule`  é‡Œé¢çš„ `x86_64-apple-ios-simulator.swiftmodule` swiftmodule æ–‡ä»¶ä¿¡æ¯ã€‚

  è¿™ä¸ªæ—¶å€™å°±å¯ä»¥åœ¨ App oc ä»£ç ä¸­è®¿é—®é™æ€åº“é‡Œ Swift ç±»äº†ã€‚

  2.ä¸ºä»€ä¹ˆ App å·¥ç¨‹ä¸­çš„ Swift ç±»ä¸­å¯¼å…¥å¤´æ–‡ä»¶æŠ¥é”™ï¼Ÿ

  å› ä¸ºä¸Šé¢çš„é…ç½®æ˜¯ Swift ç¼–è¯‘åäº§ç”Ÿçš„ modulemap å’Œ swiftmodule æ˜¯é…ç½® `OTHER_CFLAGS`ï¼Œå…¶å®å°±æ˜¯é…ç½® cã€oc ç¼–è¯‘å™¨ä¹Ÿå°±æ˜¯ clang çš„å…³äº swift çš„ä¿¡æ¯ã€‚

  è€Œ Swift ç¼–è¯‘å™¨æ˜¯ swiftcï¼Œéœ€è¦é¢å¤–é…ç½®ã€‚`SWIFT_INCLUDE_PATHS = "${SRCROOT}/FLStaticLibC/Public/FLSwiftLibA.framework/Modules/" "${SRCROOT}/FLStaticLibC/Public/FLSwiftLibB.framework/Modules/"`

  <img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/SwiftModuleFileLocation.png" style="zoom:30%" />

  ä½†æ˜¯é…ç½®åè¿˜æ˜¯æŠ¥é”™ï¼Œå› ä¸ºçœ‹ä¸Šå»æ–‡ä»¶è·¯å¾„æ˜¯å¯¹çš„ï¼ŒFrmaework ç”Ÿæˆçš„æ—¶å€™ï¼Œå°±æ˜¯è¿™ä¹ˆåˆ’åˆ†æ–‡ä»¶å¤¹çš„ã€‚ä½†å®é™…ç¼–è¯‘çš„æ—¶å€™ Headerså’Œ `module.modulemap` ã€`.swiftmodule` æ–‡ä»¶å¤¹åœ¨åŒä¸€å±‚ç›®å½•ã€‚æ‰€ä»¥æˆ‘ä»¬æ‰‹åŠ¨ç¼–è¯‘é™æ€åº“ä¹‹åï¼Œéœ€è¦å¤„ç†é™æ€åº“äº§ç‰©çš„æ–‡ä»¶ç›®å½•ä¿¡æ¯ã€‚

  

<img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/SwiftCModuleInfoInXcode.png" style="zoom:30%" />



## hmapæ–‡ä»¶ä¸ Header Maps

### å¤´æ–‡ä»¶å¯¼å…¥æŠ€æœ¯å‘å±•å†å²

#### æ€è€ƒ

å¼•å…¥å¤´æ–‡ä»¶çš„æ–¹å¼ï¼š

- è·¯å¾„ï¼šå¤´æ–‡ä»¶æ‰€åœ¨ç›®å½• + `å…·ä½“æ–‡ä»¶.h`
- moduleï¼šä¸€å † `.h` æ”¾åˆ° moduleï¼Œé‡‡ç”¨é¢„ç¼–è¯‘çš„æ–¹å¼ï¼Œäº§å‡ºäºŒè¿›åˆ¶ï¼ŒèŠ‚çœç¼–è¯‘æ—¶é—´ã€‚æ¯”å¦‚ `#import <UIKit/UIKit.h>`

æ€è€ƒï¼šå¹³æ—¶ Xcode å†™ä»£ç çš„æ—¶å€™ `#import "ViewController.h"` èƒŒåæ˜¯æ€ä¹ˆå·¥ä½œçš„ï¼Ÿæ˜¯å¦‚ä½•æ‰¾åˆ°å…·ä½“çš„æ–‡ä»¶å†…å®¹çš„

1. **æœ¬åœ°å¼•ç”¨**ï¼šå½“ä½ ä½¿ç”¨åŒå¼•å· `"ViewController.h"` è¿›è¡Œå¯¼å…¥æ—¶ï¼Œç¼–è¯‘å™¨ä¼šé¦–å…ˆåœ¨å½“å‰æ–‡ä»¶çš„æœ¬åœ°ç›®å½•ï¼ˆå³å½“å‰ `.m` æˆ– `.mm` æ–‡ä»¶æ‰€åœ¨çš„ç›®å½•ï¼‰æŸ¥æ‰¾å¤´æ–‡ä»¶ã€‚
2. **é€’å½’æœç´¢**ï¼šå¦‚æœåœ¨å½“å‰ç›®å½•æ‰¾ä¸åˆ° `ViewController.h`ï¼Œç¼–è¯‘å™¨ä¼šé€’å½’åœ°æœç´¢æ‰€æœ‰å­ç›®å½•ã€‚
3. **é¡¹ç›®è®¾ç½®**ï¼šå¦‚æœæœ¬åœ°ç›®å½•ä¸­æ²¡æœ‰æ‰¾åˆ°æ–‡ä»¶ï¼Œç¼–è¯‘å™¨ä¼šæ ¹æ® Xcode é¡¹ç›®çš„è®¾ç½®ä¸­çš„ "Header Search Paths" æ¥ç¡®å®šæ¥ä¸‹æ¥æœç´¢çš„ç›®å½•ã€‚è¿™äº›è·¯å¾„é€šå¸¸åŒ…æ‹¬ï¼š
   - é¡¹ç›®çš„å…¶ä»–éƒ¨åˆ†ï¼Œå¦‚å…¶ä»–ç›®æ ‡çš„ç›®å½•ã€‚
   - é¡¹ç›®ä¾èµ–çš„åº“æˆ–æ¡†æ¶çš„è·¯å¾„ã€‚
   - ç”¨æˆ·æˆ–ç³»ç»Ÿçº§åˆ«çš„é¢å¤–å¤´æ–‡ä»¶ç›®å½•ã€‚
4. **ç›¸å¯¹è·¯å¾„**ï¼šåœ¨ "Header Search Paths" ä¸­è®¾ç½®çš„è·¯å¾„å¯ä»¥æ˜¯ç›¸å¯¹è·¯å¾„ï¼ŒXcode ä¼šå°†å…¶ç›¸å¯¹äºé¡¹ç›®æ–‡ä»¶ï¼ˆ`.xcodeproj`ï¼‰çš„ä½ç½®æ¥è§£æã€‚
5. **ç»å¯¹è·¯å¾„**ï¼šä¹Ÿå¯ä»¥ä½¿ç”¨ç»å¯¹è·¯å¾„æŒ‡å®šå¤´æ–‡ä»¶çš„ä½ç½®ã€‚
6. **ç¯å¢ƒå˜é‡**ï¼šæœ‰æ—¶ï¼ŒHeader Search Paths ä¼šåŒ…å«ç¯å¢ƒå˜é‡ï¼Œè¿™äº›å˜é‡åœ¨ç¼–è¯‘æ—¶ä¼šè¢«ç³»ç»Ÿçš„å®é™…è·¯å¾„æ›¿æ¢ã€‚
7. **Frameworkå’ŒLibrary**ï¼šå¦‚æœ `ViewController.h` æ˜¯æŸä¸ªæ¡†æ¶æˆ–åº“çš„ä¸€éƒ¨åˆ†ï¼Œç¼–è¯‘å™¨è¿˜ä¼šåœ¨ "Framework Search Paths" ä¸­æŒ‡å®šçš„ç›®å½•ä¸‹æŸ¥æ‰¾ã€‚
8. **Header Maps**ï¼šä¸ºäº†æé«˜æŸ¥æ‰¾æ•ˆç‡ï¼Œé¡¹ç›®å¯èƒ½ä½¿ç”¨ Header Mapsã€‚è¿™äº›æ˜¯é¢„å…ˆç”Ÿæˆçš„æ–‡ä»¶ï¼Œåˆ—å‡ºäº†ç›®å½•ä¸­æ‰€æœ‰å¤´æ–‡ä»¶çš„ç´¢å¼•ï¼Œå¸®åŠ©ç¼–è¯‘å™¨å¿«é€Ÿå®šä½ã€‚
9. **ç¼–è¯‘å™¨ç¼“å­˜**ï¼šç¼–è¯‘å™¨å¯èƒ½ä¼šç¼“å­˜å¤´æ–‡ä»¶çš„æŸ¥æ‰¾ç»“æœï¼Œä»¥é¿å…åœ¨åç»­ç¼–è¯‘ä¸­é‡å¤æœç´¢ã€‚
10. **é”™è¯¯æŠ¥å‘Š**ï¼šå¦‚æœç¼–è¯‘å™¨åœ¨æ‰€æœ‰æŒ‡å®šçš„æœç´¢è·¯å¾„ä¸­éƒ½æ²¡æœ‰æ‰¾åˆ° `ViewController.h`ï¼Œå®ƒä¼šæŠ¥é”™æŒ‡å‡ºæ‰¾ä¸åˆ°æ–‡ä»¶ã€‚



#### æ—©æœŸçš„ import

æœ€æ—©æœŸæ˜¯ includeï¼Œå†åˆ°åæ¥çš„ importï¼ŒåŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ

- `include`ï¼š æ˜¯åŸºç¡€å¼•å…¥ï¼Œç¼–è¯‘è¿‡ç¨‹ä¸­ä¼šè¢«ç›´æ¥å±•å¼€ï¼Œå…¶å†…å®¹ä¼šæ’å…¥åˆ° `#include` æŒ‡ä»¤çš„ä½ç½®ã€‚å°† `ç›®æ ‡.h`  æ–‡ä»¶ä¸­çš„å†…å®¹ä¸€å­—ä¸è½åœ°æ‹·è´åˆ°å½“å‰æ–‡ä»¶ä¸­ï¼Œå¹¶æ›¿æ¢æ‰è¿™å¥ `#include`
- `import`ï¼š åªå¼•å…¥ä¸€æ¬¡ã€‚ç”¨äºå¯¼å…¥æ¨¡å—åŒ–çš„å¤´æ–‡ä»¶ï¼Œå®ƒéµå¾ªæ¨¡å—åŒ–çš„ç»“æ„ï¼Œå¯ä»¥æä¾›æ›´å¥½çš„å°è£…æ€§ã€‚ä¼šåŠ å…¥ç¼“å­˜ï¼Œåˆ¤æ–­ import çš„å†…å®¹ä¹‹å‰å·²ç»å¼•å…¥è¿‡åˆ™ä¸å†å¼•å…¥ã€‚

è¿™æ®µç¼“å­˜ç›¸å…³é€»è¾‘ï¼Œå¯ä»¥åœ¨ [LLVM:HeaderSearch.cpp](https://github.com/llvm/llvm-project/blob/main/clang/lib/Lex/HeaderSearch.cpp) ä¸­æŸ¥çœ‹

```c++
// Cache all of the lookups performed by this method.  Many headers are
// multiply included, and the "pragma once" optimization prevents them from
// being relex/pp'd, but they would still have to search through a
// (potentially huge) series of SearchDirs to find it.
LookupFileCacheInfo &CacheLookup = LookupFileCache[Filename];
```

import ä¸¾ä¸ªä¾‹å­å§ã€‚åœ¨ `Person.m`

```objective-c
#import <DynamicLibA/DynamicLibA.h>
@implementation Person
- (void)eat {
  	NSLog(@"Person eat");
}
@end
```

`DynamicLibA.h` å†…å®¹å¦‚ä¸‹

```objective-c
#import <DynamicLibA/Student.h>
#import <DynamicLibA/Worker.h>
#import <DynamicLibA/Teacher.h>
```

åœ¨æ‰¾åˆ°ä¸Šé¢çš„å†…å®¹åï¼Œç¼–è¯‘å™¨å°†å…¶å¤åˆ¶ç²˜è´´åˆ° `Person.m` ä¸­

```objective-c
#import <DynamicLibA/Student.h>
#import <DynamicLibA/Worker.h>
#import <DynamicLibA/Teacher.h>
@implementation Person
- (void)eat {
  	NSLog(@"Person eat");
}
@end
```

ç¼–è¯‘å™¨å‘ç°å­˜åœ¨3ä¸ª importï¼Œåˆ™ç»§ç»­æŸ¥æ‰¾å…¶å†…å®¹

```objective-c
// Student.h
@interface Student: NSObject
- (void)study;
@end
```

ç¼–è¯‘å™¨ä¼šæŠŠå…¶å†…å®¹å¤åˆ¶åˆ° `Person.m` ä¸­ã€‚

```objective-c
@interface Student: NSObject
- (void)study;
@end

#import <DynamicLibA/Worker.h>
#import <DynamicLibA/Teacher.h>
@implementation Person
- (void)eat {
  	NSLog(@"Person eat");
}
@end
```

è¿™æ ·çš„æ­¥éª¤ï¼Œç›´åˆ°æ•´ä¸ªæ–‡ä»¶ï¼ˆPerosn.mï¼‰ä¸­çš„æ‰€æœ‰ import è¢«æ›¿æ¢æ‰ã€‚åŒæ—¶ `.m` å¯èƒ½ä¼šå˜å¾—éå¸¸é•¿ã€‚

å­˜åœ¨2ä¸ªé—®é¢˜ï¼šå¥å£®æ€§ã€æ‹“å±•æ€§ã€‚

æˆ‘ä»¬å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œç»å¸¸éœ€è¦å¼•å…¥ä¸€äº›å¤´æ–‡ä»¶æ¥åŠ©åŠ›å®ç°æŸäº›åŠŸèƒ½ï¼Œå‡è®¾æŸä¸ªç±»åªæœ‰ä¸€ä¸ªæ–¹æ³•ï¼Œæ–¹æ³•æœ¬èº«10è¡Œã€‚ä½†æ˜¯å› ä¸ºå¯¼å…¥äº†æŸäº›å¤´æ–‡ä»¶ï¼Œæœ€åè¿™ä¸ªæ–‡ä»¶æŒ‰ç…§ä¸Šè¿° import çš„æŸ¥æ‰¾æ›¿æ¢è¿‡ç¨‹ï¼Œæœ€åè¯¥æ–‡ä»¶å¯èƒ½å­˜åœ¨10ä¸‡è¡Œä»£ç ï¼ˆimport äº† Foundationã€UIKitã€MapKit ç­‰åº“ï¼‰ã€‚å¤ªæµªè´¹ã€å¤ªä¸åˆç†äº†



#### PCH(PreCompiled Header)

ä¸ºäº†ä¼˜åŒ–å‰é¢æåˆ°çš„é—®é¢˜ï¼Œä¸€ç§æŠ˜ä¸­çš„æŠ€æœ¯æ–¹æ¡ˆè¯ç”Ÿäº†ï¼Œå®ƒå°±æ˜¯ `PreCompiled Header`ã€‚æ—©æœŸåš iOS å¼€å‘çš„éƒ½çœ‹è¿‡ pch æ–‡ä»¶ã€‚

æ—¥å¸¸å¼€å‘ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸å¯ä»¥çœ‹åˆ°æŸäº›ç»„ä»¶çš„å¤´æ–‡ä»¶ä¼šé¢‘ç¹çš„å‡ºç°ï¼Œä¾‹å¦‚ UIKitï¼Œè€Œè¿™å¾ˆå®¹æ˜“è®©äººè”æƒ³åˆ°ä¸€ä¸ªä¼˜åŒ–ç‚¹ï¼Œæˆ‘ä»¬æ˜¯ä¸æ˜¯å¯ä»¥é€šè¿‡æŸç§æ‰‹æ®µï¼Œé¿å…é‡å¤ç¼–è¯‘ç›¸åŒçš„å†…å®¹å‘¢ï¼Ÿ

è€Œè¿™å°±æ˜¯ PCH ä¸ºé¢„ç¼–è¯‘æµç¨‹å¸¦æ¥çš„æ”¹è¿›ç‚¹ã€‚å¤§ä½“åŸç†å°±æ˜¯ï¼Œåœ¨æˆ‘ä»¬ç¼–è¯‘ä»»æ„ `.m` æ–‡ä»¶å‰, ç¼–è¯‘å™¨ä¼šå…ˆå¯¹ `.pch`  é‡Œçš„å†…å®¹è¿›è¡Œé¢„ç¼–è¯‘ï¼Œå°†å…¶å˜ä¸ºä¸€ç§äºŒè¿›åˆ¶çš„ä¸­é—´æ ¼å¼ç¼“å­˜èµ·æ¥ï¼Œä¾¿äºåç»­çš„ä½¿ç”¨ã€‚å½“å¼€å§‹ç¼–è¯‘ `.m` æ–‡ä»¶æ—¶ï¼Œå¦‚æœéœ€è¦ PCH é‡Œå·²ç»ç¼–è¯‘è¿‡çš„å†…å®¹ï¼Œç›´æ¥è¯»å–å³å¯ï¼Œæ— é¡»å†æ¬¡ç¼–è¯‘ã€‚

è™½ç„¶è¿™ç§æŠ€æœ¯æœ‰ä¸€å®šçš„ä¼˜åŠ¿ï¼Œä½†å®é™…åº”ç”¨èµ·æ¥ï¼Œè¿˜å­˜åœ¨ä¸å°‘çš„é—®é¢˜ã€‚

é¦–å…ˆï¼Œå®ƒçš„ç»´æŠ¤æ˜¯æœ‰ä¸€å®šçš„æˆæœ¬çš„ï¼š

- å¯¹äºå¤§éƒ¨åˆ†å†å²åŒ…è¢±æ²‰é‡çš„ç»„ä»¶æ¥è¯´ï¼Œå°†é¡¹ç›®ä¸­çš„å¼•ç”¨å…³ç³»æ¢³ç†æ¸…æ¥šå°±ååˆ†éº»çƒ¦ã€‚å› æ­¤ä¸çŸ¥é“éœ€è¦å°†å“ªäº›å¤´æ–‡ä»¶æ”¾åˆ° `.pch` æ–‡ä»¶ä¸­
- éšç€ç‰ˆæœ¬çš„ä¸æ–­è¿­ä»£ï¼Œå“ªäº›å¤´æ–‡ä»¶éœ€è¦ç§»å‡º PCHï¼Œå“ªäº›å¤´æ–‡ä»¶éœ€è¦ç§»è¿› PCH å°†ä¼šå˜å¾—è¶Šæ¥è¶Šéº»çƒ¦



#### clang module

ä¸ºäº†è§£å†³ä¸Šé¢çš„é—®é¢˜ï¼ŒClang Module  æŠ€æœ¯è¯ç”Ÿäº†ã€‚

ä¸€ä¸ª Module æ˜¯æœºå™¨ä»£ç å’Œæ•°æ®çš„æœ€å°å•ä½ï¼Œå¯ä»¥ç‹¬ç«‹äºå…¶ä»–ä»£ç å•å…ƒè¿›è¡Œé“¾æ¥ã€‚

é€šå¸¸ï¼ŒModule æ˜¯é€šè¿‡ç¼–è¯‘å•ä¸ªæºæ–‡ä»¶ç”Ÿæˆçš„ç›®æ ‡æ–‡ä»¶ã€‚ä¾‹å¦‚ï¼Œå½“å‰çš„ `test.m` è¢«ç¼–è¯‘æˆç›®æ ‡æ–‡ä»¶ `test.o` æ—¶ï¼Œå½“å‰çš„ç›®æ ‡æ–‡ä»¶å°±ä»£è¡¨äº†ä¸€ä¸ª Module ã€‚

åœ¨å®é™…ç¼–è¯‘ä¹‹æ—¶ï¼Œç¼–è¯‘å™¨ä¼šåˆ›å»ºä¸€ä¸ªå…¨æ–°çš„ç›®å½•ï¼Œç”¨å®ƒæ¥å­˜æ”¾å·²ç»ç¼–è¯‘è¿‡çš„ Module äº§ç‰©ã€‚å¦‚æœåœ¨ç¼–è¯‘çš„æ–‡ä»¶ä¸­å¼•ç”¨åˆ°æŸä¸ª Module çš„è¯ï¼Œç³»ç»Ÿå°†ä¼˜å…ˆåœ¨è¿™ä¸ªåˆ—è¡¨å†…æŸ¥æ‰¾æ˜¯å¦å­˜åœ¨å¯¹åº”çš„ä¸­é—´äº§ç‰©ï¼Œå¦‚æœèƒ½æ‰¾åˆ°ï¼Œåˆ™è¯´æ˜è¯¥æ–‡ä»¶å·²ç»è¢«ç¼–è¯‘è¿‡ï¼Œåˆ™ç›´æ¥ä½¿ç”¨è¯¥ä¸­é—´äº§ç‰©ï¼Œå¦‚æœæ²¡æ‰¾åˆ°ï¼Œåˆ™æŠŠå¼•ç”¨åˆ°çš„å¤´æ–‡ä»¶è¿›è¡Œç¼–è¯‘ï¼Œå¹¶å°†äº§ç‰©æ·»åŠ åˆ°ç›¸åº”çš„ç©ºé—´ä¸­ä»¥å¤‡é‡å¤ä½¿ç”¨ã€‚

ç›¸å…³çš„ä¸€äº›ä½¿ç”¨ï¼Œå¯ä»¥æŸ¥çœ‹ä¸Šé¢çš„ sectionã€‚

è¿˜æ˜¯å­˜åœ¨é—®é¢˜ï¼Œå› æ­¤è¯ç”Ÿäº† Use Header Maps æŠ€æœ¯ã€‚



### è¯ç”ŸèƒŒæ™¯

ä½†å­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼Œå¦‚æœåŒæ—¶å­˜åœ¨å¤šä¸ª `header search path` çš„æ—¶å€™ï¼Œå‡è®¾ä¸€ä¸ªå·¥ä½œé¡¹ç›®æœ‰10000ä¸ªæ–‡ä»¶ï¼Œä¸€ä¸ªç±»ä½¿ç”¨äº†10ä¸ªå¤´æ–‡ä»¶ï¼Œè¦å»10000ä¸ªæ–‡ä»¶ä¸­åˆ†åˆ«æŸ¥æ‰¾10ä¸ªå¤´æ–‡ä»¶å…·ä½“ä½ç½®ï¼Œè¿™ä¸ªæŸ¥æ‰¾è¿‡ç¨‹æ˜¯å‘ç”Ÿåœ¨ç¼–è¯‘é˜¶æ®µçš„ã€‚æ— ç–‘ä¼šå¢åŠ ç¼–è¯‘è€—æ—¶ã€‚

åŸºäºæ­¤ï¼Œè¯ç”Ÿäº† Header Maps æŠ€æœ¯ï¼Œé€šè¿‡ hmap æ–‡ä»¶ï¼Œè®© Xcode åœ¨æŸ¥æ‰¾å¤´æ–‡ä»¶çš„æ—¶å€™æ›´å¿«é€Ÿã€‚

### hmap ç»“æ„

åˆ›å»ºä¸€ä¸ª iOS Appï¼Œé»˜è®¤æ¨¡ç‰ˆçš„åŸºç¡€ä¸Šæ·»åŠ ä¸€ä¸ª Person ç±»ï¼Œä¸€ä¸ªç»§æ‰¿è‡ª Person çš„ Student ç±»ã€‚ç„¶åç¼–è¯‘

<img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/HMapExploreSample.png" style="zoom:30%" />



ä» Xcode Compile log å¯ä»¥çœ‹åˆ°é€šè¿‡ `-I` å‚æ•°æ¥æŒ‡å®š hmap æ–‡ä»¶ã€‚å¤åˆ¶ç›®å½•è·¯å¾„æŸ¥çœ‹æ‰€æœ‰çš„ hmap æ–‡ä»¶ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œ

**iOS hmap æ–‡ä»¶ä¼šæ ¹æ®æ–‡ä»¶åˆ†ç±»å’Œä½¿ç”¨æ–¹å¼ä¸»è¦ä¸é¡¹ç›®ç»“æ„å’Œç¼–è¯‘éœ€æ±‚æœ‰å…³ã€‚å¯ä»¥åˆ†ä¸ºé¡¹ç›®çº§åˆ« Header Mapsã€ç»„ä»¶çº§åˆ« Header Mapsã€å…¬å…±ä¸ç§æœ‰ Header Mapsç­‰ç­‰**ã€‚



`hmap` æ–‡ä»¶ä¸å¯è¯»ï¼Œå¿…é¡»ç”¨å¯¹åº”çš„å·¥å…·è§£æï¼ŒæŒ‰ç…§æŒ‡å®šçš„æ ¼å¼è§£æã€‚å› ä¸ºå±äºç¼–è¯‘å™¨çš„ scopeï¼Œæ‰€ä»¥æŸ¥çœ‹ LLVM æºç çª¥æ¢ä¸‹ã€‚

<img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/HMapStructure.png" style="zoom:30%" />

å¯ä»¥çœ‹åˆ° hmap ç»“æ„ç±»ä¼¼ Mach-O ï¼Œé¡¶éƒ¨ HMapHeader å‘Šè¯‰ç³»ç»Ÿï¼Œå½“å‰æœ‰å‡ ä¸ª Bucketï¼Œä¸‹é¢æ˜¯ Bucket ä¿¡æ¯ã€‚ç„¶åæœ€ä¸‹æ–¹æ˜¯ string åŒºåŸŸã€‚

åœ¨ HMapBucket ä¸­ï¼š

- Keyï¼š ä¸€ä¸ª `uint32_t` ç±»å‹çš„æˆå‘˜ï¼Œè¡¨ç¤º bucket ä¸­é”®çš„å“ˆå¸Œå€¼æˆ–è€…æ˜¯ä¸€ä¸ªç‰¹æ®Šå€¼è¡¨ç¤º bucket çš„çŠ¶æ€ï¼ˆä¾‹å¦‚ï¼Œæ˜¯å¦ä¸ºç©ºæˆ–è€…æ˜¯ä¸€ä¸ªå†²çªçš„bucketï¼‰

- prefixï¼š ä¸€ä¸ª `uint32_t` ç±»å‹çš„æˆå‘˜ï¼Œé€šå¸¸ç”¨äºå­˜å‚¨é”®çš„å‰ç¼€åç§»é‡ï¼Œå®ƒä¸ `Suffix` ä¸€èµ·å®šä¹‰äº†é”®åœ¨æ•´ä¸ª Header Map ä¸­çš„å®Œæ•´å­—ç¬¦ä¸²
- Suffixï¼š ä¸€ä¸ª `uint32_t` ç±»å‹çš„æˆå‘˜ï¼Œç”¨äºå­˜å‚¨é”®çš„åç¼€é•¿åº¦ï¼Œä¸ `Prefix` ç»“åˆä½¿ç”¨å¯ä»¥å®šä½åˆ°é”®çš„å…·ä½“å­—ç¬¦ä¸²



### ç¼–å†™å·¥å…·åˆ†æ hmap æ–‡ä»¶

å…¶ç»“æ„ã€å·¥ä½œåŸç†éƒ½ç±»ä¼¼ Mach-O æ–‡ä»¶ã€‚å‚è€ƒ Mach-O æ–‡ä»¶ç»“æ„å’Œ [LLVM:HeaderMap.cpp](https://github.com/llvm/llvm-project/blob/main/clang/lib/Lex/HeaderMap.cpp) çš„å®ç°ï¼Œç¼–å†™ä¸€ä¸ªè¯»å– hmap æ–‡ä»¶çš„ä»£ç ã€‚

å…·ä½“ä»£ç å¯ä»¥åœ¨è¿™ä¸ª Repo ä¸­æŸ¥çœ‹å¹¶è¿è¡Œ  [BlogDemos:HMapDump](https://github.com/FantasticLBP/BlogDemos/tree/master/HMapDump)

è¿è¡Œè°ƒè¯•çš„æ—¶å€™ï¼ŒæŠŠéœ€è¦è¯»å–çš„ HMapFile æ‹·è´åˆ°é¡¹ç›®æ ¹ç›®å½•ã€‚ç„¶å Edit Scheme - Run - Arguments Passed On Launch

<img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/HMapDumpXcodeConfig.png" style="zoom:30%" />

<img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/HMapDumpRes.png" style="zoom:30%" />

å¦‚ä½•åšåˆ°è¯¥å·¥å…·åšåˆ°åƒç³»ç»Ÿè‡ªå¸¦çš„ `objdump` ä¸€æ ·ï¼Œåœ¨ç»ˆç«¯å‘½ä»¤è¡Œä½¿ç”¨ï¼š

- åœ¨ç”µè„‘æ ¹ç›®å½•æ–°å»º `CustomTools` æ–‡ä»¶å¤¹
- å°†ä¸Šé¢ç¼–è¯‘åçš„äº§ç‰©å¤åˆ¶è¿›å»
- åœ¨ `.zshrc` æ–‡ä»¶é‡Œå°†è·¯å¾„æ·»åŠ è¿›å»ã€‚`export PATH=~/CustomTools:$PATH`
- ç¼–è¾‘ `.zshrc` æ–‡ä»¶åï¼Œåœ¨ç»ˆç«¯æ‰§è¡Œ `souce .zshrc` 
- å³å¯ä½¿ç”¨

æ•ˆæœå¦‚ä¸‹ï¼š

<img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/HMapDumpSystemTools.png" style="zoom:30%" />





### ç¼–å†™å·¥å…·ç”Ÿæˆ hmap æ–‡ä»¶

#### ä¸ºä»€ä¹ˆè¦ç¼–å†™ hmap æ–‡ä»¶

å¦‚æœ2ä¸ª `.m` æ–‡ä»¶æœ‰ç›¸åŒçš„å¤´æ–‡ä»¶ä»£ç ï¼Œé€ æˆç¼–è¯‘æµªè´¹ã€‚



clang å¯ä»¥ä½¿ç”¨ `-I` æ¥æŒ‡å®š Header Search Path ä¿¡æ¯ã€‚`-I` åé¢å¯ä»¥è·Ÿï¼š`ç›®å½•æ–‡ä»¶å¤¹`ã€`.hmap` æ–‡ä»¶

iOS å¯¼å…¥æ–¹å¼:

- `import <> ` ï¼šæœ¬è´¨ä¸Šå°±æ˜¯ LD ç¼–è¯‘å‚æ•° `HEADERS_SEARCH_PATHS -I`
- `import ""` ï¼šæœ¬è´¨ä¸Šå°±æ˜¯ LD ç¼–è¯‘å‚æ•° `USER_HEADER_SEARCH_PATHS -iquote`

Tipsï¼šXcode è®¾ç½® Search Path æœ‰ä¸‰å¤„ `Header Search Path`ã€`System Header Search Path`ã€`User Header Search Path`ï¼ŒåŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ

- System Header Search Path æ˜¯é’ˆå¯¹ç³»ç»Ÿå¤´æ–‡ä»¶çš„è®¾ç½®ï¼Œé€šå¸¸ä»£æŒ‡ `<>` æ–¹å¼å¼•å…¥çš„æ–‡ä»¶
- User Header Search Path åˆ™æ˜¯é’ˆå¯¹éç³»ç»Ÿå¤´æ–‡ä»¶çš„è®¾ç½®ï¼Œé€šå¸¸ä»£æŒ‡ `""` æ–¹å¼å¼•å…¥çš„æ–‡ä»¶
- Header Search Path å¹¶ä¸ä¼šæœ‰ä»»ä½•é™åˆ¶ï¼Œå®ƒæ™®é€‚äºä»»ä½•æ–¹å¼çš„å¤´æ–‡ä»¶å¼•ç”¨



Xcode ä¼šä¸»åŠ¨ç”Ÿæˆ `.hmap` æ–‡ä»¶ï¼Œé‚£ä¸ºä»€ä¹ˆè¿˜éœ€è¦ç ”ç©¶ç”Ÿæˆ `hmap` æ–‡ä»¶ï¼Ÿ

æœ‰å¿…è¦ã€‚ä¸‹é¢æ¥ä¸ªä¾‹å­è¿›è¡Œè¯´æ˜ã€‚è™½ç„¶å¹³æ—¶å¼€å‘ä¸­ç»å¸¸ä»¥äºŒè¿›åˆ¶ç»„ä»¶çš„æ–¹å¼æ„å»º Appï¼Œä½†åœ¨æŸäº›åœºæ™¯ä¸‹ï¼ˆç²¾å‡†æµ‹è¯•ã€è¦†ç›–ç‡ç»Ÿè®¡ç­‰ï¼‰ï¼Œæ‰“åŒ…æ„å»ºè¿˜æ˜¯éœ€è¦ä»¥å…¨æºç ç¼–è¯‘çš„æ–¹å¼è¿›è¡Œã€‚è€Œä¸”åœ¨å®é™…å¼€å‘è¿‡ç¨‹ä¸­ï¼Œå¤§å¤šæ˜¯ä»¥æºç çš„æ–¹å¼è¿›è¡Œå¼€å‘ï¼Œæ‰€ä»¥æˆ‘ä»¬å°†å®éªŒå¯¹è±¡è®¾ç½®ä¸ºåŸºäºå…¨æºç ç¼–è¯‘çš„æµç¨‹ã€‚



åˆ›å»ºä¸€ä¸ªé™æ€åº“ `HMapStaticLib` é‡Œé¢å°±åŒ…å«2ä¸ªç±»æ–‡ä»¶ `Person` ç±»ã€ç»§æ‰¿è‡ª `Person` ç±»çš„ `Student` ç±»ã€‚å†åˆ›å»ºä¸€ä¸ªä½¿ç”¨ iOS Appï¼Œä½¿ç”¨è¯¥é™æ€åº“ã€‚ç¼–è¯‘è¯¥ Appï¼ŒæŸ¥çœ‹ç¼–è¯‘æ—¥å¿—ã€‚

ç„¶åæŸ¥çœ‹ç¼–è¯‘æ—¥å¿—ä¸­çš„ ` HMapStaticLibApp-project-headers.hmap` æ–‡ä»¶ã€‚åˆ©ç”¨ä¸Šé¢åˆ¶ä½œçš„ `HMapDump` å·¥å…·ã€‚

<img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/StaticLibUseHeaderMapOnlyQuoteMethod.png" style="zoom:30%" />

åˆ†æï¼šåœ¨ App ä½¿ç”¨ Static Library çš„æƒ…å†µä¸‹ï¼Œå‡è®¾å¼€å¯äº† `Use Header Map`ï¼Œé™æ€åº“ä¸­æ‰€æœ‰å¤´æ–‡ä»¶ç±»å‹ä¸º `Project`(åªæœ‰ Projectã€Privateã€Public 3ç§ç±»å‹ï¼Œpublic å°±æ˜¯å­—é¢æ„æ€çš„å…¬å¼€ï¼Œp r)çš„æƒ…å†µï¼Œæœ€ç»ˆç”Ÿæˆçš„ `.hmap` æ–‡ä»¶ä¸­åªä¼šåŒ…å«ç±»ä¼¼ `#import "Student.h"` çš„é”®å€¼å¼•ç”¨ã€‚ä¹Ÿå°±æ˜¯è¯´ä½¿ç”¨çš„åœ°æ–¹ï¼Œåªæœ‰ `#import "Student.h"` çš„è¿™ç§æ–¹å¼æ‰ä¼šèµ° hmap ç­–ç•¥ï¼Œå¦åˆ™è¿˜æ˜¯èµ° `Header Search Path` æ¥å¯»æ‰¾å¤´æ–‡ä»¶è·¯å¾„ã€‚

ç»„ä»¶ã€åº“ä½¿ç”¨ `#import <SomeFramework/SomeFrameworkExportedHeader.h>` æ˜¯è®¿é—®çš„æ ‡å‡†åšæ³•ã€‚å¥½å¤„æœ‰3ç‚¹ï¼š
1. æ˜ç¡®å¤´æ–‡ä»¶çš„ç”±æ¥ï¼Œé¿å…æ­§ä¹‰
2. å¯ä»¥è®©æˆ‘ä»¬åœ¨æ˜¯å¦å¼€å¯ clang module ä¸­éšæ„åˆ‡æ¢
3. Apple åœ¨ WWDC é‡Œæ›¾ç»ä¸æ­¢ä¸€æ¬¡å»ºè®®å¼€å‘è€…ä½¿ç”¨è¿™ç§æ–¹å¼æ¥å¼•å…¥å¤´æ–‡ä»¶

æ‰€ä»¥å¯ä»¥å›ç­”ä¸Šé¢çš„é—®é¢˜äº†ã€‚è™½ç„¶ä¸€ä¸ªé™æ€åº“ã€åŠ¨æ€åº“é¡¹ç›®ä¸­ï¼Œ`Build Setting` ä¸­è™½ç„¶ `Use Header Maps` ä¸º YESï¼Œä½†æ˜¯æŸäº›æƒ…å†µä¸‹ Header Maps å¸¦æ¥çš„åŠ é€Ÿç¦åˆ©æ²¡æœ‰äº«å—åˆ°ã€‚





ä¸€ä¸ªå¤§å‹é¡¹ç›®æœ‰300ä¸ª Podï¼Œæ¯ä¸ª Pod æœ‰100ä¸ªå¤´æ–‡ä»¶ï¼Œä¹Ÿå°±æ˜¯å…± 30000ä¸ªå¤´æ–‡ä»¶ï¼Œåœ¨30000ä¸ªå¤´æ–‡ä»¶ä¸­ï¼Œå¦‚æœæ²¡æœ‰äº«å— `Header Maps` å¸¦æ¥çš„ç¦åˆ©ï¼Œè€è€å®å®ä¾é  `Header Search Path` ä¸­æä¾›çš„å¤´æ–‡ä»¶æ‰€åœ¨çš„æ–‡ä»¶å¤¹ä¿¡æ¯æŸ¥æ‰¾ï¼Œæˆ–è€…é€’å½’æŸ¥æ‰¾ã€‚å¯èƒ½å­˜åœ¨ n*m çš„å¾ªç¯æŸ¥æ‰¾è¿‡ç¨‹ï¼Œæ•ˆç‡å¾ˆä½ï¼Œæ¶‰åŠçš„ IO å½±å“å¤§å‹é¡¹ç›®çš„ç¼–è¯‘æ„å»ºæ—¶é—´ï¼Œå½±å“åˆ†å‘å’Œå‘ç”Ÿé—®é¢˜æ—¶å€™çš„åŠæ—¶çƒ­ä¿®å¤ã€‚

æ—¢ç„¶çŸ¥é“æŸäº›æƒ…å†µä¸‹ä¼šå­˜åœ¨ hmap æ–‡ä»¶æ²¡æœ‰å‘½ä¸­çš„æƒ…å†µï¼Œé‚£æœ‰å¿…è¦ä¿®æ”¹å—ï¼Ÿè®©é™æ€åº“çš„æƒ…å†µï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ hmap å¸¦æ¥çš„ç¼–è¯‘çº¢åˆ©ã€‚



#### å¦‚ä½•ç”Ÿæˆ HMap æ–‡ä»¶
LLVM çœŸæ˜¯å¥½ä¸œè¥¿ï¼ŒæŠŠ Xcode ç¼–è¯‘ã€é“¾æ¥ç­‰ä¸€äº›å¹•åçš„äº‹æƒ…å˜æˆç™½ç›’ï¼Œæœ‰è¿¹å¯å¾ªï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥å»æŸ¥çœ‹æºç å¹¶å¸¦ç€ä¸€äº›å…³é”®è¯æ¥æœç´¢æºç è¿›è¡ŒæŸ¥çœ‹ï¼Œå¯èƒ½ä¼šå‘ç°ä¸€äº›å¹³æ—¶äº†è§£ä¸åˆ°çš„ç»†èŠ‚ã€‚

å¯ä»¥æŸ¥çœ‹ [HeaderMapTest.cpp](https://github.com/llvm/llvm-project/blob/main/clang/unittests/Lex/HeaderMapTest.cpp)  å’Œ [HeaderMapTestUtils.h](https://github.com/llvm/llvm-project/blob/main/clang/unittests/Lex/HeaderMapTestUtils.h) ç¼–å†™  hmap çš„ç”Ÿæˆä»£ç ã€‚ç¼–å†™åçš„å…·ä½“ä»£ç å¯ä»¥æŸ¥çœ‹  [BlogDemos:HMapWritor](https://github.com/FantasticLBP/BlogDemos/tree/master/HMapWritor)

ä¸ºäº†æ–¹ä¾¿å¹³æ—¶ä½¿ç”¨ï¼ŒæŒ‰ç…§ä¸Šé¢çš„æ–¹å¼ï¼Œä¹Ÿå°†äºŒè¿›åˆ¶æ”¾åˆ° `/Users/unix_kernel/CustomTools` ç›®å½•ä¸‹ï¼ŒåŒæ—¶è®¾ç½® `.zshrc` å¯è®¿é—®æ€§ã€‚



###  hmap åŠ©åŠ›æå‡ iOS é¡¹ç›®ç¼–è¯‘é€Ÿåº¦

å·²ç»ç¼–å†™å¥½ç”Ÿæˆ `.hmap` æ–‡ä»¶çš„èƒ½åŠ›äº†ï¼Œé‚£å¦‚ä½•ä½¿ç”¨ç”Ÿæˆçš„ `.hmap` æ–‡ä»¶ï¼Ÿ

- Xcode `Build Setting` ä¸­ `Use Header Maps` ä¸º NO
- `Header Search Path` è®¾ç½®ç”Ÿæˆçš„ hmap æ–‡ä»¶è·¯å¾„

å®è·µæ“ä½œä¸‹ã€‚æŠŠä¸Šé¢é™æ€åº“æ— æ³•èµ° Header Maps å¸¦æ¥çš„é—®é¢˜è§£å†³æ‰ã€‚

ç¬¬ä¸€æ­¥ï¼Œç¼–å†™ hmap æ‰€éœ€è¦çš„ json ä¿¡æ¯ã€‚

ç¬¬äºŒæ­¥ï¼Œåˆ©ç”¨ `HMapWriter` èƒ½åŠ›ï¼Œæ ¹æ® json ç”Ÿæˆé™æ€åº“æ‰€éœ€è¦çš„ `StaticLibUsage.hmap`

ç¬¬ä¸‰æ­¥ï¼Œåœ¨é™æ€åº“ Xcode é¡¹ç›®ä¸­ï¼Œå…³é—­ `Use Header Maps`ï¼ˆè®¾ç½®ä¸º NOï¼‰ï¼ŒåŒæ—¶ä¿®æ”¹ `Header Search Paths` ä¸ºç”Ÿæˆ `StaticLibUsage.hmap` è·¯å¾„ã€‚

ç¬¬å››æ­¥ï¼Œç¼–è¯‘ä½¿ç”¨é™æ€åº“çš„ App å·¥ç¨‹ã€‚æœ€åæ¯”è¾ƒé™æ€åº“èµ°è‡ªå®šä¹‰ `.hmap` å‰åçš„ç¼–è¯‘è€—æ—¶ã€‚

<img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/StaticLibUseHeaderMapEffect.png" style="zoom:30%" />

å¯ä»¥çœ‹åˆ°é™æ€åº“ä½¿ç”¨äº†è‡ªå®šä¹‰çš„ Header Maps æ–‡ä»¶åï¼Œä½¿ç”¨é™æ€çš„ App å‰åï¼Œç¼–è¯‘è€—æ—¶å‡å°‘äº†0.1sã€‚



Demo åŠå…¶æ¼”ç¤ºä»£ç è§ [HMapStaticLibApp](https://github.com/FantasticLBP/BlogDemos/tree/master/HMapStaticLibApp) å’Œ [HMapStaticLib](https://github.com/FantasticLBP/BlogDemos/tree/master/HMapStaticLib)ã€‚



### å·¥ç¨‹åŒ–é—®é¢˜

ä¸Šé¢æ˜¯ç†è®ºä¸Šåˆ†æå¹¶æ€è€ƒäº†2ä¸ªé—®é¢˜ï¼š
- ä¸ºä»€ä¹ˆéœ€è¦ä»‹å…¥è‡ªå·±ç”Ÿæˆ hmap æ–‡ä»¶
- ç”Ÿæˆåçš„ hmap æ–‡ä»¶å¦‚ä½•ä½¿ç”¨
å¦‚æœæ¯ä¸ªå·¥ç¨‹é¡¹ç›®éƒ½è¿™ä¹ˆåšï¼Œæ•ˆç‡æœ‰ç‚¹ä½ï¼Œæ‰€ä»¥éœ€è¦ç«™åœ¨å·¥ç¨‹åŒ–çš„è§’åº¦å»è®¾è®¡ï¼Œå¦‚ä½•ä¼˜åŒ–ï¼Ÿ

Cocoapods æä¾›äº†å¾ˆå¤šé’©å­ï¼Œå¯ä»¥è‡ªå®šä¹‰ç¼–å†™ Ruby è„šæœ¬ã€‚
- HooksManager æ³¨å†Œ cocoapods çš„ `post_install` é’©å­
- é€šè¿‡ `header_mappings_by_file_accessor` éå†æ‰€æœ‰å¤´æ–‡ä»¶å’Œ `header_dir`ï¼Œç”±header_dir/header.hå’Œheader.hä¸ºkeyï¼Œä»¥å¤´æ–‡ä»¶æœç´¢è·¯å¾„ä¸ºvalueï¼Œç»„è£…æˆä¸€ä¸ªHash<key,value>ï¼Œç”Ÿæˆæ‰€æœ‰ç»„ä»¶podå¤´æ–‡ä»¶çš„jsonæ–‡ä»¶ï¼Œå†é€šè¿‡hmapå·¥å…·å°†jsonæ–‡ä»¶è½¬æˆhmapæ–‡ä»¶ã€‚
- å†ä¿®æ”¹å„ pod ä¸­ `.xcconfig` æ–‡ä»¶çš„ `HEADER_SEARCH_PATHS` å€¼ï¼Œä»…æŒ‡å‘ç”Ÿæˆçš„æ–°ç”Ÿæˆçš„ `.hmap` æ–‡ä»¶ï¼Œåˆ é™¤åŸæ¥æ·»åŠ çš„æœç´¢ç›®å½•ï¼›
- ä¿®æ”¹å„ pod çš„ `USE_HEADERMAP` å€¼ï¼Œå…³é—­å¯¹é»˜è®¤çš„ `.hmap` æ–‡ä»¶çš„è®¿é—®



## æ­»ä»£ç å‰¥ç¦»

æ­»ä»£ç å‰¥ç¦»çš„æ¡ä»¶ï¼š

- æ²¡æœ‰è¢«å…¥å£ç‚¹ä½¿ç”¨åˆ™ä¼šè¢«å¹²æ‰
- æ²¡æœ‰è¢«å¯¼å‡ºç¬¦å·æ‰€ä½¿ç”¨ï¼Œåˆ™ä¼šè¢«å¹²æ‰

dead code strip å’Œ xlinker æä¾›çš„4ä¸ªå‚æ•°ï¼š

- `-noall_load`:  å®Œå…¨ä¸åŠ è½½ã€ç›´æ¥å»ä¼˜åŒ–ã€‚`OTHER_LDFLAGS=-Xlinker -noall_load`

- `-all_load`:  å®Œå…¨åŠ è½½ã€ä¸è¦å»ä¼˜åŒ–æ‰ã€‚`OTHER_LDFLAGS=-Xlinker -all_load`
- `-ObjC` :  æ’é™¤ObjCçš„ä»£ç ã€å…¶ä»–çš„éƒ½ä¼˜åŒ–æ‰ã€‚`OTHER_LDFLAGS=-Xlinker -ObjC ` 
-  `-force_load` ï¼š æŒ‡å®šå“ªäº›é™æ€åº“ä¸è¦ä¼˜åŒ–æ‰ï¼› 



## DYLDï¼ˆdyld shared cacheï¼‰ åŠ¨æ€åº“å…±äº«ç¼“å­˜

UIKitã€CoreGraphics ç­‰ã€‚ä» iOS13 å¼€å§‹ï¼Œä¸ºäº†æé«˜æ€§èƒ½ï¼Œç»å¤§éƒ¨åˆ†çš„ç³»ç»ŸåŠ¨æ€åº“æ–‡ä»¶éƒ½è¢«æ‰“åŒ…å­˜æ”¾åˆ°äº†ä¸€ä¸ªç¼“å­˜æ–‡ä»¶ä¸­ï¼ˆdyld shared cacheï¼‰ä¸­ã€‚
å­˜æ”¾è·¯å¾„ä¸ºï¼š`/System/Libarey/Caches/com.apple.dyld/dyld_shared_cache_armX`
å…¶ä¸­ï¼Œ`X` ä»£è¡¨ ARM å¤„ç†å™¨çš„æŒ‡ä»¤é›†æ¶æ„ã€‚V6ã€V7ã€V7sã€arm64ã€arm64eã€‚ä¸åŒæ¶æ„ï¼Œå¯¹åº”çš„åŠ¨æ€åº“ç¼“å­˜ä¸ä¸€è‡´ã€‚

æ‰€æœ‰æŒ‡ä»¤é›†åŸåˆ™æ˜¯å‘ä¸‹å…¼å®¹çš„ã€‚åŠ¨æ€åº“å…±äº«ç¼“å­˜ä¸€ä¸ªéå¸¸æ˜æ˜¾çš„å¥½å¤„æ˜¯èŠ‚çœå†…å­˜ã€‚

å…·ä½“åº•å±‚æºç å¯ä»¥æŸ¥çœ‹ï¼Œdyld æºç ä¸­ `dyld2.cpp` æ–‡ä»¶ï¼Œå‡½æ•°å…¥å£ä¸º load æ–¹æ³•ã€‚

```c
ImageLoader* load(const char* path, const LoadContext& context, unsigned& cacheIndex);
```

æŸä¸ª App è¢«ç¬¬ä¸€æ¬¡æ‰“å¼€æ—¶å€™ï¼Œ dyld æ ¹æ®åŠ¨æ€åº“çš„ä¾èµ–ï¼Œå¾ªç¯åŠ è½½åŠ¨æ€åº“åˆ°åŠ¨æ€åº“å…±äº«ç¼“å­˜ä¸­ï¼ˆå†…å­˜ï¼‰ï¼Œåç»­å…¶ä»– App ç¬¬ä¸€æ¬¡æ‰“å¼€å‘ç°ä½¿ç”¨äº†åŠ¨æ€åº“Aå·²ç»åœ¨åŠ¨æ€åº“å…±äº«ç¼“å­˜ä¸­å­˜åœ¨ï¼Œåˆ™ä¸éœ€è¦åŠ è½½ã€‚è¿™ä¸€æ­¥è°ƒç”¨æ–¹æ³•ä¸º `findInSharedCacheImage`



## dyld åŠå…¶å·¥ä½œæµç¨‹

### æ¦‚å¿µ

dyld æ˜¯ä¸€ä¸ªåŠ¨æ€é“¾æ¥ç¨‹åºã€‚æ˜¯ iOS å’Œ macOS ç³»ç»Ÿä¸­çš„**åŠ¨æ€é“¾æ¥å™¨**ï¼ˆDynamic Loaderï¼‰ã€‚å®ƒè´Ÿè´£åœ¨ç¨‹åºè¿è¡Œæ—¶åŠ è½½å’Œé“¾æ¥åŠ¨æ€åº“ã€‚ç®€å•æ¥è¯´ï¼Œdyld å°±å¦‚åŒä¸€ä¸ªã€Œä¸­é—´äººã€ï¼Œå°†ä½ çš„ç¨‹åºä»£ç å’Œå®ƒæ‰€ä¾èµ–çš„æ‰€æœ‰åŠ¨æ€åº“æ•´åˆåœ¨ä¸€èµ·ï¼Œæœ€ç»ˆè®©ä½ çš„ç¨‹åºèƒ½å¤Ÿæ­£å¸¸è¿è¡Œã€‚

`libdyld.dylib` ç»™æˆ‘ä»¬çš„ç¨‹åºæä¾›åœ¨ runtime æœŸé—´èƒ½ä½¿ç”¨åŠ¨æ€é“¾æ¥åŠŸèƒ½ã€‚æ¯”å¦‚ dlopen èƒ½åŠ›ï¼Œåˆæˆ–è€…æ˜¯ç³»ç»Ÿ lazy-binding ç¬¦å·è¡¨ï¼Œåœ¨è¿è¡Œä¹‹åï¼ŒåŠ¨æ€ä¿®æ­£ç¬¦å·åœ°å€ã€‚

æ‡’åŠ è½½çš„ç¬¦å·è¡¨é¡¹é€šå¸¸åŒ…æ‹¬ä¸€ä¸ªæˆ–å¤šä¸ªæŒ‡å‘ç¬¦å·çš„é—´æ¥ç¬¦å·ï¼ˆIndirect Symbolsï¼‰ï¼Œè¿™äº›é—´æ¥ç¬¦å·åœ¨é¦–æ¬¡è®¿é—®æ—¶ä¼šè¢«åŠ¨æ€é“¾æ¥å™¨æ›¿æ¢ä¸ºå®é™…çš„å†…å­˜åœ°å€ã€‚è¿™ä¸ªè¿‡ç¨‹ç§°ä¸ºç¬¦å·ç»‘å®šï¼ˆSymbol Bindingï¼‰ã€‚ç”±äºæ‡’åŠ è½½çš„ç¬¦å·åœ¨é¦–æ¬¡ä½¿ç”¨å‰ä¸ä¼šè¢«ç»‘å®šï¼Œå› æ­¤å¯ä»¥å‡å°‘åº”ç”¨ç¨‹åºçš„å¯åŠ¨æ—¶é—´ï¼Œå¹¶æŒ‰éœ€åŠ è½½æ‰€éœ€çš„èµ„æº



```shell
objdump --macho --private-headers DSYMDemo
```

<img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/dyldWorkFlowViaMachOStructure.png" style="zoom:30%" />

- **å¯åŠ¨é˜¶æ®µ**ï¼šåº”ç”¨ç¨‹åºå¯åŠ¨æ—¶ï¼ŒiOS ç³»ç»Ÿé¦–å…ˆè§£æ `Info.plist` æ–‡ä»¶ï¼ŒåŠ è½½ç›¸å…³ä¿¡æ¯ï¼Œä¾‹å¦‚å¯åŠ¨ç”»é¢ç­‰ï¼Œå¹¶å»ºç«‹æ²™ç›’ç¯å¢ƒä»¥åŠè¿›è¡Œæƒé™æ£€æŸ¥

- **Mach-O åŠ è½½**ï¼šç³»ç»ŸåŠ è½½åº”ç”¨ç¨‹åºçš„å¯æ‰§è¡Œæ–‡ä»¶ï¼ˆMach-O æ ¼å¼ï¼‰ï¼Œè¿™æ˜¯ä¸€ä¸ªåŒ…å«ç¨‹åºæŒ‡ä»¤å’Œæ•°æ®çš„æ–‡ä»¶ã€‚åŠ è½½æ—¶ä¼šåŒ…æ‹¬ dylibï¼ˆåŠ¨æ€åº“ï¼‰çš„åŠ è½½æ—¶é—´ä»¥åŠåç§»ä¿®æ­£ï¼ˆrebaseï¼‰å’Œç¬¦å·ç»‘å®šï¼ˆbindingï¼‰çš„æ—¶é—´

- **dyld çš„åˆå§‹åŒ–**ï¼šåœ¨ç³»ç»Ÿå†…æ ¸å®Œæˆåˆå§‹åŒ–åï¼Œä» Mach-O çš„ `LC_LOAD_DYLINKER` load command ä¸­ï¼Œæ ¹æ® name è·¯å¾„ä¿¡æ¯ï¼Œç„¶ååŠ è½½ï¼Œdyld å¼€å§‹æ‰§è¡Œã€‚å®ƒçš„ä¸»è¦ä»»åŠ¡æ˜¯åŠ è½½åº”ç”¨ç¨‹åºçš„ä¸»å¯æ‰§è¡Œæ–‡ä»¶ä»¥åŠå…¶ä»–ä¾èµ–çš„åŠ¨æ€åº“

  ```shell
  Load command 14
            cmd LC_LOAD_DYLIB
        cmdsize 88
           name /System/Library/Frameworks/Foundation.framework/Foundation (offset 24)
     time stamp 2 Thu Jan  1 08:00:02 1970
        current version 1953.255.0
  compatibility version 300.0.0
  ```

- **ä¾èµ–åˆ†æ**ï¼šdyld ä¼šåˆ†æ Mach-O æ–‡ä»¶ï¼Œæ‰¾å‡ºç¨‹åºæ‰€ä¾èµ–çš„æ‰€æœ‰åº“ï¼Œå¹¶é€’å½’åœ°è§£ææ‰€æœ‰ä¾èµ–å…³ç³»ï¼Œå½¢æˆåŠ¨æ€åº“çš„ä¾èµ–å›¾

- **å†…å­˜æ˜ å°„**ï¼šdyld å°†åŒ¹é… Mach-O æ–‡ä»¶åˆ°å†…å­˜ç©ºé—´ï¼Œç¡®ä¿æ¯ä¸ªä¾èµ–åº“éƒ½è¢«æ˜ å°„åˆ°æ­£ç¡®çš„åœ°å€

  - è§£æ Mach Headerï¼Œåˆ¤æ–­å½“å‰ Mach-O æ–‡ä»¶æ˜¯å¦å¯ç”¨

    æ¯”å¦‚ä¸Šé¢çš„ Mach header ä¸­

    - cputype æ˜¯ `X86_64`ï¼Œdyld ä¼šåˆ¤æ–­è¯¥æ¶æ„èƒ½å¦åœ¨å½“å‰ç³»ç»Ÿä¸Šè¿è¡Œ
    - filetype æ˜¯ `EXECUTE`ï¼Œæ˜¯ä¸æ˜¯ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶
    - æœ‰ ncmds 16ä¸ª Load commandsï¼Œå  sizeofcmds 2848å¤§å°çš„ç©ºé—´

  - æ ¹æ® Mach Headerï¼Œè§£æ load commandsï¼Œæ ¹æ®è§£æçš„ç»“æœï¼Œå°†ç¨‹åºå„ä¸ªéƒ¨åˆ†åŠ è½½ç¨‹åºåˆ°æŒ‡å®šçš„åœ°å€ç©ºé—´ï¼ŒåŒæ—¶è®¾ç½®ä¿æŠ¤æ ‡å¿—

    ```js
    Load command 1
          cmd LC_SEGMENT_64		// æŒ‡å®šåŠ è½½å‘½ä»¤çš„ç±»å‹æ˜¯ LC_SEGMENT_64ï¼Œè¿™ä»£è¡¨ä¸€ä¸ª 64 ä½çš„å†…å­˜æ®µå‘½ä»¤ã€‚
      cmdsize 792							// è¡¨ç¤ºè¿™ä¸ªåŠ è½½å‘½ä»¤çš„æ€»å¤§å°æ˜¯ 792 å­—èŠ‚ã€‚
      segname __TEXT					// æ®µåç§°ï¼Œè¿™é‡Œæ˜¯ __TEXT æ®µï¼Œé€šå¸¸åŒ…å«ç¨‹åºçš„æŒ‡ä»¤å’Œåªè¯»æ•°æ®ã€‚
       vmaddr 0x0000000100000000	// æŒ‡å®šäº†è¯¥æ®µåœ¨å†…å­˜ä¸­çš„è™šæ‹Ÿåœ°å€
       vmsize 0x0000000000004000	// å®šä¹‰äº†è¯¥æ®µåœ¨å†…å­˜ä¸­çš„å¤§å°ï¼Œè¿™é‡Œæ˜¯ 16 KiBï¼ˆ4000 åå…­è¿›åˆ¶è½¬æ¢ä¸ºåè¿›åˆ¶æ˜¯ 16384ï¼‰ã€‚
      fileoff 0										//  è¡¨ç¤ºè¯¥æ®µåœ¨æ–‡ä»¶ä¸­çš„åç§»é‡ï¼Œè¿™é‡Œæ˜¯æ–‡ä»¶çš„èµ·å§‹ä½ç½®
     filesize 16384								// è¡¨ç¤ºè¯¥æ®µåœ¨æ–‡ä»¶ä¸­çš„å®é™…å¤§å°ï¼Œä»¥å­—èŠ‚ä¸ºå•ä½
      maxprot r-x									// å®šä¹‰äº†è¯¥æ®µï¼ˆä»£ç æ®µï¼‰çš„æœ€å¤§ä¿æŠ¤çº§åˆ«ï¼Œè¿™é‡Œæ˜¯ r-xï¼ˆè¯»å’Œæ‰§è¡Œï¼‰ï¼Œè¡¨ç¤ºè¯¥æ®µå¯ä»¥è¢«è¯»å–å’Œæ‰§è¡Œï¼Œä½†ä¸èƒ½å†™å…¥ã€‚å¦‚æœæ˜¯æ•°æ®æ®µï¼Œåˆ™å¯è¯»å¯å†™ rw-
     initprot r-x									// å®šä¹‰äº†è¯¥æ®µåœ¨åŠ è½½åˆ°å†…å­˜æ—¶çš„åˆå§‹ä¿æŠ¤çº§åˆ«ï¼Œä¸æœ€å¤§ä¿æŠ¤çº§åˆ«ç›¸åŒ
       nsects 9										// è¡¨ç¤ºè¯¥æ®µåŒ…å«çš„èŠ‚ï¼ˆsectionsï¼‰æ•°é‡ï¼Œè¿™é‡Œæ˜¯ 9 ä¸ª
        flags (none)							// è¯¥æ®µæ²¡æœ‰è®¾ç½®ä»»ä½•ç‰¹æ®Šæ ‡å¿—
    ```

    

- **ç¬¦å·æŸ¥æ‰¾å’Œç»‘å®š**ï¼šè¿›è¡Œç¬¦å·æŸ¥æ‰¾ï¼Œå¤„ç†ç¨‹åºä¸­çš„ç¬¦å·å¼•ç”¨ï¼Œå¹¶è¿›è¡Œç¬¦å·ç»‘å®šï¼Œç¡®ä¿æ‰€æœ‰çš„å‡½æ•°è°ƒç”¨å’Œå…¨å±€å˜é‡å¼•ç”¨éƒ½èƒ½æ­£ç¡®åœ°æŒ‡å‘å®ƒä»¬çš„å®ç°

- **rebase æ“ä½œ**ï¼šç”±äº ASLRï¼ˆåœ°å€ç©ºé—´å¸ƒå±€éšæœºåŒ–ï¼‰çš„éœ€è¦ï¼Œdyld ä¼šå¯¹ Mach-O æ–‡ä»¶è¿›è¡Œ rebase æ“ä½œï¼Œè°ƒæ•´ä»£ç å’Œæ•°æ®çš„åœ°å€ä»¥é€‚åº”éšæœºåŒ–çš„å†…å­˜å¸ƒå±€

- **åˆå§‹åŒ–ç¨‹åºæ‰§è¡Œ**ï¼šåœ¨é“¾æ¥æ“ä½œå®Œæˆåï¼Œdyld ä¼šæ‰§è¡Œåˆå§‹åŒ–ç¨‹åºï¼ŒåŒ…æ‹¬ Objective-C çš„ `+load` æ–¹æ³•å’Œ C çš„æ„é€ å‡½æ•°ï¼Œä»¥åˆå§‹åŒ–é™æ€å˜é‡

- **main å‡½æ•°è°ƒç”¨**ï¼šæœ€åï¼Œdyld è¯»å– Mach-O æ–‡ä»¶çš„ `LC_MAIN` å‘½ä»¤ï¼Œè·å–ç¨‹åºçš„å…¥å£åœ°å€ï¼Œå¹¶è°ƒç”¨  `main` å‡½æ•°ï¼Œå¯åŠ¨åº”ç”¨ç¨‹åºçš„ä¸»æ‰§è¡Œæµç¨‹

- **dyld 3 çš„ä¼˜åŒ–**ï¼šä» iOS 11 å¼€å§‹ï¼Œå¼•å…¥äº† dyld 3ï¼Œå®ƒé€šè¿‡è¿›ç¨‹å¤–çš„ Mach-O åˆ†æå™¨/ç¼–è¯‘å™¨ä»¥åŠè¿›ç¨‹å†…çš„æ‰§è¡Œå¼•æ“ï¼Œå°†è®¸å¤šè€—æ—¶çš„æ“ä½œæå‰å¤„ç†å¥½ï¼Œå¹¶ç¼“å­˜ç»“æœï¼Œä»è€Œæå¤§æå‡äº†å¯åŠ¨é€Ÿåº¦



### dyld åˆ°åº•åšäº†ä»€ä¹ˆ

1. æ‰§è¡Œè‡ªèº«åˆå§‹åŒ–é…ç½®åŠ è½½ç¯å¢ƒã€‚ `LC_DYLD_INFO_ONLY`

   ```shell
   Load command 4
               cmd LC_DYLD_INFO_ONLY	// è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªåªåŒ…å« dyld ä¿¡æ¯çš„åŠ è½½å‘½ä»¤ï¼Œå®ƒé€šå¸¸ä¸åŒ…å«å®é™…çš„ rebaseã€bind ç­‰ä¿¡æ¯ï¼Œè€Œæ˜¯æä¾›ç»™ dyld ç”¨äºä¼˜åŒ–é“¾æ¥è¿‡ç¨‹çš„ä¿¡æ¯
           cmdsize 48	// è¿™ä¸ªå‘½ä»¤çš„æ€»å¤§å°æ˜¯ 48 å­—èŠ‚
        rebase_off 0		// æŒ‡ç¤º rebase ä¿¡æ¯åœ¨æ–‡ä»¶ä¸­çš„ä½ç½®
       rebase_size 0		// æŒ‡ç¤º rebase ä¿¡æ¯åœ¨æ–‡ä»¶ä¸­çš„å¤§å°
          bind_off 0		// æŒ‡ç¤º bind ä¿¡æ¯çš„ä½ç½®
         bind_size 0		// æŒ‡ç¤º bind ä¿¡æ¯çš„å¤§å°	
     weak_bind_off 0		// æŒ‡ç¤ºå¼±ç»‘å®šä¿¡æ¯çš„ä½ç½®
    weak_bind_size 0		// æŒ‡ç¤ºå¼±ç»‘å®šä¿¡æ¯çš„å¤§å°
     lazy_bind_off 0		// æŒ‡ç¤ºå»¶è¿Ÿç»‘å®šä¿¡æ¯çš„ä½ç½®
    lazy_bind_size 0		// æŒ‡ç¤ºå»¶è¿Ÿç»‘å®šä¿¡æ¯çš„å¤§å°
        export_off 32768	// å¯¼å‡ºè¡¨ï¼ˆexport tableï¼‰çš„ä½ç½®
       export_size 48		// å¯¼å‡ºè¡¨ï¼ˆexport tableï¼‰çš„å¤§å°
   ```

2. åŠ è½½å½“å‰ç¨‹åºé“¾æ¥çš„æ‰€æœ‰åŠ¨æ€åº“åˆ°æŒ‡å®šçš„å†…å­˜ä¸­ã€‚`LC_LOAD_DYLIB`

   ```shell
   Load command 12
             cmd LC_LOAD_DYLIB	//  æŒ‡æ˜äº† load command çš„ç±»å‹æ˜¯ LC_LOAD_DYLIBï¼Œæ„å‘³ç€æ¥ä¸‹æ¥çš„ä¿¡æ¯æ˜¯å…³äºåŠ è½½ä¸€ä¸ªåŠ¨æ€åº“çš„
         cmdsize 56						// è¿™ä¸ªå‘½ä»¤çš„æ€»å¤§å°æ˜¯56å­—èŠ‚
            name /usr/lib/libSystem.B.dylib (offset 24)	// æŒ‡å®šäº†è¦åŠ è½½çš„åŠ¨æ€åº“çš„è·¯å¾„å’Œæ–‡ä»¶åã€‚è¿™é‡Œæ˜¯ libSystem.B.dylibï¼Œä½äº /usr/lib/ ç›®å½•ä¸‹ã€‚(offset 24) è¡¨ç¤ºæ–‡ä»¶ååœ¨å‘½ä»¤æ•°æ®ä¸­çš„åç§»é‡
      time stamp 2 Thu Jan  1 08:00:02 1970	// è¿™æ˜¯åŠ¨æ€åº“çš„æ—¶é—´æˆ³ï¼Œç”¨äºç‰ˆæœ¬æ£€æŸ¥ã€‚ä¸è¿‡ï¼Œè¿™ä¸ªæ—¶é—´æˆ³é€šå¸¸æ˜¯0æˆ–ä¸€ä¸ªå›ºå®šå€¼ï¼Œå› ä¸ºç³»ç»Ÿåº“çš„åŠ è½½ä¸ä¾èµ–äºæ—¶é—´æˆ³
         current version 1319.0.0	// è¿™æ˜¯åŠ¨æ€åº“çš„å½“å‰ç‰ˆæœ¬å·ï¼Œç”¨äºç¡®ä¿åº”ç”¨ç¨‹åºåŠ è½½çš„æ˜¯å…¼å®¹çš„ç‰ˆæœ¬
   compatibility version 1.0.0			//  è¿™æ˜¯åŠ¨æ€åº“çš„å…¼å®¹ç‰ˆæœ¬å·ï¼Œè¡¨æ˜åº”ç”¨ç¨‹åºè‡³å°‘éœ€è¦è¿™ä¸ªç‰ˆæœ¬çš„åº“æ‰èƒ½æ­£å¸¸è¿è¡Œ
   ```

3. æœç´¢æ‰€æœ‰åŠ¨æ€åº“ï¼Œç»‘å®šéœ€è¦åœ¨è°ƒç”¨ç¨‹åºä¹‹å‰ç”¨çš„ç¬¦å·ï¼ˆéæ‡’åŠ è½½ç¬¦å·ï¼‰ã€‚`LC_DYSYMTAB`

4. åœ¨  indirect symbol table ä¸­ï¼Œå°†éœ€è¦ç»‘å®šçš„å¯¼å…¥ç¬¦å·çœŸå®åœ°å€æ›¿æ¢ã€‚`LC_DYSYMTAB`

   Todoï¼šfishhook åŸç†

5. å‘ç¨‹åºæä¾› Runtime è¿è¡Œæ—¶ä½¿ç”¨ dyld çš„æ¥å£ï¼ˆå­˜åœ¨äº libdyld .dylib ä¸­ï¼Œç”± `LC_LOAD_DYLIB` æä¾›ï¼‰

6. é…ç½® Runtimeï¼Œæ‰§è¡Œæ‰€æœ‰åŠ¨æ€åº“/image ä¸­ä½¿ç”¨çš„å…¨å±€æ„é€ å‡½æ•°

7. dyld è°ƒç”¨ç¨‹åºå…¥å£å‡½æ•°ï¼Œå¼€å§‹æ‰§è¡Œç¨‹åºã€‚`LC_MAIN`

   ```
   Load command 11
          cmd LC_MAIN	// é‡Œçš„ cmd æŒ‡æ˜äº†åŠ è½½å‘½ä»¤çš„ç±»å‹æ˜¯ LC_MAINï¼Œè¿™ä¸ªå‘½ä»¤ç”¨äºæŒ‡å®šç¨‹åºçš„ä¸»å…¥å£ç‚¹
      cmdsize 24	// è¿™ä¸ªå‘½ä»¤çš„å¤§å°æ˜¯24å­—èŠ‚ï¼Œè¿™æ˜¯å‘½ä»¤å¤´åŠ ä¸Šä»»ä½•å°¾éƒ¨æ•°æ®çš„æ€»å’Œ
     entryoff 16288	// æŒ‡å®šäº†ç¨‹åºå…¥å£ç‚¹çš„åç§»é‡ï¼Œå®ƒæ˜¯ç›¸å¯¹äºæ–‡ä»¶çš„å¼€å§‹ä½ç½®çš„ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œå…¥å£ç‚¹ä½äºæ–‡ä»¶å¼€å¤´çš„ç¬¬ 16288 å­—èŠ‚å¤„ã€‚å…¥å£ç‚¹é€šå¸¸æ˜¯ main å‡½æ•°çš„åœ°å€
    stacksize 0 // è¿™ä¸ªå­—æ®µæŒ‡å®šäº†ä¸ºç¨‹åºçš„ä¸»çº¿ç¨‹åˆå§‹æ ˆåˆ†é…çš„å¤§å°ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæ ˆå¤§å°è¢«è®¾ç½®ä¸º0ï¼Œè¿™å¯èƒ½æ„å‘³ç€æ ˆçš„å¤§å°å°†ä½¿ç”¨é»˜è®¤å€¼ï¼Œæˆ–è€…åœ¨å…¶ä»–åœ°æ–¹æŒ‡å®šï¼ˆä¾‹å¦‚ï¼Œé€šè¿‡é“¾æ¥å™¨çš„å…¶ä»–è®¾ç½®æˆ–å‘½ä»¤è¡Œé€‰é¡¹ï¼‰
   ```

   <img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/MachOMainEntryPoint.png" style="zoom:30%" />

   

### dyld åŠ è½½è¿‡ç¨‹

<img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/dyldFullProcess.png" style="zoom:40%" />



- è°ƒâ½¤ `fork `å‡½æ•°ï¼Œåˆ›å»ºâ¼€ä¸ªè¿›ç¨‹

- è°ƒâ½¤ `execve` æˆ–å…¶è¡â½£å‡½æ•°ï¼Œåœ¨è¯¥è¿›ç¨‹ä¸ŠåŠ è½½ï¼Œæ‰§â¾ `Mach-O`â½‚ä»¶

- å°† `Mach-O` â½‚ä»¶åŠ è½½åˆ°å†…å­˜

- å¼€å§‹åˆ†æ `Mach-O` ä¸­çš„ `mach_header`ï¼Œä»¥ç¡®è®¤å®ƒæ˜¯æœ‰æ•ˆçš„ `Mach-O` â½‚ä»¶

- éªŒè¯é€šè¿‡ï¼Œæ ¹æ® `mach_header `è§£æ `load commands`ã€‚æ ¹æ®è§£æç»“æœï¼Œå°†ç¨‹åºå„ä¸ªéƒ¨åˆ†åŠ è½½åˆ°æŒ‡å®šçš„åœ°å€ç©ºé—´ï¼ŒåŒæ—¶è®¾ç½®ä¿æŠ¤æ ‡è®°

- ä» `LC_LOAD_DYLINKEN`ä¸­åŠ è½½ `dyld`

- `dyld`å¼€å§‹â¼¯ä½œ

- è°ƒç”¨ `__dyld_start()` å‡½æ•°ï¼Œé€šçŸ¥ `dyld` å¼€å§‹å·¥ä½œ

- è°ƒç”¨ `dyldbootstrap::start` å‡½æ•°ï¼Œä½¿ `dyld` â¾ƒèº«è¿›â¼Šå¯è¿â¾çŠ¶æ€

- è°ƒç”¨ `dyld::_main` å‡½æ•°ï¼Œ`dyld `çš„å…¥å£å‡½æ•°

- æ£€æŸ¥å…±äº«ç¼“å­˜ä¸­çš„ç¼“å­˜ï¼Œå¦‚æœæ‰¾åˆ°ç›´æ¥è¿”å›ï¼ˆçº¢çº¿é€»è¾‘ï¼‰ï¼Œå¦åˆ™ç»§ç»­åé¢çš„æµç¨‹

- å…±äº«ç¼“å­˜ä¸­æ²¡æœ‰æ‰¾åˆ°ï¼Œåˆ™ç»§ç»­ä¸‹é¢æµç¨‹

- åŠ è½½æ‰€æœ‰æ‰‹åŠ¨æ’å…¥çš„åŠ¨æ€åº“

- é“¾æ¥ç¨‹åºéœ€è¦çš„åŠ¨æ€åº“

- é“¾æ¥æ’å…¥çš„åº“

- åº”ç”¨æ’å…¥å‡½æ•°

- ç»‘å®šç¬¦å·

- è°ƒç”¨  `instantiateMainExecutable` ï¼Œä¸ºä¸»å¯æ‰§è¡Œæ–‡ä»¶åˆ›å»ºé•œåƒ

- è°ƒç”¨å½“å‰ç¨‹åºä¸åŠ¨æ€åº“çš„åˆå§‹åŒ–æ„é€ å‡½æ•°ï¼ˆ`__attribute__((constructor))`ï¼‰

- é€šè¿‡ `LC_MAIN` æŸ¥æ‰¾è®¾ç½®ç¨‹åºâ¼Šâ¼å‡½æ•°ï¼Œå°†èƒ¶â½”åœ°å€è®¾ç½®æˆâ¼Šâ¼å‡½æ•°åœ°å€ï¼Œå¦åˆ™èƒ¶â½”åœ°å€ä¸º0

- æä¾›èƒ¶æ°´åœ°å€ï¼Œè¿”å›åˆ° `dyld::_main` å‡½æ•°ä¸­ç»§ç»­æ‰§è¡Œ

- é€šè¿‡ `dyld::_main`â†’`dyldbootstrap::start`â†’`__dyld_start()`ï¼Œdyld  é…ç½®å®Œæˆï¼ŒæŠŠæ§åˆ¶æƒäº¤ç»™å¯æ‰§â¾â½‚ä»¶çš„â¼Šâ¼å‡½æ•°`main()`ï¼Œç»§ç»­åé¢çš„æµç¨‹

  

### dyld åº”ç”¨

çª¥æ¢ç³»ç»Ÿåº“åº•å±‚å®ç°çš„æ—¶å€™å¯èƒ½éœ€è¦ä»åŠ¨æ€åº“å…±äº«ç¼“å­˜ä¸­æå–å‡ºæŸä¸ª Frameworkï¼Œæ¯”å¦‚ UIKitã€‚è¿™æ—¶å€™è¦ä¹ˆç”¨ç¬¬ä¸‰æ–¹å·¥å…·ï¼Œè¦ä¹ˆç”¨ dyld çš„èƒ½åŠ›ã€‚

æŸ¥çœ‹ `dsc_extractor.cpp` ä»£ç å¯ä»¥çœ‹åˆ°æ˜¯å…·å¤‡æŠ½å–èƒ½åŠ›çš„ã€‚ä¿®æ”¹æºç ï¼Œå°† if å®å®šä¹‰å»æ‰ã€‚å¦‚ä¸‹

```c
#include <stdio.h>
#include <stddef.h>
#include <dlfcn.h>


typedef int (*extractor_proc)(const char* shared_cache_file_path, const char* extraction_root_path,
                              void (^progress)(unsigned current, unsigned total));

int main(int argc, const char* argv[])
{
    if ( argc != 3 ) {
        fprintf(stderr, "usage: dsc_extractor <path-to-cache-file> <path-to-device-dir>\n");
        return 1;
    }

    //void* handle = dlopen("/Volumes/my/src/dyld/build/Debug/dsc_extractor.bundle", RTLD_LAZY);
    void* handle = dlopen("/Applications/Xcode.app/Contents/Developer/Platforms/iPhoneOS.platform/usr/lib/dsc_extractor.bundle", RTLD_LAZY);
    if ( handle == NULL ) {
        fprintf(stderr, "dsc_extractor.bundle could not be loaded\n");
        return 1;
    }

    extractor_proc proc = (extractor_proc)dlsym(handle, "dyld_shared_cache_extract_dylibs_progress");
    if ( proc == NULL ) {
        fprintf(stderr, "dsc_extractor.bundle did not have dyld_shared_cache_extract_dylibs_progress symbol\n");
        return 1;
    }

    int result = (*proc)(argv[1], argv[2], ^(unsigned c, unsigned total) { printf("%d/%d\n", c, total); } );
    fprintf(stderr, "dyld_shared_cache_extract_dylibs_progress() => %d\n", result);
    return 0;
}
```

ç„¶åç”¨ clang++ ç¼–è¯‘ï¼Œå‘½ä»¤ä¸º `clang++ dsc_extractor.cpp`

å°†ç¼–è¯‘åçš„äº§ç‰©å¤åˆ¶åˆ°åŠ¨æ€åº“å…±äº«ç¼“å­˜ç›®å½•ä¸‹å»ã€‚ç„¶åæ‰§è¡Œå‘½ä»¤`./dsc_extractor dyld_shared_cache_armv7s armv7s`ï¼Œä»£è¡¨å°†åŠ¨æ€åº“æå–åˆ° armv7s ç›®å½•ä¸‹ã€‚



dyld æœ¬èº«å°±æ˜¯ä¸€ç§ MachO æ–‡ä»¶ï¼ŒMachO æ–‡ä»¶ç±»å‹ä¸º7ï¼Œæ˜¯ä¸€ç§åŒ…å«å¤šç§æ¶æ„çš„ç»“æ„ï¼Œå¦‚ä¸‹å›¾ï¼š

<img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/DyldStructure.png" style="zoom:25%">

å¯ä»¥åŠ è½½ä»¥ä¸‹ç±»å‹çš„ Mach-O æ–‡ä»¶ï¼šMH_EXECUTEã€MH_DYLIBã€MH_BUNDLE



#### æ’å…¥åŠ¨æ€åº“

å·¥ä½œåŸç†ï¼šä½¿ç”¨ `__attribute__((constructor))` æ˜¯ GCC å’Œ Clang ç¼–è¯‘å™¨æ”¯æŒçš„ä¸€ä¸ªå±æ€§ï¼Œç”¨äºæ ‡è®°ä¸€ä¸ªå‡½æ•°ä¸ºæ„é€ å‡½æ•°ï¼Œè¯¥å‡½æ•°ä¼šåœ¨ç¨‹åºåŠ è½½åŠ¨æ€åº“æ—¶è‡ªåŠ¨æ‰§è¡Œã€‚

åŠ¨æ€åº“çš„åŠ è½½è¿‡ç¨‹é€šå¸¸æ˜¯åœ¨ç¨‹åºå¯åŠ¨æ—¶è¿›è¡Œçš„ï¼Œå› æ­¤ `__attribute__((constructor))` å±æ€§æ ‡è®°çš„å‡½æ•°ä¼šåœ¨ `main` å‡½æ•°æ‰§è¡Œä¹‹å‰è¢«è°ƒç”¨ã€‚



ç¬¬ä¸€æ­¥ï¼šåˆ›å»º `Inject` åŠ¨æ€åº“ï¼Œæ–°å»º `Inject.m` æ–‡ä»¶

```c++
#import <Foundation/Foundation.h>

__attribute__((constructor))
static void customConstructor(int argc, const char **argv) {
    NSLog(@"Helloï¼ŒI am an injected dynamic library!");
}
```

ç¬¬äºŒæ­¥ï¼šåˆ›å»º iOS App æµ‹è¯•å·¥ç¨‹ï¼Œæ¥å…¥ Inject åŠ¨æ€åº“ã€‚å°† `Inject.framework` é‡Œçš„åŠ¨æ€åº“æ‹–åˆ° App å·¥ç¨‹æ ¹ç›®å½•ã€‚

ç¬¬ä¸‰æ­¥ï¼šEdit scheme -> Run -> Environment Variablesã€‚Name ä¸º `DYLD_INSERT_LIBRARIES`ï¼Œvalue ä¸º InjectFunction åŠ¨æ€åº“è·¯å¾„ï¼Œ`${SRCROOT}/Inject`ã€‚

<img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/InjectDylibIntoAppUseDyld.png" style="zoom:30%" />

ç¬¬å››æ­¥ï¼šè¿è¡Œè¾“å‡ºå¦‚ä¸‹

<img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/dyldInsetDylibResult.png" style="zoom:30%" />

å…·ä½“ [Demo]()



#### å‡½æ•°æ›¿æ¢

å·¥ä½œåŸç†ï¼š

åœ¨ iOS ä¸­ï¼Œ`__DATA, __interpose` æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„ Mach-O æ®µï¼Œç”¨äºå®ç°å‡½æ•°æ’æ¡© (Function Interposing)ã€‚å®ƒå…è®¸ä½ åœ¨ä¸ä¿®æ”¹åŸå§‹åº“ä»£ç çš„æƒ…å†µä¸‹ï¼Œæ‹¦æˆªå¹¶æ›¿æ¢åº“ä¸­çš„æŸä¸ªå‡½æ•°

**`__attribute__((used)) static struct { ... } ... __attribute__ ((section("__DATA, __interpose"))) = { ... };`** å®šä¹‰ä¸€ä¸ªç»“æ„ä½“ï¼Œå®ƒåŒ…å«ä¸¤ä¸ªæŒ‡å‘å‡½æ•°çš„æŒ‡é’ˆï¼š`replacement` å’Œ `replacee`ã€‚ç»“æ„ä½“ä½¿ç”¨ `__attribute__((used))` å±æ€§æ ‡è®°ï¼Œä»¥é¿å…ç¼–è¯‘å™¨å°†å…¶ä¼˜åŒ–æ‰ã€‚åŒæ—¶ï¼Œå®ƒè¢«æ”¾ç½®åœ¨ `__DATA, __interpose` æ®µï¼Œè¿™ä¸ªæ®µæ˜¯ä¸“é—¨ä¸ºå‡½æ•°æ’æ¡©è€Œè®¾è®¡çš„ã€‚



å‚è€ƒ [dyld::dyld-interposing.h](https://opensource.apple.com/source/dyld/dyld-210.2.3/include/mach-o/dyld-interposing.h)

ç¬¬ä¸€æ­¥ï¼šåˆ›å»º `InjectFunction` åŠ¨æ€åº“ï¼Œæ–°å»º `InjectFunction.m` æ–‡ä»¶

```c++
#import <Foundation/Foundation.h>
#define INTERPOSE(_replacement, _replacee) \
   __attribute__((used)) static struct { \
       const void* replacement; \
       const void* replacee; \
   } _interpose_##_replacee __attribute__ ((section("__DATA, __interpose"))) = { \
       (const void*) (unsigned long) &_replacement, \
       (const void*) (unsigned long) &_replacee \
   };

void my_NSLog(NSString *format, ...) {
   NSLog(@"Injected Function ---> %@", format);
}
INTERPOSE(my_NSLog, NSLog);
```

ç¬¬äºŒæ­¥ï¼šåˆ›å»º iOS App æµ‹è¯•å·¥ç¨‹ï¼Œæ¥å…¥ InjectFunction åŠ¨æ€åº“ã€‚å°† `InjectFunction.framework` é‡Œçš„åŠ¨æ€åº“æ‰˜åˆ° App å·¥ç¨‹æ ¹ç›®å½•ã€‚

ç¬¬ä¸‰æ­¥ï¼šEdit scheme -> Run -> Environment Variablesã€‚Name ä¸º `DYLD_INSERT_LIBRARIES`ï¼Œvalue ä¸º InjectFunction åŠ¨æ€åº“è·¯å¾„ï¼Œå½“æœ‰å¤šä¸ªåŠ¨æ€åº“çš„æ—¶å€™ï¼Œä¸­é—´ç”¨ `:` æŠŠè·¯å¾„éš”å¼€ã€‚`${SRCROOT}/Inject:${SRCROOT}/InjectFunction`ã€‚

ç¬¬å››æ­¥ï¼šè¿è¡Œè¾“å‡ºã€‚å‘ç° NSLog ç¡®å®è¢« hook åšäº†æ›¿æ¢ã€‚

<img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/dyldFunctionHookResult.png" style="zoom:30%" />



åº”ç”¨åœºæ™¯ï¼šä¸èƒ½ä¸Šæ¶ï¼Œä½†å¯ä»¥å»åšæ¢ç´¢ã€éªŒè¯æºç ç­‰åœºæ™¯ã€‚



### è°ƒè¯• dyld

ä¸€ç§æ˜¯æ›¿æ¢ç³»ç»Ÿçš„ dyldï¼Œé£é™©å¤§ï¼Œéœ€è¦æ„ŸçŸ¥æºç ã€‚æ¨èä½¿ç”¨ dyld æä¾›çš„ç¯å¢ƒå˜é‡æ¥æ§åˆ¶ dyld åœ¨è¿è¡Œè¿‡ç¨‹ä¸­è¾“å‡ºæ„Ÿå…´è¶£çš„ä¿¡æ¯ã€‚

- `DYLD_PRINT_APIS`ï¼š æ‰“å° dyld å†…å‡ ä¹æ‰€æœ‰å‘ç”Ÿçš„è°ƒç”¨
- `DYLD_PRINT_LIBRARIES` ï¼šæ‰“å°åœ¨åº”ç”¨ç¨‹åºå¯åŠ¨æœŸé—´æ­£åœ¨åŠ è½½çš„æ‰€æœ‰åŠ¨æ€åº“
- `DYLD_PRINT_WARNINGS`ï¼šæ‰“å° dyld è¿è¡Œè¿‡ç¨‹ä¸­çš„è¾…åŠ©ä¿¡æ¯
- `DYLD_PATH`ï¼šæ˜¾ç¤º dyld æœç´¢åŠ¨æ€åº“çš„ç›®å½•é¡ºåº
- `DYLD_PRINT_ENV`ï¼šæ˜¾ç¤º dyld åˆå§‹åŒ–çš„ç¯å¢ƒå˜é‡
- `DLYD_PRINT_SEGMENTS`ï¼šæ‰“å°å½“å‰ç¨‹åºçš„ segment ä¿¡æ¯
- `DYLD_PRINT_STATISTICS`ï¼šæ‰“å° pre-main è€—æ—¶
- `DYLD_PRINT_INITIALIZERS`ï¼šä¼šåœ¨æ‰§è¡Œæ¯ä¸ªé•œåƒï¼ˆimageï¼‰çš„åˆå§‹åŒ–å™¨ï¼ˆinitializerï¼‰æ—¶æ‰“å°å‡ºä¸€è¡Œä¿¡æ¯ã€‚è¿™äº›åˆå§‹åŒ–å™¨åŒ…æ‹¬ C++ çš„é™æ€æ„é€ å‡½æ•°ä»¥åŠä½¿ç”¨ `__attribute__((constructor))` æ ‡è®°çš„å‡½æ•°ã€‚è¿™ä¸ªç¯å¢ƒå˜é‡å¯¹äºè°ƒè¯•å’Œåˆ†æç¨‹åºå¯åŠ¨æ—¶çš„åˆå§‹åŒ–é¡ºåºå’Œè¡Œä¸ºéå¸¸æœ‰ç”¨ã€‚

æ€ä¹ˆç”¨ï¼Ÿ

`ç¯å¢ƒå˜é‡=1 ./å¯æ‰§è¡Œæ–‡ä»¶`

<img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/dyldEnvUsage.png" style="zoom:30%" />



å¦ä¸€ç§æ–¹å¼æ˜¯åˆ©ç”¨ Xcode -> Edit Schemeï¼Œå¢åŠ æˆ–ä¿®æ”¹ dyld ç¯å¢ƒå˜é‡

<img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/XcodeEditDyldEnvValue.png" style="zoom:30%" />





## Mach-O

Mach Object çš„ç¼©å†™ï¼Œæ˜¯ iOS/MacOS ä¸Šç”¨äºå­˜å‚¨ç¨‹åºã€åº“çš„æ ‡å‡†æ ¼å¼ã€‚

Mach-O æ ¼å¼â½¤æ¥æ›¿ä»£ BSD ç³»ç»Ÿçš„ `a.out` æ ¼å¼ã€‚Mach-O â½‚ä»¶æ ¼å¼ä¿å­˜äº†åœ¨ç¼–è¯‘è¿‡ç¨‹å’Œé“¾æ¥è¿‡ç¨‹ä¸­äº§â½£çš„æœºå™¨ä»£ç å’Œæ•°æ®ï¼Œä»â½½ä¸ºé™æ€é“¾æ¥å’ŒåŠ¨æ€é“¾æ¥çš„ä»£ç æä¾›äº†å•â¼€â½‚ä»¶æ ¼å¼ã€‚



åœ¨ XNU æºç ä¸­å¯ä»¥æŸ¥çœ‹ Mach-O çš„å®šä¹‰ã€‚`loader.h` 

å±äº Mach-O æ ¼å¼çš„æ–‡ä»¶ç±»å‹æœ‰ï¼š

```c
#define    MH_OBJECT    0x1        /* relocatable object file */
#define    MH_EXECUTE    0x2        /* demand paged executable file */
#define    MH_FVMLIB    0x3        /* fixed VM shared library file */
#define    MH_CORE        0x4        /* core file */
#define    MH_PRELOAD    0x5        /* preloaded executable file */
#define    MH_DYLIB    0x6        /* dynamically bound shared library */
#define    MH_DYLINKER    0x7        /* dynamic link editor */
#define    MH_BUNDLE    0x8        /* dynamically bound bundle file */
#define    MH_DYLIB_STUB    0x9        /* shared library stub for static */
                    /*  linking only, no section contents */
#define    MH_DSYM        0xa        /* companion file with only debug */
                    /*  sections */
#define    MH_KEXT_BUNDLE    0xb        /* x86_64 kexts */
```



### å¸¸è§çš„ Mach-O æ–‡ä»¶ç±»å‹

- MH_OBJECT
    - ç›®æ ‡æ–‡ä»¶ï¼ˆ.oï¼‰
    - é™æ€åº“æ–‡ä»¶ï¼ˆ.aï¼‰ï¼Œé™æ€åº“å…¶å®å°±æ˜¯ N ä¸ª `.o` åˆå¹¶åœ¨ä¸€èµ·

- MH_EXECUTEï¼šå¯æ‰§è¡Œæ–‡ä»¶

- MH_DYLIBï¼šåŠ¨æ€åº“æ–‡ä»¶
    - dylib
    - .framework
- MH_DYLINKERï¼šåŠ¨æ€é“¾æ¥å™¨ (/usr/lib/dyld)
- MH_DSYMï¼šå­˜å‚¨ç€äºŒè¿›åˆ¶æ–‡ä»¶ç¬¦å·ã€‚`.dSYM/Contents/Resource/DWARF/xx` å¸¸ç”¨äºè¿˜åŸå †æ ˆ

Xcode ä¸­ä¹Ÿå¯ä»¥æŸ¥çœ‹ Mach-O æ–‡ä»¶ç±»å‹

<img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/MachOFileType.png" style="zoom:25%">



æºä»£ç ï¼ˆæ¯”å¦‚cæ–‡ä»¶ï¼‰ï¼Œç¼–è¯‘å˜ä¸ºç›®æ ‡æ–‡ä»¶ï¼ˆæ¯”å¦‚.oæ–‡ä»¶ï¼‰ï¼Œå†ç»è¿‡é“¾æ¥å˜ä¸ºå¯æ‰§è¡Œæ–‡ä»¶ã€‚

Tipsï¼š`file` å‘½ä»¤å¯ä»¥æŸ¥çœ‹æ–‡ä»¶ç±»å‹ã€‚

<img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/FileCommandToWatchFileType.png" style="zoom:45%">

`find . -name "*.c"` æ¯”å¦‚åœ¨å½“å‰è·¯å¾„æŸ¥æ‰¾ .c æ–‡ä»¶



### Universal Binary

é€šç”¨äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå¯ä»¥åŒæ—¶é€‚ç”¨äºå¤šç§æ¶æ„çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼ŒåŒ…å«å¤šç§ä¸åŒæ¶æ„çš„ç‹¬ç«‹çš„äºŒè¿›åˆ¶æ–‡ä»¶ã€‚

- å› ä¸ºè¦å­˜å‚¨å¤šç§æ¶æ„çš„ä»£ç ï¼Œæ‰€ä»¥é€šç”¨äºŒè¿›åˆ¶æ–‡ä»¶é€šå¸¸æ¯”å•ä¸€å¹³å°çš„äºŒè¿›åˆ¶ç¨‹åºæ›´å¤§

- ç”±äºä¸¤ç§æ¶æ„æœ‰å…±åŒçš„ä¸€äº›èµ„æºï¼Œæ‰€ä»¥å¹¶ä¸ä¼šè¾¾åˆ°å•ä¸€ç‰ˆæœ¬çš„2å€å¤šã€‚

- æ‰§è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œåªè°ƒç”¨ä¸€éƒ¨åˆ†ä»£ç ï¼Œè¿è¡Œèµ·æ¥ä¸éœ€è¦é¢å¤–çš„å†…å­˜ã€‚

å› ä¸ºé€šç”¨äºŒè¿›åˆ¶æ–‡ä»¶æ¯”åŸæ¥çš„å¤§ï¼Œæ‰€ä»¥è¢«æˆä¸ºâ€œèƒ–äºŒè¿›åˆ¶æ–‡ä»¶â€ï¼ˆFat Binaryï¼‰ï¼Œä½¿ç”¨ Hopper æ‰“å¼€ä¼šæ˜¾ç¤º â€œFAT archiveâ€

ä¿¡æ¯æŸ¥çœ‹ï¼š

- æŸ¥çœ‹æŸå¯æ‰§è¡Œæ–‡ä»¶(Test)æ”¯æŒçš„æ¶æ„æŒ‡ä»¤é›† ï¼š`lipo -info Test`

- å°†æŸä¸ªæŒ‡ä»¤é›†æ‹†å‡ºæ¥æ¯”å¦‚ arm64ï¼š`lipo Test -thin arm64 -o Test_arm64`

- ä¹Ÿå¯ä»¥å°†å¤šä¸ªæŒ‡ä»¤é›†åˆå¹¶ï¼š`lipo -create Test_arm64 Test_armv7 -output Test_universal`

Xcode ä¸­å¯ä»¥ä¿®æ”¹æŒ‡ä»¤é›†ã€‚ç”± Build Settings çš„2ä¸ªé…ç½®å†³å®šï¼š `Architectures->Architectures` `User-Defined->VALID_ARCHS`ï¼Œå–2è€…çš„äº¤é›†ã€‚
å…¶ä¸­ `Architectures->Architectures` çš„å€¼ `$(ARCHS_STANDARD)` æ˜¯ Xcode å†…ç½®çš„ç¯å¢ƒå˜é‡ï¼Œä¸åŒç‰ˆæœ¬çš„ Xcode å€¼ä¸ä¸€æ ·ï¼Œæ˜¯é€šç”¨çš„ä¸€äº›æ¶æ„å€¼ã€‚æ¯”å¦‚ Xcode9ä¸‹ï¼Œ`$(ARCHS_STANDARD)` å¯èƒ½ä¸º arm64ã€armv7ã€‚Xcode 4ä¸‹ï¼Œ`$(ARCHS_STANDARD)` å¯èƒ½ä¸º armv7



### Mach-O ç»“æ„

<img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/Mach-OStructure.png" style="zoom:45%">

ä¸€ä¸ª Mach-O æ–‡ä»¶åŒ…å«3å—

- Headerï¼šæ–‡ä»¶ç±»å‹ã€ç›®æ ‡æ¶æ„ç±»å‹ä¿¡æ¯

- Load commandsï¼šæè¿°æ–‡ä»¶åœ¨è™šæ‹Ÿå†…å­˜ä¸­çš„é€»è¾‘ç»“æ„ã€å¸ƒå±€

- Raw segment dataï¼šåœ¨ Load Commands ä¸­å®šä¹‰çš„ segment çš„åŸå§‹æ•°æ®

å¯ä»¥ç”¨ [MachOView:](https://github.com/fangshufeng/MachOView) å’Œç³»ç»Ÿè‡ªå¸¦çš„ atool æŸ¥çœ‹ Mach-O ä¿¡æ¯

<img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/otoolhelp.png" style="zoom:25%">

æ¯”å¦‚æˆ‘ç”¨ otool æŸ¥çœ‹æˆ‘ç¼–å†™çš„ä¸€ä¸ª SwiftUIDemo æ‰€ä¾èµ–çš„å…±äº«ç¼“å­˜åº“

<img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/SwiftUIDemoDependencyLibrary.png" style="zoom:25%">

ç”¨ MachOView æŸ¥çœ‹ DDD Mach-O æ–‡ä»¶

<img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/MachOPageZero.png" style="zoom:35%">

<img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/MachOText.png" style="zoom:35%">

å¯ä»¥çœ‹åˆ°åœ¨ Mach-O  æ–‡ä»¶ä¸Šï¼Œ`__PAGEZERO` çš„  `VM Size`  æœ‰å€¼ï¼Œä½†æ˜¯ File Size ä¸º0ï¼Œä¹Ÿå°±æ˜¯è¯´ `__PAGEZERO` åœ¨ Mach-O ä¸­ä¸å æ®å†…å­˜ï¼Œä½†æ˜¯ç¨‹åºè¿è¡Œèµ·æ¥ä¹‹åï¼Œä¼šå æ®è™šæ‹Ÿå†…å­˜ã€‚æ‰€ä»¥ä»£ç æ®µåœ¨ Mach-O ä¸­ File Offset ä¸º0ï¼ˆå¦‚æœå‰é¢çš„ `__PAGEZERO` çš„ File size æœ‰å€¼ï¼Œè¿™é‡Œçš„ File Offset å°±ä¸ä¸º0ï¼‰ã€‚

**åœ¨æ²¡æœ‰ ASLR çš„æ—¶å€™ï¼š__TEXT ä»£ç æ®µåœ°å€ = __PAGEZEROR åœ°å€**



## Mach-O æ–‡ä»¶å¦‚ä½•æŸ¥æ‰¾åœ°å€

ç¬¬ä¸€æ­¥ï¼Œç¼–å†™ä¸€ä¸ªåä¸º `main.m` çš„ä»£ç 

```objective-c
void test1 () {}
void test2() {}
int globalValue;
int main () {
    globalValue = 21;
    globalValue = 20;
    test1();
    test2();
    return 0;
}
```

ç¬¬äºŒæ­¥ï¼Œå°†å…¶è½¬æ¢ä¸ºå¯æ‰§è¡Œæ–‡ä»¶ï¼ŒæŒ‡ä»¤ä¸º`clang main.m -o main` 

ç¬¬ä¸‰æ­¥ï¼Œåˆ†ææŸ¥çœ‹å¯æ‰§è¡Œæ–‡ä»¶ `objdump --macho -d main`

ç¬¬å››æ­¥ï¼Œå°†å…¶è½¬ä¸ºç›®æ ‡æ–‡ä»¶ï¼ŒæŒ‡ä»¤ä¸º `clang -c main.m -o main.o`

ç¬¬äº”æ­¥ï¼ŒæŸ¥çœ‹ç›®æ ‡æ–‡ä»¶æŒ‡ä»¤ä¿¡æ¯ `objdump --macho -d main.o`

<img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/MachOExploreInstruction.png" style="zoom:30%" />

åˆ†æä¸‹æŒ‡ä»¤ä¿¡æ¯ï¼š

- å¯ä»¥çœ‹åˆ°æºç ä¸­ä»ä¸Šåˆ°ä¸‹å£°æ˜çš„å‡½æ•°ï¼Œåœ¨ç›®æ ‡æ–‡ä»¶å’Œå¯æ‰§è¡Œæ–‡ä»¶ä¸­é¡ºåºæ˜¯ä¸€è‡´çš„

  - å¯æ‰§è¡Œæ–‡ä»¶ä¸­ï¼Œé¡ºåºä¹Ÿæ˜¯ä»ä¸Šåˆ°ä¸‹ï¼Œä¾æ¬¡æ‰§è¡Œçš„ã€‚å·¦ä¾§æ˜¯çœŸå®æŒ‡ä»¤åœ°å€
  - ç›®æ ‡æ–‡ä»¶ä¸­ï¼Œé¡ºåºä¹Ÿæ˜¯ä»ä¸Šå¤§ä¸‹ï¼Œä½†æ²¡æœ‰çœŸå®åœ°å€ï¼Œæ˜¯ç›¸å¯¹åœ°å€ï¼Œæ˜¯åç§»é‡ã€‚

- å¯ä»¥çœ‹åˆ°åƒå‡½æ•°è°ƒç”¨çš„é€»è¾‘ï¼Œæ˜¯ `	e8 00 00 00 00	callq	_test1`ï¼Œå…¶ä¸­ `e8` æ˜¯å›ºå®šæŒ‡ä»¤ï¼Œä»£è¡¨ `callq`ã€‚åé¢çš„ `00 00 00 00 ` æ˜¯ç›¸å¯¹åœ°å€ï¼Œtest1 çœŸæ­£çš„åœ°å€æ˜¯ `ä¸‹é¢ 4e` + `ä¸Šé¢ 00 00 00 00` çš„ç»“æœã€‚è¿™æ˜¯ä¸€ç§**è¿‘åœ°å€ç›¸å¯¹ä½ç§»æŠ€æœ¯**

- test1ã€test2 2ä¸ªå‡½æ•°éƒ½å­˜åœ¨ï¼Œåœ°å€ä¸ä¸€æ ·ï¼Œä¸ºä»€ä¹ˆéƒ½æ˜¯ `00 00 00 00 ` ï¼Ÿé‚£ç³»ç»Ÿå¦‚ä½•ç¡®å®šå‡½æ•°çœŸå®åœ°å€ï¼Ÿéœ€è¦æ‰¾ä¸ªåœ°æ–¹å°†è¿™äº›ç¬¦å·å­˜èµ·æ¥ï¼Œç„¶åå†æ‰¾ä¸ªæ—¶æœºå»æŠŠçœŸå®çš„åœ°å€å†™è¿›å»ã€‚éœ€è¦**é‡å®šä½ç¬¦å·è¡¨**ï¼Œå‘Šè¯‰é“¾æ¥å™¨åœ¨é“¾æ¥é˜¶æ®µéœ€è¦é‡å®šä½

  <img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/RelocationSymbolTableAndCodeInstructionMap.png" style="zoom:30%" />

  - ä½¿ç”¨ `objdump --macho --reloc main.o` æŒ‡ä»¤æŸ¥çœ‹ main.o çš„é‡å®šä½ç¬¦å·è¡¨ã€‚
  - ç¬¦å·è¡¨ä¸­ `test1` çš„åœ°å€å°±æ˜¯ `0000004a` å¯¹åº”çš„æ•°æ®ã€‚`49` åé¢å°±æ˜¯ `4a`
  - ç¬¦å·è¡¨ä¸­ `test2` çš„åœ°å€å°±æ˜¯ `0000004f` å¯¹åº”çš„æ•°æ®ã€‚`4e` åé¢å°±æ˜¯ `4f`
  - ç¬¦å·è¡¨ä¸­ `globalValue` çš„åœ°å€å°±æ˜¯ `0000003f` å¯¹åº”çš„æ•°æ®ï¼Œ`3c 3d 3e 3f`ï¼Œç»è¿‡ `48 8b 05` åˆ° `3f`



### å¦‚ä½•æ‰¾åˆ°å‡½æ•°çš„çœŸå®åœ°å€

ä»¥ test1 ä¸ºä¾‹ã€‚

```shell
100003f93:	c7 00 14 00 00 00	movl	$20, (%rax)
100003f99:	e8 b2 ff ff ff	callq	_test1
100003f9e:	e8 bd ff ff ff	callq	_test2
100003fa3:	31 c0	xorl	%eax, %eax
```

ç¬¬ä¸€æ­¥ï¼šæ ¹æ® B2 è®¡ç®—å¾—åˆ°åŸç ï¼Œç„¶åè®¡ç®—å‡ºåŸç ã€‚

iOS æ˜¯å°ç«¯åºï¼Œä»å³å‘å·¦çœ‹ï¼Œ`b2 ff ff ff` å¯ä»¥çœ‹åˆ°å4ä½æ˜¯ ffï¼Œæ‰€ä»¥æ˜¯ä¸€ä¸ªç»è¿‡è®¡ç®—åçš„è¡¥ç ä¿¡æ¯ã€‚æ‰€ä»¥éœ€è¦è®¡ç®—å¾—åˆ°åŸç ä¿¡æ¯ã€‚

è¡¥ç å¦‚ä½•åˆ°åŸç ï¼Ÿæ‰€æœ‰çš„1å–åï¼Œç„¶ååŠ 1ã€‚ç¬¬ä¸€æ­¥è®¡ç®—ç»“æœä¸º `0x4E`

ç¬¬äºŒæ­¥ï¼šæ ¹æ®è¿‘åœ°å€ç›¸å¯¹ä½ç§»æŠ€æœ¯ï¼Œ`ä¸‹ä¸€æ¡æŒ‡ä»¤åœ°å€+ b2 ff ff ff` å°±æ˜¯å‡½æ•° test1 çš„çœŸå®åœ°å€ã€‚ä½†æ˜¯ FF æ˜¯è´Ÿçš„ï¼Œæ‰€ä»¥ `0x100003f9e - 0x4E = 0x100003F50  `ï¼Œä¹Ÿå°±æ˜¯ Text æ®µä¸­ test1 çš„çœŸå®åœ°å€ã€‚

å®Œæ•´çš„

<img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/MachOCalcuateFunAddress.png" style="zoom:40%" />



### å¦‚ä½•æ‰¾åˆ°å…¨å±€å˜é‡åœ°å€

ç¬¬ä¸€æ­¥ï¼Œå…ˆç”¨æŒ‡ä»¤æŸ¥çœ‹å…¨å±€å˜é‡çš„åœ°å€å€¼ã€‚ `objdump --macho -s main`ï¼Œå¯ä»¥çœ‹åˆ°åœ°å€å€¼ä¸º `0x100008000` 

<img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/GlobalValueAddress.png" style="zoom:40%" />



ç¬¬äºŒæ­¥ï¼Œæ‰‹åŠ¨è®¡ç®—ã€‚æ ¹æ®è¿‘åœ°å€ç›¸å¯¹ä½ç§»æŠ€æœ¯åŸç†ï¼Œ`ä¸‹ä¸€æ¡æŒ‡ä»¤ + 0x407a` = `0x100003f86 +0x407a = 0x100008000`

å»æ‰æœ€å¼€å§‹çš„ `48 8d 05` ï¼ŒiOS å°ç«¯åºï¼Œæ‰€ä»¥æ˜¯ `0x407a`

```shell
100003f70:	55	pushq	%rbp
100003f71:	48 89 e5	movq	%rsp, %rbp
100003f74:	48 83 ec 10	subq	$16, %rsp
100003f78:	c7 45 fc 00 00 00 00	movl	$0, -4(%rbp)

100003f7f:	48 8d 05 7a 40 00 00	leaq	_globalValue(%rip), %rax
100003f86:	c7 00 15 00 00 00	movl	$21, (%rax)

100003f8c:	48 8d 05 6d 40 00 00	leaq	_globalValue(%rip), %rax
100003f93:	c7 00 14 00 00 00	movl	$20, (%rax)
```

å¯è§ `0x100008000` å’Œæ•°æ®æ®µçš„åœ°å€æ˜¯ä¸€æ ·çš„ã€‚

è‡³æ­¤ï¼Œå¯ä»¥äº†è§£åˆ° Mach-O æ–‡ä»¶æ˜¯æŒ‰ç…§ä¸åŒ Section å»åŠ è½½æ•°æ®ï¼Œè®¿é—®æ•°æ®çš„ã€‚ä½†ä¸åŒ Section æ˜¯è¯­ä¹‰ä¸Šæ›´æ–¹ä¾¿ç†è§£çš„ï¼Œç¨‹åºæ‰§è¡Œæœ€æœ¬è´¨çš„æ˜¯ï¼šä¸ç®¡å¤„äºä»€ä¹ˆ sectionï¼Œåªçœ‹åç§»é‡ã€‚



## .dSYM æ–‡ä»¶

### å®šä¹‰

`.dSYM` æ–‡ä»¶å°±æ˜¯ä¿å­˜ DWARF æ ¼å¼çš„è°ƒè¯•ä¿¡æ¯çš„æ–‡ä»¶ã€‚

`.DSYM` ï¼ˆdebugging symbolï¼‰æ–‡ä»¶æ˜¯ä¿å­˜åå…­è¿›åˆ¶å‡½æ•°åœ°å€æ˜ å°„ä¿¡æ¯çš„ä¸­è½¬æ–‡ä»¶ï¼Œè°ƒè¯•ä¿¡æ¯ï¼ˆsymbolsï¼‰éƒ½åŒ…å«åœ¨è¯¥æ–‡ä»¶ä¸­ã€‚Xcode å·¥ç¨‹æ¯æ¬¡ç¼–è¯‘è¿è¡Œéƒ½ä¼šç”Ÿæˆæ–°çš„ `.DSYM` æ–‡ä»¶ã€‚é»˜è®¤æƒ…å†µä¸‹ debug æ¨¡å¼æ—¶ä¸ç”Ÿæˆ `.DSYM` ï¼Œå¯ä»¥åœ¨ Build Settings -> Build Options -> Debug Information Format åå°†å€¼ `DWARF` ä¿®æ”¹ä¸º `DWARF with DSYM File`ï¼Œè¿™æ ·å†æ¬¡ç¼–è¯‘è¿è¡Œå°±å¯ä»¥ç”Ÿæˆ `.DSYM` æ–‡ä»¶ã€‚

DWARF æ˜¯è¢«ä¼—å¤šç¼–è¯‘å™¨å’Œè°ƒè¯•å™¨ä½¿ç”¨çš„ï¼Œç”¨äºæ”¯æŒæºç çº§åˆ«è°ƒè¯•çš„è°ƒè¯•æ–‡ä»¶æ ¼å¼ã€‚



### æ¢ç´¢

#### å¦‚ä½•ç”Ÿæˆ `.dSYM` æ–‡ä»¶

ç¬¬ä¸€æ­¥ï¼Œæ–°å»º `main.m` æ–‡ä»¶

ç¬¬äºŒæ­¥ï¼šXcode æ¯æ¬¡ç¼–è¯‘è¿è¡Œéƒ½ä¼šç”Ÿæˆæ–°çš„ `.DSYM` æ–‡ä»¶ã€‚ä½¿ç”¨ clang -g å‚æ•°ä¹Ÿå¯ä»¥ç”Ÿæˆï¼ŒæŒ‡ä»¤ä¸º `clang -g -c main.m -o main.o`

ç¬¬ä¸‰æ­¥ï¼šæŸ¥çœ‹ Mach-O ä¸­ï¼ŒåŒ…å« `__DWARF` çš„æ®µï¼Œä½¿ç”¨æŒ‡ä»¤ `objdump --macho --private-headers main.o`

<img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/MachOContainsDWARFSection.png" style="zoom:30%" />

ç¬¬å››æ­¥ï¼šç¼–è¯‘æˆå¯æ‰§è¡Œæ–‡ä»¶ï¼ŒæŒ‡ä»¤ä¸º `clang -g main.m -o main`

ç¬¬äº”æ­¥ï¼šæŸ¥çœ‹å¯æ‰§è¡Œæ–‡ä»¶ä¸­æ˜¯å¦åŒ…å« `__DWARF` æ®µã€‚`objdump --macho --private-headers main`

<img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/ExecutableFileDonotContainDWARF.png" style="zoom:30%" />

ç¬¬å…­æ­¥ï¼šæŸ¥çœ‹å¯æ‰§è¡Œæ–‡ä»¶çš„ç¬¦å·è¡¨ã€‚æŒ‡ä»¤ä¸ºï¼š`nm -pa main`ã€‚çº¢è‰²åŒºåŸŸä»£è¡¨è°ƒè¯•ç¬¦å·ã€‚

<img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/ExecuteFIleSymbolTable.png" style="zoom:30%" />





çœ‹åˆ°äº†è°ƒè¯•ç¬¦å·å’Œ DWARF ä¿¡æ¯ï¼Œé‚£å¦‚ä½•ç”Ÿæˆ .dSYM æ–‡ä»¶ï¼Ÿ

- æŒ‡ä»¤ `clang -g1 main.m -o main`ï¼Œå‚æ•° `-g1` ç”¨äºç”Ÿæˆ `.dSYM` æ–‡ä»¶ã€‚
- æŒ‡ä»¤ `dwarfdump main.dSYM` ç”¨äºæŸ¥çœ‹ `.dSYM` æ–‡ä»¶

<img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/GenerateDSYMAndDisplay.png" style="zoom:30%" />





- è¯»å– `debug map`
- ä» `.o` æ–‡ä»¶ä¸­åŠ è½½ DWARF
- é‡æ–°å®šä½æ‰€æœ‰åœ°å€
- æœ€åå°†å…¨éƒ¨çš„ DWARF æ‰“åŒ…æˆ `.dSYM` bundle



ç»“è®ºï¼š

ç¼–è¯‘å™¨ä¼šåœ¨ç¼–è¯‘é˜¶æ®µï¼ŒæŠŠè°ƒè¯•ä¿¡æ¯æ”¾åœ¨å•ç‹¬çš„ `__DWARF` æ®µä¸­ã€‚å½“å»é“¾æ¥çš„æ—¶å€™ï¼Œä¼šæŠŠ `__DWARF` æ®µåˆ æ‰ï¼ŒåŒæ—¶æŠŠæ‰€æœ‰çš„è°ƒè¯•ä¿¡æ¯æ”¾åœ¨ç¬¦å·è¡¨ä¸­ã€‚

æ‰“åŒ…ä¸Šçº¿çš„æ—¶å€™ä¼šæŠŠè°ƒè¯•ç¬¦å·ç­‰è£å‰ªæ‰ï¼Œä½†æ˜¯çº¿ä¸Šç»Ÿè®¡åˆ°çš„å †æ ˆæˆ‘ä»¬ä»ç„¶è¦èƒ½å¤ŸçŸ¥é“å¯¹åº”çš„æºä»£ç ï¼Œè¿™æ—¶å€™å°±éœ€è¦æŠŠç¬¦å·å†™åˆ°å¦å¤–ä¸€ä¸ªå•ç‹¬çš„æ–‡ä»¶é‡Œï¼Œè¿™ä¸ªæ–‡ä»¶å°±æ˜¯DSYMã€‚



#### .dSYM ç¬¦å·åŒ–

ç¬¬ä¸€æ­¥ï¼šæ–°å»º iOS é¡¹ç›®ï¼ŒBuidl Setting åˆ‡æ¢ä¸º `DWARF with dSYM File ` ã€‚è®¾ç½®æ¨¡æ‹Ÿ crashï¼ˆæ•°ç»„è¶Šç•Œï¼‰

ç¬¬äºŒæ­¥ï¼šMac è‡ªå¸¦ `console` App æŸ¥çœ‹å´©æºƒæŠ¥å‘Šï¼Œå› ä¸ºæœ‰ `.dSYM` æ–‡ä»¶ï¼Œæ‰€ä»¥å¯ä»¥çœ‹åˆ°æ–¹æ³•ä¿¡æ¯

<img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/ MockCrashAndDiaplayViaConsoleApp.png" style="zoom:30%" />



æ€è€ƒï¼šå‡è®¾çº¿ä¸Š crash äº†ï¼Œå¦‚ä½•æ ¹æ® crash å †æ ˆä¸­æ²¡æœ‰ç¬¦å·åŒ–çš„åœ°å€ï¼Œæ‰¾åˆ°ç¬¦å·çš„çœŸå®åœ°å€ï¼Ÿ

```shell
Last Exception Backtrace:
0   CoreFoundation                	    0x7ff80042889b __exceptionPreprocess + 226
1   libobjc.A.dylib               	    0x7ff80004dba3 objc_exception_throw + 48
2   CoreFoundation                	    0x7ff800304c83 -[__NSArray0 objectEnumerator] + 0
3   DSYMDemo                      	       0x1003f4f16 -[ViewController visitElement] + 54 (ViewController.m:26)
4   DSYMDemo                      	       0x1003f4e64 __29-[ViewController viewDidLoad]_block_invoke + 36 (ViewController.m:20)
5   libdispatch.dylib             	    0x7ff80013ca3a _dispatch_client_callout + 8
6   libdispatch.dylib             	    0x7ff80013fe87 _dispatch_continuation_pop + 715
7   libdispatch.dylib             	    0x7ff80015534a _dispatch_source_invoke + 2046
8   libdispatch.dylib             	    0x7ff80014c1e9 _dispatch_main_queue_drain + 1015
9   libdispatch.dylib             	    0x7ff80014bde4 _dispatch_main_queue_callback_4CF + 31
10  CoreFoundation                	    0x7ff800387b1f __CFRUNLOOP_IS_SERVICING_THE_MAIN_DISPATCH_QUEUE__ + 9
11  CoreFoundation                	    0x7ff800382436 __CFRunLoopRun + 2482
12  CoreFoundation                	    0x7ff8003816a7 CFRunLoopRunSpecific + 560
13  GraphicsServices              	    0x7ff809cb128a GSEventRunModal + 139
14  UIKitCore                     	       0x107850ad3 -[UIApplication _run] + 994
15  UIKitCore                     	       0x1078559ef UIApplicationMain + 123
16  DSYMDemo                      	       0x1003f51be main + 110 (main.m:17)
17  dyld_sim                      	       0x1006312bf start_sim + 10
18  dyld                          	       0x10deea52e start + 462
// ...

Binary Images:
    0x7ff836115000 -     0x7ff83614cfff libsystem_kernel.dylib (*) <c37bfe8a-c5ae-3fe0-b722-33483d9017b9> /usr/lib/system/libsystem_kernel.dylib
    0x7ff83616e000 -     0x7ff836179ff7 libsystem_pthread.dylib (*) <e097f78f-fcfb-30f3-9164-dbc9709ba134> /usr/lib/system/libsystem_pthread.dylib
    0x7ff8000b5000 -     0x7ff800139ff7 libsystem_c.dylib (*) <8a60f5c1-ea1f-352b-b778-967be44e3677> /Applications/Xcode.app/Contents/Developer/Platforms/iPhoneOS.platform/Library/Developer/CoreSimulator/Profiles/Runtimes/iOS.simruntime/Contents/Resources/RuntimeRoot/usr/lib/system/libsystem_c.dylib
    0x7ff800248000 -     0x7ff80025dffb libc++abi.dylib (*) <ae8cbd53-0926-3251-b648-6f32d9330a50> /Applications/Xcode.app/Contents/Developer/Platforms/iPhoneOS.platform/Library/Developer/CoreSimulator/Profiles/Runtimes/iOS.simruntime/Contents/Resources/RuntimeRoot/usr/lib/libc++abi.dylib
    0x7ff80002c000 -     0x7ff80005ffe9 libobjc.A.dylib (*) <2a7a213a-fdb2-311c-81d7-efdfd9ddf25a> /Applications/Xcode.app/Contents/Developer/Platforms/iPhoneOS.platform/Library/Developer/CoreSimulator/Profiles/Runtimes/iOS.simruntime/Contents/Resources/RuntimeRoot/usr/lib/libobjc.A.dylib
    0x7ff80013a000 -     0x7ff800185ff3 libdispatch.dylib (*) <59be51c1-e9f3-3a60-8108-cd70ae082897> /Applications/Xcode.app/Contents/Developer/Platforms/iPhoneOS.platform/Library/Developer/CoreSimulator/Profiles/Runtimes/iOS.simruntime/Contents/Resources/RuntimeRoot/usr/lib/system/libdispatch.dylib
    0x7ff800303000 -     0x7ff80068bffc com.apple.CoreFoundation (6.9) <2be0f79f-8b25-3614-9e7e-dbac565f72dd> /Applications/Xcode.app/Contents/Developer/Platforms/iPhoneOS.platform/Library/Developer/CoreSimulator/Profiles/Runtimes/iOS.simruntime/Contents/Resources/RuntimeRoot/System/Library/Frameworks/CoreFoundation.framework/CoreFoundation
    0x7ff809cae000 -     0x7ff809cb5ff2 com.apple.GraphicsServices (1.0) <16365e42-1d5c-363d-84d1-3bb290a43253> /Applications/Xcode.app/Contents/Developer/Platforms/iPhoneOS.platform/Library/Developer/CoreSimulator/Profiles/Runtimes/iOS.simruntime/Contents/Resources/RuntimeRoot/System/Library/PrivateFrameworks/GraphicsServices.framework/GraphicsServices
       0x106a0f000 -        0x1084dafff com.apple.UIKitCore (1.0) <adb282b1-2fb2-38e0-8492-47f9443eb1ef> /Applications/Xcode.app/Contents/Developer/Platforms/iPhoneOS.platform/Library/Developer/CoreSimulator/Profiles/Runtimes/iOS.simruntime/Contents/Resources/RuntimeRoot/System/Library/PrivateFrameworks/UIKitCore.framework/UIKitCore
       0x1003f3000 -        0x1003f6fff com.unix.kernel.DSYMDemo (1.0) <dfa5c389-73ed-3edb-b1cc-0f3b71ce0579> /Users/USER/Library/Developer/CoreSimulator/Devices/5E0D0385-812D-4FE6-83F6-FFE74E964106/data/Containers/Bundle/Application/474123CE-45D0-45A4-A4B1-EC7588A849AB/DSYMDemo.app/DSYMDemo
       0x10062f000 -        0x10068efff dyld_sim (*) <6fb74554-3370-3677-93d4-7f7a01ea6a80> /Applications/Xcode.app/Contents/Developer/Platforms/iPhoneOS.platform/Library/Developer/CoreSimulator/Profiles/Runtimes/iOS.simruntime/Contents/Resources/RuntimeRoot/usr/lib/dyld_sim
       0x10dee5000 -        0x10df50fff dyld (*) <499010ac-3054-326e-a050-fefffb5ce89a> /usr/lib/dyld
    0x7ff8006fe000 -     0x7ff80102eff4 com.apple.Foundation (6.9) <86cd050d-44fc-3045-a1f3-8ad5047b329e> /Applications/Xcode.app/Contents/Developer/Platforms/iPhoneOS.platform/Library/Developer/CoreSimulator/Profiles/Runtimes/iOS.simruntime/Contents/Resources/RuntimeRoot/System/Library/Frameworks/Foundation.framework/Foundation
```

åˆ†æï¼š

- iOS å­˜åœ¨ ASLR æŠ€æœ¯ï¼Œæ‰€ä»¥å½“å‘ç”Ÿ crash çš„æ—¶å€™ï¼Œè·å–åˆ°çš„ç¬¦å·æ˜¯å·²ç»ç»è¿‡ dyld å¯åŠ¨åŠ è½½ï¼Œèµ‹äºˆè¿‡åç§»é‡ä¹‹åçš„åœ°å€
- `.dSYM` æ–‡ä»¶ä¿å­˜çš„åœ°å€æ˜¯åç§»åçš„åœ°å€ã€‚å› ä¸ºè™šæ‹Ÿåœ°å€çš„ dyld å¯åŠ¨ä¸ºäº†å®‰å…¨æ‰åšçš„éšæœºåç§»ï¼Œä¸” `.dSYM` æ–‡ä»¶æ˜¯ç¼–è¯‘é˜¶æ®µå°±ç”Ÿæˆçš„ï¼Œæ‰€ä»¥ä¸å¯èƒ½æ˜¯è™šæ‹Ÿåœ°å€ï¼Œä¸€å®šæ˜¯åç§»åœ°å€ã€‚
- ç¬¦å·è¡¨å­˜å‚¨äº†å½“å‰æ–‡ä»¶çš„ç¬¦å·ä¿¡æ¯ï¼Œé™æ€é“¾æ¥å™¨(ld) å’ŒåŠ¨æ€é“¾æ¥å™¨(dyld) åœ¨é“¾æ¥çš„è¿‡ç¨‹ä¸­éƒ½ä¼šè¯»å–ç¬¦å·è¡¨ï¼Œå¦å¤–è°ƒè¯•å™¨ä¹Ÿä¼šç”¨ç¬¦å·è¡¨æ¥æŠŠç¬¦å·æ˜ å°„åˆ°æºæ–‡ä»¶ã€‚
- æ‰“åŒ…ä¸Šçº¿çš„æ—¶å€™ä¼šæŠŠè°ƒè¯•ç¬¦å·ç­‰è£å‰ªæ‰ï¼Œä½†æ˜¯çº¿ä¸Šç»Ÿè®¡åˆ°çš„å †æ ˆæˆ‘ä»¬ä»ç„¶è¦èƒ½å¤ŸçŸ¥é“å¯¹åº”çš„æºä»£ç ï¼Œè¿™æ—¶å€™å°±éœ€è¦æŠŠç¬¦å·å†™åˆ°å¦å¤–ä¸€ä¸ªå•ç‹¬çš„æ–‡ä»¶é‡Œï¼Œè¿™ä¸ªæ–‡ä»¶å°±æ˜¯ DSYMã€‚
- ç¬¦å·åŒ–ï¼Œä»€ä¹ˆæ˜¯ç¬¦å·åŒ–ï¼Ÿä¾é ç¬¦å·è¡¨æ ¹æ®åœ°å€æ‰¾å¯¹åº”çš„ç¬¦å·åã€ä»£ç æ–‡ä»¶åçš„è¿™ä¸ªè¿‡ç¨‹å°±å«ç¬¦å·åŒ–
- 
- ä½†æ˜¯ç¬¦å·è¡¨ä¸­è®°å½•çš„ä¿¡æ¯æ˜¯æœªç» ASLR çš„ï¼Œä¹Ÿå°±æ˜¯æ ¹æ®åç§»åœ°å€æ¥è®°å½•çš„ã€‚æ‰€ä»¥ crash å‘ç”Ÿæ‹¿åˆ°çš„åœ°å€ï¼Œéœ€è¦è®¡ç®—å‡ºåŸå§‹åœ°å€ï¼ˆåŸå§‹åœ°å€ä¹Ÿæ˜¯ç›¸å¯¹ Mach-O çš„åœ°å€ï¼‰æ‰å¯ä»¥æ ¹æ®ç¬¦å·è¡¨æ‹¿åˆ°åŸå§‹ç¬¦å·ã€æ–‡ä»¶ä¿¡æ¯
- æ€ä¹ˆè®¡ç®—åŸå§‹åœ°å€ï¼Ÿå‡è®¾ä¸šåŠ¡ä»£ç ï¼ˆä¹Ÿå°±æ˜¯ä¸Šé¢çš„ DSYMDemoï¼‰å‘ç”Ÿ crashï¼Œcrash åœ°å€ä¸º `0x1003f4f16`ï¼Œcrash æŠ¥å‘Šæœ€ä¸‹é¢ä¹Ÿåˆ—å‡ºäº†æ‰€ä»¥æ¥çš„é•œåƒï¼ˆMach-Oï¼‰ï¼Œä¹Ÿæä¾›äº† base åœ°å€ã€‚Mach-O çš„å¼€å§‹åœ°å€ä¸ºï¼š  `0x1003f3000 -        0x1003f6fff com.unix.kernel.DSYMDemo` ã€‚åˆ™ ASLR å‰çš„åœ°å€ä¸ºï¼š`0x1003f4f16 - 0x1003f3000`ã€‚è®¡ç®—åå†å»ç¬¦å·è¡¨æŸ¥æ‰¾å¯¹åº”çš„ç¬¦å·ã€æ–‡ä»¶ä¿¡æ¯
- ç„¶ååˆ©ç”¨ `dwarfdump --lookup åœ°å€ --arch æ¶æ„  DSYMDemo.app.dSYM` æ¥æ‰¾åˆ°ç›¸å…³ä¿¡æ¯ï¼Œé‡Œé¢æœ‰ç¬¦å·åã€æ–‡ä»¶åã€ä»£ç è¡Œæ•°



#### è®¡ç®—åŸå§‹åœ°å€

```objective-c
#import <mach-o/dyld.h>
#import <objc/runtime.h>

uintptr_t get_slide_address(void) { // è·å– ASLR
    uintptr_t vmAddress_slide = 0;
  	// éå†æ‰€æœ‰åŠ è½½è¿‡çš„ imageï¼ŒåŒ…æ‹¬ ipaä¸­çš„å¯æ‰§è¡Œæ–‡ä»¶ + ä¾èµ–çš„åŠ¨æ€åº“
    for (uint32_t i = 0; i < _dyld_image_count(); i++) {
        const char *imageName = (char *)_dyld_get_image_name(i);
        const struct mach_header *header = _dyld_get_image_header(i);
        if (header->filetype == MH_EXECUTE) {
          	// è·å– image å½“å‰çš„åç§»åœ°å€ã€‚åç§»æ˜¯åŸºäºè¯¥ç¬¦å·æ‰€åœ¨ image çš„
            vmAddress_slide = _dyld_get_image_vmaddr_slide(i);
        }
        NSString *str = [NSString stringWithUTF8String:imageName];
        if ([str containsString:@"DSYMDemo"]) {
            NSLog(@"image name %s at address 0x%llx and ASLR slide 0x%lx.\n", imageName, (mach_vm_address_t)header, vmAddress_slide);
        }
    }
    return vmAddress_slide;
}

- (void)getMethodVMAddress {
	  // è·å– sel çš„ ASLR åçš„åœ°å€ï¼Œå› ä¸ºå¯åŠ¨åç»è¿‡ dyld åšäº†åç§»
    IMP imp = class_getMethodImplementation(self.class, @selector(visitElement));
    unsigned long imppos = (unsigned long)imp;
    unsigned long slide = get_slide_address();
  	// ç¬¦å·çš„çœŸå®åœ°å€ï¼Œåœ¨ ASLR æŠ€æœ¯ä½œç”¨ä¸‹ï¼ŒåŸºäº Mach-O çš„ä¸€ä¸ªåç§»åœ°å€ã€‚æ‰€ä»¥çœŸå®åœ°å€ = ç»è¿‡ runtime æ‹¿åˆ°çš„ imp åœ°å€ - å½“å‰ image çš„èµ·å§‹åœ°å€
    unsigned long addr = imppos - slide;
    NSLog(@"%lu", addr);
}
```

æ‹¿åˆ°çœŸå®åœ°å€ï¼Œç„¶ååˆ©ç”¨ `dwarfdump --lookup 0x0000000100001ce0 DSYMDemo.app.dSYM` æ‰¾åˆ°å¯¹åº”çš„ä¿¡æ¯ï¼Œå¯ä»¥çœ‹åˆ°

- ç¬¦å·å
- ç¬¦å·æ‰€åœ¨ä»£ç æ–‡ä»¶
- ç¬¦å·æ‰€åœ¨ä»£ç æ–‡ä»¶çš„å¤šå°‘è¡Œ

<img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/CalcuateARLRAddressViaDyld.png" style="zoom:30%" />



## ASLR

### è™šæ‹Ÿå†…å­˜ã€ç‰©ç†å†…å­˜ã€å†…å­˜åˆ†é¡µã€ASLR

æ—©æœŸï¼šåº”ç”¨ç¨‹åºçš„å¯æ‰§è¡Œæ–‡ä»¶æ˜¯å­˜å‚¨åœ¨ç£ç›˜ä¸Šçš„ï¼Œå¯åŠ¨åº”ç”¨ï¼Œåˆ™éœ€è¦å°†å¯æ‰§è¡Œæ–‡ä»¶åŠ è½½è¿›å†…å­˜ï¼Œæ—©æœŸè®¡ç®—æœºæ˜¯æ²¡æœ‰è™šæ‹Ÿå†…å­˜çš„ï¼Œä¸€æ—¦åŠ è½½å°±ä¼šå…¨éƒ¨åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œå¹¶ä¸”è¿›ç¨‹éƒ½æ˜¯æŒ‰ç…§é¡ºåºæ’åˆ—çš„ï¼Œè¿™æ ·å­˜åœ¨ä¸¤ä¸ªé—®é¢˜ï¼š

- å½“å‰è¿›ç¨‹åªéœ€è¦åœ¨åˆé€‚çš„åœ°å€åŸºç¡€ä¸Šï¼ŒåŠ å‡ä¸€äº›åœ°å€ï¼Œå°±èƒ½è®¿é—®åˆ°ä¸‹ä¸€ä¸ªè¿›ç¨‹æ‰€ä½¿ç”¨çš„å†…å­˜ï¼Œå®‰å…¨æ€§å¾ˆä½

- å½“å‰è½¯ä»¶è¶Šæ¥è¶Šå¤§ï¼Œå¼€å¯å¤šä¸ªè½¯ä»¶æ—¶ä¼šç›´æ¥å…¨éƒ¨åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œå¯¼è‡´å†…å­˜ä¸å¤Ÿç”¨ã€‚è€Œä¸”ä½¿ç”¨è½¯ä»¶çš„æ—¶å€™å¤§å¤šæ•°æƒ…å†µåªä½¿ç”¨éƒ¨åˆ†åŠŸèƒ½ã€‚å¦‚æœè½¯ä»¶ä¸€æ‰“å¼€å°±å…¨éƒ¨åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œä¼šé€ æˆå†…å­˜çš„ä¸¥é‡æµªè´¹ã€‚

åŸºäºä¸Šè¿°2ä¸ªé—®é¢˜ï¼Œè¯ç”Ÿäº†è™šæ‹Ÿå†…å­˜æŠ€æœ¯ã€‚App è¿›ç¨‹é€šè¿‡å†…å­˜ç®¡ç†å•å…ƒï¼ˆMemory Management Unit, MMUï¼‰æ¥ç®¡ç†çš„ã€‚MMU ä½¿ç”¨ä¸€å¼ ç‰¹æ®Šçš„è¡¨æ¥è·Ÿè¸ªè™šæ‹Ÿå†…å­˜åœ°å€å’Œç‰©ç†å†…å­˜åœ°å€ä¹‹é—´çš„æ˜ å°„å…³ç³»ã€‚è¿™å¼ è¡¨é€šå¸¸è¢«ç§°ä¸ºé¡µè¡¨ï¼ˆPage Tableï¼‰

å†…å­˜åˆ†é¡µï¼š

- é¡µè¡¨ç»“æ„ï¼šé¡µè¡¨åŒ…å«äº†ä¸€ç³»åˆ—çš„è¡¨é¡¹ï¼Œæ¯ä¸ªè¡¨é¡¹å¯¹åº”è™šæ‹Ÿå†…å­˜ä¸­çš„ä¸€ä¸ªé¡µï¼ˆé€šå¸¸æ˜¯ 4KBï¼‰ã€‚æ¯ä¸ªè¡¨é¡¹åŒ…å«äº†è¯¥è™šæ‹Ÿé¡µå¯¹åº”çš„ç‰©ç†é¡µçš„ä¿¡æ¯ï¼ŒåŒ…æ‹¬ç‰©ç†é¡µçš„èµ·å§‹åœ°å€å’Œä¸€äº›çŠ¶æ€ä¿¡æ¯ã€‚
- è™šæ‹Ÿåœ°å€åˆ°ç‰©ç†åœ°å€çš„è½¬æ¢ï¼šå½“ç¨‹åºè®¿é—®ä¸€ä¸ªè™šæ‹Ÿåœ°å€æ—¶ï¼ŒMMU æŸ¥çœ‹é¡µè¡¨æ¥æ‰¾åˆ°å¯¹åº”çš„è¡¨é¡¹ï¼Œç„¶åæ ¹æ®è¡¨é¡¹ä¸­çš„ä¿¡æ¯å°†è™šæ‹Ÿåœ°å€è½¬æ¢ä¸ºç‰©ç†åœ°å€ã€‚
- é¡µè¡¨ç¼“å­˜ï¼ˆTLB - Translation Lookaside Bufferï¼‰ï¼šä¸ºäº†æé«˜åœ°å€è½¬æ¢çš„é€Ÿåº¦ï¼ŒMMU é€šå¸¸ä¼šæœ‰ä¸€ä¸ª TLBï¼Œå®ƒç¼“å­˜äº†æœ€è¿‘è®¿é—®çš„é¡µè¡¨é¡¹ã€‚è¿™æ ·ï¼Œå¯¹äºé¢‘ç¹è®¿é—®çš„åœ°å€ï¼Œè½¬æ¢è¿‡ç¨‹å¯ä»¥æ›´å¿«åœ°å®Œæˆ
- é¡µé”™è¯¯å¤„ç†ï¼šå¦‚æœä¸€ä¸ªè™šæ‹Ÿåœ°å€åœ¨é¡µè¡¨ä¸­æ²¡æœ‰å¯¹åº”çš„æ¡ç›®ï¼Œå°±ä¼šå‘ç”Ÿé¡µé”™è¯¯ã€‚æ“ä½œç³»ç»Ÿçš„é¡µé”™è¯¯å¤„ç†ç¨‹åºä¼šè¢«è°ƒç”¨ï¼Œå®ƒè´Ÿè´£åŠ è½½ç¼ºå¤±çš„é¡µåˆ°ç‰©ç†å†…å­˜ä¸­ï¼Œå¹¶æ›´æ–°é¡µè¡¨ã€‚
- å†…å­˜åˆ†é…ï¼šå½“åº”ç”¨ç¨‹åºè¯·æ±‚å†…å­˜æ—¶ï¼Œæ“ä½œç³»ç»Ÿä¼šåˆ†é…è™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œå¹¶åœ¨é¡µè¡¨ä¸­åˆ›å»ºç›¸åº”çš„æ¡ç›®ã€‚å¦‚æœéœ€è¦ï¼Œæ“ä½œç³»ç»Ÿè¿˜ä¼šåˆ†é…ç‰©ç†å†…å­˜é¡µï¼Œå¹¶å°†å…¶ä¸è™šæ‹Ÿé¡µå…³è”èµ·æ¥ã€‚

å½“ç‰©ç†å†…å­˜æ»¡çš„æ—¶å€™ï¼Œä¼šå‘ç”Ÿè¦†ç›–ã€‚ç”¨æˆ·ä½¿ç”¨çš„æ´»è·ƒçš„æ•°æ®ï¼Œè¦†ç›–å†…å­˜ä¸­æœ€ä¸æ´»è·ƒçš„æ•°æ®é‚£ä¸€é¡µã€‚å¯¹åº”ç°å®çš„è¡¨ç°å°±æ˜¯ï¼šiPhone ä¸Šæ°¸è¿œå¯ä»¥è¾ƒå¥½çš„æ‰“å¼€ä¸€ä¸ª Appï¼Œæ¯”å¦‚æ‰“å¼€äº† App1ã€App2ã€App3...ï¼Œç­‰æ‰“å¼€ä½¿ç”¨äº†ä¸€é˜µå­åï¼Œå†…å­˜ç´§å¼ ï¼Œæˆ‘ä»¬å°è¯•åˆ‡æ¢æ‰“å¼€æœ€æ—©çš„ App1ï¼Œä¼šå‘ç° App1 é‡æ–°å¯åŠ¨äº†ï¼Œä¹‹å‰ç”¨çš„åŠŸèƒ½ A çš„é¡µé¢1ï¼Œå·²ç»ä¸è§äº†ï¼Œç»å†ä¸€ä¸ªæ–°çš„å¯åŠ¨æµç¨‹ã€‚



ä½†è™šæ‹Ÿå†…å­˜æ–¹æ¡ˆå¸¦æ¥ä¸€ä¸ªé—®é¢˜ã€‚æ¯”å¦‚é»‘å®¢ä¸æ–­æ¢ç´¢å‘ç°ï¼ŒæŸä¸ªé‡è¦çš„åŠŸèƒ½ä½äºç¬¬3é¡µï¼Œæ˜¯ä¸æ˜¯å®Œå…¨å¯ä»¥é€šè¿‡å›ºå®šçš„åœ°å€å»è®¿é—®ï¼Ÿï¼Ÿ

å› ä¸ºæ—©æœŸç‰©ç†å†…å­˜æ–¹æ¡ˆä¸‹ï¼ŒApp å¯åŠ¨åä½äºä»€ä¹ˆåœ°å€æ˜¯ä¸ç¡®å®šçš„ã€‚æœ‰äº†è™šæ‹Ÿå†…å­˜åï¼ŒApp å†…ç¬¦å·çš„åœ°å€éƒ½æ˜¯ä»0åˆ°4Gï¼Œéƒ½æ˜¯ç›¸å¯¹åœ°å€ã€‚

ä¸ºäº†è§£å†³è¯¥é—®é¢˜ï¼ŒApple åˆæ¨å‡ºäº† ASLR æŠ€æœ¯ã€‚æ ¸å¿ƒå°±æ˜¯ä¸ºäº†è§£å†³è™šæ‹Ÿå†…å­˜åœ°å€å›ºå®šä¸å˜çš„é—®é¢˜ã€‚å°±ä¸èƒ½é€šè¿‡å›ºå®šçš„åœ°å€è®¿é—®å†…å­˜æˆ–è€…æ•°æ®äº†ã€‚

### æœªä½¿ç”¨ ASLR çš„é—®é¢˜

- å‡½æ•°ä»£ç å­˜æ”¾åœ¨ `__TEXT` æ®µ

- å…¨å±€å˜é‡å­˜æ”¾åœ¨ `__DATA` æ®µ

- å¯æ‰§è¡Œæ–‡ä»¶çš„å†…å­˜åœ°å€ä¸º `0x0`

- å¯æ‰§è¡Œæ–‡ä»¶ Header çš„å†…å­˜åœ°å€ï¼Œå°±æ˜¯ `LC_SEGMENT(__TEXT)` ä¸­çš„ VM Address
  
  - arm64 ï¼š`0x100000000`
  
  - é arm64ï¼š`0x4000`

ä¹Ÿå¯ä»¥ä½¿ç”¨ `size -l -m -x DDD` æŒ‡ä»¤æ¥æŸ¥çœ‹ Mach-O çš„å†…å­˜åˆ†å¸ƒ

<img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/MachOInsepect.png" style="zoom:35%">

åˆ©ç”¨ MachOView æŸ¥çœ‹å¦‚ä¸‹ï¼š

<img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/MachOViewDemo1.png" style="zoom:25%">

<img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/MachOViewDemo2.png" style="zoom:25%">



- _PAGEZERO
  - VM Addressï¼š0x0
  - VM Sizeï¼š0x100000000
- _TEXT
  - VM Addressï¼š0x100000000
  - VM Sizeï¼š0x4000
- _DATA_CONST:
  - VM Addressï¼š0x10004000
  - VM Sizeï¼š0x4000
- _DATA
  - VM Addressï¼š0x10008000
  - VM Sizeï¼š0x4000
- _LINKEDIT
  - VM Addressï¼š0x1000C000
  - VM Sizeï¼š0x8000



<img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/ASLRDemo.png" style="zoom:45%">





File Offsetï¼šåœ¨ Mach-O æ–‡ä»¶ä¸­çš„ä½ç½®

File Sizeï¼šåœ¨ Mach-O æ–‡ä»¶ä¸­çš„å æ®çš„å¤§å°

ä»ä¸‹é¢çš„å›¾å¯ä»¥çœ‹å‡ºï¼Œ`_PAGEZERO` åœ¨çœŸå®çš„ Mach-O æ–‡ä»¶ä¸­ä¸å­˜åœ¨ï¼Œä¸å æ®å¤§å°ã€‚åªåœ¨è™šæ‹Ÿå†…å­˜ä¸­å­˜åœ¨ã€‚

<img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/MachOViewDemo1.png" style="zoom:25%">





æˆ‘ä»¬ä¼šå‘ç°æ ¹æ® Mach-O æ–‡ä»¶ä¸­çš„ä¿¡æ¯ï¼ŒFile Sizeã€File Offsetã€VM Addressã€VM Size å¯ä»¥åˆ¤æ–­å‡º `__TEXT` æ®µå†…å‡½æ•°ä¿¡æ¯ï¼Œè¿™æ ·å­ä¸å¤Ÿå®‰å…¨



### ASLR è¯ç”Ÿ

Address Space Layout Randomizationï¼Œåœ°å€ç©ºé—´å¸ƒå±€éšæœºåŒ–ã€‚æ˜¯ä¸€ç§é’ˆå¯¹ç¼“å†²åŒºæº¢å‡ºçš„å®‰å…¨ä¿æŠ¤æŠ€æœ¯ï¼Œé€šè¿‡å †ã€æ ˆã€å…±äº«åº“æ˜ å°„ç­‰çº¿æ€§åŒºå¸ƒå±€çš„éšæœºåŒ–ï¼Œé€šè¿‡å¢åŠ æ”»å‡»è€…é¢„æµ‹ç›®çš„åœ°å€çš„éš¾åº¦ï¼Œé˜²æ­¢æ”»å‡»è€…ç›´æ¥å®šä½æ”»å‡»ä»£ç çš„ä½ç½®ï¼Œè¾¾åˆ°é˜»æ­¢æº¢å‡ºæ”»å‡»ç›®çš„çš„ä¸€ç§æŠ€æœ¯ã€‚åœ¨ iOS 4.3 å¼•å…¥ã€‚

<img src="https://raw.githubusercontent.com/FantasticLBP/knowledge-kit/master/assets/ASLROffset.png" style="zoom:45%">



- LC_SEGMENT (__TEXT) çš„ VM Address `0x10005000`

- ASLR éšæœºåç§» 0x5000ï¼Œä¹Ÿå°±æ˜¯å¯æ‰§è¡Œæ–‡ä»¶çš„å†…å­˜åœ°å€

åœ¨æœ‰ ASLR çš„æ—¶å€™ï¼š__TEXT ä»£ç æ®µåœ°å€ = __`PAGEZEROR åœ°å€`

åœ¨ Mach-O æ–‡ä»¶ä¸­çš„åœ°å€æ˜¯åŸå§‹åœ°å€

```shell
ä»£ç è¿è¡Œèµ·æ¥å‡½æ•°çœŸå®åœ°å€ = ASLR-Offset + __PAGEZEROï¼ˆarm64ï¼š0x100000000ï¼Œå…¶ä»–ï¼š0x4000ï¼‰+ å‡½æ•°åŸºäº Mach-O çš„åœ°å€
```